# API封装与Token处理修改实施步骤

本文档提供了API封装与Token处理修改的实施步骤和测试方法。

## 1. 已完成的修改

1. 创建了API类型定义文件：`src/types/api.ts`
2. 修改了用户API文件：`src/api/user.ts`
3. 增强了HTTP请求工具：`src/utils/http/index.ts`
4. 更新了用户存储模块：`src/store/modules/user.ts`

## 2. 测试步骤

### 2.1 测试登录功能

1. 运行项目：`npm run dev`
2. 打开浏览器，访问登录页面
3. 输入用户名和密码进行登录
4. 检查浏览器开发者工具中的网络请求，确认请求格式正确
5. 检查浏览器开发者工具中的本地存储，确认`access_token`、`refresh_token`和`user_info`已正确存储

### 2.2 测试Token刷新功能

1. 在浏览器开发者工具中，修改`access_token`的值，使其无效
2. 刷新页面或尝试访问需要认证的API
3. 观察网络请求，确认系统自动尝试刷新Token
4. 确认刷新Token请求的参数格式为`{ refresh_token: "xxx" }`
5. 确认刷新Token成功后，原始请求自动重试

### 2.3 测试请求重试功能

1. 在浏览器控制台中执行以下代码，模拟Token过期：
   ```javascript
   localStorage.setItem('access_token', 'invalid_token');
   ```
2. 尝试访问需要认证的API
3. 观察网络请求，确认系统自动尝试刷新Token
4. 确认刷新Token成功后，原始请求自动重试，无需刷新页面

### 2.4 测试错误处理功能

1. 故意发送错误请求，如访问不存在的API
2. 确认系统显示友好的错误提示
3. 检查错误响应格式是否符合标准格式：
   ```json
   {
     "success": false,
     "code": 4004,
     "message": "请求的资源不存在",
     "data": null
   }
   ```

## 3. 注意事项

1. **请求URL格式**：确保所有请求URL末尾都添加斜杠，以符合Django的URL规范
2. **Token存储**：系统同时使用localStorage和cookie存储Token，以兼容现有代码
3. **刷新Token参数**：刷新Token请求的参数格式为`{ refresh_token: "xxx" }`
4. **请求白名单**：登录和刷新Token接口不需要添加认证头

## 4. 可能的问题与解决方案

### 4.1 刷新Token失败

**问题**：刷新Token请求失败，系统跳转到登录页面

**解决方案**：
- 检查`refresh_token`是否正确
- 确认刷新Token接口URL是否正确
- 确认刷新Token请求参数格式是否正确

### 4.2 原始请求重试失败

**问题**：刷新Token成功，但原始请求重试失败

**解决方案**：
- 检查请求队列处理逻辑
- 确认新Token已正确应用到重试请求中
- 检查重试请求的配置是否正确

### 4.3 CSRF Token问题

**问题**：请求返回CSRF验证失败错误

**解决方案**：
- 确认CSRF Token获取逻辑正确
- 检查请求头中是否正确添加了`X-CSRFTOKEN`
- 确认Django后端的CSRF设置是否正确

## 5. 后续优化方向

1. 添加Token自动续期功能，在Token即将过期前主动刷新
2. 优化错误处理逻辑，提供更详细的错误信息
3. 增加请求重试次数限制，避免无限重试
4. 添加请求取消功能，支持手动取消长时间未响应的请求 