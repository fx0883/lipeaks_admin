# Pure Admin Thin i18n 项目适配计划

## 1. 背景

需要将 Pure Admin Thin i18n 项目适配到现有的后端API，包括登录、令牌刷新等功能。后端API提供了用户认证和授权的功能，前端需要与之对接。

## 2. 后端API概览

### 2.1 登录API
- URL: `http://localhost:8000/api/v1/auth/login/`
- 方法: POST
- 请求体:
  ```json
  {
    "username": "admin",
    "password": "admin_main"
  }
  ```
- 响应:
  ```json
  {
    "success": true,
    "code": 2000,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "user": {
        "id": 1,
        "username": "admin",
        "email": "admin@qq.com",
        "nick_name": "Xuan",
        "is_admin": true,
        "is_super_admin": true,
        "avatar": "/media/avatars/a3fbfd97-e898-47b5-8725-5741f23597ad.jpg"
      }
    }
  }
  ```

### 2.2 令牌刷新API
- URL: `http://localhost:8000/api/v1/auth/refresh/`
- 方法: POST
- 请求体:
  ```json
  {
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```
- 响应:
  ```json
  {
    "success": true,
    "code": 2000,
    "message": "令牌刷新成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
  }
  ```

### 2.3 用户数据结构
```python
class User(AbstractUser):
    tenant = models.ForeignKey('tenants.Tenant', on_delete=models.CASCADE, null=True, blank=True, related_name="users", verbose_name=_("所属租户"))
    parent = models.ForeignKey('self', on_delete=models.CASCADE, null=True, blank=True, related_name="sub_accounts", verbose_name=_("父账号"))
    is_admin = models.BooleanField(_("是否管理员"), default=False)
    is_member = models.BooleanField(_("是否普通成员"), default=True)
    is_super_admin = models.BooleanField(_("是否超级管理员"), default=False)
    phone = models.CharField(_("手机号"), max_length=11, null=True, blank=True)
    email = models.EmailField(_("邮箱"))
    nick_name = models.CharField(_("昵称"), max_length=30, null=True, blank=True)
    avatar = models.CharField(_("头像"), max_length=200, default="", blank=True)
    is_deleted = models.BooleanField(_("是否删除"), default=False)
    status = models.CharField(_("状态"), max_length=20, choices=[('active', '活跃'), ('suspended', '暂停'), ('inactive', '未激活')], default='active')
    last_login_ip = models.CharField(_("最后登录IP"), max_length=50, null=True, blank=True)
```

## 3. 修改计划

### 3.1 API接口适配

#### 3.1.1 修改登录接口
1. 修改 `/src/api/user.ts` 中的登录接口，适配新的API地址和参数格式
2. 修改响应数据处理，将 `token` 映射为 `accessToken`，`refresh_token` 映射为 `refreshToken`
3. 存储用户信息到 Pinia store 中

#### 3.1.2 修改令牌刷新接口
1. 修改 `/src/utils/http/index.ts` 中的令牌刷新逻辑
2. 适配新的API地址和参数格式
3. 更新令牌处理逻辑

### 3.2 用户数据结构适配

1. 修改 `/src/store/modules/user.ts` 中的用户数据结构，添加新的字段：
   - tenant
   - parent
   - is_admin
   - is_member
   - is_super_admin
   - phone
   - nick_name
   - avatar
   - status
   - last_login_ip

2. 更新相关组件和页面，以显示和使用这些新字段

### 3.3 权限控制适配

1. 根据 `is_admin`, `is_super_admin`, `is_member` 字段调整权限控制逻辑
2. 更新 `/src/store/modules/permission.ts` 中的权限判断逻辑

### 3.4 其他适配

1. 修改 API 基础地址配置，指向 `http://localhost:8000/api/v1/`
2. 添加 CSRF Token 处理，确保请求头中包含 `X-CSRFTOKEN`
3. 更新用户界面，以适应新的用户数据结构

## 4. 实施步骤

1. 修改 API 基础地址配置
2. 实现登录接口适配
3. 实现令牌刷新接口适配
4. 更新用户数据结构
5. 调整权限控制逻辑
6. 更新用户界面
7. 测试登录和令牌刷新功能
8. 测试权限控制功能

## 5. 注意事项

1. 确保 token 和 refresh_token 的正确存储和使用
2. 处理好权限控制逻辑，避免未授权访问
3. 注意 API 响应格式的差异，确保正确处理
4. 考虑租户和子账号功能的实现 