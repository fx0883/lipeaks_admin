# 错误处理策略

## 概述

本文档定义了项目中的错误处理策略，旨在提供一致的错误处理机制，改善用户体验，并简化开发流程。

## 错误处理层级

项目中的错误处理分为以下几个层级：

1. **HTTP 拦截器层**：处理网络请求错误，格式化错误响应
2. **业务逻辑层（Store）**：处理业务特定的错误，更新状态，显示错误消息
3. **组件层**：处理UI相关的错误，如表单验证错误

## 错误处理职责划分

### HTTP 拦截器层职责

- 捕获网络请求错误（如 400、401、500 等状态码）
- 格式化错误响应为统一的格式
- 处理认证相关错误（如令牌过期）
- 记录错误日志
- **不显示错误消息**，而是将格式化的错误传递给业务层

```typescript
// 正确示例：HTTP 拦截器不显示错误消息
logger.logError(error);
return Promise.reject(errorResponse);
```

### 业务逻辑层（Store）职责

- 处理业务特定的错误
- 更新状态（如 loading、error 等）
- 提供特定的错误恢复机制
- **显示错误消息**给用户
- 记录业务相关的错误日志

```typescript
// 正确示例：业务层显示错误消息
catch (error) {
  logger.error("创建会员失败", error);
  this.error = error.message || "创建会员失败";
  message(this.error, { type: "error" });
  throw error;
}
```

### 组件层职责

- 处理UI相关的错误，如表单验证错误
- 显示内联错误消息
- 不处理网络请求错误，将其委托给业务层

## 错误处理最佳实践

1. **避免重复显示错误消息**：
   - HTTP 拦截器不应显示错误消息
   - 业务层负责显示错误消息
   - 组件层只处理UI相关的错误

2. **统一错误格式**：
   - 所有错误应遵循统一的格式：`{ success: false, code: number, message: string, data: any }`
   - 错误代码应有明确的含义和范围

3. **错误日志记录**：
   - 所有错误都应记录日志，包括足够的上下文信息
   - 敏感信息应在记录前脱敏

4. **用户友好的错误消息**：
   - 错误消息应该用户友好，避免技术术语
   - 提供清晰的错误原因和可能的解决方案

5. **错误恢复机制**：
   - 对于可恢复的错误，应提供自动或手动恢复机制
   - 认证错误应自动尝试刷新令牌

## 常见错误类型及处理方式

### 认证错误（401）

- 自动尝试刷新令牌
- 如果刷新失败，跳转到登录页面

### 权限错误（403）

- 显示权限不足的错误消息
- 可能跳转到无权限页面

### 表单验证错误（400）

- 提取具体的字段错误信息
- 显示用户友好的错误消息
- 对于密码验证等特殊错误，提供专门的处理

### 服务器错误（500+）

- 显示通用的服务器错误消息
- 记录详细的错误日志供排查

## 结论

遵循本文档定义的错误处理策略，可以确保项目中的错误处理一致、可靠，并提供良好的用户体验。开发人员应确保在实现新功能时遵循这些原则，避免重复显示错误消息或遗漏错误处理。 