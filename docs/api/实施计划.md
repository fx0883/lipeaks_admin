# Pure Admin Thin i18n 项目适配实施计划

## 1. API 基础地址配置修改

### 1.1 创建环境变量配置

修改 `.env` 文件或创建新的环境变量文件，设置 API 基础地址：

```
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

## 2. API 接口适配

### 2.1 修改 `/src/api/user.ts`

```typescript
import { http } from "@/utils/http";

// 修改用户接口返回类型定义，适配后端API
export type UserResult = {
  success: boolean;
  code: number;
  message: string;
  data: {
    /** token */
    token: string;
    /** 刷新token */
    refresh_token: string;
    /** 用户信息 */
    user: {
      /** 用户ID */
      id: number;
      /** 用户名 */
      username: string;
      /** 邮箱 */
      email: string;
      /** 昵称 */
      nick_name: string;
      /** 是否管理员 */
      is_admin: boolean;
      /** 是否超级管理员 */
      is_super_admin: boolean;
      /** 头像 */
      avatar: string;
      /** 是否普通成员 */
      is_member?: boolean;
      /** 手机号 */
      phone?: string;
      /** 状态 */
      status?: string;
      /** 最后登录IP */
      last_login_ip?: string;
      /** 租户ID */
      tenant?: number;
      /** 父账号ID */
      parent?: number;
    }
  };
};

// 修改刷新token接口返回类型定义
export type RefreshTokenResult = {
  success: boolean;
  code: number;
  message: string;
  data: {
    /** token */
    token: string;
    /** 刷新token */
    refresh_token: string;
  };
};

/** 登录 */
export const getLogin = (data?: object) => {
  return http.request<UserResult>("post", "/auth/login", { data });
};

/** 刷新token */
export const refreshTokenApi = (data?: object) => {
  return http.request<RefreshTokenResult>("post", "/auth/refresh", { data });
};
```

## 3. 用户认证逻辑修改

### 3.1 修改 `/src/utils/auth.ts`

```typescript
// 修改 DataInfo 接口，适配新的用户数据结构
export interface DataInfo<T> {
  /** token */
  accessToken: string;
  /** token的过期时间（时间戳） */
  expires: T;
  /** 用于调用刷新accessToken的接口时所需的token */
  refreshToken: string;
  /** 用户ID */
  id?: number;
  /** 头像 */
  avatar?: string;
  /** 用户名 */
  username?: string;
  /** 昵称 */
  nick_name?: string;
  /** 邮箱 */
  email?: string;
  /** 是否管理员 */
  is_admin?: boolean;
  /** 是否超级管理员 */
  is_super_admin?: boolean;
  /** 是否普通成员 */
  is_member?: boolean;
  /** 手机号 */
  phone?: string;
  /** 状态 */
  status?: string;
  /** 最后登录IP */
  last_login_ip?: string;
  /** 租户ID */
  tenant?: number;
  /** 父账号ID */
  parent?: number;
  /** 当前登录用户的角色 */
  roles?: Array<string>;
  /** 当前登录用户的按钮级别权限 */
  permissions?: Array<string>;
}

// 修改 setToken 函数，适配新的用户数据结构
export function setToken(data: DataInfo<Date>) {
  let expires = 0;
  const { accessToken, refreshToken } = data;
  const { isRemembered, loginDay } = useUserStoreHook();
  
  // 设置过期时间
  expires = new Date(data.expires).getTime();
  const cookieString = JSON.stringify({ accessToken, expires, refreshToken });

  expires > 0
    ? Cookies.set(TokenKey, cookieString, {
        expires: (expires - Date.now()) / 86400000
      })
    : Cookies.set(TokenKey, cookieString);

  Cookies.set(
    multipleTabsKey,
    "true",
    isRemembered
      ? {
          expires: loginDay
        }
      : {}
  );

  // 更新存储用户信息的函数，添加新字段
  function setUserKey({
    id,
    avatar,
    username,
    nick_name,
    email,
    is_admin,
    is_super_admin,
    is_member,
    phone,
    status,
    last_login_ip,
    tenant,
    parent,
    roles,
    permissions
  }) {
    useUserStoreHook().SET_ID(id);
    useUserStoreHook().SET_AVATAR(avatar);
    useUserStoreHook().SET_USERNAME(username);
    useUserStoreHook().SET_NICKNAME(nick_name);
    useUserStoreHook().SET_EMAIL(email);
    useUserStoreHook().SET_IS_ADMIN(is_admin);
    useUserStoreHook().SET_IS_SUPER_ADMIN(is_super_admin);
    useUserStoreHook().SET_IS_MEMBER(is_member);
    useUserStoreHook().SET_PHONE(phone);
    useUserStoreHook().SET_STATUS(status);
    useUserStoreHook().SET_LAST_LOGIN_IP(last_login_ip);
    useUserStoreHook().SET_TENANT(tenant);
    useUserStoreHook().SET_PARENT(parent);
    useUserStoreHook().SET_ROLES(roles);
    useUserStoreHook().SET_PERMS(permissions);
    
    // 存储到本地
    storageLocal().setItem(userKey, {
      refreshToken,
      expires,
      id,
      avatar,
      username,
      nick_name,
      email,
      is_admin,
      is_super_admin,
      is_member,
      phone,
      status,
      last_login_ip,
      tenant,
      parent,
      roles,
      permissions
    });
  }

  // 处理用户信息
  if (data.username && data.roles) {
    const { 
      id,
      username,
      nick_name,
      email,
      is_admin,
      is_super_admin,
      is_member,
      phone,
      status,
      last_login_ip,
      tenant,
      parent,
      roles
    } = data;
    
    setUserKey({
      id,
      avatar: data?.avatar ?? "",
      username,
      nick_name: nick_name ?? "",
      email,
      is_admin,
      is_super_admin,
      is_member,
      phone,
      status,
      last_login_ip,
      tenant,
      parent,
      roles,
      permissions: data?.permissions ?? []
    });
  } else {
    // 从本地存储获取
    const userData = storageLocal().getItem<DataInfo<number>>(userKey);
    setUserKey({
      id: userData?.id,
      avatar: userData?.avatar ?? "",
      username: userData?.username ?? "",
      nick_name: userData?.nick_name ?? "",
      email: userData?.email ?? "",
      is_admin: userData?.is_admin ?? false,
      is_super_admin: userData?.is_super_admin ?? false,
      is_member: userData?.is_member ?? false,
      phone: userData?.phone ?? "",
      status: userData?.status ?? "",
      last_login_ip: userData?.last_login_ip ?? "",
      tenant: userData?.tenant,
      parent: userData?.parent,
      roles: userData?.roles ?? [],
      permissions: userData?.permissions ?? []
    });
  }
}
```

### 3.2 修改 `/src/store/modules/user.ts`

```typescript
import { defineStore } from "pinia";
import {
  type userType,
  store,
  router,
  resetRouter,
  routerArrays,
  storageLocal
} from "../utils";
import {
  type UserResult,
  type RefreshTokenResult,
  getLogin,
  refreshTokenApi
} from "@/api/user";
import { useMultiTagsStoreHook } from "./multiTags";
import { type DataInfo, setToken, removeToken, userKey } from "@/utils/auth";

// 扩展用户类型
export interface userType {
  id?: number;
  avatar: string;
  username: string;
  nickname: string;
  email?: string;
  is_admin?: boolean;
  is_super_admin?: boolean;
  is_member?: boolean;
  phone?: string;
  status?: string;
  last_login_ip?: string;
  tenant?: number;
  parent?: number;
  roles: Array<string>;
  permissions: Array<string>;
  isRemembered: boolean;
  loginDay: number;
}

export const useUserStore = defineStore("pure-user", {
  state: (): userType => ({
    // 用户ID
    id: storageLocal().getItem<DataInfo<number>>(userKey)?.id,
    // 头像
    avatar: storageLocal().getItem<DataInfo<number>>(userKey)?.avatar ?? "",
    // 用户名
    username: storageLocal().getItem<DataInfo<number>>(userKey)?.username ?? "",
    // 昵称
    nickname: storageLocal().getItem<DataInfo<number>>(userKey)?.nick_name ?? "",
    // 邮箱
    email: storageLocal().getItem<DataInfo<number>>(userKey)?.email ?? "",
    // 是否管理员
    is_admin: storageLocal().getItem<DataInfo<number>>(userKey)?.is_admin ?? false,
    // 是否超级管理员
    is_super_admin: storageLocal().getItem<DataInfo<number>>(userKey)?.is_super_admin ?? false,
    // 是否普通成员
    is_member: storageLocal().getItem<DataInfo<number>>(userKey)?.is_member ?? false,
    // 手机号
    phone: storageLocal().getItem<DataInfo<number>>(userKey)?.phone ?? "",
    // 状态
    status: storageLocal().getItem<DataInfo<number>>(userKey)?.status ?? "",
    // 最后登录IP
    last_login_ip: storageLocal().getItem<DataInfo<number>>(userKey)?.last_login_ip ?? "",
    // 租户ID
    tenant: storageLocal().getItem<DataInfo<number>>(userKey)?.tenant,
    // 父账号ID
    parent: storageLocal().getItem<DataInfo<number>>(userKey)?.parent,
    // 页面级别权限
    roles: storageLocal().getItem<DataInfo<number>>(userKey)?.roles ?? [],
    // 按钮级别权限
    permissions:
      storageLocal().getItem<DataInfo<number>>(userKey)?.permissions ?? [],
    // 是否勾选了登录页的免登录
    isRemembered: false,
    // 登录页的免登录存储几天，默认7天
    loginDay: 7
  }),
  actions: {
    /** 存储用户ID */
    SET_ID(id: number) {
      this.id = id;
    },
    /** 存储头像 */
    SET_AVATAR(avatar: string) {
      this.avatar = avatar;
    },
    /** 存储用户名 */
    SET_USERNAME(username: string) {
      this.username = username;
    },
    /** 存储昵称 */
    SET_NICKNAME(nickname: string) {
      this.nickname = nickname;
    },
    /** 存储邮箱 */
    SET_EMAIL(email: string) {
      this.email = email;
    },
    /** 存储是否管理员 */
    SET_IS_ADMIN(is_admin: boolean) {
      this.is_admin = is_admin;
    },
    /** 存储是否超级管理员 */
    SET_IS_SUPER_ADMIN(is_super_admin: boolean) {
      this.is_super_admin = is_super_admin;
    },
    /** 存储是否普通成员 */
    SET_IS_MEMBER(is_member: boolean) {
      this.is_member = is_member;
    },
    /** 存储手机号 */
    SET_PHONE(phone: string) {
      this.phone = phone;
    },
    /** 存储状态 */
    SET_STATUS(status: string) {
      this.status = status;
    },
    /** 存储最后登录IP */
    SET_LAST_LOGIN_IP(last_login_ip: string) {
      this.last_login_ip = last_login_ip;
    },
    /** 存储租户ID */
    SET_TENANT(tenant: number) {
      this.tenant = tenant;
    },
    /** 存储父账号ID */
    SET_PARENT(parent: number) {
      this.parent = parent;
    },
    /** 存储角色 */
    SET_ROLES(roles: Array<string>) {
      this.roles = roles;
    },
    /** 存储按钮级别权限 */
    SET_PERMS(permissions: Array<string>) {
      this.permissions = permissions;
    },
    /** 存储是否勾选了登录页的免登录 */
    SET_ISREMEMBERED(bool: boolean) {
      this.isRemembered = bool;
    },
    /** 设置登录页的免登录存储几天 */
    SET_LOGINDAY(value: number) {
      this.loginDay = Number(value);
    },
    /** 登入 */
    async loginByUsername(data) {
      return new Promise<UserResult>((resolve, reject) => {
        getLogin(data)
          .then(data => {
            if (data?.success) {
              // 适配后端返回的数据结构
              const { token, refresh_token, user } = data.data;
              const userData = {
                accessToken: token,
                refreshToken: refresh_token,
                expires: new Date(Date.now() + 24 * 60 * 60 * 1000), // 假设token有效期为24小时
                ...user,
                roles: [user.is_super_admin ? "super" : (user.is_admin ? "admin" : "member")],
                permissions: ["*:*:*"] // 假设拥有所有权限，根据实际情况调整
              };
              setToken(userData);
            }
            resolve(data);
          })
          .catch(error => {
            reject(error);
          });
      });
    },
    /** 前端登出（不调用接口） */
    logOut() {
      this.username = "";
      this.roles = [];
      this.permissions = [];
      removeToken();
      useMultiTagsStoreHook().handleTags("equal", [...routerArrays]);
      resetRouter();
      router.push("/login");
    },
    /** 刷新token */
    async handRefreshToken(data) {
      return new Promise<RefreshTokenResult>((resolve, reject) => {
        refreshTokenApi(data)
          .then(data => {
            if (data?.success) {
              // 适配后端返回的数据结构
              const { token, refresh_token } = data.data;
              const userData = {
                accessToken: token,
                refreshToken: refresh_token,
                expires: new Date(Date.now() + 24 * 60 * 60 * 1000) // 假设token有效期为24小时
              };
              setToken(userData);
              resolve(data);
            }
          })
          .catch(error => {
            reject(error);
          });
      });
    }
  }
});

export function useUserStoreHook() {
  return useUserStore(store);
}
```

### 3.3 修改 `/src/utils/http/index.ts`

```typescript
// 修改请求拦截器和响应拦截器
private httpInterceptorsRequest(): void {
  PureHttp.axiosInstance.interceptors.request.use(
    async (config: PureHttpRequestConfig): Promise<any> => {
      // 开启进度条动画
      NProgress.start();
      // 优先判断post/get等方法是否传入回调，否则执行初始化设置等回调
      if (typeof config.beforeRequestCallback === "function") {
        config.beforeRequestCallback(config);
        return config;
      }
      if (PureHttp.initConfig.beforeRequestCallback) {
        PureHttp.initConfig.beforeRequestCallback(config);
        return config;
      }
      
      // 添加CSRF Token
      const csrfToken = Cookies.get("csrftoken");
      if (csrfToken) {
        config.headers["X-CSRFTOKEN"] = csrfToken;
      }
      
      /** 请求白名单，放置一些不需要token的接口 */
      const whiteList = ["/auth/refresh", "/auth/login"];
      return whiteList.some(url => config.url.endsWith(url))
        ? config
        : new Promise(resolve => {
            const data = getToken();
            if (data) {
              const now = new Date().getTime();
              const expired = parseInt(data.expires) - now <= 0;
              if (expired) {
                if (!PureHttp.isRefreshing) {
                  PureHttp.isRefreshing = true;
                  // token过期刷新
                  useUserStoreHook()
                    .handRefreshToken({ refresh_token: data.refreshToken })
                    .then(res => {
                      const token = res.data.token;
                      config.headers["Authorization"] = formatToken(token);
                      PureHttp.requests.forEach(cb => cb(token));
                      PureHttp.requests = [];
                    })
                    .finally(() => {
                      PureHttp.isRefreshing = false;
                    });
                }
                resolve(PureHttp.retryOriginalRequest(config));
              } else {
                config.headers["Authorization"] = formatToken(
                  data.accessToken
                );
                resolve(config);
              }
            } else {
              resolve(config);
            }
          });
    },
    error => {
      return Promise.reject(error);
    }
  );
}
```

## 4. 登录页面修改

### 4.1 修改 `/src/views/login/index.vue`

```vue
<script setup>
// 修改登录逻辑
const onLogin = async (formEl: FormInstance | undefined) => {
  if (!formEl) return;
  await formEl.validate(valid => {
    if (valid) {
      loading.value = true;
      useUserStoreHook()
        .loginByUsername({
          username: ruleForm.username,
          password: ruleForm.password
        })
        .then(res => {
          if (res.success && res.code === 2000) {
            // 获取后端路由
            return initRouter().then(() => {
              disabled.value = true;
              router
                .push(getTopMenu(true).path)
                .then(() => {
                  message(res.message || t("login.pureLoginSuccess"), { type: "success" });
                })
                .finally(() => (disabled.value = false));
            });
          } else {
            message(res.message || t("login.pureLoginFail"), { type: "error" });
          }
        })
        .finally(() => (loading.value = false));
    }
  });
};
</script>
```

## 5. 权限控制修改

### 5.1 修改 `/src/store/modules/permission.ts`

```typescript
// 根据用户角色生成路由
function generateRoutes(roles: Array<string>, is_admin: boolean, is_super_admin: boolean) {
  // 如果是超级管理员，返回所有路由
  if (is_super_admin) {
    return asyncRoutes;
  }
  
  // 如果是管理员，返回除了超级管理员专属路由外的所有路由
  if (is_admin) {
    return asyncRoutes.filter(route => !route.meta?.super_admin_only);
  }
  
  // 普通成员，只返回有权限的路由
  return filterAsyncRoutes(asyncRoutes, roles);
}
```

## 6. 环境变量配置

### 6.1 创建或修改 `.env` 文件

```
# API基础地址
VITE_API_BASE_URL=http://localhost:8000/api/v1

# 其他环境变量
VITE_PUBLIC_PATH=/
VITE_ROUTER_HISTORY=hash
VITE_HIDE_HOME=false
```

## 7. 其他配置

### 7.1 修改 `/src/utils/http/index.ts` 中的API基础地址

```typescript
// 相关配置请参考：www.axios-js.com/zh-cn/docs/#axios-request-config-1
const defaultConfig: AxiosRequestConfig = {
  // 请求基础地址
  baseURL: import.meta.env.VITE_API_BASE_URL || "",
  // 请求超时时间
  timeout: 10000,
  headers: {
    Accept: "application/json, text/plain, */*",
    "Content-Type": "application/json",
    "X-Requested-With": "XMLHttpRequest"
  },
  // 数组格式参数序列化
  paramsSerializer: {
    serialize: stringify as unknown as CustomParamsSerializer
  }
};
```

## 8. 测试计划

1. 登录功能测试
   - 使用正确的用户名和密码登录
   - 使用错误的用户名和密码登录
   - 验证登录后的用户信息显示

2. 令牌刷新测试
   - 模拟令牌过期场景
   - 验证令牌刷新功能

3. 权限控制测试
   - 测试不同角色用户的路由访问权限
   - 测试按钮级别的权限控制

4. 用户信息显示测试
   - 验证用户信息在界面上的正确显示
   - 验证用户角色和权限的正确应用 