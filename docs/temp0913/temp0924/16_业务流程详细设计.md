# ä¸šåŠ¡æµç¨‹è¯¦ç»†è®¾è®¡

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ¦‚è§ˆ

### ä¸šåŠ¡æµç¨‹åˆ†ç±»
```
ç”¨æˆ·æˆé•¿æµç¨‹               æƒé™ç®¡ç†æµç¨‹              è®¸å¯è¯é›†æˆæµç¨‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ç§¯åˆ†è·å–æµç¨‹            â€¢ æƒé™è®¡ç®—æµç¨‹            â€¢ é…é¢æ£€æŸ¥æµç¨‹
â€¢ ç­‰çº§å‡çº§æµç¨‹            â€¢ æ ‡ç­¾ç®¡ç†æµç¨‹            â€¢ åˆ†é…ç­–ç•¥è°ƒæ•´
â€¢ é™çº§ä¿æŠ¤æµç¨‹            â€¢ æƒé™ç¼“å­˜ç®¡ç†            â€¢ å†å²æ•°æ®è¿ç§»
â€¢ æ ‡ç­¾ç”Ÿå‘½å‘¨æœŸ            â€¢ è·¨ç§Ÿæˆ·æƒé™æ§åˆ¶          â€¢ æŠ¥è¡¨ç»Ÿè®¡åˆ†æ
```

## ğŸ”„ ç§¯åˆ†è·å–ä¸ç®¡ç†æµç¨‹

### 1. ç§¯åˆ†è·å–ä¸šåŠ¡æµç¨‹å›¾

```
ç”¨æˆ·è¡Œä¸ºè§¦å‘
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡Œä¸ºè¯†åˆ«ä¸éªŒè¯  â”‚     â”‚   ç§¯åˆ†è§„åˆ™å¼•æ“   â”‚
â”‚                 â”‚â”€â”€â”€â”€â–¶â”‚                 â”‚
â”‚ â€¢ è¡Œä¸ºç±»å‹åˆ¤æ–­  â”‚     â”‚ â€¢ è§„åˆ™åŒ¹é…      â”‚
â”‚ â€¢ é¢‘ç‡é™åˆ¶æ£€æŸ¥  â”‚     â”‚ â€¢ ç§¯åˆ†è®¡ç®—      â”‚
â”‚ â€¢ æœ‰æ•ˆæ€§éªŒè¯    â”‚     â”‚ â€¢ å¥–åŠ±å€æ•°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â–¼ [éªŒè¯é€šè¿‡]                   â–¼ [è®¡ç®—å®Œæˆ]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§¯åˆ†å‘æ”¾å¤„ç†   â”‚     â”‚   æ•°æ®æŒä¹…åŒ–    â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ åˆ›å»ºç§¯åˆ†è®°å½•  â”‚â”€â”€â”€â”€â–¶â”‚ â€¢ æ›´æ–°ç”¨æˆ·ç§¯åˆ†  â”‚
â”‚ â€¢ æ›´æ–°ç”¨æˆ·ä½™é¢  â”‚     â”‚ â€¢ è®°å½•æ“ä½œæ—¥å¿—  â”‚
â”‚ â€¢ è§¦å‘ç­‰çº§æ£€æŸ¥  â”‚     â”‚ â€¢ ç¼“å­˜æ›´æ–°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç»­å¤„ç†       â”‚     â”‚   é€šçŸ¥æ¨é€      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ ç­‰çº§å˜æ›´æ£€æŸ¥  â”‚     â”‚ â€¢ ç§¯åˆ†åˆ°è´¦é€šçŸ¥  â”‚
â”‚ â€¢ æˆå°±è§£é”      â”‚     â”‚ â€¢ ç­‰çº§å‡çº§é€šçŸ¥  â”‚
â”‚ â€¢ ç»Ÿè®¡æ›´æ–°      â”‚     â”‚ â€¢ æ´»åŠ¨æé†’      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å…·ä½“ç§¯åˆ†è·å–è§„åˆ™å®ç°

#### æ¯æ—¥ç™»å½•ç§¯åˆ†
```
ç™»å½•ç§¯åˆ†ç®—æ³•ï¼š
åŸºç¡€ç§¯åˆ† = 10åˆ†
è¿ç»­ç™»å½•å¥–åŠ± = min(è¿ç»­å¤©æ•° Ã— 2, 50)  // æœ€é«˜50åˆ†å¥–åŠ±
å‘¨æœ«å¥–åŠ± = 5åˆ† (ä»…å‘¨å…­æ—¥)
æ–°ç”¨æˆ·å¥–åŠ± = 20åˆ† (æ³¨å†Œå7å¤©å†…)

æ€»ç§¯åˆ† = åŸºç¡€ç§¯åˆ† + è¿ç»­ç™»å½•å¥–åŠ± + å‘¨æœ«å¥–åŠ± + æ–°ç”¨æˆ·å¥–åŠ±

ç¤ºä¾‹ï¼š
ç”¨æˆ·è¿ç»­ç™»å½•ç¬¬5å¤©ï¼ˆå‘¨æ—¥ï¼‰ä¸”ä¸ºæ–°ç”¨æˆ·ï¼š
10 + (5Ã—2) + 5 + 20 = 45åˆ†
```

#### è®¸å¯è¯ç›¸å…³ç§¯åˆ†
```
è®¸å¯è¯ç§¯åˆ†è§„åˆ™ï¼š

ç”³è¯·è®¸å¯è¯ï¼š
â€¢ é¦–æ¬¡ç”³è¯·: +50åˆ†
â€¢ åç»­ç”³è¯·: +30åˆ†
â€¢ é«˜çº§è®¸å¯è¯: +é¢å¤–20åˆ†

æ¿€æ´»è®¸å¯è¯ï¼š
â€¢ é¦–æ¬¡æ¿€æ´»: +80åˆ†  
â€¢ 7å¤©å†…æ¿€æ´»: +é¢å¤–30åˆ†
â€¢ ä¼ä¸šè®¸å¯è¯æ¿€æ´»: +é¢å¤–50åˆ†

ä½¿ç”¨æ´»è·ƒåº¦ï¼š
â€¢ æ¯æ—¥ä½¿ç”¨: +5åˆ†
â€¢ å‘¨æ´»è·ƒ(ä½¿ç”¨5å¤©ä»¥ä¸Š): +50åˆ†
â€¢ æœˆæ´»è·ƒ(ä½¿ç”¨20å¤©ä»¥ä¸Š): +200åˆ†

è®¸å¯è¯ç»­è´¹ï¼š
â€¢ è‡ªåŠ¨ç»­è´¹: +é‡‘é¢Ã—8åˆ†
â€¢ æ‰‹åŠ¨ç»­è´¹: +é‡‘é¢Ã—5åˆ†
â€¢ æå‰ç»­è´¹(30å¤©å‰): +é¢å¤–100åˆ†
```

#### ç¤¾åŒºè´¡çŒ®ç§¯åˆ†
```
ç¤¾åŒºæ´»åŠ¨ç§¯åˆ†è§„åˆ™ï¼š

å†…å®¹è´¡çŒ®ï¼š
â€¢ å‘å¸ƒæœ‰ç”¨å¸–å­: +50åˆ† (è´¨é‡è¯„åˆ†â‰¥4.0)
â€¢ å›ç­”è¢«é‡‡çº³: +100åˆ†
â€¢ è·å¾—ç‚¹èµ: +5åˆ†/ä¸ª (æ¯æ—¥æœ€å¤š50åˆ†)
â€¢ ç²¾åå¸–è®¤å®š: +300åˆ†

BugæŠ¥å‘Šï¼š
â€¢ æœ‰æ•ˆBug: +200åˆ†
â€¢ ä¸¥é‡Bug: +500åˆ†
â€¢ æä¾›è§£å†³æ–¹æ¡ˆ: +é¢å¤–100åˆ†

äº§å“æ”¹è¿›ï¼š
â€¢ åŠŸèƒ½å»ºè®®è¢«é‡‡çº³: +300åˆ†
â€¢ å‚ä¸Betaæµ‹è¯•: +150åˆ†/æ¬¡
â€¢ æäº¤æœ‰æ•ˆåé¦ˆ: +50åˆ†
```

### 3. ç§¯åˆ†æ¶ˆè´¹æµç¨‹è®¾è®¡

#### ç§¯åˆ†æ¶ˆè´¹ä¸šåŠ¡æµç¨‹

```
ç”¨æˆ·æ¶ˆè´¹è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆè´¹èµ„æ ¼éªŒè¯   â”‚     â”‚   ç§¯åˆ†å……è¶³æ£€æŸ¥   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ ç”¨æˆ·çŠ¶æ€æ­£å¸¸  â”‚â”€â”€â”€â”€â–¶â”‚ â€¢ å¯ç”¨ç§¯åˆ†è®¡ç®—  â”‚
â”‚ â€¢ æ¶ˆè´¹æƒé™ç¡®è®¤  â”‚     â”‚ â€¢ æ¶ˆè´¹æ•°é‡éªŒè¯  â”‚
â”‚ â€¢ æ¶ˆè´¹é¡¹ç›®æœ‰æ•ˆ  â”‚     â”‚ â€¢ é¢„ç•™ç§¯åˆ†æ£€æŸ¥  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â–¼ [éªŒè¯é€šè¿‡]                   â–¼ [ç§¯åˆ†å……è¶³]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§¯åˆ†æ‰£é™¤å¤„ç†   â”‚     â”‚   æ¶ˆè´¹æ‰§è¡Œ      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ åˆ›å»ºæ¶ˆè´¹è®°å½•  â”‚â”€â”€â”€â”€â–¶â”‚ â€¢ æä¾›æ¶ˆè´¹æœåŠ¡  â”‚
â”‚ â€¢ æ›´æ–°ç”¨æˆ·ä½™é¢  â”‚     â”‚ â€¢ æ›´æ–°æœåŠ¡çŠ¶æ€  â”‚
â”‚ â€¢ æ£€æŸ¥ç­‰çº§å˜åŒ–  â”‚     â”‚ â€¢ è®°å½•ä½¿ç”¨æ—¥å¿—  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                             â”‚
    â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç»­å¤„ç†       â”‚     â”‚   ç¡®è®¤é€šçŸ¥      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ ç­‰çº§é‡æ–°è®¡ç®—  â”‚     â”‚ â€¢ æ¶ˆè´¹æˆåŠŸé€šçŸ¥  â”‚
â”‚ â€¢ æƒé™æ›´æ–°      â”‚     â”‚ â€¢ æœåŠ¡ç”Ÿæ•ˆé€šçŸ¥  â”‚
â”‚ â€¢ ç»Ÿè®¡æ•°æ®æ›´æ–°  â”‚     â”‚ â€¢ ä½™é¢å˜åŠ¨æé†’  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## â¬†ï¸ ç­‰çº§å‡çº§ç®¡ç†æµç¨‹

### 1. ç­‰çº§è®¡ç®—ä¸å‡çº§æµç¨‹

```
ç§¯åˆ†å˜åŠ¨è§¦å‘
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­‰çº§é‡æ–°è®¡ç®—   â”‚
â”‚                 â”‚
â”‚ current_points = user.total_points
â”‚ 
â”‚ FOR level IN levels ORDER BY level_order DESC:
â”‚   IF current_points >= level.min_points AND
â”‚      (level.max_points IS NULL OR 
â”‚       current_points <= level.max_points):
â”‚     new_level = level
â”‚     BREAK
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ [è®¡ç®—å®Œæˆ]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­‰çº§å˜æ›´æ£€æµ‹   â”‚ NO  â”‚   æ— éœ€å¤„ç†      â”‚
â”‚                 â”œâ”€â”€â”€â”€â–¶â”‚                 â”‚
â”‚ IF new_level != â”‚     â”‚ â€¢ ä¿æŒç°çŠ¶      â”‚
â”‚    current_levelâ”‚     â”‚ â€¢ è®°å½•æ£€æŸ¥æ—¥å¿—  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ YES
          â–¼ [ç­‰çº§å˜åŒ–]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‡çº§èµ„æ ¼éªŒè¯   â”‚
â”‚                 â”‚
â”‚ â€¢ è´¦æˆ·çŠ¶æ€æ­£å¸¸  â”‚
â”‚ â€¢ æ— è¿è§„è®°å½•    â”‚
â”‚ â€¢ æ»¡è¶³å‰ç½®æ¡ä»¶  â”‚
â”‚ â€¢ é€šè¿‡é£é™©è¯„ä¼°  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ [éªŒè¯é€šè¿‡]
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œç­‰çº§å‡çº§   â”‚â”€â”€â”€â”€â–¶â”‚   å‡çº§å¥–åŠ±å‘æ”¾   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ æ›´æ–°ç”¨æˆ·ç­‰çº§  â”‚     â”‚ â€¢ è®¡ç®—å‡çº§å¥–åŠ±  â”‚
â”‚ â€¢ è®°å½•å‡çº§æ—¶é—´  â”‚     â”‚ â€¢ å‘æ”¾å¥–åŠ±ç§¯åˆ†  â”‚
â”‚ â€¢ æ¸…é™¤æƒé™ç¼“å­˜  â”‚     â”‚ â€¢ è§£é”æ–°åŠŸèƒ½    â”‚
â”‚ â€¢ è§¦å‘å‡çº§äº‹ä»¶  â”‚     â”‚ â€¢ å‘é€å‡çº§ç¤¼å“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æƒé™é‡æ–°è®¡ç®—   â”‚     â”‚   å‡çº§é€šçŸ¥      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ åŠ è½½æ–°ç­‰çº§æƒé™â”‚     â”‚ â€¢ å‡çº§æˆåŠŸé€šçŸ¥  â”‚
â”‚ â€¢ åˆå¹¶æ ‡ç­¾æƒé™  â”‚     â”‚ â€¢ æ–°åŠŸèƒ½ä»‹ç»    â”‚
â”‚ â€¢ æ›´æ–°æƒé™ç¼“å­˜  â”‚     â”‚ â€¢ ç­‰çº§å±•ç¤ºæ›´æ–°  â”‚
â”‚ â€¢ åŒæ­¥åˆ°ç›¸å…³ç³»ç»Ÿâ”‚     â”‚ â€¢ ç¤¾äº¤åˆ†äº«æ¨è  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é™çº§ä¿æŠ¤æœºåˆ¶

#### é™çº§ä¿æŠ¤å†³ç­–æµç¨‹

```
ç§¯åˆ†ä¸‹é™æ£€æµ‹
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é™çº§é£é™©è¯„ä¼°   â”‚
â”‚                 â”‚
â”‚ current_points < current_level.min_points?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ YES [å­˜åœ¨é™çº§é£é™©]
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿æŠ¤ç­–ç•¥åˆ¤æ–­   â”‚     â”‚   ç”¨æˆ·æ ‡ç­¾æ£€æŸ¥   â”‚
â”‚                 â”‚â”€â”€â”€â”€â–¶â”‚                 â”‚
â”‚ â€¢ ç”¨æˆ·ç±»å‹      â”‚     â”‚ â€¢ VIPæ ‡ç­¾ä¿æŠ¤   â”‚
â”‚ â€¢ ä»˜è´¹çŠ¶æ€      â”‚     â”‚ â€¢ ä¼ä¸šç”¨æˆ·ä¿æŠ¤  â”‚
â”‚ â€¢ å†å²è´¡çŒ®      â”‚     â”‚ â€¢ ç‰¹æ®Šèº«ä»½ä¿æŠ¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼“å†²æœŸæœºåˆ¶     â”‚     â”‚   é™çº§æ‰§è¡Œ      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ 30å¤©ä¿æŠ¤æœŸ    â”‚     â”‚ â€¢ æ›´æ–°åˆ°æ–°ç­‰çº§  â”‚
â”‚ â€¢ ç§¯åˆ†æ¢å¤æé†’  â”‚     â”‚ â€¢ è°ƒæ•´æƒé™é…é¢  â”‚
â”‚ â€¢ ä»»åŠ¡æ¨è      â”‚     â”‚ â€¢ å‘é€é™çº§é€šçŸ¥  â”‚
â”‚ â€¢ ä¸“å±æ”¯æŒ      â”‚     â”‚ â€¢ æä¾›æ¢å¤å»ºè®®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…·ä½“ä¿æŠ¤è§„åˆ™

```
é™çº§ä¿æŠ¤ç­‰çº§è¡¨ï¼š

ç”¨æˆ·ç±»å‹          ä¿æŠ¤æœŸ    ä¿æŠ¤æ¡ä»¶                   ç‰¹æ®Šæ”¿ç­–
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ™®é€šç”¨æˆ·         30å¤©     ç§¯åˆ†ä¸è¶³å½“å‰ç­‰çº§è¦æ±‚        æä¾›æ¢å¤ä»»åŠ¡
VIPç”¨æˆ·          90å¤©     VIPæ ‡ç­¾æœ‰æ•ˆæœŸå†…            ä¿æŒVIPæƒé™
ä¼ä¸šç”¨æˆ·         æ°¸ä¹…     ä¼ä¸šè®¤è¯æœ‰æ•ˆæœŸå†…            ä¼ä¸šçº§ä¿æŠ¤
æ•™è‚²ç”¨æˆ·         180å¤©    å­¦æœŸå†…                     æ•™è‚²ä¼˜æƒ ä¿æŠ¤
å¼€å‘è€…           60å¤©     æŠ€æœ¯è´¡çŒ®è®°å½•è‰¯å¥½            ç¤¾åŒºè´¡çŒ®ä¿æŠ¤

ä¿æŠ¤æœŸå†…ç”¨æˆ·ä½“éªŒï¼š
â€¢ ä¿æŒå½“å‰ç­‰çº§çš„æ‰€æœ‰æƒé™
â€¢ æ¯å‘¨å‘é€ç§¯åˆ†æ¢å¤æé†’
â€¢ æä¾›ä¸“å±çš„ç§¯åˆ†è·å–ä»»åŠ¡
â€¢ ä¼˜å…ˆå®¢æœæ”¯æŒå’ŒæŒ‡å¯¼
â€¢ ç¤¾åŒºå¯¼å¸ˆé…å¯¹æ”¯æŒ
```

## ğŸ” æƒé™è®¡ç®—ä¸ç®¡ç†æµç¨‹

### 1. ç”¨æˆ·æƒé™å®æ—¶è®¡ç®—æµç¨‹

```
æƒé™æŸ¥è¯¢è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼“å­˜æ£€æŸ¥       â”‚ HIT â”‚   è¿”å›ç¼“å­˜æƒé™   â”‚
â”‚                 â”œâ”€â”€â”€â”€â–¶â”‚                 â”‚
â”‚ cache_key =     â”‚     â”‚ â€¢ æƒé™é…ç½®      â”‚
â”‚ "perms:{user_id}"â”‚     â”‚ â€¢ é…é¢ä¿¡æ¯      â”‚
â”‚ TTL: 30åˆ†é’Ÿ     â”‚     â”‚ â€¢ ç¼“å­˜æ—¶é—´æˆ³    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ MISS
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸºç¡€æ•°æ®åŠ è½½   â”‚â”€â”€â”€â”€â–¶â”‚   ç­‰çº§æƒé™è®¡ç®—   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ ç”¨æˆ·ç§¯åˆ†      â”‚     â”‚ â€¢ æ ¹æ®ç§¯åˆ†ç¡®å®šç­‰çº§â”‚
â”‚ â€¢ å½“å‰ç­‰çº§      â”‚     â”‚ â€¢ åŠ è½½ç­‰çº§åŸºç¡€æƒé™â”‚
â”‚ â€¢ æ´»è·ƒæ ‡ç­¾åˆ—è¡¨  â”‚     â”‚ â€¢ è®¡ç®—åŸºç¡€é…é¢    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ‡ç­¾æƒé™å åŠ    â”‚â”€â”€â”€â”€â–¶â”‚   æœ€ç»ˆæƒé™åˆæˆ   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ FOR tag IN tags:â”‚     â”‚ â€¢ æƒé™åˆå¹¶ç®—æ³•  â”‚
â”‚   perms += tag. â”‚     â”‚ â€¢ é…é¢å€æ•°è®¡ç®—  â”‚
â”‚   permissions   â”‚     â”‚ â€¢ ç‰¹æ®Šè§„åˆ™å¤„ç†  â”‚
â”‚   quota *= tag. â”‚     â”‚ â€¢ ç»“æœéªŒè¯      â”‚
â”‚   multiplier    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
          â”‚                       â–¼
          â–¼                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   ç¼“å­˜æ›´æ–°      â”‚
â”‚  æƒé™éªŒè¯       â”‚       â”‚                 â”‚
â”‚                 â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ å†™å…¥Redisç¼“å­˜ â”‚
â”‚ â€¢ æƒé™æœ‰æ•ˆæ€§    â”‚       â”‚ â€¢ è®¾ç½®è¿‡æœŸæ—¶é—´  â”‚
â”‚ â€¢ é…é¢åˆç†æ€§    â”‚       â”‚ â€¢ è®°å½•è®¡ç®—æ—¥å¿—  â”‚
â”‚ â€¢ ä¸šåŠ¡è§„åˆ™æ£€æŸ¥  â”‚       â”‚ â€¢ è¿”å›æœ€ç»ˆç»“æœ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æƒé™åˆå¹¶ç®—æ³•è¯¦è§£

#### æƒé™åˆå¹¶ä¼ªä»£ç 
```python
def merge_permissions(base_permissions, tag_permissions_list):
    """
    æƒé™åˆå¹¶ç®—æ³•
    - å¸ƒå°”ç±»å‹æƒé™ï¼šORè¿ç®—ï¼ˆä»»ä¸€ä¸ºtrueåˆ™ä¸ºtrueï¼‰
    - æ•°å€¼ç±»å‹æƒé™ï¼šå–æœ€å¤§å€¼
    - å­—ç¬¦ä¸²ç±»å‹æƒé™ï¼šæŒ‰ä¼˜å…ˆçº§å–å€¼
    - å¯¹è±¡ç±»å‹æƒé™ï¼šé€’å½’åˆå¹¶
    """
    final_permissions = base_permissions.copy()
    
    for tag_perms in tag_permissions_list:
        for key, value in tag_perms.items():
            if key not in final_permissions:
                final_permissions[key] = value
            else:
                current_value = final_permissions[key]
                
                if isinstance(value, bool) and isinstance(current_value, bool):
                    # å¸ƒå°”æƒé™ï¼šORè¿ç®—
                    final_permissions[key] = current_value or value
                
                elif isinstance(value, (int, float)) and isinstance(current_value, (int, float)):
                    # æ•°å€¼æƒé™ï¼šå–æœ€å¤§å€¼
                    final_permissions[key] = max(current_value, value)
                
                elif isinstance(value, str) and isinstance(current_value, str):
                    # å­—ç¬¦ä¸²æƒé™ï¼šæŒ‰ä¼˜å…ˆçº§
                    priority_map = {"basic": 1, "standard": 2, "premium": 3, "unlimited": 4}
                    if priority_map.get(value, 0) > priority_map.get(current_value, 0):
                        final_permissions[key] = value
                
                elif isinstance(value, dict) and isinstance(current_value, dict):
                    # å¯¹è±¡æƒé™ï¼šé€’å½’åˆå¹¶
                    final_permissions[key] = merge_permissions(current_value, [value])
    
    return final_permissions

def calculate_quota_multiplier(tag_quota_modifiers_list):
    """é…é¢å€æ•°è®¡ç®—"""
    total_multiplier = 1.0
    
    for tag_quota in tag_quota_modifiers_list:
        multiplier = tag_quota.get('license_multiplier', 1.0)
        total_multiplier *= multiplier
    
    # è®¾ç½®åˆç†ä¸Šé™ï¼Œé¿å…æ— é™åˆ¶é…é¢
    return min(total_multiplier, 10.0)
```

### 3. æ ‡ç­¾ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### æ ‡ç­¾æˆäºˆæµç¨‹
```
æ ‡ç­¾æˆäºˆè¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆäºˆæ¡ä»¶éªŒè¯   â”‚     â”‚   ç”¨æˆ·èµ„æ ¼æ£€æŸ¥   â”‚
â”‚                 â”‚â”€â”€â”€â”€â–¶â”‚                 â”‚
â”‚ â€¢ æ ‡ç­¾æœ‰æ•ˆæ€§    â”‚     â”‚ â€¢ ç”¨æˆ·çŠ¶æ€æ­£å¸¸  â”‚
â”‚ â€¢ æˆäºˆæƒé™      â”‚     â”‚ â€¢ æ— å†²çªæ ‡ç­¾    â”‚
â”‚ â€¢ ä¸šåŠ¡è§„åˆ™      â”‚     â”‚ â€¢ æ»¡è¶³å‰ç½®æ¡ä»¶  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼ [éªŒè¯é€šè¿‡]              â–¼ [èµ„æ ¼ç¡®è®¤]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ‡ç­¾è®°å½•åˆ›å»º   â”‚â”€â”€â”€â”€â–¶â”‚   æƒé™ç”Ÿæ•ˆå¤„ç†   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ åˆ›å»ºå…³è”è®°å½•  â”‚     â”‚ â€¢ æ¸…é™¤æƒé™ç¼“å­˜  â”‚
â”‚ â€¢ è®¾ç½®æœ‰æ•ˆæœŸ    â”‚     â”‚ â€¢ é‡æ–°è®¡ç®—æƒé™  â”‚
â”‚ â€¢ è®°å½•æˆäºˆä¿¡æ¯  â”‚     â”‚ â€¢ åŒæ­¥åˆ°ä¸šåŠ¡ç³»ç»Ÿâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç»­å¤„ç†       â”‚     â”‚   æˆäºˆé€šçŸ¥      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ ç§¯åˆ†å¥–åŠ±      â”‚     â”‚ â€¢ æ ‡ç­¾è·å¾—é€šçŸ¥  â”‚
â”‚ â€¢ æˆå°±è§£é”      â”‚     â”‚ â€¢ åŠŸèƒ½ä»‹ç»æŒ‡å—  â”‚
â”‚ â€¢ ç»Ÿè®¡æ›´æ–°      â”‚     â”‚ â€¢ ä¸“å±æƒç›Šè¯´æ˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ‡ç­¾è¿‡æœŸå¤„ç†
```
å®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ£€æŸ¥æ ‡ç­¾è¿‡æœŸ

æ£€æŸ¥è¿‡æœŸæ ‡ç­¾
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿‡æœŸæ ‡ç­¾è¯†åˆ«   â”‚â”€â”€â”€â”€â–¶â”‚   è¿‡æœŸå‰æé†’     â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ SELECT * FROM   â”‚     â”‚ â€¢ 7å¤©å‰æé†’     â”‚
â”‚ member_type_tag â”‚     â”‚ â€¢ 1å¤©å‰æé†’     â”‚
â”‚ WHERE expires_atâ”‚     â”‚ â€¢ å³å°†è¿‡æœŸæé†’  â”‚
â”‚ BETWEEN NOW()   â”‚     â”‚ â€¢ ç»­è´¹å¼•å¯¼      â”‚
â”‚ AND NOW()+7DAYS â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ [æ ‡ç­¾å·²è¿‡æœŸ]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ‡ç­¾å¤±æ•ˆå¤„ç†   â”‚â”€â”€â”€â”€â–¶â”‚   æƒé™è°ƒæ•´      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ æ›´æ–°çŠ¶æ€expiredâ”‚     â”‚ â€¢ æ¸…é™¤æƒé™ç¼“å­˜  â”‚
â”‚ â€¢ è®°å½•è¿‡æœŸæ—¶é—´  â”‚     â”‚ â€¢ é‡æ–°è®¡ç®—æƒé™  â”‚
â”‚ â€¢ ä¿ç•™å†å²è®°å½•  â”‚     â”‚ â€¢ é™çº§ä¿æŠ¤æ£€æŸ¥  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿‡æœŸé€šçŸ¥       â”‚     â”‚   æŒ½å›ç­–ç•¥      â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ è¿‡æœŸæé†’é€šçŸ¥  â”‚     â”‚ â€¢ ç»­è´¹ä¼˜æƒ æ¨é€  â”‚
â”‚ â€¢ æƒé™å˜æ›´è¯´æ˜  â”‚     â”‚ â€¢ æ¢å¤æ–¹æ¡ˆå»ºè®®  â”‚
â”‚ â€¢ å½±å“åŠŸèƒ½åˆ—è¡¨  â”‚     â”‚ â€¢ å®¢æœä¸»åŠ¨è”ç³»  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— è®¸å¯è¯ç³»ç»Ÿé›†æˆæµç¨‹

### 1. è®¸å¯è¯ç”³è¯·é›†æˆæ–°æµç¨‹

```
ç”¨æˆ·ç”³è¯·è®¸å¯è¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æƒé™æŸ¥è¯¢   â”‚â”€â”€â”€â”€â–¶â”‚   ç”¨æˆ·ç­‰çº§æƒé™   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ user_permissionsâ”‚     â”‚ â€¢ åŸºç¡€ç­‰çº§é…é¢  â”‚
â”‚ = calculate_    â”‚     â”‚ â€¢ æ ‡ç­¾æƒé™åŠ æˆ  â”‚
â”‚ permissions(    â”‚     â”‚ â€¢ ç‰¹æ®Šæƒé™å¤„ç†  â”‚
â”‚ user_id)        â”‚     â”‚ â€¢ æœ€ç»ˆé…é¢è®¡ç®—  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤šå±‚é…é¢æ£€æŸ¥   â”‚     â”‚   ç”¨æˆ·é…é¢æ£€æŸ¥   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ 1. ç”¨æˆ·ç­‰çº§é…é¢ â”‚â”€â”€â”€â”€â–¶â”‚ current_licensesâ”‚
â”‚ 2. Licenseé…é¢  â”‚     â”‚ <= user_quota.  â”‚
â”‚ 3. ç§Ÿæˆ·æ€»é…é¢   â”‚     â”‚ max_licenses?   â”‚
â”‚ 4. äº§å“ç‰¹æ®Šé…é¢ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ [é…é¢å……è¶³]
          â”‚                       â–¼
          â–¼ [æ‰€æœ‰æ£€æŸ¥é€šè¿‡]  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   åˆ†é…æ‰§è¡Œ      â”‚
â”‚  åˆ›å»ºåˆ†é…è®°å½•   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
â”‚                 â”‚       â”‚ â€¢ åˆ›å»ºassignmentâ”‚
â”‚ â€¢ LicenseAssign-â”‚       â”‚ â€¢ æ›´æ–°Licenseè®¡æ•°â”‚
â”‚   mentè®°å½•      â”‚       â”‚ â€¢ ç§¯åˆ†å¥–åŠ±å‘æ”¾  â”‚
â”‚ â€¢ ç§¯åˆ†å¥–åŠ±è®¡ç®—  â”‚       â”‚ â€¢ æˆå°±æ£€æŸ¥      â”‚
â”‚ â€¢ ç»Ÿè®¡æ•°æ®æ›´æ–°  â”‚       â”‚ â€¢ é€šçŸ¥æ¨é€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é…é¢æ£€æŸ¥è¯¦ç»†ç®—æ³•

```python
def check_license_quota(user_id, license_id, request_count=1):
    """
    å¤šå±‚é…é¢æ£€æŸ¥ç®—æ³•
    """
    # 1. è·å–ç”¨æˆ·æƒé™é…ç½®
    user_perms = calculate_user_permissions(user_id)
    user_quota = user_perms['quota']
    
    # 2. æ£€æŸ¥ç”¨æˆ·ç­‰çº§é…é¢
    current_user_licenses = count_user_licenses(user_id, status=['assigned', 'active'])
    max_user_licenses = user_quota.get('max_licenses', 0)
    
    if current_user_licenses + request_count > max_user_licenses:
        return {
            'allowed': False,
            'reason': 'USER_QUOTA_EXCEEDED',
            'details': {
                'current': current_user_licenses,
                'max': max_user_licenses,
                'requested': request_count
            }
        }
    
    # 3. æ£€æŸ¥Licenseé…é¢
    license_info = get_license_info(license_id)
    if license_info.current_activations + request_count > license_info.max_activations:
        return {
            'allowed': False,
            'reason': 'LICENSE_QUOTA_EXCEEDED',
            'details': {
                'current': license_info.current_activations,
                'max': license_info.max_activations,
                'requested': request_count
            }
        }
    
    # 4. æ£€æŸ¥ç§Ÿæˆ·é…é¢
    tenant_quota = get_tenant_quota(user_id)
    current_tenant_licenses = count_tenant_licenses(get_user_tenant(user_id))
    
    if current_tenant_licenses + request_count > tenant_quota.max_licenses:
        return {
            'allowed': False,
            'reason': 'TENANT_QUOTA_EXCEEDED',
            'details': {
                'current': current_tenant_licenses,
                'max': tenant_quota.max_licenses,
                'requested': request_count
            }
        }
    
    # 5. æ£€æŸ¥äº§å“ç‰¹æ®Šé™åˆ¶
    product_limits = get_product_limits(license_info.product_id, user_perms['level'])
    if not check_product_access(user_perms, product_limits):
        return {
            'allowed': False,
            'reason': 'PRODUCT_ACCESS_DENIED',
            'details': {
                'required_level': product_limits.min_level,
                'user_level': user_perms['level']
            }
        }
    
    return {
        'allowed': True,
        'quota_info': {
            'user_quota': {'current': current_user_licenses, 'max': max_user_licenses},
            'license_quota': {'current': license_info.current_activations, 'max': license_info.max_activations},
            'tenant_quota': {'current': current_tenant_licenses, 'max': tenant_quota.max_licenses}
        }
    }
```

## ğŸ“Š æ•°æ®åŒæ­¥ä¸ä¸€è‡´æ€§ä¿éšœ

### 1. ç§¯åˆ†æ•°æ®ä¸€è‡´æ€§ä¿éšœ

```
ç§¯åˆ†æ›´æ–°äº‹åŠ¡æµç¨‹ï¼š

BEGIN TRANSACTION;

1. æ£€æŸ¥ç”¨æˆ·è´¦æˆ·çŠ¶æ€
   IF user.is_deleted OR user.status != 'active':
     ROLLBACK; RETURN error;

2. éªŒè¯ç§¯åˆ†æ“ä½œåˆæ³•æ€§
   IF point_change < 0 AND user.available_points < ABS(point_change):
     ROLLBACK; RETURN insufficient_points;

3. åˆ›å»ºç§¯åˆ†è®°å½•
   INSERT INTO user_points (member_id, points, balance_before, balance_after, ...);

4. æ›´æ–°ç”¨æˆ·ç§¯åˆ†ä½™é¢
   UPDATE member SET 
     total_points = total_points + point_change,
     available_points = calculate_available_points(member_id),
     last_points_update = NOW()
   WHERE id = member_id;

5. æ£€æŸ¥ç­‰çº§å˜åŒ–
   new_level = calculate_user_level(total_points);
   IF new_level != current_level:
     UPDATE member SET current_level_id = new_level.id, level_updated_at = NOW();
     INSERT INTO level_change_log (...);

6. æ¸…é™¤ç›¸å…³ç¼“å­˜
   DELETE FROM cache WHERE key IN ('perms:' || member_id, 'level:' || member_id);

COMMIT;

-- å¼‚æ­¥åç»­å¤„ç†
NOTIFY 'points_changed', json_build_object('member_id', member_id, 'points', point_change);
```

### 2. æƒé™ç¼“å­˜åŒæ­¥ç­–ç•¥

```
ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼š

1. å†™æ—¶å¤±æ•ˆ (Write-Through)
   ç”¨æˆ·ç­‰çº§/æ ‡ç­¾å˜æ›´æ—¶ â†’ ç«‹å³æ¸…é™¤æƒé™ç¼“å­˜ â†’ ä¸‹æ¬¡è®¿é—®æ—¶é‡æ–°è®¡ç®—

2. å®šæ—¶åˆ·æ–° (Time-Based)
   æ¯30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ â†’ é˜²æ­¢é•¿æœŸç¼“å­˜ä¸ä¸€è‡´

3. äº‹ä»¶é©±åŠ¨æ›´æ–° (Event-Driven)
   ç­‰çº§å‡çº§äº‹ä»¶ â†’ æƒé™ç¼“å­˜æ›´æ–°
   æ ‡ç­¾å˜æ›´äº‹ä»¶ â†’ æƒé™ç¼“å­˜æ›´æ–°
   ç³»ç»Ÿé…ç½®å˜æ›´ â†’ æ‰¹é‡æ¸…é™¤ç¼“å­˜

4. ä¸€è‡´æ€§æ£€æŸ¥ (Consistency Check)
   æ¯æ—¥å‡Œæ™¨ â†’ æ‰¹é‡éªŒè¯ç¼“å­˜ä¸€è‡´æ€§
   å‘ç°ä¸ä¸€è‡´ â†’ è‡ªåŠ¨ä¿®å¤ + å‘Šè­¦é€šçŸ¥
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹[æŠ€æœ¯å®ç°æŒ‡å—](17_æŠ€æœ¯å®ç°æŒ‡å—.md)äº†è§£å…·ä½“çš„ä»£ç å®ç°æ–¹æ¡ˆ
