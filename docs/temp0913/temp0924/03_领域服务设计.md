# 多租户积分系统领域服务设计

## 🎯 设计原则

### 多租户隔离
- **租户数据隔离**: 每个服务都确保租户间数据完全隔离
- **租户权限隔离**: 权限计算和检查按租户独立进行
- **租户配置隔离**: 支持不同租户的独立积分政策和标签配置

### 统一权限体系
- **积分驱动**: 所有权限计算基于统一的积分等级体系
- **标签增强**: 通过标签提供额外的权限加成
- **动态配置**: 支持积分规则和权限配置的动态调整

### 职责分离
- **单一职责**: 每个领域服务只负责一个特定的业务领域
- **无状态设计**: 服务本身不保存状态，所有状态都在数据模型中
- **纯函数设计**: 相同输入产生相同输出，便于测试和理解

## 🏗️ 多租户积分系统服务架构图

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                 多租户积分领域服务层                      │
                    └─────────────────────────────────────────────────────────┘
                                            │
                ┌───────────────────────────┼───────────────────────────┐
                │                           │                           │
    ┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
    │  积分引擎服务   │        │租户权限计算服务 │        │  VIP期限服务    │
    │                 │        │                 │        │                 │
    │• 积分获取规则   │        │• 多租户权限计算 │        │• VIP状态管理    │
    │• 积分消费处理   │        │• 等级权限合并   │        │• 宽限期处理     │
    │• 积分过期管理   │        │• 标签权限叠加   │        │• 自动续期       │
    │• 等级升级检查   │        │• 缓存管理       │        │• 期限提醒       │
    └─────────────────┘        └─────────────────┘        └─────────────────┘
                │                           │                           │
                └───────────────────────────┼───────────────────────────┘
                                            │
                ┌───────────────────────────┼───────────────────────────┐
                │                           │                           │
    ┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
    │许可证分配服务   │        │  标签管理服务   │        │  审计服务       │
    │(集成新权限检查) │        │                 │        │                 │
    │• 多层配额检查   │        │• 标签授予       │        │• 积分变动记录   │
    │• 分配后积分奖励 │        │• 标签过期       │        │• 等级变更记录   │
    │• 租户隔离验证   │        │• 标签续期       │        │• 权限操作审计   │
    └─────────────────┘        └─────────────────┘        └─────────────────┘
```

## 🔧 核心领域服务详细设计

### 1. 许可证分配核心服务 (TenantAwareLicenseAssignmentService)

#### 职责范围
- 处理许可证与用户的分配逻辑，集成多租户权限检查
- 在分配前检查用户在特定租户下的积分等级和配额限制
- 分配成功后触发积分奖励机制
- 管理分配状态的生命周期
- 控制分配配额和限制
- 验证分配的业务规则

#### 核心方法设计

##### assign_license_to_member()
**功能**: 将许可证分配给指定成员（集成多租户权限检查）
**输入参数**:
- member_id: 成员ID
- license_id: 许可证ID
- tenant_id: 租户ID
- assignment_type: 分配类型 (默认'user_request')

**业务规则**:
1. 验证成员和许可证都存在且属于同一租户
2. **新增**: 通过TenantUserProfile检查用户在该租户下的权限配额
3. **新增**: 检查用户等级配额 (基础等级配额 × 标签倍数)
4. 检查License表的剩余配额 (max_activations - current_activations)
5. 创建LicenseAssignment记录，自动递增License.current_activations
6. **新增**: 触发积分奖励机制
7. 记录分配操作的审计日志

---

**重要说明**: 本文档展示了LicenseAssignment与新的多租户积分系统的集成方式。完整的积分系统设计请参考：
- [多租户积分设计修正](19_多租户积分设计修正.md) - 核心设计方案
- [数据模型详细设计](15_数据模型详细设计.md) - 完整数据结构
- [技术实现指南](17_技术实现指南.md) - 具体代码实现

##### assign_license_to_member()
**功能**: 将许可证分配给指定成员
**输入参数**:
- license_id: 许可证ID
- member_id: 成员ID  
- assignment_type: 分配类型 (默认'user_request')
- expires_days: 有效天数 (可选，覆盖License默认期限)
- reason: 申请原因 (可选)
- notes: 备注信息 (可选)

**业务规则**:
1. 验证许可证和成员都存在且属于同一租户
2. 检查许可证剩余配额是否足够 (License.max_activations - current_activations)
3. 验证成员是否已经拥有该许可证
4. 支持用户自主申请，无需验证操作人员权限
5. 自动递增License.current_activations计数
6. 记录分配操作的审计日志

**返回结果**:
- 操作成功/失败状态
- 分配记录ID (成功时)
- 详细的错误信息 (失败时)

##### revoke_license_from_member()
**功能**: 撤销用户的许可证分配
**输入参数**:
- assignment_id: 分配记录ID
- reason: 撤销原因

**业务规则**:
1. 验证分配记录存在且可撤销
2. 处理关联的设备绑定清理
3. 自动递减License.current_activations计数
4. 释放许可证配额供其他用户使用
5. 记录撤销操作的审计日志

##### activate_assignment()
**功能**: 激活许可证分配 (首次使用时)
**输入参数**:
- assignment_id: 分配记录ID
- device_info: 设备信息
- activation_context: 激活上下文

**业务规则**:
1. 验证分配记录状态允许激活
2. 检查设备数量限制
3. 生成设备绑定记录
4. 更新分配状态为active
5. 记录激活时间和设备信息

##### check_assignment_quota()
**功能**: 检查许可证分配配额
**输入参数**:
- license_id: 许可证ID
- requested_count: 请求分配数量 (默认1)

**业务规则**:
1. 从License表读取max_activations和current_activations
2. 计算可用配额: max_activations - current_activations
3. 验证请求数量不超过可用配额
4. 考虑即将过期的分配可能释放的配额
5. 返回详细的配额信息

### 2. 权限验证服务 (PermissionValidationService)

#### 职责范围
- 验证用户对许可证的访问权限
- 检查租户级别的数据隔离
- 管理操作权限的层级控制

#### 核心方法设计

##### can_assign_license()
**功能**: 检查是否可以进行许可证分配操作
**输入参数**:
- operator_id: 操作人员ID
- license_id: 许可证ID
- member_id: 目标成员ID

**验证规则**:
1. 操作人员必须是管理员或有相应权限
2. 许可证和成员必须属于操作人员可管理的租户
3. 许可证状态必须允许分配
4. 成员状态必须允许接受分配

##### can_access_assignment()
**功能**: 检查是否可以访问特定的分配记录
**输入参数**:
- user_id: 请求用户ID
- assignment_id: 分配记录ID
- operation_type: 操作类型 (read/update/delete)

**验证规则**:
1. 租户管理员只能访问本租户的记录
2. 普通成员只能访问自己的分配记录  
3. 不同操作类型需要不同级别的权限
4. 严格禁止任何跨租户访问

##### validate_tenant_isolation()
**功能**: 验证跨租户访问的安全性
**输入参数**:
- user_tenant_id: 用户所属租户ID
- resource_tenant_id: 资源所属租户ID
- user_role: 用户角色

**验证规则**:
1. 同租户内的访问根据用户权限允许
2. 严格禁止任何跨租户访问
3. 记录所有跨租户访问尝试并拒绝
4. 租户间完全隔离，无权限委托

### 3. 审计日志服务 (AuditLogService)

#### 职责范围
- 记录所有许可证分配相关的操作
- 提供详细的操作追踪信息
- 支持合规性审计需求

#### 核心方法设计

##### log_assignment_operation()
**功能**: 记录许可证分配操作日志
**输入参数**:
- operation_type: 操作类型
- operator_id: 操作人员ID
- assignment_id: 分配记录ID
- details: 操作详细信息
- ip_address: 操作IP地址

**记录内容**:
1. 操作时间戳
2. 操作人员信息
3. 受影响的资源信息
4. 操作前后的状态变化
5. 操作结果和错误信息

##### log_security_event()
**功能**: 记录安全相关事件
**输入参数**:
- event_type: 事件类型
- severity: 严重程度
- user_id: 相关用户ID
- details: 事件详细信息

**安全事件类型**:
- 未授权访问尝试
- 权限提升尝试
- 异常操作模式
- 系统配置变更

### 4. 使用追踪服务 (UsageTrackingService)

#### 职责范围
- 追踪许可证的实际使用情况
- 管理设备绑定和并发控制
- 提供使用统计和分析数据

#### 核心方法设计

##### track_license_usage()
**功能**: 记录许可证使用事件
**输入参数**:
- assignment_id: 分配记录ID
- device_id: 设备标识
- usage_type: 使用类型
- session_info: 会话信息

**追踪内容**:
1. 使用开始和结束时间
2. 设备和网络信息
3. 软件版本和功能使用
4. 异常和错误情况

##### manage_device_binding()
**功能**: 管理设备绑定关系
**输入参数**:
- assignment_id: 分配记录ID
- device_info: 设备信息
- operation: 操作类型 (bind/unbind/update)

**管理规则**:
1. 验证设备数量限制
2. 检查设备指纹合法性
3. 处理设备更换情况
4. 维护设备使用历史

## 🔄 服务间协作模式

### 典型协作流程

#### 许可证分配流程
```
1. PermissionValidationService.can_assign_license()
   ↓ [权限验证通过]
2. LicenseAssignmentDomainService.check_assignment_quota()
   ↓ [配额检查通过]
3. LicenseAssignmentDomainService.assign_license_to_member()
   ↓ [分配操作执行]
4. AuditLogService.log_assignment_operation()
   ↓ [记录操作日志]
5. [返回分配结果]
```

#### 许可证激活流程
```
1. PermissionValidationService.can_access_assignment()
   ↓ [访问权限验证]
2. LicenseAssignmentDomainService.activate_assignment()
   ↓ [激活分配记录]
3. UsageTrackingService.manage_device_binding()
   ↓ [绑定设备]
4. UsageTrackingService.track_license_usage()
   ↓ [记录使用开始]
5. AuditLogService.log_assignment_operation()
   ↓ [记录激活日志]
```

### 错误处理策略

#### 分层错误处理
- **验证错误**: 参数验证失败，返回明确的错误信息
- **业务错误**: 业务规则违反，返回业务相关的错误码
- **系统错误**: 系统异常，记录详细日志并返回通用错误信息
- **安全错误**: 安全相关错误，记录安全日志并限制详细信息暴露

#### 补偿机制
- **事务回滚**: 数据库事务失败时的自动回滚
- **状态恢复**: 关键操作失败时的状态恢复机制
- **重试机制**: 临时性错误的自动重试
- **手动干预**: 需要人工介入的异常情况处理

## 📊 性能优化策略

### 缓存策略
- **权限缓存**: 缓存用户权限信息，减少重复查询
- **配额缓存**: 缓存许可证配额信息，提高分配效率
- **统计缓存**: 缓存常用的统计数据，减少计算开销

### 批量操作
- **批量分配**: 支持一次操作分配多个许可证
- **批量撤销**: 支持批量撤销操作
- **批量状态更新**: 定期批量更新过期状态

### 异步处理
- **日志记录**: 审计日志异步写入，不影响主流程
- **通知发送**: 状态变更通知异步处理
- **统计计算**: 复杂统计计算后台异步执行

---

**下一步**: 查看[应用服务设计](04_应用服务设计.md)了解如何协调多个领域服务
