# é¢†åŸŸæ¨¡å‹è®¾è®¡

## ğŸ¯ è®¾è®¡åŸåˆ™

### ğŸ”’ ç°æœ‰ä»£ç æ¨¡å‹åˆ†æç»“æœ
ç»è¿‡æ·±åº¦åˆ†æç°æœ‰ä»£ç åº“ï¼ˆ`users/models.py`, `licenses/models.py`, `tenants/models.py`ï¼‰ç¡®è®¤ï¼š

**âœ… ç°æœ‰åŸå­æ¨¡å‹ï¼ˆé›¶ä¿®æ”¹ï¼‰**:
- **Memberæ¨¡å‹** - ç°æœ‰ä»£ç ä¸­å®Œå…¨åŸå­ï¼Œæ— ç§¯åˆ†å­—æ®µï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹
- **Licenseæ¨¡å‹** - ç°æœ‰ä»£ç ä¸­å®Œå…¨åŸå­ï¼Œå·²åŒ…å«`max_activations`å’Œ`current_activations`å­—æ®µ
- **Tenantæ¨¡å‹** - ç°æœ‰ç§Ÿæˆ·ç³»ç»Ÿä¿æŒä¸å˜

**âœ… æ–°å¢æ¨¡å‹ï¼ˆå…¨æ–°ä»£ç ï¼‰**:
- **LicenseAssignmentæ¨¡å‹** - åœ¨ç°æœ‰ä»£ç ä¸­**å®Œå…¨ä¸å­˜åœ¨**ï¼Œæ˜¯å…¨æ–°æ¨¡å‹
- **ç§¯åˆ†ç³»ç»Ÿç›¸å…³æ¨¡å‹** - åœ¨ç°æœ‰ä»£ç ä¸­**å®Œå…¨ä¸å­˜åœ¨**ï¼Œéƒ½æ˜¯å…¨æ–°æ¨¡å‹

**âœ… è®¾è®¡åŸåˆ™éªŒè¯**:
- æ‰€æœ‰ç°æœ‰ä»£ç æ¨¡å‹ä¿æŒå®Œå…¨åŸå­æ€§å’Œä¸å˜æ€§
- æ‰€æœ‰æ–°åŠŸèƒ½é€šè¿‡æ–°å¢æ¨¡å‹å®ç°ï¼Œä¸ç°æœ‰ä»£ç é›¶å†²çª
- ä¸šåŠ¡é€»è¾‘å®Œå…¨é€šè¿‡æ–°çš„æœåŠ¡å±‚å®ç°ï¼Œä¸ä¿®æ”¹ç°æœ‰ä¸šåŠ¡é€»è¾‘

### å¤šç§Ÿæˆ·ç§¯åˆ†é›†æˆ
- **LicenseAssignment**é›†æˆæ–°çš„å¤šç§Ÿæˆ·æƒé™è®¡ç®—æœºåˆ¶
- åˆ†é…å‰æ£€æŸ¥ç”¨æˆ·åœ¨ç§Ÿæˆ·ä¸‹çš„ç­‰çº§å’Œé…é¢é™åˆ¶
- æ”¯æŒåŸºäºç§¯åˆ†ç­‰çº§çš„åŠ¨æ€é…é¢åˆ†é…
- ä¸**TenantUserProfile**åä½œï¼Œå®ç°ç§Ÿæˆ·éš”ç¦»çš„è®¸å¯è¯ç®¡ç†

### æ•°æ®ä¸€è‡´æ€§
- é€šè¿‡æ•°æ®åº“çº¦æŸä¿è¯å¼•ç”¨å®Œæ•´æ€§
- é€šè¿‡é¢†åŸŸæœåŠ¡ä¿è¯ä¸šåŠ¡è§„åˆ™ä¸€è‡´æ€§
- æ”¯æŒäº‹åŠ¡æ€§æ“ä½œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- ç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»ï¼Œé¿å…è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²

## ğŸ“Š æ•°æ®æ¨¡å‹å…³ç³»å›¾

### è®¸å¯è¯åˆ†é…ä¸å¤šç§Ÿæˆ·ç§¯åˆ†ç³»ç»Ÿé›†æˆ

```
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚     Tenant      â”‚         â”‚   SoftwareProductâ”‚
                 â”‚                 â”‚         â”‚                 â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                           â”‚
                           â”‚ 1:N                       â”‚ 1:N
                           â–¼                           â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚     Member      â”‚         â”‚     License     â”‚
                 â”‚   (åŸå­æ¨¡å‹)     â”‚         â”‚   (åŸå­æ¨¡å‹)     â”‚
                 â”‚   ğŸ”’ é›¶ä¿®æ”¹      â”‚         â”‚   ğŸ”’ é›¶ä¿®æ”¹      â”‚
                 â”‚                 â”‚         â”‚                 â”‚
                 â”‚ + username      â”‚         â”‚ + license_key   â”‚
                 â”‚ + email         â”‚         â”‚ + max_activationsâ”‚
                 â”‚ + tenant_id     â”‚         â”‚ + current_activationsâ”‚
                 â”‚ + parent        â”‚         â”‚ + expires_at    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                           â”‚
                           â”‚ 1:N                       â”‚ 1:N
                           â–¼                           â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚TenantUserProfileâ”‚         â”‚LicenseAssignmentâ”‚
                 â”‚ (ç§Ÿæˆ·ç”¨æˆ·æ¡£æ¡ˆ)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   (è®¸å¯è¯åˆ†é…)   â”‚
                 â”‚                 â”‚         â”‚                 â”‚
                 â”‚ + member_id     â”‚         â”‚ + member_id     â”‚
                 â”‚ + tenant_id     â”‚         â”‚ + license_id    â”‚
                 â”‚ + total_points  â”‚         â”‚ + tenant_id     â”‚
                 â”‚ + current_level â”‚         â”‚ + status        â”‚
                 â”‚ + available_pointsâ”‚       â”‚ + assigned_at   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ + expires_at    â”‚
                           â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ 1:N                      â–²
                           â–¼                          â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
                 â”‚TenantUserTypeTagâ”‚                 â”‚
                 â”‚ (ç§Ÿæˆ·ç”¨æˆ·æ ‡ç­¾)   â”‚                 â”‚
                 â”‚                 â”‚                 â”‚
                 â”‚ + vip_expires   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ + grace_period  â”‚   æƒé™æ£€æŸ¥é›†æˆ
                 â”‚ + auto_renewal  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒé™æ£€æŸ¥æµç¨‹ï¼š
LicenseAssignmentåˆ›å»ºå‰ â†’ æŸ¥è¯¢TenantUserProfile â†’ è®¡ç®—ç”¨æˆ·æƒé™é…é¢ â†’ æ‰§è¡Œåˆ†é…
```

## ğŸ—ï¸ LicenseAssignment æ¨¡å‹è¯¦ç»†è®¾è®¡

### ä¸å¤šç§Ÿæˆ·ç§¯åˆ†ç³»ç»Ÿçš„åä½œå…³ç³»

#### Licenseè¡¨å­—æ®µåˆ©ç”¨ (ä¿æŒä¸å˜)
```
Licenseè¡¨å­—æ®µ               LicenseAssignmentè¡¨ä½œç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
max_activations            æ§åˆ¶è®¸å¯è¯æ€»ä½“å¯åˆ†é…æ•°é‡
current_activations        å®æ—¶ç»Ÿè®¡å½“å‰æ¿€æ´»çš„åˆ†é…æ•°
expires_at                 è®¸å¯è¯æ•´ä½“è¿‡æœŸæ—¶é—´
customer_name/email        å®¢æˆ·åŸºç¡€ä¿¡æ¯
metadata                   è®¸å¯è¯æ‰©å±•ä¿¡æ¯
```

#### Memberè¡¨å­—æ®µåˆ©ç”¨ (ä¿æŒä¸å˜)
```
Memberè¡¨å­—æ®µ               LicenseAssignmentè¡¨ä½œç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tenant_id                 ç¡®ä¿åˆ†é…åœ¨åŒä¸€ç§Ÿæˆ·å†…
parentå­—æ®µ                 æ”¯æŒçˆ¶å­è´¦å·çš„è®¸å¯è¯ç»§æ‰¿
```

#### TenantUserProfileè¡¨é›†æˆ (æ–°å¢)
```
TenantUserProfileå­—æ®µ      LicenseAssignmentæƒé™æ£€æŸ¥ä½œç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
total_points               è®¡ç®—ç”¨æˆ·å½“å‰ç­‰çº§
current_level_id           è·å–ç”¨æˆ·ç­‰çº§é…é¢é™åˆ¶
available_points           æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ(å¦‚éœ€è¦)
points_multiplier          ç§Ÿæˆ·ç§¯åˆ†æ”¿ç­–(å½±å“å¥–åŠ±ç§¯åˆ†)
```

#### TenantUserTypeTagè¡¨é›†æˆ (æ–°å¢)
```
TenantUserTypeTagå­—æ®µ      LicenseAssignmentæƒé™æ£€æŸ¥ä½œç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tagæƒé™åŠ æˆ                 è®¡ç®—ç”¨æˆ·æœ€ç»ˆé…é¢(åŸºç¡€Ã—æ ‡ç­¾å€æ•°)
vip_expires_at             æ£€æŸ¥VIPç­‰æ ‡ç­¾æ˜¯å¦æœ‰æ•ˆ
grace_period_days          VIPå®½é™æœŸå†…å¯èƒ½çš„æƒé™é™åˆ¶
```

#### å¤šå±‚é…é¢æ£€æŸ¥æœºåˆ¶
- **ç¬¬ä¸€å±‚**: ç”¨æˆ·ç­‰çº§é…é¢æ£€æŸ¥ (åŸºäºTenantUserProfile.current_level)
- **ç¬¬äºŒå±‚**: Licenseè¡¨çš„activationsé…é¢æ£€æŸ¥ (ä¿æŒåŸé€»è¾‘)
- **ç¬¬ä¸‰å±‚**: ç§Ÿæˆ·æ€»ä½“é…é¢æ£€æŸ¥ (TenantLicenseQuota)
- **æƒé™å¢å¼º**: åŸºäºç”¨æˆ·æ ‡ç­¾çš„é…é¢å€æ•°åŠ æˆ

#### é¿å…æ•°æ®å†—ä½™çš„è®¾è®¡
- **ç§¯åˆ†ä¿¡æ¯**: ä¸åœ¨LicenseAssignmentä¸­å­˜å‚¨ï¼Œé€šè¿‡TenantUserProfileæŸ¥è¯¢
- **è®¾å¤‡æ•°é‡ç®¡ç†**: ç»Ÿä¸€ä½¿ç”¨Licenseè¡¨çš„activationså­—æ®µ
- **ç”¨æˆ·ä¿¡æ¯**: é€šè¿‡å¤–é”®å…³è”ï¼Œé¿å…é‡å¤å­˜å‚¨
- **æƒé™æ§åˆ¶**: åŸºäºå¤šç§Ÿæˆ·ç§¯åˆ†ç­‰çº§ç³»ç»ŸåŠ¨æ€è®¡ç®—

### æ ¸å¿ƒå­—æ®µè®¾è®¡

#### åŸºç¡€å…³è”å­—æ®µ
```
member_id (FK)        - å…³è”Memberç”¨æˆ·çš„å¤–é”®
license_id (FK)       - å…³è”Licenseçš„å¤–é”®  
tenant_id (FK)        - ç§Ÿæˆ·ID (å†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ä¼˜åŒ–å’Œå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»)
```

> **è®¾è®¡è¯´æ˜**: 
> - è®¾å¤‡æ•°é‡æ§åˆ¶é€šè¿‡Licenseè¡¨çš„`max_activations`å’Œ`current_activations`å­—æ®µç®¡ç†
> - è®¸å¯è¯è¿‡æœŸæ—¶é—´ä»¥Licenseè¡¨çš„`expires_at`ä¸ºå‡†ï¼Œåˆ†é…è¡¨çš„`expires_at`å¯ç”¨äºä¸ªåˆ«è°ƒæ•´
> - ç§»é™¤äº†`assigned_by_id`å­—æ®µï¼Œæ”¯æŒç”¨æˆ·è‡ªä¸»ç”³è¯·è®¸å¯è¯
> - **å¤šç§Ÿæˆ·é›†æˆ**: åˆ†é…å‰é€šè¿‡TenantUserProfileæ£€æŸ¥ç”¨æˆ·åœ¨è¯¥ç§Ÿæˆ·ä¸‹çš„æƒé™é…é¢

#### çŠ¶æ€ç®¡ç†å­—æ®µ
```
status                - åˆ†é…çŠ¶æ€
  â”œâ”€ 'pending'        # å¾…åˆ†é…
  â”œâ”€ 'assigned'       # å·²åˆ†é…
  â”œâ”€ 'active'         # ä½¿ç”¨ä¸­  
  â”œâ”€ 'suspended'      # å·²æš‚åœ
  â”œâ”€ 'revoked'        # å·²æ’¤é”€
  â””â”€ 'expired'        # å·²è¿‡æœŸ

assignment_type       - åˆ†é…ç±»å‹
  â”œâ”€ 'user_request'   # ç”¨æˆ·ç”³è¯·
  â”œâ”€ 'admin_assign'   # ç®¡ç†å‘˜åˆ†é…
  â”œâ”€ 'auto_assign'    # è‡ªåŠ¨åˆ†é…
  â””â”€ 'group_assign'   # æ‰¹é‡åˆ†é…
```

#### æ—¶é—´ç®¡ç†å­—æ®µ
```
assigned_at           - åˆ†é…æ—¶é—´ (è‡ªåŠ¨è®¾ç½®)
activated_at          - æ¿€æ´»æ—¶é—´ (é¦–æ¬¡ä½¿ç”¨æ—¶è®¾ç½®)
last_used_at          - æœ€åä½¿ç”¨æ—¶é—´ (æ¯æ¬¡ä½¿ç”¨æ›´æ–°)
expires_at            - è¿‡æœŸæ—¶é—´ (å¯ä¸ºç©ºï¼Œè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ)
suspended_at          - æš‚åœæ—¶é—´
revoked_at            - æ’¤é”€æ—¶é—´
```

#### ç®¡ç†å­—æ®µ
```
assignment_reason        - åˆ†é…åŸå› è¯´æ˜ (å¦‚ï¼šç”¨æˆ·ç”³è¯·ã€ç®¡ç†å‘˜åˆ†é…ç­‰)
assignment_notes         - åˆ†é…å¤‡æ³¨
```

### æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE license_assignment (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”å­—æ®µ
    member_id BIGINT NOT NULL REFERENCES member(id),
    license_id BIGINT NOT NULL REFERENCES licenses_license(id),
    tenant_id BIGINT NOT NULL REFERENCES tenants_tenant(id),
    
    -- çŠ¶æ€å­—æ®µ
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    assignment_type VARCHAR(20) NOT NULL DEFAULT 'user_request',
    
    -- æ—¶é—´å­—æ®µ
    assigned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    activated_at TIMESTAMP WITH TIME ZONE,
    last_used_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    suspended_at TIMESTAMP WITH TIME ZONE,
    revoked_at TIMESTAMP WITH TIME ZONE,
    
    -- ç®¡ç†å­—æ®µ
    assignment_reason TEXT DEFAULT 'ç”¨æˆ·ç”³è¯·',
    assignment_notes TEXT,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    
    -- çº¦æŸ
    CONSTRAINT unique_member_license UNIQUE (member_id, license_id, is_deleted)
        DEFERRABLE INITIALLY DEFERRED
);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE license_assignment IS 'è®¸å¯è¯åˆ†é…å…³ç³»è¡¨ï¼Œè®°å½•Memberå’ŒLicenseçš„å…³è”å…³ç³»';
COMMENT ON COLUMN license_assignment.assignment_type IS 'åˆ†é…ç±»å‹ï¼šuser_request(ç”¨æˆ·ç”³è¯·), admin_assign(ç®¡ç†å‘˜åˆ†é…), auto_assign(è‡ªåŠ¨åˆ†é…), group_assign(æ‰¹é‡åˆ†é…)';
COMMENT ON COLUMN license_assignment.assignment_reason IS 'åˆ†é…åŸå› ï¼šè®°å½•ä¸ºä»€ä¹ˆè¿›è¡Œæ­¤æ¬¡åˆ†é…';
```

### ç´¢å¼•è®¾è®¡

```sql
-- ä¸»è¦æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_license_assignment_member_status 
ON license_assignment (member_id, status) WHERE NOT is_deleted;

CREATE INDEX idx_license_assignment_license_status 
ON license_assignment (license_id, status) WHERE NOT is_deleted;

CREATE INDEX idx_license_assignment_tenant_status 
ON license_assignment (tenant_id, status) WHERE NOT is_deleted;

-- æ—¶é—´ç›¸å…³ç´¢å¼•
CREATE INDEX idx_license_assignment_expires_at 
ON license_assignment (expires_at) WHERE expires_at IS NOT NULL AND NOT is_deleted;

CREATE INDEX idx_license_assignment_assigned_at 
ON license_assignment (assigned_at) WHERE NOT is_deleted;

-- å¤åˆæŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_license_assignment_tenant_member 
ON license_assignment (tenant_id, member_id, status) WHERE NOT is_deleted;
```

## ğŸ“‹ çŠ¶æ€æœºè®¾è®¡

### åˆ†é…çŠ¶æ€æµè½¬å›¾

```
    [åˆ›å»ºåˆ†é…]
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    [æ¿€æ´»]     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ pending â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ assignedâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â”‚ [ç›´æ¥æ¿€æ´»]               â”‚ [é¦–æ¬¡ä½¿ç”¨]
        â”‚                        â–¼
        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    [æš‚åœ]     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ active  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚suspendedâ”‚
                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â”‚ [æ’¤é”€]                  â”‚ [æ¢å¤]
                                â”‚                        â”‚
                                â–¼                        â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
                           â”‚ revoked â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–²
                                â”‚ [è¿‡æœŸ]
                                â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ expired â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€è½¬æ¢è§„åˆ™

#### å…è®¸çš„çŠ¶æ€è½¬æ¢
- `pending` â†’ `assigned` : åˆ†é…ç¡®è®¤
- `pending` â†’ `active` : ç›´æ¥æ¿€æ´»  
- `assigned` â†’ `active` : é¦–æ¬¡ä½¿ç”¨
- `active` â†’ `suspended` : æš‚åœä½¿ç”¨
- `suspended` â†’ `active` : æ¢å¤ä½¿ç”¨
- `assigned/active/suspended` â†’ `revoked` : æ’¤é”€åˆ†é…
- `ä»»ä½•çŠ¶æ€` â†’ `expired` : è‡ªåŠ¨è¿‡æœŸ

#### ç¦æ­¢çš„çŠ¶æ€è½¬æ¢
- `revoked` â†’ ä»»ä½•å…¶ä»–çŠ¶æ€ (æ’¤é”€åä¸å¯æ¢å¤)
- `expired` â†’ ä»»ä½•å…¶ä»–çŠ¶æ€ (è¿‡æœŸåä¸å¯æ¢å¤)

## ğŸ”— å…³è”æŸ¥è¯¢ä¼˜åŒ–

### å¸¸ç”¨æŸ¥è¯¢åœºæ™¯

#### 1. ç”¨æˆ·çš„æ‰€æœ‰æœ‰æ•ˆè®¸å¯è¯
```sql
SELECT l.* FROM licenses_license l
JOIN license_assignment la ON l.id = la.license_id
WHERE la.member_id = ? 
  AND la.status IN ('assigned', 'active')
  AND NOT la.is_deleted
  AND (la.expires_at IS NULL OR la.expires_at > NOW());
```

#### 2. è®¸å¯è¯çš„æ‰€æœ‰åˆ†é…ç”¨æˆ·
```sql
SELECT m.* FROM member m
JOIN license_assignment la ON m.id = la.member_id
WHERE la.license_id = ?
  AND la.status IN ('assigned', 'active')
  AND NOT la.is_deleted;
```

#### 3. ç§Ÿæˆ·çš„è®¸å¯è¯ä½¿ç”¨ç»Ÿè®¡
```sql
SELECT 
    COUNT(*) as total_assignments,
    COUNT(CASE WHEN la.status = 'active' THEN 1 END) as active_count,
    COUNT(CASE WHEN la.expires_at < NOW() THEN 1 END) as expired_count
FROM license_assignment la
WHERE la.tenant_id = ?
  AND NOT la.is_deleted;
```

## ğŸ“Š æ•°æ®å®Œæ•´æ€§ä¿è¯

### æ•°æ®åº“çº¦æŸ
- **å¤–é”®çº¦æŸ**: ä¿è¯å…³è”å®ä½“å­˜åœ¨
- **å”¯ä¸€çº¦æŸ**: é˜²æ­¢é‡å¤åˆ†é…
- **æ£€æŸ¥çº¦æŸ**: ä¿è¯æ•°å€¼å­—æ®µçš„æœ‰æ•ˆæ€§

### ä¸šåŠ¡è§„åˆ™çº¦æŸ
- åˆ†é…æ•°é‡ä¸èƒ½è¶…è¿‡è®¸å¯è¯çš„æœ€å¤§æ¿€æ´»æ•°
- ç”¨æˆ·åªèƒ½è¢«åˆ†é…åŒä¸€è®¸å¯è¯ä¸€æ¬¡
- ç§Ÿæˆ·å†…çš„æ•°æ®éš”ç¦»

### æ•°æ®ä¸€è‡´æ€§ç­–ç•¥
- **è¯»å–æ—¶éªŒè¯**: æŸ¥è¯¢æ—¶æ£€æŸ¥è¿‡æœŸçŠ¶æ€
- **å®šæœŸæ¸…ç†**: å®šæ—¶ä»»åŠ¡å¤„ç†è¿‡æœŸæ•°æ®
- **äº‹åŠ¡æ€§æ“ä½œ**: å…³é”®æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
- **å¤šç§Ÿæˆ·éš”ç¦»**: æ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶ï¼Œç¡®ä¿æ•°æ®éš”ç¦»

## ğŸ¯ å¤šç§Ÿæˆ·ç§¯åˆ†ç³»ç»Ÿé›†æˆ

### è®¸å¯è¯åˆ†é…çš„ç§¯åˆ†å¥–åŠ±æœºåˆ¶

#### ç§¯åˆ†å¥–åŠ±è§¦å‘ç‚¹
```
è®¸å¯è¯åˆ†é…äº‹ä»¶              ç§¯åˆ†å¥–åŠ±                     è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é¦–æ¬¡ç”³è¯·è®¸å¯è¯              +50åˆ†                       é¼“åŠ±ç”¨æˆ·ä½¿ç”¨
æˆåŠŸæ¿€æ´»è®¸å¯è¯              +80åˆ† (é¦–æ¬¡æ¿€æ´»)           ä¿ƒè¿›æ¿€æ´»è¡Œä¸º
è¿ç»­ä½¿ç”¨è½¯ä»¶                +5åˆ†/å¤©                     æ´»è·ƒåº¦å¥–åŠ±
æ¨èä»–äººä½¿ç”¨                +100åˆ† (æˆåŠŸåˆ†é…å)        æ¨å¹¿å¥–åŠ±
ä¼ä¸šè®¸å¯è¯æ¿€æ´»              +é¢å¤–50åˆ†                   é«˜ä»·å€¼è®¸å¯è¯
```

#### ç§¯åˆ†å‘æ”¾æµç¨‹é›†æˆ
```
LicenseAssignmentçŠ¶æ€å˜æ›´è§¦å‘:

assigned â†’ active (é¦–æ¬¡æ¿€æ´»)
    â†“
æ£€æŸ¥æ˜¯å¦é¦–æ¬¡æ¿€æ´»è¯¥ç±»å‹è®¸å¯è¯
    â†“
é€šè¿‡PointsEngineå‘æ”¾å¯¹åº”ç§¯åˆ†
    â†“
TenantUserPointsåˆ›å»ºç§¯åˆ†è®°å½•
    â†“
TenantUserProfileæ›´æ–°ç§¯åˆ†æ€»æ•°
    â†“
æ£€æŸ¥æ˜¯å¦è§¦å‘ç­‰çº§å‡çº§
    â†“
æ›´æ–°æƒé™ç¼“å­˜
```

### æ–°æ—§ç³»ç»Ÿå…¼å®¹æ€§

#### æ¸è¿›å¼é›†æˆ
- **ç¬¬ä¸€é˜¶æ®µ**: LicenseAssignmentä¿æŒç°æœ‰é€»è¾‘ï¼Œæ·»åŠ æ–°çš„æƒé™æ£€æŸ¥
- **ç¬¬äºŒé˜¶æ®µ**: é›†æˆç§¯åˆ†å¥–åŠ±æœºåˆ¶ï¼Œç”¨æˆ·å¼€å§‹è·å¾—ç§¯åˆ†
- **ç¬¬ä¸‰é˜¶æ®µ**: å¯ç”¨åŸºäºç§¯åˆ†ç­‰çº§çš„åŠ¨æ€é…é¢åˆ†é…
- **ç¬¬å››é˜¶æ®µ**: å®Œå…¨åˆ‡æ¢åˆ°æ–°çš„å¤šç§Ÿæˆ·æƒé™ä½“ç³»

#### æ•°æ®è¿ç§»å…¼å®¹
- **ç°æœ‰åˆ†é…è®°å½•**: ä¿æŒä¸å˜ï¼Œé€šè¿‡å†å²è¡Œä¸ºè®¡ç®—ç”¨æˆ·ç§¯åˆ†
- **æƒé™æ£€æŸ¥**: å‘ä¸‹å…¼å®¹ï¼Œç°æœ‰ç”¨æˆ·æƒé™ä¸ä¼šé™çº§
- **APIæ¥å£**: ä¿æŒç°æœ‰è°ƒç”¨æ–¹å¼ï¼Œå†…éƒ¨é€»è¾‘å‡çº§

### æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

#### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–çš„è®¸å¯è¯åˆ†é…æŸ¥è¯¢ï¼ˆæ”¯æŒå¤šç§Ÿæˆ·ï¼‰
SELECT la.*, 
       m.username,
       l.license_key,
       tup.total_points,
       ul.level_name
FROM license_assignment la
JOIN member m ON la.member_id = m.id
JOIN licenses_license l ON la.license_id = l.id
LEFT JOIN tenant_user_profile tup ON (tup.member_id = m.id AND tup.tenant_id = la.tenant_id)
LEFT JOIN user_level ul ON tup.current_level_id = ul.id
WHERE la.tenant_id = ?
  AND la.status IN ('assigned', 'active')
  AND NOT la.is_deleted;
```

#### ç¼“å­˜ç­–ç•¥
- **æƒé™ç¼“å­˜**: æŒ‰ç§Ÿæˆ·éš”ç¦»çš„ç”¨æˆ·æƒé™ç¼“å­˜
- **é…é¢ç¼“å­˜**: ç¼“å­˜ç”¨æˆ·å½“å‰é…é¢é™åˆ¶ï¼Œå‡å°‘è®¡ç®—å¼€é”€
- **åˆ†é…ç¼“å­˜**: ç¼“å­˜ç”¨æˆ·å½“å‰è®¸å¯è¯åˆ†é…çŠ¶æ€

---

**ä¸‹ä¸€æ­¥**: 
1. æŸ¥çœ‹[é¢†åŸŸæœåŠ¡è®¾è®¡](03_é¢†åŸŸæœåŠ¡è®¾è®¡.md)äº†è§£LicenseAssignmentçš„ä¸šåŠ¡é€»è¾‘
2. é‡ç‚¹å­¦ä¹ [å¤šç§Ÿæˆ·ç§¯åˆ†è®¾è®¡ä¿®æ­£](19_å¤šç§Ÿæˆ·ç§¯åˆ†è®¾è®¡ä¿®æ­£.md)æŒæ¡å®Œæ•´çš„ç§¯åˆ†ç³»ç»Ÿè®¾è®¡
3. å‚è€ƒ[æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡](15_æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡.md)äº†è§£TenantUserProfileç­‰æ–°è¡¨çš„å®Œæ•´ç»“æ„
