# 领域模型设计

## 🎯 设计原则

### 🔒 现有代码模型分析结果
经过深度分析现有代码库（`users/models.py`, `licenses/models.py`, `tenants/models.py`）确认：

**✅ 现有原子模型（零修改）**:
- **Member模型** - 现有代码中完全原子，无积分字段，无需任何修改
- **License模型** - 现有代码中完全原子，已包含`max_activations`和`current_activations`字段
- **Tenant模型** - 现有租户系统保持不变

**✅ 新增模型（全新代码）**:
- **LicenseAssignment模型** - 在现有代码中**完全不存在**，是全新模型
- **积分系统相关模型** - 在现有代码中**完全不存在**，都是全新模型

**✅ 设计原则验证**:
- 所有现有代码模型保持完全原子性和不变性
- 所有新功能通过新增模型实现，与现有代码零冲突
- 业务逻辑完全通过新的服务层实现，不修改现有业务逻辑

### 多租户积分集成
- **LicenseAssignment**集成新的多租户权限计算机制
- 分配前检查用户在租户下的等级和配额限制
- 支持基于积分等级的动态配额分配
- 与**TenantUserProfile**协作，实现租户隔离的许可证管理

### 数据一致性
- 通过数据库约束保证引用完整性
- 通过领域服务保证业务规则一致性
- 支持事务性操作确保数据一致性
- 租户数据完全隔离，避免跨租户数据泄露

## 📊 数据模型关系图

### 许可证分配与多租户积分系统集成

```
                 ┌─────────────────┐         ┌─────────────────┐
                 │     Tenant      │         │   SoftwareProduct│
                 │                 │         │                 │
                 └─────────┬───────┘         └─────────┬───────┘
                           │                           │
                           │ 1:N                       │ 1:N
                           ▼                           ▼
                 ┌─────────────────┐         ┌─────────────────┐
                 │     Member      │         │     License     │
                 │   (原子模型)     │         │   (原子模型)     │
                 │   🔒 零修改      │         │   🔒 零修改      │
                 │                 │         │                 │
                 │ + username      │         │ + license_key   │
                 │ + email         │         │ + max_activations│
                 │ + tenant_id     │         │ + current_activations│
                 │ + parent        │         │ + expires_at    │
                 └─────────┬───────┘         └─────────┬───────┘
                           │                           │
                           │ 1:N                       │ 1:N
                           ▼                           ▼
                 ┌─────────────────┐         ┌─────────────────┐
                 │TenantUserProfile│         │LicenseAssignment│
                 │ (租户用户档案)   │◄────────┤   (许可证分配)   │
                 │                 │         │                 │
                 │ + member_id     │         │ + member_id     │
                 │ + tenant_id     │         │ + license_id    │
                 │ + total_points  │         │ + tenant_id     │
                 │ + current_level │         │ + status        │
                 │ + available_points│       │ + assigned_at   │
                 └─────────┬───────┘         │ + expires_at    │
                           │                 └─────────────────┘
                           │ 1:N                      ▲
                           ▼                          │
                 ┌─────────────────┐                 │
                 │TenantUserTypeTag│                 │
                 │ (租户用户标签)   │                 │
                 │                 │                 │
                 │ + vip_expires   │─────────────────┘
                 │ + grace_period  │   权限检查集成
                 │ + auto_renewal  │
                 └─────────────────┘

权限检查流程：
LicenseAssignment创建前 → 查询TenantUserProfile → 计算用户权限配额 → 执行分配
```

## 🏗️ LicenseAssignment 模型详细设计

### 与多租户积分系统的协作关系

#### License表字段利用 (保持不变)
```
License表字段               LicenseAssignment表作用
─────────────────────      ──────────────────────────
max_activations            控制许可证总体可分配数量
current_activations        实时统计当前激活的分配数
expires_at                 许可证整体过期时间
customer_name/email        客户基础信息
metadata                   许可证扩展信息
```

#### Member表字段利用 (保持不变)
```
Member表字段               LicenseAssignment表作用
─────────────────────      ──────────────────────────
tenant_id                 确保分配在同一租户内
parent字段                 支持父子账号的许可证继承
```

#### TenantUserProfile表集成 (新增)
```
TenantUserProfile字段      LicenseAssignment权限检查作用
─────────────────────      ──────────────────────────────
total_points               计算用户当前等级
current_level_id           获取用户等级配额限制
available_points           检查积分是否足够(如需要)
points_multiplier          租户积分政策(影响奖励积分)
```

#### TenantUserTypeTag表集成 (新增)
```
TenantUserTypeTag字段      LicenseAssignment权限检查作用
─────────────────────      ──────────────────────────────
tag权限加成                 计算用户最终配额(基础×标签倍数)
vip_expires_at             检查VIP等标签是否有效
grace_period_days          VIP宽限期内可能的权限限制
```

#### 多层配额检查机制
- **第一层**: 用户等级配额检查 (基于TenantUserProfile.current_level)
- **第二层**: License表的activations配额检查 (保持原逻辑)
- **第三层**: 租户总体配额检查 (TenantLicenseQuota)
- **权限增强**: 基于用户标签的配额倍数加成

#### 避免数据冗余的设计
- **积分信息**: 不在LicenseAssignment中存储，通过TenantUserProfile查询
- **设备数量管理**: 统一使用License表的activations字段
- **用户信息**: 通过外键关联，避免重复存储
- **权限控制**: 基于多租户积分等级系统动态计算

### 核心字段设计

#### 基础关联字段
```
member_id (FK)        - 关联Member用户的外键
license_id (FK)       - 关联License的外键  
tenant_id (FK)        - 租户ID (冗余字段，便于查询优化和多租户数据隔离)
```

> **设计说明**: 
> - 设备数量控制通过License表的`max_activations`和`current_activations`字段管理
> - 许可证过期时间以License表的`expires_at`为准，分配表的`expires_at`可用于个别调整
> - 移除了`assigned_by_id`字段，支持用户自主申请许可证
> - **多租户集成**: 分配前通过TenantUserProfile检查用户在该租户下的权限配额

#### 状态管理字段
```
status                - 分配状态
  ├─ 'pending'        # 待分配
  ├─ 'assigned'       # 已分配
  ├─ 'active'         # 使用中  
  ├─ 'suspended'      # 已暂停
  ├─ 'revoked'        # 已撤销
  └─ 'expired'        # 已过期

assignment_type       - 分配类型
  ├─ 'user_request'   # 用户申请
  ├─ 'admin_assign'   # 管理员分配
  ├─ 'auto_assign'    # 自动分配
  └─ 'group_assign'   # 批量分配
```

#### 时间管理字段
```
assigned_at           - 分配时间 (自动设置)
activated_at          - 激活时间 (首次使用时设置)
last_used_at          - 最后使用时间 (每次使用更新)
expires_at            - 过期时间 (可为空，表示永不过期)
suspended_at          - 暂停时间
revoked_at            - 撤销时间
```

#### 管理字段
```
assignment_reason        - 分配原因说明 (如：用户申请、管理员分配等)
assignment_notes         - 分配备注
```

### 数据库表结构

```sql
CREATE TABLE license_assignment (
    id BIGSERIAL PRIMARY KEY,
    
    -- 关联字段
    member_id BIGINT NOT NULL REFERENCES member(id),
    license_id BIGINT NOT NULL REFERENCES licenses_license(id),
    tenant_id BIGINT NOT NULL REFERENCES tenants_tenant(id),
    
    -- 状态字段
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    assignment_type VARCHAR(20) NOT NULL DEFAULT 'user_request',
    
    -- 时间字段
    assigned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    activated_at TIMESTAMP WITH TIME ZONE,
    last_used_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    suspended_at TIMESTAMP WITH TIME ZONE,
    revoked_at TIMESTAMP WITH TIME ZONE,
    
    -- 管理字段
    assignment_reason TEXT DEFAULT '用户申请',
    assignment_notes TEXT,
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
    
    -- 约束
    CONSTRAINT unique_member_license UNIQUE (member_id, license_id, is_deleted)
        DEFERRABLE INITIALLY DEFERRED
);

-- 添加注释
COMMENT ON TABLE license_assignment IS '许可证分配关系表，记录Member和License的关联关系';
COMMENT ON COLUMN license_assignment.assignment_type IS '分配类型：user_request(用户申请), admin_assign(管理员分配), auto_assign(自动分配), group_assign(批量分配)';
COMMENT ON COLUMN license_assignment.assignment_reason IS '分配原因：记录为什么进行此次分配';
```

### 索引设计

```sql
-- 主要查询索引
CREATE INDEX idx_license_assignment_member_status 
ON license_assignment (member_id, status) WHERE NOT is_deleted;

CREATE INDEX idx_license_assignment_license_status 
ON license_assignment (license_id, status) WHERE NOT is_deleted;

CREATE INDEX idx_license_assignment_tenant_status 
ON license_assignment (tenant_id, status) WHERE NOT is_deleted;

-- 时间相关索引
CREATE INDEX idx_license_assignment_expires_at 
ON license_assignment (expires_at) WHERE expires_at IS NOT NULL AND NOT is_deleted;

CREATE INDEX idx_license_assignment_assigned_at 
ON license_assignment (assigned_at) WHERE NOT is_deleted;

-- 复合查询索引
CREATE INDEX idx_license_assignment_tenant_member 
ON license_assignment (tenant_id, member_id, status) WHERE NOT is_deleted;
```

## 📋 状态机设计

### 分配状态流转图

```
    [创建分配]
        │
        ▼
   ┌─────────┐    [激活]     ┌─────────┐
   │ pending ├──────────────▶│ assigned│
   └─────────┘               └────┬────┘
        │                        │
        │ [直接激活]               │ [首次使用]
        │                        ▼
        │                  ┌─────────┐    [暂停]     ┌─────────┐
        └─────────────────▶│ active  ├──────────────▶│suspended│
                           └────┬────┘               └────┬────┘
                                │                        │
                                │ [撤销]                  │ [恢复]
                                │                        │
                                ▼                        │
                           ┌─────────┐                   │
                           │ revoked ◀───────────────────┘
                           └─────────┘
                                ▲
                                │ [过期]
                                │
                           ┌─────────┐
                           │ expired │
                           └─────────┘
```

### 状态转换规则

#### 允许的状态转换
- `pending` → `assigned` : 分配确认
- `pending` → `active` : 直接激活  
- `assigned` → `active` : 首次使用
- `active` → `suspended` : 暂停使用
- `suspended` → `active` : 恢复使用
- `assigned/active/suspended` → `revoked` : 撤销分配
- `任何状态` → `expired` : 自动过期

#### 禁止的状态转换
- `revoked` → 任何其他状态 (撤销后不可恢复)
- `expired` → 任何其他状态 (过期后不可恢复)

## 🔗 关联查询优化

### 常用查询场景

#### 1. 用户的所有有效许可证
```sql
SELECT l.* FROM licenses_license l
JOIN license_assignment la ON l.id = la.license_id
WHERE la.member_id = ? 
  AND la.status IN ('assigned', 'active')
  AND NOT la.is_deleted
  AND (la.expires_at IS NULL OR la.expires_at > NOW());
```

#### 2. 许可证的所有分配用户
```sql
SELECT m.* FROM member m
JOIN license_assignment la ON m.id = la.member_id
WHERE la.license_id = ?
  AND la.status IN ('assigned', 'active')
  AND NOT la.is_deleted;
```

#### 3. 租户的许可证使用统计
```sql
SELECT 
    COUNT(*) as total_assignments,
    COUNT(CASE WHEN la.status = 'active' THEN 1 END) as active_count,
    COUNT(CASE WHEN la.expires_at < NOW() THEN 1 END) as expired_count
FROM license_assignment la
WHERE la.tenant_id = ?
  AND NOT la.is_deleted;
```

## 📊 数据完整性保证

### 数据库约束
- **外键约束**: 保证关联实体存在
- **唯一约束**: 防止重复分配
- **检查约束**: 保证数值字段的有效性

### 业务规则约束
- 分配数量不能超过许可证的最大激活数
- 用户只能被分配同一许可证一次
- 租户内的数据隔离

### 数据一致性策略
- **读取时验证**: 查询时检查过期状态
- **定期清理**: 定时任务处理过期数据
- **事务性操作**: 关键操作使用数据库事务
- **多租户隔离**: 所有查询自动添加租户条件，确保数据隔离

## 🎯 多租户积分系统集成

### 许可证分配的积分奖励机制

#### 积分奖励触发点
```
许可证分配事件              积分奖励                     说明
─────────────────────      ──────────────────────      ──────────────────
首次申请许可证              +50分                       鼓励用户使用
成功激活许可证              +80分 (首次激活)           促进激活行为
连续使用软件                +5分/天                     活跃度奖励
推荐他人使用                +100分 (成功分配后)        推广奖励
企业许可证激活              +额外50分                   高价值许可证
```

#### 积分发放流程集成
```
LicenseAssignment状态变更触发:

assigned → active (首次激活)
    ↓
检查是否首次激活该类型许可证
    ↓
通过PointsEngine发放对应积分
    ↓
TenantUserPoints创建积分记录
    ↓
TenantUserProfile更新积分总数
    ↓
检查是否触发等级升级
    ↓
更新权限缓存
```

### 新旧系统兼容性

#### 渐进式集成
- **第一阶段**: LicenseAssignment保持现有逻辑，添加新的权限检查
- **第二阶段**: 集成积分奖励机制，用户开始获得积分
- **第三阶段**: 启用基于积分等级的动态配额分配
- **第四阶段**: 完全切换到新的多租户权限体系

#### 数据迁移兼容
- **现有分配记录**: 保持不变，通过历史行为计算用户积分
- **权限检查**: 向下兼容，现有用户权限不会降级
- **API接口**: 保持现有调用方式，内部逻辑升级

### 性能优化考虑

#### 查询优化
```sql
-- 优化的许可证分配查询（支持多租户）
SELECT la.*, 
       m.username,
       l.license_key,
       tup.total_points,
       ul.level_name
FROM license_assignment la
JOIN member m ON la.member_id = m.id
JOIN licenses_license l ON la.license_id = l.id
LEFT JOIN tenant_user_profile tup ON (tup.member_id = m.id AND tup.tenant_id = la.tenant_id)
LEFT JOIN user_level ul ON tup.current_level_id = ul.id
WHERE la.tenant_id = ?
  AND la.status IN ('assigned', 'active')
  AND NOT la.is_deleted;
```

#### 缓存策略
- **权限缓存**: 按租户隔离的用户权限缓存
- **配额缓存**: 缓存用户当前配额限制，减少计算开销
- **分配缓存**: 缓存用户当前许可证分配状态

---

**下一步**: 
1. 查看[领域服务设计](03_领域服务设计.md)了解LicenseAssignment的业务逻辑
2. 重点学习[多租户积分设计修正](19_多租户积分设计修正.md)掌握完整的积分系统设计
3. 参考[数据模型详细设计](15_数据模型详细设计.md)了解TenantUserProfile等新表的完整结构
