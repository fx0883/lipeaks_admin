# å¤šç§Ÿæˆ·ç§¯åˆ†è®¾è®¡ä¿®æ­£æ–¹æ¡ˆ

## ğŸ¯ è®¾è®¡ä¿®æ­£ç›®æ ‡

### ğŸ” ç°æœ‰ä»£ç æ·±åº¦åˆ†æç»“æœ
ç»è¿‡ä»”ç»†åˆ†æç°æœ‰ä»£ç åº“ç¡®è®¤ï¼š

**âœ… ç°æœ‰æ¨¡å‹éªŒè¯**:
- **Memberæ¨¡å‹** (`users/models.py`) - å®Œå…¨åŸå­ï¼Œæ— ç§¯åˆ†ç›¸å…³å­—æ®µ
- **Licenseæ¨¡å‹** (`licenses/models.py`) - å®Œå…¨åŸå­ï¼Œå·²æœ‰`max_activations`å’Œ`current_activations`
- **LicenseAssignmentæ¨¡å‹** - åœ¨ç°æœ‰ä»£ç ä¸­**å®Œå…¨ä¸å­˜åœ¨**
- **ç§¯åˆ†ç³»ç»Ÿ** - åœ¨ç°æœ‰ä»£ç ä¸­**å®Œå…¨ä¸å­˜åœ¨**

**âœ… é›¶ä¿®æ”¹ç¡®è®¤**:
- æ‰€æœ‰ç°æœ‰ä»£ç æ¨¡å‹ä¿æŒ100%ä¸å˜
- æ‰€æœ‰æ–°åŠŸèƒ½é€šè¿‡æ–°å¢æ¨¡å‹å®ç°
- å®Œå…¨å‘ä¸‹å…¼å®¹ï¼Œé›¶ä¸šåŠ¡é£é™©

### æ ¸å¿ƒé—®é¢˜è§£å†³
1. **ğŸ”’ é›¶ä»£ç ä¿®æ”¹**: ä»»ä½•ç°æœ‰ä»£ç æ¨¡å‹éƒ½ä¸ä¿®æ”¹ï¼Œä¿è¯100%å®‰å…¨
2. **å¤šç§Ÿæˆ·ç§¯åˆ†éš”ç¦»**: åŒä¸€ Member åœ¨ä¸åŒç§Ÿæˆ·ä¸‹æ‹¥æœ‰ç‹¬ç«‹çš„ç§¯åˆ†å’Œç­‰çº§
3. **VIP æœŸé™ç®¡ç†**: å®Œæ•´çš„ VIP ç­‰æ ‡ç­¾æœŸé™ç®¡ç†æœºåˆ¶
4. **å‘ä¸‹å…¼å®¹ä¿è¯**: ç°æœ‰ä¸šåŠ¡é€»è¾‘å’ŒAPIå®Œå…¨ä¸å—å½±å“

### è®¾è®¡åŸåˆ™
- **åŸå­æ¨¡å‹ä¿æŠ¤**: ç°æœ‰Memberã€Licenseã€Tenantè¡¨å®Œå…¨ä¸å˜
- **ç§Ÿæˆ·éš”ç¦»**: ç§¯åˆ†å’Œç­‰çº§æ•°æ®æŒ‰ç§Ÿæˆ·ä¸¥æ ¼éš”ç¦»ï¼Œé€šè¿‡æ–°å¢TenantUserProfileè¡¨å®ç°
- **åŠŸèƒ½ç‹¬ç«‹**: æ–°åŠŸèƒ½é€šè¿‡ç‹¬ç«‹çš„è¡¨å’ŒæœåŠ¡å®ç°ï¼Œå¯ç‹¬ç«‹éƒ¨ç½²å’Œå›æ»š
- **æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹å¤šç§Ÿæˆ·æŸ¥è¯¢çš„ä¸“é—¨ä¼˜åŒ–è®¾è®¡

## ğŸ—ï¸ é‡æ–°è®¾è®¡çš„æ•°æ®æ¨¡å‹

### æ ¸å¿ƒè¡¨ç»“æ„å…³ç³»å›¾

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚     Tenant      â”‚
                            â”‚    (ç§Ÿæˆ·)       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ 1:N
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ TenantUserProfileâ”‚
                            â”‚ (ç§Ÿæˆ·ç”¨æˆ·æ¡£æ¡ˆ)   â”‚
                            â”‚ + total_points  â”‚
                            â”‚ + current_level â”‚
                            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚   â”‚
                             1:N  â”‚   â”‚ N:M
                                  â”‚   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼   â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ TenantUserPoints  â”‚           â”‚TenantUserTypeTag  â”‚
          â”‚ (ç§Ÿæˆ·ç”¨æˆ·ç§¯åˆ†)     â”‚           â”‚(ç§Ÿæˆ·ç”¨æˆ·æ ‡ç­¾å…³è”) â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â”‚                               â”‚ N:1
                    â”‚                               â–¼
                    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚   UserTypeTag   â”‚
                    â”‚                     â”‚   (ç”¨æˆ·æ ‡ç­¾)     â”‚
                    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    UserLevel      â”‚
          â”‚   (ç”¨æˆ·ç­‰çº§)       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. TenantUserProfile (ç§Ÿæˆ·ç”¨æˆ·æ¡£æ¡ˆè¡¨)

è¿™æ˜¯æ–°çš„æ ¸å¿ƒè¡¨ï¼Œæ›¿ä»£åœ¨ Member è¡¨ä¸­å­˜å‚¨ç§¯åˆ†ä¿¡æ¯ï¼š

```sql
CREATE TABLE tenant_user_profile (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,
    tenant_id BIGINT NOT NULL REFERENCES tenants_tenant(id) ON DELETE CASCADE,
    
    -- ç§¯åˆ†ä¿¡æ¯
    total_points INTEGER NOT NULL DEFAULT 0,
    available_points INTEGER NOT NULL DEFAULT 0,  -- å¯ç”¨ç§¯åˆ†ï¼ˆæ’é™¤å·²è¿‡æœŸï¼‰
    
    -- ç­‰çº§ä¿¡æ¯
    current_level_id BIGINT REFERENCES user_level(id),
    level_updated_at TIMESTAMP WITH TIME ZONE,
    
    -- ç»Ÿè®¡ä¿¡æ¯
    points_earned_total INTEGER NOT NULL DEFAULT 0,      -- å†å²æ€»è·å¾—ç§¯åˆ†
    points_spent_total INTEGER NOT NULL DEFAULT 0,       -- å†å²æ€»æ¶ˆè´¹ç§¯åˆ†
    points_expired_total INTEGER NOT NULL DEFAULT 0,     -- å†å²æ€»è¿‡æœŸç§¯åˆ†
    
    -- æ´»è·ƒåº¦ä¿¡æ¯
    last_points_update TIMESTAMP WITH TIME ZONE,         -- æœ€åç§¯åˆ†å˜åŠ¨æ—¶é—´
    last_level_check TIMESTAMP WITH TIME ZONE,           -- æœ€åç­‰çº§æ£€æŸ¥æ—¶é—´
    consecutive_login_days INTEGER DEFAULT 0,            -- è¿ç»­ç™»å½•å¤©æ•°
    last_login_date DATE,                                -- æœ€åç™»å½•æ—¥æœŸ
    
    -- é…ç½®ä¿¡æ¯
    points_multiplier DECIMAL(3,2) DEFAULT 1.00,         -- ç§¯åˆ†å€æ•°ï¼ˆç§Ÿæˆ·ç‰¹æ®Šé…ç½®ï¼‰
    is_points_enabled BOOLEAN DEFAULT TRUE,              -- æ˜¯å¦å¯ç”¨ç§¯åˆ†åŠŸèƒ½
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    CONSTRAINT unique_member_tenant UNIQUE (member_id, tenant_id),
    CONSTRAINT valid_points CHECK (total_points >= 0 AND available_points >= 0),
    CONSTRAINT available_points_check CHECK (available_points <= total_points),
    CONSTRAINT valid_multiplier CHECK (points_multiplier > 0)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_tenant_user_profile_member ON tenant_user_profile (member_id);
CREATE INDEX idx_tenant_user_profile_tenant ON tenant_user_profile (tenant_id);
CREATE INDEX idx_tenant_user_profile_points ON tenant_user_profile (tenant_id, total_points DESC);
CREATE INDEX idx_tenant_user_profile_level ON tenant_user_profile (current_level_id);
CREATE INDEX idx_tenant_user_profile_active ON tenant_user_profile (tenant_id, last_points_update DESC);

-- æ³¨é‡Š
COMMENT ON TABLE tenant_user_profile IS 'ç§Ÿæˆ·ç”¨æˆ·æ¡£æ¡ˆè¡¨ï¼Œå­˜å‚¨ç”¨æˆ·åœ¨ç‰¹å®šç§Ÿæˆ·ä¸‹çš„ç§¯åˆ†å’Œç­‰çº§ä¿¡æ¯';
COMMENT ON COLUMN tenant_user_profile.points_multiplier IS 'ç§¯åˆ†å€æ•°ï¼Œæ”¯æŒç§Ÿæˆ·çº§åˆ«çš„ç§¯åˆ†æ”¿ç­–è°ƒæ•´';
COMMENT ON COLUMN tenant_user_profile.consecutive_login_days IS 'è¿ç»­ç™»å½•å¤©æ•°ï¼Œç”¨äºè®¡ç®—ç™»å½•å¥–åŠ±';
```

### 2. TenantUserPoints (ç§Ÿæˆ·ç”¨æˆ·ç§¯åˆ†è®°å½•è¡¨)

ä¿®æ”¹åŸæœ‰çš„ UserPoints è¡¨ï¼Œå¢åŠ ç§Ÿæˆ·éš”ç¦»ï¼š

```sql
CREATE TABLE tenant_user_points (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    tenant_user_profile_id BIGINT NOT NULL REFERENCES tenant_user_profile(id) ON DELETE CASCADE,
    tenant_id BIGINT NOT NULL REFERENCES tenants_tenant(id) ON DELETE CASCADE,  -- å†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ä¼˜åŒ–
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,          -- å†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ä¼˜åŒ–
    
    -- ç§¯åˆ†ç±»å‹åˆ†ç±»
    point_type VARCHAR(50) NOT NULL,           -- ç§¯åˆ†ç±»å‹ï¼šearn(è·å¾—), spend(æ¶ˆè´¹), expire(è¿‡æœŸ), adjust(è°ƒæ•´)
    category VARCHAR(50) NOT NULL,             -- ä¸šåŠ¡åˆ†ç±»ï¼šlogin, license, referral, payment, community, etc.
    subcategory VARCHAR(50),                   -- å­åˆ†ç±»ï¼šdaily_login, first_activation, etc.
    
    -- ç§¯åˆ†æ•°å€¼
    points INTEGER NOT NULL,                   -- ç§¯åˆ†å˜åŠ¨æ•°é‡ï¼ˆæ­£æ•°ä¸ºè·å¾—ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè´¹ï¼‰
    balance_before INTEGER NOT NULL,          -- æ“ä½œå‰ç§¯åˆ†ä½™é¢
    balance_after INTEGER NOT NULL,           -- æ“ä½œåç§¯åˆ†ä½™é¢
    
    -- ç§Ÿæˆ·ç‰¹å®šä¿¡æ¯
    tenant_multiplier DECIMAL(3,2) DEFAULT 1.00,  -- æœ¬æ¬¡ç§¯åˆ†çš„ç§Ÿæˆ·å€æ•°
    original_points INTEGER,                       -- å€æ•°è°ƒæ•´å‰çš„åŸå§‹ç§¯åˆ†
    
    -- å…³è”ä¿¡æ¯
    source_type VARCHAR(50),                   -- æ¥æºç±»å‹ï¼šmanual, system, api, migration
    source_id BIGINT,                          -- å…³è”çš„æºè®°å½•IDï¼ˆå¦‚license_id, order_idç­‰ï¼‰
    source_description TEXT,                   -- æ¥æºæè¿°
    
    -- ç§¯åˆ†ç”Ÿå‘½å‘¨æœŸ
    earned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),  -- ç§¯åˆ†è·å¾—æ—¶é—´
    expires_at TIMESTAMP WITH TIME ZONE,       -- ç§¯åˆ†è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼‰
    expired_at TIMESTAMP WITH TIME ZONE,       -- å®é™…è¿‡æœŸæ—¶é—´
    
    -- æ“ä½œä¿¡æ¯
    operation_reason TEXT,                     -- æ“ä½œåŸå› è¯´æ˜
    operator_id BIGINT,                        -- æ“ä½œäººå‘˜IDï¼ˆç³»ç»Ÿæ“ä½œä¸ºNULLï¼‰
    batch_id VARCHAR(100),                     -- æ‰¹é‡æ“ä½œæ ‡è¯†
    
    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- çŠ¶æ€ï¼šactive, expired, cancelled, adjusted
    is_manual BOOLEAN NOT NULL DEFAULT FALSE,  -- æ˜¯å¦æ‰‹åŠ¨è°ƒæ•´
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- çº¦æŸ
    CONSTRAINT points_not_zero CHECK (points != 0),
    CONSTRAINT valid_balance CHECK (balance_after = balance_before + points),
    CONSTRAINT valid_balance_positive CHECK (balance_after >= 0),
    CONSTRAINT valid_tenant_multiplier CHECK (tenant_multiplier > 0)
);

-- ç´¢å¼•ä¼˜åŒ–ï¼ˆæ”¯æŒå¤šç§Ÿæˆ·æŸ¥è¯¢ï¼‰
CREATE INDEX idx_tenant_user_points_profile ON tenant_user_points (tenant_user_profile_id, created_at DESC);
CREATE INDEX idx_tenant_user_points_tenant_member ON tenant_user_points (tenant_id, member_id, created_at DESC);
CREATE INDEX idx_tenant_user_points_type ON tenant_user_points (tenant_id, point_type, category);
CREATE INDEX idx_tenant_user_points_expires ON tenant_user_points (tenant_id, expires_at) 
    WHERE expires_at IS NOT NULL AND status = 'active';
CREATE INDEX idx_tenant_user_points_source ON tenant_user_points (tenant_id, source_type, source_id) 
    WHERE source_id IS NOT NULL;

-- åˆ†åŒºè¡¨ï¼ˆæŒ‰ç§Ÿæˆ·åˆ†åŒºï¼Œå¯é€‰ï¼‰
-- æ³¨æ„ï¼šPostgreSQL 13+ æ”¯æŒ
/*
CREATE TABLE tenant_user_points_default PARTITION OF tenant_user_points DEFAULT;
-- ä¸ºå¤§ç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹åˆ†åŒº
CREATE TABLE tenant_user_points_tenant_1 PARTITION OF tenant_user_points 
FOR VALUES IN (1);
*/

COMMENT ON TABLE tenant_user_points IS 'ç§Ÿæˆ·ç”¨æˆ·ç§¯åˆ†è®°å½•è¡¨ï¼ŒæŒ‰ç§Ÿæˆ·éš”ç¦»å­˜å‚¨ç§¯åˆ†å˜åŠ¨è®°å½•';
COMMENT ON COLUMN tenant_user_points.tenant_multiplier IS 'ç§Ÿæˆ·ç§¯åˆ†å€æ•°ï¼Œè®°å½•å½“æ—¶çš„å€æ•°æ”¿ç­–';
```

### 3. TenantUserTypeTag (ç§Ÿæˆ·ç”¨æˆ·æ ‡ç­¾å…³è”è¡¨)

ä¿®æ”¹ç”¨æˆ·æ ‡ç­¾å…³è”ï¼Œæ”¯æŒç§Ÿæˆ·éš”ç¦»å’ŒVIPæœŸé™ï¼š

```sql
CREATE TABLE tenant_user_type_tag (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    tenant_user_profile_id BIGINT NOT NULL REFERENCES tenant_user_profile(id) ON DELETE CASCADE,
    tag_id BIGINT NOT NULL REFERENCES user_type_tag(id) ON DELETE CASCADE,
    tenant_id BIGINT NOT NULL REFERENCES tenants_tenant(id) ON DELETE CASCADE,  -- å†—ä½™å­—æ®µ
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,          -- å†—ä½™å­—æ®µ
    
    -- æˆäºˆä¿¡æ¯
    granted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    granted_by_id BIGINT,                      -- æˆäºˆäººIDï¼ˆç³»ç»Ÿæˆäºˆä¸ºNULLï¼‰
    grant_reason TEXT,                         -- æˆäºˆåŸå› 
    grant_method VARCHAR(50) NOT NULL,         -- æˆäºˆæ–¹å¼ï¼špayment, manual, auto, promotion, migration
    
    -- VIPæœŸé™ç®¡ç†
    expires_at TIMESTAMP WITH TIME ZONE,       -- è¿‡æœŸæ—¶é—´
    original_duration_days INTEGER,            -- åŸå§‹æœ‰æ•ˆæœŸå¤©æ•°
    extended_days INTEGER DEFAULT 0,           -- å»¶æœŸå¤©æ•°
    auto_renewal BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦è‡ªåŠ¨ç»­æœŸ
    renewal_count INTEGER DEFAULT 0,           -- ç»­æœŸæ¬¡æ•°
    
    -- æœŸé™è®¡ç®—è¾…åŠ©å­—æ®µ
    grace_period_days INTEGER DEFAULT 0,       -- å®½é™æœŸå¤©æ•°ï¼ˆè¿‡æœŸåä»å¯ä½¿ç”¨çš„å¤©æ•°ï¼‰
    reminder_sent_at TIMESTAMP WITH TIME ZONE, -- è¿‡æœŸæé†’å‘é€æ—¶é—´
    renewal_reminder_sent BOOLEAN DEFAULT FALSE, -- æ˜¯å¦å·²å‘é€ç»­æœŸæé†’
    
    -- ä½¿ç”¨ç»Ÿè®¡
    last_used_at TIMESTAMP WITH TIME ZONE,     -- æœ€åä½¿ç”¨æ—¶é—´
    usage_count INTEGER DEFAULT 0,             -- ä½¿ç”¨æ¬¡æ•°
    benefits_used JSONB DEFAULT '{}',          -- å·²ä½¿ç”¨çš„ç¦åˆ©è®°å½•
    
    -- æ”¯ä»˜ä¿¡æ¯ï¼ˆç”¨äºVIPç­‰ä»˜è´¹æ ‡ç­¾ï¼‰
    payment_id BIGINT,                         -- å…³è”çš„æ”¯ä»˜è®°å½•ID
    payment_amount DECIMAL(10,2),              -- æ”¯ä»˜é‡‘é¢
    payment_currency VARCHAR(3) DEFAULT 'CNY', -- æ”¯ä»˜è´§å¸
    
    -- çŠ¶æ€ç®¡ç†
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    status VARCHAR(20) DEFAULT 'active',       -- çŠ¶æ€ï¼šactive, expired, suspended, cancelled, grace_period
    
    -- å¤‡æ³¨ä¿¡æ¯
    notes TEXT,                                -- å¤‡æ³¨ä¿¡æ¯
    metadata JSONB DEFAULT '{}',               -- æ‰©å±•å…ƒæ•°æ®
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    CONSTRAINT unique_tenant_member_tag UNIQUE (tenant_id, member_id, tag_id),
    CONSTRAINT valid_expiry CHECK (expires_at IS NULL OR expires_at > granted_at),
    CONSTRAINT valid_duration CHECK (original_duration_days IS NULL OR original_duration_days > 0),
    CONSTRAINT valid_payment_amount CHECK (payment_amount IS NULL OR payment_amount >= 0)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_tenant_user_type_tag_profile ON tenant_user_type_tag (tenant_user_profile_id, is_active);
CREATE INDEX idx_tenant_user_type_tag_tenant_member ON tenant_user_type_tag (tenant_id, member_id, is_active);
CREATE INDEX idx_tenant_user_type_tag_expires ON tenant_user_type_tag (tenant_id, expires_at) 
    WHERE expires_at IS NOT NULL AND is_active = TRUE;
CREATE INDEX idx_tenant_user_type_tag_payment ON tenant_user_type_tag (payment_id) 
    WHERE payment_id IS NOT NULL;
CREATE INDEX idx_tenant_user_type_tag_renewal ON tenant_user_type_tag (tenant_id, auto_renewal, expires_at)
    WHERE auto_renewal = TRUE AND is_active = TRUE;

COMMENT ON TABLE tenant_user_type_tag IS 'ç§Ÿæˆ·ç”¨æˆ·æ ‡ç­¾å…³è”è¡¨ï¼Œæ”¯æŒVIPæœŸé™ç®¡ç†å’Œç§Ÿæˆ·éš”ç¦»';
COMMENT ON COLUMN tenant_user_type_tag.grace_period_days IS 'VIPè¿‡æœŸåçš„å®½é™æœŸï¼Œå…è®¸ç”¨æˆ·åœ¨æ­¤æœŸé—´ä»äº«å—éƒ¨åˆ†æƒç›Š';
COMMENT ON COLUMN tenant_user_type_tag.auto_renewal IS 'è‡ªåŠ¨ç»­æœŸæ ‡è¯†ï¼Œå¯ä¸æ”¯ä»˜ç³»ç»Ÿé›†æˆå®ç°è‡ªåŠ¨ç»­è´¹';
```

## ğŸ”§ VIPæœŸé™ç®¡ç†æœºåˆ¶

### VIPæœŸé™è®¡ç®—é€»è¾‘

```python
class VipExpirationManager:
    """VIPæœŸé™ç®¡ç†å™¨"""
    
    def calculate_vip_status(self, tenant_user_tag_relation):
        """è®¡ç®—VIPçŠ¶æ€"""
        
        now = timezone.now()
        
        # 1. æ£€æŸ¥åŸºç¡€è¿‡æœŸæ—¶é—´
        if not tenant_user_tag_relation.expires_at:
            return {
                'status': 'permanent',
                'is_active': True,
                'days_remaining': None,
                'grace_period_remaining': None
            }
        
        expires_at = tenant_user_tag_relation.expires_at
        
        # 2. æœªè¿‡æœŸ
        if now < expires_at:
            days_remaining = (expires_at - now).days
            return {
                'status': 'active',
                'is_active': True,
                'days_remaining': days_remaining,
                'expires_at': expires_at,
                'needs_renewal_reminder': days_remaining <= 7  # 7å¤©å†…æé†’ç»­è´¹
            }
        
        # 3. å·²è¿‡æœŸï¼Œæ£€æŸ¥å®½é™æœŸ
        grace_period_days = tenant_user_tag_relation.grace_period_days or 0
        grace_period_end = expires_at + timedelta(days=grace_period_days)
        
        if now <= grace_period_end:
            grace_days_remaining = (grace_period_end - now).days
            return {
                'status': 'grace_period',
                'is_active': True,  # å®½é™æœŸå†…ä»å¯ä½¿ç”¨
                'days_remaining': 0,
                'grace_period_remaining': grace_days_remaining,
                'expires_at': expires_at,
                'grace_period_end': grace_period_end
            }
        
        # 4. å½»åº•è¿‡æœŸ
        return {
            'status': 'expired',
            'is_active': False,
            'days_remaining': 0,
            'grace_period_remaining': 0,
            'expired_days': (now - grace_period_end).days
        }
    
    def extend_vip_period(self, tenant_user_tag_id, extend_days, reason=""):
        """å»¶é•¿VIPæœŸé™"""
        
        with transaction.atomic():
            relation = TenantUserTypeTag.objects.select_for_update().get(
                id=tenant_user_tag_id
            )
            
            if relation.expires_at:
                # ä»å½“å‰è¿‡æœŸæ—¶é—´å»¶é•¿
                new_expires_at = relation.expires_at + timedelta(days=extend_days)
            else:
                # æ°¸ä¹…VIPè®¾ç½®è¿‡æœŸæ—¶é—´
                new_expires_at = timezone.now() + timedelta(days=extend_days)
            
            relation.expires_at = new_expires_at
            relation.extended_days = (relation.extended_days or 0) + extend_days
            relation.updated_at = timezone.now()
            relation.save()
            
            # è®°å½•å»¶æœŸæ—¥å¿—
            self._log_vip_extension(relation, extend_days, reason)
            
            return new_expires_at
    
    def setup_auto_renewal(self, tenant_user_tag_id, payment_method_id):
        """è®¾ç½®è‡ªåŠ¨ç»­æœŸ"""
        
        relation = TenantUserTypeTag.objects.get(id=tenant_user_tag_id)
        relation.auto_renewal = True
        relation.metadata = relation.metadata or {}
        relation.metadata['auto_renewal_payment_method'] = payment_method_id
        relation.save()
        
        # åˆ›å»ºè‡ªåŠ¨ç»­æœŸä»»åŠ¡
        schedule_auto_renewal_check.apply_async(
            args=[tenant_user_tag_id],
            eta=relation.expires_at - timedelta(days=3)  # æå‰3å¤©æ£€æŸ¥ç»­æœŸ
        )
```

### VIPæœŸé™æ£€æŸ¥ä»»åŠ¡

```python
@shared_task
def check_vip_expirations():
    """æ£€æŸ¥VIPè¿‡æœŸçŠ¶æ€çš„å®šæ—¶ä»»åŠ¡"""
    
    now = timezone.now()
    
    # 1. æŸ¥æ‰¾å³å°†è¿‡æœŸçš„VIPï¼ˆ7å¤©å†…ï¼‰
    soon_expire_tags = TenantUserTypeTag.objects.filter(
        tag__tag_code='vip',
        is_active=True,
        expires_at__lte=now + timedelta(days=7),
        expires_at__gt=now,
        renewal_reminder_sent=False
    )
    
    for tag_relation in soon_expire_tags:
        # å‘é€ç»­æœŸæé†’
        send_vip_renewal_reminder.delay(tag_relation.id)
        
        # æ ‡è®°å·²å‘é€æé†’
        tag_relation.renewal_reminder_sent = True
        tag_relation.save(update_fields=['renewal_reminder_sent'])
    
    # 2. å¤„ç†å·²è¿‡æœŸä½†åœ¨å®½é™æœŸå†…çš„VIP
    grace_period_tags = TenantUserTypeTag.objects.filter(
        tag__tag_code='vip',
        is_active=True,
        expires_at__lt=now,
        status='active'
    )
    
    for tag_relation in grace_period_tags:
        grace_period_end = tag_relation.expires_at + timedelta(
            days=tag_relation.grace_period_days or 0
        )
        
        if now <= grace_period_end:
            # è¿›å…¥å®½é™æœŸ
            tag_relation.status = 'grace_period'
            tag_relation.save(update_fields=['status'])
            
            # å‘é€å®½é™æœŸé€šçŸ¥
            send_vip_grace_period_notice.delay(tag_relation.id)
        else:
            # å½»åº•è¿‡æœŸ
            tag_relation.is_active = False
            tag_relation.status = 'expired'
            tag_relation.save(update_fields=['is_active', 'status'])
            
            # å‘é€è¿‡æœŸé€šçŸ¥
            send_vip_expired_notice.delay(tag_relation.id)
            
            # æ¸…é™¤æƒé™ç¼“å­˜
            clear_user_permission_cache.delay(
                tag_relation.tenant_id, 
                tag_relation.member_id
            )
    
    # 3. å¤„ç†è‡ªåŠ¨ç»­æœŸ
    auto_renewal_tags = TenantUserTypeTag.objects.filter(
        tag__tag_code='vip',
        is_active=True,
        auto_renewal=True,
        expires_at__lte=now + timedelta(days=1),  # æå‰1å¤©ç»­æœŸ
        expires_at__gt=now
    )
    
    for tag_relation in auto_renewal_tags:
        try_auto_renewal.delay(tag_relation.id)

@shared_task
def try_auto_renewal(tenant_user_tag_id):
    """å°è¯•è‡ªåŠ¨ç»­æœŸVIP"""
    
    try:
        tag_relation = TenantUserTypeTag.objects.get(id=tenant_user_tag_id)
        
        # è·å–æ”¯ä»˜æ–¹å¼
        payment_method_id = tag_relation.metadata.get('auto_renewal_payment_method')
        if not payment_method_id:
            logger.warning(f"VIPè‡ªåŠ¨ç»­æœŸå¤±è´¥ï¼šæœªæ‰¾åˆ°æ”¯ä»˜æ–¹å¼ (tag_id: {tenant_user_tag_id})")
            return
        
        # è®¡ç®—ç»­æœŸè´¹ç”¨
        tag = tag_relation.tag
        renewal_price = tag.price_config.get('renewal_price', tag.price_config.get('price', 0))
        
        # å°è¯•æ”¯ä»˜
        payment_result = process_vip_renewal_payment(
            member_id=tag_relation.member_id,
            tenant_id=tag_relation.tenant_id,
            amount=renewal_price,
            payment_method_id=payment_method_id
        )
        
        if payment_result['success']:
            # ç»­æœŸæˆåŠŸ
            original_duration = tag_relation.original_duration_days or 365
            extend_days = original_duration
            
            VipExpirationManager().extend_vip_period(
                tenant_user_tag_id, 
                extend_days, 
                f"è‡ªåŠ¨ç»­æœŸ - æ”¯ä»˜ID: {payment_result['payment_id']}"
            )
            
            tag_relation.renewal_count += 1
            tag_relation.payment_id = payment_result['payment_id']
            tag_relation.payment_amount = renewal_price
            tag_relation.save()
            
            # å‘é€ç»­æœŸæˆåŠŸé€šçŸ¥
            send_vip_renewal_success_notice.delay(tenant_user_tag_id)
            
            logger.info(f"VIPè‡ªåŠ¨ç»­æœŸæˆåŠŸ (tag_id: {tenant_user_tag_id})")
        else:
            # ç»­æœŸå¤±è´¥
            logger.warning(f"VIPè‡ªåŠ¨ç»­æœŸæ”¯ä»˜å¤±è´¥: {payment_result['error']} (tag_id: {tenant_user_tag_id})")
            
            # å‘é€ç»­æœŸå¤±è´¥é€šçŸ¥
            send_vip_renewal_failed_notice.delay(tenant_user_tag_id, payment_result['error'])
            
    except Exception as e:
        logger.error(f"VIPè‡ªåŠ¨ç»­æœŸå¼‚å¸¸: {str(e)} (tag_id: {tenant_user_tag_id})")
```

## ğŸ”„ å¤šç§Ÿæˆ·æƒé™è®¡ç®—

### ç§Ÿæˆ·éš”ç¦»çš„æƒé™æœåŠ¡

```python
class TenantAwarePermissionService:
    """æ”¯æŒå¤šç§Ÿæˆ·çš„æƒé™è®¡ç®—æœåŠ¡"""
    
    def get_user_permissions(self, member_id: int, tenant_id: int, force_refresh: bool = False):
        """è·å–ç”¨æˆ·åœ¨ç‰¹å®šç§Ÿæˆ·ä¸‹çš„æƒé™"""
        
        cache_key = f"tenant_perms:{tenant_id}:{member_id}"
        
        if not force_refresh:
            cached_perms = cache.get(cache_key)
            if cached_perms:
                return cached_perms
        
        # è®¡ç®—ç§Ÿæˆ·ç”¨æˆ·æƒé™
        permissions = self._calculate_tenant_user_permissions(member_id, tenant_id)
        
        # ç¼“å­˜ç»“æœï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
        cache.set(cache_key, permissions, self.CACHE_TIMEOUT)
        
        return permissions
    
    def _calculate_tenant_user_permissions(self, member_id: int, tenant_id: int):
        """è®¡ç®—ç§Ÿæˆ·ç”¨æˆ·æƒé™"""
        
        try:
            # è·å–æˆ–åˆ›å»ºç§Ÿæˆ·ç”¨æˆ·æ¡£æ¡ˆ
            profile, created = TenantUserProfile.objects.get_or_create(
                member_id=member_id,
                tenant_id=tenant_id,
                defaults={
                    'total_points': 0,
                    'available_points': 0,
                }
            )
            
            if created:
                # æ–°ç”¨æˆ·ï¼Œè®¾ç½®é»˜è®¤ç­‰çº§
                default_level = UserLevel.objects.filter(
                    level_order=1, is_active=True
                ).first()
                if default_level:
                    profile.current_level = default_level
                    profile.save()
        
        except Exception as e:
            logger.error(f"è·å–ç§Ÿæˆ·ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥: member_id={member_id}, tenant_id={tenant_id}, error={str(e)}")
            return self._get_default_permissions(member_id, tenant_id)
        
        # 1. è·å–åŸºç¡€ç­‰çº§æƒé™
        level_permissions, level_quota = self._get_level_permissions(profile)
        
        # 2. è·å–ç§Ÿæˆ·ç”¨æˆ·æ ‡ç­¾æƒé™
        tag_permissions_list, tag_quota_modifiers = self._get_tenant_tag_permissions(profile)
        
        # 3. åˆå¹¶æƒé™
        final_permissions = self._merge_permissions(level_permissions, tag_permissions_list)
        
        # 4. è®¡ç®—æœ€ç»ˆé…é¢ï¼ˆè€ƒè™‘ç§Ÿæˆ·å€æ•°ï¼‰
        final_quota = self._calculate_tenant_final_quota(
            level_quota, tag_quota_modifiers, profile.points_multiplier
        )
        
        return {
            'member_id': member_id,
            'tenant_id': tenant_id,
            'profile_id': profile.id,
            'level': {
                'id': profile.current_level.id if profile.current_level else None,
                'name': profile.current_level.level_name if profile.current_level else 'æœªè®¾ç½®',
                'code': profile.current_level.level_code if profile.current_level else 'none',
                'order': profile.current_level.level_order if profile.current_level else 0,
            },
            'total_points': profile.total_points,
            'available_points': profile.available_points,
            'points_multiplier': float(profile.points_multiplier),
            'permissions': final_permissions,
            'quota': final_quota,
            'tags': self._get_tenant_tag_info(profile),
            'calculated_at': timezone.now().isoformat(),
        }
    
    def _get_tenant_tag_permissions(self, profile):
        """è·å–ç§Ÿæˆ·æ ‡ç­¾æƒé™"""
        
        # è·å–å½“å‰æœ‰æ•ˆçš„æ ‡ç­¾ï¼ˆè€ƒè™‘VIPè¿‡æœŸçŠ¶æ€ï¼‰
        active_tag_relations = TenantUserTypeTag.objects.filter(
            tenant_user_profile=profile,
            is_active=True
        ).select_related('tag')
        
        tag_permissions = []
        tag_quota_modifiers = []
        
        vip_manager = VipExpirationManager()
        
        for tag_relation in active_tag_relations:
            # æ£€æŸ¥VIPç­‰æœ‰æœŸé™æ ‡ç­¾çš„çŠ¶æ€
            if tag_relation.expires_at:
                vip_status = vip_manager.calculate_vip_status(tag_relation)
                if not vip_status['is_active']:
                    # æ ‡ç­¾å·²è¿‡æœŸï¼Œè·³è¿‡
                    continue
                
                # å¦‚æœåœ¨å®½é™æœŸï¼Œå¯èƒ½æœ‰æƒé™é™çº§
                if vip_status['status'] == 'grace_period':
                    # å®½é™æœŸå†…æƒé™å¯èƒ½æœ‰æ‰€é™åˆ¶
                    grace_permissions = self._get_grace_period_permissions(tag_relation.tag)
                    tag_permissions.append(grace_permissions)
                    
                    grace_quota = self._get_grace_period_quota_modifiers(tag_relation.tag)
                    tag_quota_modifiers.append(grace_quota)
                else:
                    # æ­£å¸¸æƒé™
                    tag_permissions.append(tag_relation.tag.permission_modifiers or {})
                    tag_quota_modifiers.append(tag_relation.tag.quota_modifiers or {})
            else:
                # æ°¸ä¹…æ ‡ç­¾
                tag_permissions.append(tag_relation.tag.permission_modifiers or {})
                tag_quota_modifiers.append(tag_relation.tag.quota_modifiers or {})
        
        return tag_permissions, tag_quota_modifiers
    
    def _get_grace_period_permissions(self, tag):
        """è·å–å®½é™æœŸæƒé™ï¼ˆå¯èƒ½æœ‰æ‰€é™åˆ¶ï¼‰"""
        
        base_permissions = tag.permission_modifiers or {}
        grace_permissions = base_permissions.copy()
        
        # å®½é™æœŸå¯èƒ½é™åˆ¶æŸäº›æƒé™
        if tag.tag_code == 'vip':
            # VIPå®½é™æœŸï¼šä¿ç•™åŸºç¡€æƒé™ï¼Œé™åˆ¶é«˜çº§æƒé™
            grace_permissions.pop('batch_operations', None)
            grace_permissions.pop('api_unlimited', None)
            grace_permissions['support_level'] = 'standard'  # é™çº§æ”¯æŒç­‰çº§
        
        return grace_permissions
    
    def invalidate_tenant_user_cache(self, member_id: int, tenant_id: int):
        """æ¸…é™¤ç§Ÿæˆ·ç”¨æˆ·æƒé™ç¼“å­˜"""
        cache_key = f"tenant_perms:{tenant_id}:{member_id}"
        cache.delete(cache_key)
```

## ğŸ“‹ æ€»ç»“

### ğŸ¯ æ ¸å¿ƒä¿®æ­£ç‚¹

1. **Memberè¡¨ä¿æŒä¸å˜**: æ‰€æœ‰ç§¯åˆ†å’Œç­‰çº§ä¿¡æ¯å­˜å‚¨åœ¨ `TenantUserProfile` è¡¨ä¸­
2. **å®Œæ•´ç§Ÿæˆ·éš”ç¦»**: åŒä¸€ç”¨æˆ·åœ¨ä¸åŒç§Ÿæˆ·ä¸‹æ‹¥æœ‰ç‹¬ç«‹çš„ç§¯åˆ†ã€ç­‰çº§å’Œæ ‡ç­¾
3. **VIPæœŸé™ç²¾ç¡®ç®¡ç†**: æ”¯æŒè¿‡æœŸæ—¶é—´ã€å®½é™æœŸã€è‡ªåŠ¨ç»­æœŸç­‰å®Œæ•´çš„æœŸé™ç®¡ç†
4. **å¤šç§Ÿæˆ·æƒé™è®¡ç®—**: æƒé™ç¼“å­˜å’Œè®¡ç®—éƒ½æŒ‰ç§Ÿæˆ·éš”ç¦»

### ğŸ”§ VIPæœŸé™ç®¡ç†ç‰¹æ€§

- **çµæ´»æœŸé™è®¾ç½®**: æ”¯æŒå¤©æ•°ã€æœˆæ•°ã€å¹´æ•°ç­‰å¤šç§æœŸé™å•ä½
- **å®½é™æœŸæœºåˆ¶**: VIPè¿‡æœŸåä»å¯åœ¨å®½é™æœŸå†…ä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½
- **è‡ªåŠ¨ç»­æœŸ**: æ”¯æŒç»‘å®šæ”¯ä»˜æ–¹å¼çš„è‡ªåŠ¨ç»­è´¹
- **æé†’æœºåˆ¶**: è¿‡æœŸå‰æé†’ã€å®½é™æœŸæé†’ã€ç»­è´¹å¤±è´¥æé†’
- **ä½¿ç”¨ç»Ÿè®¡**: è®°å½•VIPåŠŸèƒ½ä½¿ç”¨æƒ…å†µå’Œé¢‘æ¬¡

### ğŸš€ ç³»ç»Ÿä¼˜åŠ¿

- **æ•°æ®éš”ç¦»**: å®Œç¾æ”¯æŒå¤šç§Ÿæˆ·ç¯å¢ƒ
- **æ‰©å±•æ€§å¼º**: æ¯ä¸ªç§Ÿæˆ·å¯ä»¥æœ‰ä¸åŒçš„ç§¯åˆ†æ”¿ç­–
- **ç¨³å®šæ€§é«˜**: ä¸ä¿®æ”¹æ ¸å¿ƒMemberè¡¨ï¼Œé™ä½é£é™©
- **åŠŸèƒ½å®Œæ•´**: VIPç®¡ç†åŠŸèƒ½ä¸€åº”ä¿±å…¨

è¿™ä¸ªä¿®æ­£æ–¹æ¡ˆå®Œç¾è§£å†³äº†å¤šç§Ÿæˆ·ç§¯åˆ†éš”ç¦»å’ŒVIPæœŸé™ç®¡ç†çš„é—®é¢˜ï¼
