# æœ€ä½³å®è·µ

## ğŸ¯ å¼€å‘è§„èŒƒ

### ä»£ç è´¨é‡æ ‡å‡†

#### å‘½åè§„èŒƒ
```python
# ç±»åï¼šä½¿ç”¨å¸•æ–¯å¡å‘½åæ³•
class LicenseAssignmentDomainService:
    pass

# æ–¹æ³•åï¼šä½¿ç”¨è›‡å½¢å‘½åæ³•ï¼ŒåŠ¨è¯å¼€å¤´
def assign_license_to_member(self, member_id: int, license_id: int):
    pass

# å˜é‡åï¼šä½¿ç”¨è›‡å½¢å‘½åæ³•ï¼Œåè¯ä¼˜å…ˆ
assignment_count = 0
user_licenses = []

# å¸¸é‡ï¼šå…¨å¤§å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”
MAX_ASSIGNMENT_RETRY_COUNT = 3
DEFAULT_ASSIGNMENT_EXPIRES_DAYS = 365
```

#### æ³¨é‡Šå’Œæ–‡æ¡£è§„èŒƒ
```python
class LicenseAssignmentDomainService:
    """
    è®¸å¯è¯åˆ†é…é¢†åŸŸæœåŠ¡
    
    èŒè´£ï¼š
    - å¤„ç†è®¸å¯è¯ä¸ç”¨æˆ·çš„åˆ†é…é€»è¾‘
    - ç®¡ç†åˆ†é…çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ
    - æ§åˆ¶åˆ†é…é…é¢å’Œé™åˆ¶
    - éªŒè¯åˆ†é…çš„ä¸šåŠ¡è§„åˆ™
    
    è®¾è®¡åŸåˆ™ï¼š
    - æ— çŠ¶æ€æœåŠ¡ï¼Œä¸ä¿å­˜å†…éƒ¨çŠ¶æ€
    - å•ä¸€èŒè´£ï¼Œåªå¤„ç†åˆ†é…ç›¸å…³ä¸šåŠ¡
    - ä¾èµ–æ³¨å…¥ï¼Œä¾¿äºæµ‹è¯•å’Œæ‰©å±•
    """
    
    def assign_license_to_member(
        self, 
        member_id: int, 
        license_id: int,
        assigned_by_id: int = None,
        **kwargs
    ) -> Dict[str, Any]:
        """
        å°†è®¸å¯è¯åˆ†é…ç»™æŒ‡å®šæˆå‘˜
        
        Args:
            member_id: æˆå‘˜ç”¨æˆ·ID
            license_id: è®¸å¯è¯ID  
            assigned_by_id: åˆ†é…æ“ä½œäººå‘˜ID (å¯é€‰)
            **kwargs: å…¶ä»–åˆ†é…å‚æ•°
                - assignment_type: åˆ†é…ç±»å‹
                - expires_days: æœ‰æ•ˆå¤©æ•°
                - max_devices: æœ€å¤§è®¾å¤‡æ•°
                - notes: å¤‡æ³¨ä¿¡æ¯
        
        Returns:
            Dict[str, Any]: æ“ä½œç»“æœ
            {
                'success': bool,           # æ“ä½œæ˜¯å¦æˆåŠŸ
                'assignment_id': int,      # åˆ†é…è®°å½•ID (æˆåŠŸæ—¶)
                'message': str,            # æ“ä½œæ¶ˆæ¯
                'error': str              # é”™è¯¯ä¿¡æ¯ (å¤±è´¥æ—¶)
            }
        
        Raises:
            ValidationError: å‚æ•°éªŒè¯å¤±è´¥
            PermissionDenied: æƒé™ä¸è¶³
            BusinessRuleError: ä¸šåŠ¡è§„åˆ™è¿å
        
        Examples:
            >>> service = LicenseAssignmentDomainService()
            >>> result = service.assign_license_to_member(
            ...     member_id=10,
            ...     license_id=5,
            ...     assigned_by_id=1,
            ...     assignment_type='direct'
            ... )
            >>> print(result['success'])
            True
        """
        # å®ç°é€»è¾‘...
```

#### ç±»å‹æ³¨è§£è§„èŒƒ
```python
from typing import Dict, List, Optional, Union, Any
from datetime import datetime

class LicenseAssignmentService:
    def create_assignment(
        self,
        assignment_data: Dict[str, Any]
    ) -> LicenseAssignment:
        """åˆ›å»ºåˆ†é…è®°å½•"""
        pass
    
    def find_assignments_by_criteria(
        self,
        member_id: Optional[int] = None,
        license_id: Optional[int] = None,
        status_list: Optional[List[str]] = None,
        date_range: Optional[tuple[datetime, datetime]] = None
    ) -> List[LicenseAssignment]:
        """æ ¹æ®æ¡ä»¶æŸ¥æ‰¾åˆ†é…è®°å½•"""
        pass
    
    def get_assignment_statistics(
        self,
        tenant_id: int
    ) -> Dict[str, Union[int, float, str]]:
        """è·å–åˆ†é…ç»Ÿè®¡ä¿¡æ¯"""
        pass
```

### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

#### å¼‚å¸¸å±‚æ¬¡è®¾è®¡
```python
# åŸºç¡€å¼‚å¸¸ç±»
class LicenseAssignmentException(Exception):
    """è®¸å¯è¯åˆ†é…åŸºç¡€å¼‚å¸¸"""
    
    def __init__(self, message: str, error_code: str = None, details: Dict = None):
        self.message = message
        self.error_code = error_code or self.__class__.__name__
        self.details = details or {}
        super().__init__(self.message)

# ä¸šåŠ¡å¼‚å¸¸ç±»
class QuotaExceededException(LicenseAssignmentException):
    """é…é¢è¶…é™å¼‚å¸¸"""
    
    def __init__(self, license_id: int, current_count: int, max_count: int):
        message = f"è®¸å¯è¯ {license_id} åˆ†é…é…é¢å·²æ»¡ ({current_count}/{max_count})"
        details = {
            'license_id': license_id,
            'current_count': current_count,
            'max_count': max_count
        }
        super().__init__(message, 'QUOTA_EXCEEDED', details)

class DuplicateAssignmentException(LicenseAssignmentException):
    """é‡å¤åˆ†é…å¼‚å¸¸"""
    
    def __init__(self, member_id: int, license_id: int):
        message = f"æˆå‘˜ {member_id} å·²ç»æ‹¥æœ‰è®¸å¯è¯ {license_id}"
        details = {'member_id': member_id, 'license_id': license_id}
        super().__init__(message, 'DUPLICATE_ASSIGNMENT', details)

# ä½¿ç”¨ç¤ºä¾‹
class LicenseAssignmentDomainService:
    def assign_license_to_member(self, member_id: int, license_id: int):
        try:
            # æ£€æŸ¥é…é¢
            if not self._check_quota(license_id):
                current, max_count = self._get_quota_info(license_id)
                raise QuotaExceededException(license_id, current, max_count)
            
            # æ£€æŸ¥é‡å¤åˆ†é…
            if self._is_already_assigned(member_id, license_id):
                raise DuplicateAssignmentException(member_id, license_id)
            
            # æ‰§è¡Œåˆ†é…é€»è¾‘
            return self._create_assignment(member_id, license_id)
            
        except LicenseAssignmentException:
            # é‡æ–°æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
            raise
        except Exception as e:
            # åŒ…è£…ç³»ç»Ÿå¼‚å¸¸
            logger.error(f"è®¸å¯è¯åˆ†é…ç³»ç»Ÿé”™è¯¯: {str(e)}")
            raise LicenseAssignmentException(
                "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•",
                "SYSTEM_ERROR",
                {'original_error': str(e)}
            )
```

#### é”™è¯¯æ—¥å¿—è®°å½•
```python
import logging
from datetime import datetime

# é…ç½®ä¸“ç”¨çš„ä¸šåŠ¡æ—¥å¿—è®°å½•å™¨
business_logger = logging.getLogger('license_assignment.business')
security_logger = logging.getLogger('license_assignment.security')
performance_logger = logging.getLogger('license_assignment.performance')

class AuditLogService:
    def log_assignment_operation(
        self,
        operation: str,
        user_id: int,
        assignment_id: int = None,
        success: bool = True,
        error_message: str = None,
        execution_time: float = None
    ):
        """è®°å½•åˆ†é…æ“ä½œæ—¥å¿—"""
        
        log_data = {
            'timestamp': datetime.now().isoformat(),
            'operation': operation,
            'user_id': user_id,
            'assignment_id': assignment_id,
            'success': success,
            'execution_time_ms': execution_time * 1000 if execution_time else None
        }
        
        if success:
            business_logger.info(
                f"åˆ†é…æ“ä½œæˆåŠŸ: {operation}",
                extra=log_data
            )
        else:
            business_logger.error(
                f"åˆ†é…æ“ä½œå¤±è´¥: {operation} - {error_message}",
                extra={**log_data, 'error_message': error_message}
            )
        
        # æ€§èƒ½æ—¥å¿—
        if execution_time and execution_time > 1.0:  # è¶…è¿‡1ç§’
            performance_logger.warning(
                f"åˆ†é…æ“ä½œæ€§èƒ½å‘Šè­¦: {operation}",
                extra=log_data
            )
```

### æµ‹è¯•æœ€ä½³å®è·µ

#### å•å…ƒæµ‹è¯•è§„èŒƒ
```python
import pytest
from unittest.mock import Mock, patch
from django.test import TestCase

class TestLicenseAssignmentDomainService(TestCase):
    """è®¸å¯è¯åˆ†é…é¢†åŸŸæœåŠ¡æµ‹è¯•"""
    
    def setUp(self):
        """æµ‹è¯•å‡†å¤‡"""
        self.service = LicenseAssignmentDomainService()
        self.mock_repository = Mock()
        self.service.repository = self.mock_repository
        
        # æµ‹è¯•æ•°æ®å‡†å¤‡
        self.test_member_id = 10
        self.test_license_id = 5
        self.test_assigned_by_id = 1
    
    def test_assign_license_success(self):
        """æµ‹è¯•æˆåŠŸåˆ†é…è®¸å¯è¯"""
        # Arrange
        self.mock_repository.check_quota.return_value = True
        self.mock_repository.is_already_assigned.return_value = False
        self.mock_repository.create_assignment.return_value = Mock(id=100)
        
        # Act
        result = self.service.assign_license_to_member(
            self.test_member_id,
            self.test_license_id,
            self.test_assigned_by_id
        )
        
        # Assert
        self.assertTrue(result['success'])
        self.assertEqual(result['assignment_id'], 100)
        self.mock_repository.create_assignment.assert_called_once()
    
    def test_assign_license_quota_exceeded(self):
        """æµ‹è¯•é…é¢è¶…é™æƒ…å†µ"""
        # Arrange
        self.mock_repository.check_quota.return_value = False
        self.mock_repository.get_quota_info.return_value = (5, 5)
        
        # Act & Assert
        with self.assertRaises(QuotaExceededException) as context:
            self.service.assign_license_to_member(
                self.test_member_id,
                self.test_license_id
            )
        
        self.assertEqual(context.exception.error_code, 'QUOTA_EXCEEDED')
    
    def test_assign_license_duplicate_assignment(self):
        """æµ‹è¯•é‡å¤åˆ†é…æƒ…å†µ"""
        # Arrange
        self.mock_repository.check_quota.return_value = True
        self.mock_repository.is_already_assigned.return_value = True
        
        # Act & Assert
        with self.assertRaises(DuplicateAssignmentException):
            self.service.assign_license_to_member(
                self.test_member_id,
                self.test_license_id
            )
```

#### é›†æˆæµ‹è¯•è§„èŒƒ
```python
class TestLicenseAssignmentIntegration(TestCase):
    """è®¸å¯è¯åˆ†é…é›†æˆæµ‹è¯•"""
    
    def setUp(self):
        """åˆ›å»ºæµ‹è¯•æ•°æ®"""
        self.tenant = Tenant.objects.create(name="æµ‹è¯•ç§Ÿæˆ·")
        self.member = Member.objects.create(
            username="testuser",
            email="test@example.com",
            tenant=self.tenant
        )
        self.license = License.objects.create(
            license_key="TEST-KEY-123",
            tenant=self.tenant,
            max_activations=5
        )
    
    def test_full_assignment_workflow(self):
        """æµ‹è¯•å®Œæ•´çš„åˆ†é…å·¥ä½œæµ"""
        # 1. åˆ†é…è®¸å¯è¯
        service = LicenseAssignmentDomainService()
        result = service.assign_license_to_member(
            member_id=self.member.id,
            license_id=self.license.id
        )
        
        self.assertTrue(result['success'])
        assignment_id = result['assignment_id']
        
        # 2. éªŒè¯åˆ†é…è®°å½•åˆ›å»º
        assignment = LicenseAssignment.objects.get(id=assignment_id)
        self.assertEqual(assignment.member, self.member)
        self.assertEqual(assignment.license, self.license)
        self.assertEqual(assignment.status, 'assigned')
        
        # 3. æ¿€æ´»è®¸å¯è¯
        activation_result = service.activate_assignment(
            assignment_id=assignment_id,
            device_info={'device_id': 'TEST-DEVICE-001'}
        )
        
        self.assertTrue(activation_result['success'])
        
        # 4. éªŒè¯çŠ¶æ€å˜æ›´
        assignment.refresh_from_db()
        self.assertEqual(assignment.status, 'active')
        self.assertIsNotNone(assignment.activated_at)
```

### æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

#### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```python
class OptimizedQueryPatterns:
    """ä¼˜åŒ–çš„æŸ¥è¯¢æ¨¡å¼"""
    
    def get_user_assignments_with_details(self, member_id: int):
        """è·å–ç”¨æˆ·åˆ†é…è¯¦æƒ… - ä¼˜åŒ–ç‰ˆæœ¬"""
        # ä½¿ç”¨select_relatedå‡å°‘æŸ¥è¯¢æ¬¡æ•°
        return LicenseAssignment.objects.select_related(
            'license',
            'license__product',
            'license__plan',
            'member',
            'assigned_by'
        ).prefetch_related(
            'license__machine_bindings'
        ).filter(
            member_id=member_id,
            is_deleted=False
        ).order_by('-assigned_at')
    
    def get_expiring_assignments_batch(self, days: int):
        """æ‰¹é‡è·å–å³å°†è¿‡æœŸçš„åˆ†é… - ä½¿ç”¨è¿­ä»£å™¨é¿å…å†…å­˜é—®é¢˜"""
        from django.utils import timezone
        from datetime import timedelta
        
        expiry_date = timezone.now() + timedelta(days=days)
        
        return LicenseAssignment.objects.filter(
            expires_at__lte=expiry_date,
            status__in=['assigned', 'active'],
            is_deleted=False
        ).select_related('license', 'member').iterator(chunk_size=1000)
    
    def get_license_utilization_stats(self, tenant_id: int):
        """è·å–è®¸å¯è¯åˆ©ç”¨ç‡ç»Ÿè®¡ - ä½¿ç”¨èšåˆæŸ¥è¯¢"""
        from django.db.models import Count, F, Case, When
        
        return License.objects.filter(
            tenant_id=tenant_id,
            is_deleted=False
        ).annotate(
            active_assignments=Count('assignments', filter=Q(
                assignments__status='active',
                assignments__is_deleted=False
            )),
            utilization_rate=Case(
                When(max_activations=0, then=0),
                default=F('active_assignments') * 100 / F('max_activations'),
                output_field=IntegerField()
            )
        ).values(
            'id', 'license_key', 'product__name',
            'max_activations', 'active_assignments', 'utilization_rate'
        )
```

#### ç¼“å­˜ä½¿ç”¨ç­–ç•¥
```python
from django.core.cache import cache
from functools import wraps
import hashlib
import json

def cache_result(timeout=300, vary_on=None):
    """ç»“æœç¼“å­˜è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜é”®
            cache_key_data = {
                'func': f"{func.__module__}.{func.__name__}",
                'args': args,
                'kwargs': kwargs
            }
            
            if vary_on:
                for key in vary_on:
                    if key in kwargs:
                        cache_key_data[f'vary_{key}'] = kwargs[key]
            
            cache_key = hashlib.md5(
                json.dumps(cache_key_data, sort_keys=True).encode()
            ).hexdigest()
            
            # å°è¯•ä»ç¼“å­˜è·å–
            result = cache.get(cache_key)
            if result is not None:
                return result
            
            # æ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ç»“æœ
            result = func(*args, **kwargs)
            cache.set(cache_key, result, timeout)
            
            return result
        return wrapper
    return decorator

class CachedAssignmentService:
    """å¸¦ç¼“å­˜çš„åˆ†é…æœåŠ¡"""
    
    @cache_result(timeout=600, vary_on=['member_id'])
    def get_member_assignments(self, member_id: int):
        """è·å–æˆå‘˜åˆ†é… - 10åˆ†é’Ÿç¼“å­˜"""
        return self.repository.find_by_member(member_id)
    
    @cache_result(timeout=300)
    def get_assignment_statistics(self, tenant_id: int):
        """è·å–åˆ†é…ç»Ÿè®¡ - 5åˆ†é’Ÿç¼“å­˜"""
        return self.repository.get_statistics(tenant_id)
    
    def invalidate_member_cache(self, member_id: int):
        """å¤±æ•ˆæˆå‘˜ç›¸å…³ç¼“å­˜"""
        # è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„ç¼“å­˜å¤±æ•ˆé€»è¾‘
        # å¯ä»¥ä½¿ç”¨ç¼“å­˜æ ‡ç­¾æˆ–è€…æ¨¡å¼åŒ¹é…
        pass
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### æ•°æ®éªŒè¯å’Œæ¸…ç†
```python
from django.core.exceptions import ValidationError
from typing import Any, Dict

class DataValidator:
    """æ•°æ®éªŒè¯å™¨"""
    
    @staticmethod
    def validate_assignment_data(data: Dict[str, Any]) -> Dict[str, Any]:
        """éªŒè¯åˆ†é…æ•°æ®"""
        cleaned_data = {}
        
        # æˆå‘˜IDéªŒè¯
        member_id = data.get('member_id')
        if not isinstance(member_id, int) or member_id <= 0:
            raise ValidationError("æ— æ•ˆçš„æˆå‘˜ID")
        cleaned_data['member_id'] = member_id
        
        # è®¸å¯è¯IDéªŒè¯
        license_id = data.get('license_id')
        if not isinstance(license_id, int) or license_id <= 0:
            raise ValidationError("æ— æ•ˆçš„è®¸å¯è¯ID")
        cleaned_data['license_id'] = license_id
        
        # åˆ†é…ç±»å‹éªŒè¯
        assignment_type = data.get('assignment_type', 'direct')
        valid_types = ['direct', 'group', 'auto', 'temporary']
        if assignment_type not in valid_types:
            raise ValidationError(f"æ— æ•ˆçš„åˆ†é…ç±»å‹ï¼Œå¿…é¡»æ˜¯: {valid_types}")
        cleaned_data['assignment_type'] = assignment_type
        
        # è®¾å¤‡æ•°é‡éªŒè¯
        max_devices = data.get('max_concurrent_devices', 1)
        if not isinstance(max_devices, int) or max_devices < 1 or max_devices > 100:
            raise ValidationError("è®¾å¤‡æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´")
        cleaned_data['max_concurrent_devices'] = max_devices
        
        # å¤‡æ³¨æ¸…ç† (é˜²æ­¢XSS)
        notes = data.get('assignment_notes', '')
        if notes:
            from html import escape
            cleaned_data['assignment_notes'] = escape(notes[:1000])  # é™åˆ¶é•¿åº¦
        
        return cleaned_data
```

### æƒé™æ§åˆ¶æ¨¡å¼
```python
class PermissionChecker:
    """æƒé™æ£€æŸ¥å™¨"""
    
    def check_assignment_permission(
        self,
        user: Any,
        operation: str,
        resource: Dict[str, Any]
    ) -> bool:
        """æ£€æŸ¥åˆ†é…æƒé™"""
        
        # ç§Ÿæˆ·ç®¡ç†å‘˜æƒé™æ£€æŸ¥
        if user.is_admin:
            return self._check_tenant_admin_permission(user, operation, resource)
        
        # æ™®é€šç”¨æˆ·æƒé™æ£€æŸ¥
        return self._check_member_permission(user, operation, resource)
    
    def _check_tenant_admin_permission(self, user, operation, resource):
        """æ£€æŸ¥ç§Ÿæˆ·ç®¡ç†å‘˜æƒé™"""
        tenant_id = resource.get('tenant_id')
        
        # åªèƒ½æ“ä½œè‡ªå·±ç§Ÿæˆ·çš„èµ„æº
        if user.tenant_id != tenant_id:
            return False
        
        # ç§Ÿæˆ·ç®¡ç†å‘˜å¯ä»¥è¿›è¡Œå¤§éƒ¨åˆ†æ“ä½œ
        allowed_operations = ['create', 'read', 'update', 'assign', 'revoke']
        return operation in allowed_operations
    
    def _check_member_permission(self, user, operation, resource):
        """æ£€æŸ¥æ™®é€šæˆå‘˜æƒé™"""
        member_id = resource.get('member_id')
        
        # åªèƒ½æ“ä½œè‡ªå·±çš„èµ„æº
        if user.id != member_id:
            return False
        
        # æ™®é€šæˆå‘˜åªèƒ½è¿›è¡Œåªè¯»æ“ä½œ
        allowed_operations = ['read', 'activate']
        return operation in allowed_operations
```

### å®¡è®¡æ—¥å¿—è®°å½•
```python
class SecurityAuditService:
    """å®‰å…¨å®¡è®¡æœåŠ¡"""
    
    def log_security_event(
        self,
        event_type: str,
        user_id: int,
        resource_type: str,
        resource_id: int,
        operation: str,
        success: bool,
        ip_address: str = None,
        user_agent: str = None,
        additional_data: Dict = None
    ):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        
        audit_data = {
            'event_type': event_type,
            'user_id': user_id,
            'resource_type': resource_type,
            'resource_id': resource_id,
            'operation': operation,
            'success': success,
            'ip_address': ip_address,
            'user_agent': user_agent,
            'timestamp': timezone.now(),
            'additional_data': additional_data or {}
        }
        
        # è®°å½•åˆ°æ•°æ®åº“
        SecurityAuditLog.objects.create(**audit_data)
        
        # è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
        security_logger.info(
            f"å®‰å…¨äº‹ä»¶: {event_type} - {operation} - {'æˆåŠŸ' if success else 'å¤±è´¥'}",
            extra=audit_data
        )
        
        # é«˜é£é™©äº‹ä»¶å®æ—¶å‘Šè­¦
        if event_type in ['unauthorized_access', 'privilege_escalation']:
            self._send_security_alert(audit_data)
    
    def _send_security_alert(self, audit_data):
        """å‘é€å®‰å…¨å‘Šè­¦"""
        # å®ç°å‘Šè­¦é€»è¾‘
        pass
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´æœ€ä½³å®è·µ

### ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
```python
from django.core.management.base import BaseCommand
from django.db.models import Count, Q
from datetime import datetime, timedelta

class MonitoringService:
    """ç›‘æ§æœåŠ¡"""
    
    def collect_assignment_metrics(self):
        """æ”¶é›†åˆ†é…æŒ‡æ ‡"""
        now = timezone.now()
        today = now.date()
        yesterday = today - timedelta(days=1)
        
        metrics = {
            'timestamp': now.isoformat(),
            'assignment_stats': {
                'total_assignments': LicenseAssignment.objects.filter(
                    is_deleted=False
                ).count(),
                'active_assignments': LicenseAssignment.objects.filter(
                    status='active',
                    is_deleted=False
                ).count(),
                'daily_new_assignments': LicenseAssignment.objects.filter(
                    assigned_at__date=today
                ).count(),
                'daily_activations': LicenseAssignment.objects.filter(
                    activated_at__date=today
                ).count()
            },
            'license_utilization': self._calculate_license_utilization(),
            'performance_metrics': self._collect_performance_metrics()
        }
        
        return metrics
    
    def _calculate_license_utilization(self):
        """è®¡ç®—è®¸å¯è¯åˆ©ç”¨ç‡"""
        from django.db.models import F, Avg
        
        utilization = License.objects.filter(
            is_deleted=False
        ).annotate(
            active_count=Count('assignments', filter=Q(
                assignments__status='active',
                assignments__is_deleted=False
            )),
            utilization_rate=F('active_count') * 100.0 / F('max_activations')
        ).aggregate(
            avg_utilization=Avg('utilization_rate'),
            total_licenses=Count('id'),
            fully_utilized=Count('id', filter=Q(utilization_rate=100))
        )
        
        return utilization
    
    def _collect_performance_metrics(self):
        """æ”¶é›†æ€§èƒ½æŒ‡æ ‡"""
        # è¿™é‡Œå¯ä»¥é›†æˆAPMå·¥å…·çš„æ•°æ®
        return {
            'avg_assignment_time': 0.8,  # ç§’
            'avg_query_time': 0.05,      # ç§’
            'cache_hit_rate': 85.3       # ç™¾åˆ†æ¯”
        }
```

### å¥åº·æ£€æŸ¥
```python
class HealthCheckService:
    """å¥åº·æ£€æŸ¥æœåŠ¡"""
    
    def check_system_health(self):
        """æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€"""
        checks = {
            'database': self._check_database(),
            'cache': self._check_cache(),
            'external_services': self._check_external_services(),
            'business_logic': self._check_business_logic()
        }
        
        overall_status = all(check['status'] == 'healthy' for check in checks.values())
        
        return {
            'status': 'healthy' if overall_status else 'unhealthy',
            'timestamp': timezone.now().isoformat(),
            'checks': checks
        }
    
    def _check_database(self):
        """æ£€æŸ¥æ•°æ®åº“è¿æ¥"""
        try:
            LicenseAssignment.objects.count()
            return {'status': 'healthy', 'message': 'æ•°æ®åº“è¿æ¥æ­£å¸¸'}
        except Exception as e:
            return {'status': 'unhealthy', 'message': f'æ•°æ®åº“è¿æ¥å¤±è´¥: {str(e)}'}
    
    def _check_cache(self):
        """æ£€æŸ¥ç¼“å­˜æœåŠ¡"""
        try:
            cache.set('health_check', 'ok', 10)
            result = cache.get('health_check')
            if result == 'ok':
                return {'status': 'healthy', 'message': 'ç¼“å­˜æœåŠ¡æ­£å¸¸'}
            else:
                return {'status': 'unhealthy', 'message': 'ç¼“å­˜è¯»å†™å¤±è´¥'}
        except Exception as e:
            return {'status': 'unhealthy', 'message': f'ç¼“å­˜æœåŠ¡å¼‚å¸¸: {str(e)}'}
    
    def _check_business_logic(self):
        """æ£€æŸ¥ä¸šåŠ¡é€»è¾‘"""
        try:
            # æ‰§è¡Œä¸€ä¸ªç®€å•çš„ä¸šåŠ¡æ“ä½œæµ‹è¯•
            service = LicenseAssignmentDomainService()
            # è¿™é‡Œå¯ä»¥æ‰§è¡Œä¸€äº›ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„æµ‹è¯•æ“ä½œ
            return {'status': 'healthy', 'message': 'ä¸šåŠ¡é€»è¾‘æ­£å¸¸'}
        except Exception as e:
            return {'status': 'unhealthy', 'message': f'ä¸šåŠ¡é€»è¾‘å¼‚å¸¸: {str(e)}'}
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹[æµ‹è¯•ç­–ç•¥](09_æµ‹è¯•ç­–ç•¥.md)äº†è§£å®Œæ•´çš„æµ‹è¯•æ–¹æ¡ˆ
