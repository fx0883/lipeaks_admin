# æ•°æ®è®¿é—®å±‚è®¾è®¡

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ•°æ®æŠ½è±¡
- **éš”ç¦»æ•°æ®å®ç°**: å°†æ•°æ®å­˜å‚¨ç»†èŠ‚ä»ä¸šåŠ¡é€»è¾‘ä¸­æŠ½ç¦»
- **ç»Ÿä¸€è®¿é—®æ¥å£**: æä¾›ä¸€è‡´çš„æ•°æ®è®¿é—®æ–¹å¼
- **æ”¯æŒå¤šæ•°æ®æº**: æ”¯æŒä¸åŒç±»å‹çš„æ•°æ®å­˜å‚¨

### æ€§èƒ½ä¼˜åŒ–
- **æŸ¥è¯¢ä¼˜åŒ–**: é€šè¿‡ç´¢å¼•å’ŒæŸ¥è¯¢ç­–ç•¥æå‡æ€§èƒ½
- **ç¼“å­˜é›†æˆ**: é›†æˆå¤šçº§ç¼“å­˜æœºåˆ¶
- **è¿æ¥æ± ç®¡ç†**: é«˜æ•ˆçš„æ•°æ®åº“è¿æ¥ç®¡ç†

## ğŸ—ï¸ æ•°æ®è®¿é—®æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚          æ•°æ®è®¿é—®å±‚                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                       â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Repositoryå±‚   â”‚     â”‚   QuerySetå±‚    â”‚     â”‚   Managerå±‚     â”‚
   â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
   â”‚â€¢ ä¸šåŠ¡æŸ¥è¯¢å°è£…   â”‚     â”‚â€¢ å¤æ‚æŸ¥è¯¢æ„å»º   â”‚     â”‚â€¢ æ¨¡å‹ç®¡ç†       â”‚
   â”‚â€¢ æ•°æ®è®¿é—®æ¥å£   â”‚     â”‚â€¢ æ€§èƒ½ä¼˜åŒ–       â”‚     â”‚â€¢ ç¼“å­˜ç®¡ç†       â”‚
   â”‚â€¢ äº‹åŠ¡ç®¡ç†       â”‚     â”‚â€¢ åˆ†é¡µå¤„ç†       â”‚     â”‚â€¢ æ‰¹é‡æ“ä½œ       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           æ•°æ®å­˜å‚¨å±‚                 â”‚
                    â”‚                                     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚  â”‚ PostgreSQL  â”‚  â”‚    Redis    â”‚    â”‚
                    â”‚  â”‚   ä¸»æ•°æ®åº“   â”‚  â”‚    ç¼“å­˜     â”‚    â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Repositoryæ¨¡å¼å®ç°

### 1. è®¸å¯è¯åˆ†é…ä»“å‚¨ (LicenseAssignmentRepository)

#### æ¥å£è®¾è®¡
```python
# æŠ½è±¡æ¥å£å®šä¹‰
class LicenseAssignmentRepositoryInterface:
    """è®¸å¯è¯åˆ†é…ä»“å‚¨æ¥å£"""
    
    # åŸºç¡€CRUDæ“ä½œ
    def create(self, assignment_data: dict) -> LicenseAssignment
    def get_by_id(self, assignment_id: int) -> LicenseAssignment
    def update(self, assignment_id: int, update_data: dict) -> LicenseAssignment
    def delete(self, assignment_id: int) -> bool
    
    # ä¸šåŠ¡æŸ¥è¯¢æ–¹æ³•
    def find_by_member(self, member_id: int) -> List[LicenseAssignment]
    def find_by_license(self, license_id: int) -> List[LicenseAssignment]
    def find_active_assignments(self, tenant_id: int) -> List[LicenseAssignment]
    def find_expiring_assignments(self, days: int) -> List[LicenseAssignment]
    
    # ç»Ÿè®¡æŸ¥è¯¢æ–¹æ³•
    def count_by_license(self, license_id: int) -> int
    def count_by_member(self, member_id: int) -> int
    def count_by_status(self, status: str, tenant_id: int) -> int
```

#### å…·ä½“å®ç°è¦ç‚¹

##### æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
```python
class LicenseAssignmentRepository(LicenseAssignmentRepositoryInterface):
    
    def find_by_member_with_details(self, member_id: int):
        """æŸ¥è¯¢ç”¨æˆ·çš„è®¸å¯è¯åˆ†é…è¯¦æƒ… - ä¼˜åŒ–ç‰ˆæœ¬"""
        return LicenseAssignment.objects.select_related(
            'license', 
            'license__product', 
            'license__plan',
            'member',
            'assigned_by'
        ).prefetch_related(
            'license__machine_bindings'
        ).filter(
            member_id=member_id,
            is_deleted=False
        ).order_by('-assigned_at')
    
    def find_expiring_assignments_batch(self, days: int, batch_size: int = 1000):
        """æ‰¹é‡æŸ¥è¯¢å³å°†è¿‡æœŸçš„åˆ†é…è®°å½•"""
        from django.utils import timezone
        from datetime import timedelta
        
        expiry_date = timezone.now() + timedelta(days=days)
        
        return LicenseAssignment.objects.filter(
            expires_at__lte=expiry_date,
            status__in=['assigned', 'active'],
            is_deleted=False
        ).select_related('license', 'member').iterator(chunk_size=batch_size)
```

##### äº‹åŠ¡å¤„ç†
```python
from django.db import transaction

class LicenseAssignmentRepository:
    
    @transaction.atomic
    def create_with_audit(self, assignment_data: dict, audit_data: dict):
        """åˆ›å»ºåˆ†é…è®°å½•å¹¶è®°å½•å®¡è®¡æ—¥å¿—"""
        # åˆ›å»ºåˆ†é…è®°å½•
        assignment = LicenseAssignment.objects.create(**assignment_data)
        
        # æ›´æ–°è®¸å¯è¯ç»Ÿè®¡
        self._update_license_stats(assignment.license_id)
        
        # è®°å½•å®¡è®¡æ—¥å¿—
        self._create_audit_log(assignment.id, audit_data)
        
        return assignment
    
    @transaction.atomic  
    def revoke_with_cleanup(self, assignment_id: int, revoke_reason: str):
        """æ’¤é”€åˆ†é…å¹¶æ¸…ç†ç›¸å…³æ•°æ®"""
        assignment = self.get_by_id(assignment_id)
        
        # æ›´æ–°åˆ†é…çŠ¶æ€
        assignment.status = 'revoked'
        assignment.revoked_at = timezone.now()
        assignment.assignment_notes += f"\næ’¤é”€åŸå› : {revoke_reason}"
        assignment.save()
        
        # æ¸…ç†è®¾å¤‡ç»‘å®š
        self._cleanup_device_bindings(assignment_id)
        
        # æ›´æ–°è®¸å¯è¯ç»Ÿè®¡
        self._update_license_stats(assignment.license_id)
        
        return assignment
```

### 2. å¤åˆæŸ¥è¯¢ä»“å‚¨ (CompositeQueryRepository)

#### è·¨è¡¨å¤æ‚æŸ¥è¯¢
```python
class CompositeQueryRepository:
    """å¤„ç†è·¨å¤šä¸ªæ¨¡å‹çš„å¤æ‚æŸ¥è¯¢"""
    
    def get_user_license_summary(self, member_id: int, tenant_id: int):
        """è·å–ç”¨æˆ·è®¸å¯è¯ä½¿ç”¨æ¦‚è§ˆ"""
        from django.db.models import Count, Q, Case, When, IntegerField
        
        return LicenseAssignment.objects.filter(
            member_id=member_id,
            license__tenant_id=tenant_id,
            is_deleted=False
        ).aggregate(
            total_licenses=Count('id'),
            active_licenses=Count('id', filter=Q(status='active')),
            expiring_soon=Count('id', filter=Q(
                expires_at__lte=timezone.now() + timedelta(days=30),
                status__in=['assigned', 'active']
            )),
            expired_licenses=Count('id', filter=Q(status='expired'))
        )
    
    def get_license_utilization_report(self, tenant_id: int, date_range: tuple):
        """è·å–è®¸å¯è¯åˆ©ç”¨ç‡æŠ¥å‘Š"""
        start_date, end_date = date_range
        
        return License.objects.filter(
            tenant_id=tenant_id,
            is_deleted=False
        ).annotate(
            total_assignments=Count('assignments'),
            active_assignments=Count('assignments', filter=Q(
                assignments__status='active',
                assignments__is_deleted=False
            )),
            utilization_rate=Case(
                When(max_activations=0, then=0),
                default=F('active_assignments') * 100 / F('max_activations'),
                output_field=IntegerField()
            )
        ).values(
            'id', 'license_key', 'product__name', 
            'max_activations', 'total_assignments', 
            'active_assignments', 'utilization_rate'
        )
```

## ğŸ”§ è‡ªå®šä¹‰Managerå’ŒQuerySet

### 1. è®¸å¯è¯åˆ†é…Manager
```python
class LicenseAssignmentQuerySet(models.QuerySet):
    """è®¸å¯è¯åˆ†é…æŸ¥è¯¢é›†"""
    
    def active(self):
        """æ´»è·ƒçš„åˆ†é…"""
        return self.filter(status__in=['assigned', 'active'], is_deleted=False)
    
    def expired(self):
        """å·²è¿‡æœŸçš„åˆ†é…"""
        from django.utils import timezone
        return self.filter(
            Q(expires_at__lt=timezone.now()) | Q(status='expired'),
            is_deleted=False
        )
    
    def expiring_in_days(self, days: int):
        """æŒ‡å®šå¤©æ•°å†…è¿‡æœŸçš„åˆ†é…"""
        from django.utils import timezone
        from datetime import timedelta
        
        target_date = timezone.now() + timedelta(days=days)
        return self.filter(
            expires_at__lte=target_date,
            expires_at__gt=timezone.now(),
            status__in=['assigned', 'active'],
            is_deleted=False
        )
    
    def by_tenant(self, tenant_id: int):
        """æŒ‰ç§Ÿæˆ·è¿‡æ»¤"""
        return self.filter(license__tenant_id=tenant_id)
    
    def with_license_details(self):
        """é¢„åŠ è½½è®¸å¯è¯è¯¦æƒ…"""
        return self.select_related(
            'license',
            'license__product', 
            'license__plan'
        )
    
    def with_member_details(self):
        """é¢„åŠ è½½æˆå‘˜è¯¦æƒ…"""
        return self.select_related('member')

class LicenseAssignmentManager(models.Manager):
    """è®¸å¯è¯åˆ†é…ç®¡ç†å™¨"""
    
    def get_queryset(self):
        return LicenseAssignmentQuerySet(self.model, using=self._db)
    
    def active(self):
        return self.get_queryset().active()
    
    def expired(self):
        return self.get_queryset().expired()
    
    def expiring_in_days(self, days: int):
        return self.get_queryset().expiring_in_days(days)
    
    def by_tenant(self, tenant_id: int):
        return self.get_queryset().by_tenant(tenant_id)
    
    def create_assignment(self, **kwargs):
        """åˆ›å»ºåˆ†é…è®°å½•çš„ä¾¿æ·æ–¹æ³•"""
        # è‡ªåŠ¨è®¾ç½®ä¸€äº›é»˜è®¤å€¼
        if 'assigned_at' not in kwargs:
            kwargs['assigned_at'] = timezone.now()
        
        return self.create(**kwargs)
```

### 2. æ‰©å±•ç°æœ‰æ¨¡å‹çš„Manager
```python
class ExtendedLicenseManager(models.Manager):
    """æ‰©å±•çš„è®¸å¯è¯ç®¡ç†å™¨"""
    
    def with_assignment_stats(self):
        """åŒ…å«åˆ†é…ç»Ÿè®¡çš„è®¸å¯è¯æŸ¥è¯¢"""
        from django.db.models import Count, Q
        
        return self.get_queryset().annotate(
            total_assignments=Count('assignments'),
            active_assignments=Count('assignments', filter=Q(
                assignments__status__in=['assigned', 'active'],
                assignments__is_deleted=False
            )),
            available_slots=F('max_activations') - F('active_assignments')
        )
    
    def available_for_assignment(self, tenant_id: int):
        """å¯ç”¨äºåˆ†é…çš„è®¸å¯è¯"""
        return self.with_assignment_stats().filter(
            tenant_id=tenant_id,
            status='activated',
            is_deleted=False,
            available_slots__gt=0
        )

class ExtendedMemberManager(models.Manager):
    """æ‰©å±•çš„æˆå‘˜ç®¡ç†å™¨"""
    
    def with_license_count(self):
        """åŒ…å«è®¸å¯è¯æ•°é‡çš„æˆå‘˜æŸ¥è¯¢"""
        return self.get_queryset().annotate(
            license_count=Count('license_assignments', filter=Q(
                license_assignments__status__in=['assigned', 'active'],
                license_assignments__is_deleted=False
            ))
        )
    
    def licensed_members(self, tenant_id: int):
        """æ‹¥æœ‰è®¸å¯è¯çš„æˆå‘˜"""
        return self.filter(
            tenant_id=tenant_id,
            license_assignments__isnull=False,
            license_assignments__status__in=['assigned', 'active'],
            license_assignments__is_deleted=False
        ).distinct()
```

## ğŸ“Š ç¼“å­˜ç­–ç•¥è®¾è®¡

### 1. å¤šçº§ç¼“å­˜æ¶æ„
```python
class CachedLicenseAssignmentRepository(LicenseAssignmentRepository):
    """å¸¦ç¼“å­˜çš„è®¸å¯è¯åˆ†é…ä»“å‚¨"""
    
    def __init__(self):
        self.cache_timeout = 300  # 5åˆ†é’Ÿ
        self.cache_prefix = 'license_assignment'
    
    def get_by_id(self, assignment_id: int):
        """å¸¦ç¼“å­˜çš„IDæŸ¥è¯¢"""
        cache_key = f"{self.cache_prefix}:assignment:{assignment_id}"
        
        # å°è¯•ä»ç¼“å­˜è·å–
        cached_result = cache.get(cache_key)
        if cached_result:
            return cached_result
        
        # ä»æ•°æ®åº“æŸ¥è¯¢
        assignment = super().get_by_id(assignment_id)
        
        # å†™å…¥ç¼“å­˜
        if assignment:
            cache.set(cache_key, assignment, self.cache_timeout)
        
        return assignment
    
    def find_by_member(self, member_id: int):
        """å¸¦ç¼“å­˜çš„æˆå‘˜è®¸å¯è¯æŸ¥è¯¢"""
        cache_key = f"{self.cache_prefix}:member:{member_id}"
        
        cached_result = cache.get(cache_key)
        if cached_result:
            return cached_result
        
        assignments = super().find_by_member(member_id)
        cache.set(cache_key, assignments, self.cache_timeout)
        
        return assignments
    
    def invalidate_cache(self, assignment_id: int = None, member_id: int = None):
        """ç¼“å­˜å¤±æ•ˆ"""
        if assignment_id:
            cache.delete(f"{self.cache_prefix}:assignment:{assignment_id}")
        
        if member_id:
            cache.delete(f"{self.cache_prefix}:member:{member_id}")
```

### 2. æ™ºèƒ½ç¼“å­˜æ›´æ–°
```python
class SmartCacheRepository:
    """æ™ºèƒ½ç¼“å­˜ä»“å‚¨"""
    
    def update_with_cache_invalidation(self, assignment_id: int, update_data: dict):
        """æ›´æ–°æ•°æ®å¹¶æ™ºèƒ½å¤±æ•ˆç›¸å…³ç¼“å­˜"""
        assignment = super().update(assignment_id, update_data)
        
        # å¤±æ•ˆç›´æ¥ç›¸å…³çš„ç¼“å­˜
        self.invalidate_cache(assignment_id=assignment_id)
        
        # å¤±æ•ˆæˆå‘˜ç›¸å…³ç¼“å­˜
        self.invalidate_cache(member_id=assignment.member_id)
        
        # å¦‚æœçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¤±æ•ˆè®¸å¯è¯ç»Ÿè®¡ç¼“å­˜
        if 'status' in update_data:
            self._invalidate_license_stats_cache(assignment.license_id)
        
        return assignment
```

## ğŸ” æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ç­–ç•¥
```sql
-- ç»„åˆç´¢å¼•ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
CREATE INDEX CONCURRENTLY idx_license_assignment_member_status_active 
ON license_assignment (member_id, status, assigned_at DESC) 
WHERE status IN ('assigned', 'active') AND NOT is_deleted;

-- è¿‡æœŸæŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_license_assignment_expires_status 
ON license_assignment (expires_at, status) 
WHERE expires_at IS NOT NULL AND NOT is_deleted;

-- ç§Ÿæˆ·éš”ç¦»æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_license_assignment_tenant_compound 
ON license_assignment (tenant_id, status, expires_at) 
WHERE NOT is_deleted;
```

### 2. åˆ†é¡µä¼˜åŒ–
```python
class OptimizedPagination:
    """ä¼˜åŒ–çš„åˆ†é¡µæŸ¥è¯¢"""
    
    def paginate_assignments(self, queryset, page: int, page_size: int):
        """ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä¼˜åŒ–å¤§æ•°æ®é›†æŸ¥è¯¢"""
        # ä½¿ç”¨created_atä½œä¸ºæ¸¸æ ‡å­—æ®µ
        offset = (page - 1) * page_size
        
        # å¯¹äºå¤§åç§»é‡ï¼Œä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
        if offset > 10000:
            return self._cursor_paginate(queryset, page, page_size)
        else:
            return queryset[offset:offset + page_size]
    
    def _cursor_paginate(self, queryset, page: int, page_size: int):
        """æ¸¸æ ‡åˆ†é¡µå®ç°"""
        # è·å–æ¸¸æ ‡ä½ç½®
        cursor_offset = (page - 1) * page_size
        
        # ä½¿ç”¨å­æŸ¥è¯¢è·å–æ¸¸æ ‡å€¼
        cursor_query = queryset.order_by('created_at').values_list(
            'created_at', flat=True
        )[cursor_offset:cursor_offset + 1]
        
        if cursor_query:
            cursor_value = cursor_query[0]
            return queryset.filter(created_at__gte=cursor_value).order_by(
                'created_at'
            )[:page_size]
        else:
            return queryset.none()
```

### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
```python
class BatchOperationRepository:
    """æ‰¹é‡æ“ä½œä»“å‚¨"""
    
    def bulk_create_assignments(self, assignments_data: List[dict]):
        """æ‰¹é‡åˆ›å»ºåˆ†é…è®°å½•"""
        assignments = [
            LicenseAssignment(**data) for data in assignments_data
        ]
        
        # ä½¿ç”¨bulk_createå‡å°‘æ•°æ®åº“äº¤äº’
        created_assignments = LicenseAssignment.objects.bulk_create(
            assignments, 
            batch_size=1000,
            ignore_conflicts=False
        )
        
        return created_assignments
    
    def bulk_update_status(self, assignment_ids: List[int], new_status: str):
        """æ‰¹é‡æ›´æ–°çŠ¶æ€"""
        from django.utils import timezone
        
        # æ„é€ æ›´æ–°å­—æ®µ
        update_fields = {'status': new_status}
        
        if new_status == 'revoked':
            update_fields['revoked_at'] = timezone.now()
        elif new_status == 'active':
            update_fields['activated_at'] = timezone.now()
        
        # æ‰¹é‡æ›´æ–°
        return LicenseAssignment.objects.filter(
            id__in=assignment_ids
        ).update(**update_fields)
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹[APIå±‚è®¾è®¡](06_APIå±‚è®¾è®¡.md)äº†è§£REST APIæ¥å£çš„å…·ä½“è®¾è®¡
