# 多租户积分数据模型详细设计

## 🎯 数据模型设计目标

### 🔍 基于现有代码分析的设计原则

**✅ 现有代码零修改验证**:
- 分析了`users/models.py`中的Member模型 - 确认完全原子，无需修改
- 分析了`licenses/models.py`中的License模型 - 确认完全原子，已有所需字段
- 分析了`tenants/models.py`中的Tenant模型 - 确认无需修改
- LicenseAssignment和积分系统在现有代码中完全不存在 - 可安全新建

**✅ 设计原则**:
- **现有模型零修改**: 所有现有数据模型保持100%不变
- **多租户完全隔离**: 通过新增TenantUserProfile等表实现租户数据隔离
- **高性能查询**: 专门为多租户场景优化的索引设计
- **灵活扩展**: 支持租户级积分政策和动态权限配置  
- **安全部署**: 新功能可独立部署，支持回滚，零业务风险

## 📊 完整数据模型关系图

```
                            ┌─────────────────┐
                            │     Tenant      │
                            │    (租户)       │
                            └─────────┬───────┘
                                      │ 1:N
                                      ▼
                            ┌─────────────────┐
                            │     Member      │
                            │    (用户)       │
                            │ + total_points  │
                            │ + current_level │
                            └─────┬───┬───────┘
                                  │   │
                             1:N  │   │ N:M
                                  │   │
                    ┌─────────────▼   ▼─────────────┐
                    │                               │
          ┌─────────▼─────────┐           ┌─────────▼─────────┐
          │    UserPoints     │           │  MemberTypeTag    │
          │   (积分记录)       │           │  (用户标签关联)   │
          └─────────┬─────────┘           └─────────┬─────────┘
                    │                               │
                    │                               │ N:1
                    │                               ▼
                    │                     ┌─────────────────┐
                    │                     │   UserTypeTag   │
                    │                     │   (用户标签)     │
                    │                     └─────────────────┘
                    │
          ┌─────────▼─────────┐
          │    UserLevel      │
          │   (用户等级)       │
          └───────────────────┘
```

## 🗃️ 核心表结构设计

### 1. UserLevel (用户等级表)

#### 表结构
```sql
CREATE TABLE user_level (
    id BIGSERIAL PRIMARY KEY,
    
    -- 等级基本信息
    level_name VARCHAR(50) NOT NULL,           -- 等级名称：青铜、白银、黄金、铂金、钻石
    level_code VARCHAR(20) NOT NULL UNIQUE,    -- 等级代码：bronze, silver, gold, platinum, diamond
    level_order INTEGER NOT NULL UNIQUE,       -- 等级顺序：1, 2, 3, 4, 5
    
    -- 积分阈值
    min_points INTEGER NOT NULL,               -- 达到此等级的最小积分
    max_points INTEGER,                        -- 此等级的最大积分（NULL表示无上限）
    
    -- 权限配置 (JSONB格式，支持灵活查询)
    base_permissions JSONB NOT NULL DEFAULT '{}',      -- 基础权限配置
    base_quota_config JSONB NOT NULL DEFAULT '{}',     -- 基础配额配置
    
    -- 等级特权和福利
    level_benefits JSONB DEFAULT '{}',         -- 等级专属福利配置
    upgrade_rewards JSONB DEFAULT '{}',        -- 升级到此等级的奖励
    
    -- 显示配置
    level_icon VARCHAR(255),                   -- 等级图标URL
    level_color VARCHAR(7),                    -- 等级主题色(HEX)
    level_description TEXT,                    -- 等级描述说明
    
    -- 状态管理
    is_active BOOLEAN NOT NULL DEFAULT TRUE,   -- 是否启用
    sort_order INTEGER DEFAULT 0,              -- 显示排序
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- 约束
    CONSTRAINT valid_point_range CHECK (min_points >= 0),
    CONSTRAINT valid_max_points CHECK (max_points IS NULL OR max_points >= min_points),
    CONSTRAINT valid_level_order CHECK (level_order > 0)
);

-- 索引
CREATE INDEX idx_user_level_points ON user_level (min_points, max_points);
CREATE INDEX idx_user_level_order ON user_level (level_order);
CREATE INDEX idx_user_level_active ON user_level (is_active) WHERE is_active = TRUE;

-- 注释
COMMENT ON TABLE user_level IS '用户等级配置表，定义基于积分的用户等级体系';
COMMENT ON COLUMN user_level.base_permissions IS '基础权限JSON: {"license_request": true, "api_access": false}';
COMMENT ON COLUMN user_level.base_quota_config IS '基础配额JSON: {"max_licenses": 10, "max_devices_per_license": 3}';
```

#### 初始数据
```sql
INSERT INTO user_level (level_name, level_code, level_order, min_points, max_points, base_permissions, base_quota_config, level_benefits, level_color) VALUES
('青铜', 'bronze', 1, 0, 999, 
 '{"license_request": true, "basic_features": true, "support_level": "standard"}',
 '{"max_licenses": 2, "max_devices_per_license": 1, "license_duration_days": 365, "api_rate_limit": 100}',
 '{"welcome_bonus": 50, "monthly_free_quota": 1}',
 '#CD7F32'),

('白银', 'silver', 2, 1000, 2999,
 '{"license_request": true, "basic_features": true, "analytics_basic": true, "support_level": "priority"}',
 '{"max_licenses": 5, "max_devices_per_license": 2, "license_duration_days": 365, "api_rate_limit": 500}',
 '{"upgrade_bonus": 100, "monthly_free_quota": 2, "feature_trial": ["analytics"]}',
 '#C0C0C0'),

('黄金', 'gold', 3, 3000, 5999,
 '{"license_request": true, "advanced_features": true, "analytics_full": true, "api_access_basic": true, "support_level": "vip"}',
 '{"max_licenses": 10, "max_devices_per_license": 3, "license_duration_days": 730, "api_rate_limit": 2000}',
 '{"upgrade_bonus": 200, "monthly_free_quota": 5, "priority_support": true}',
 '#FFD700'),

('铂金', 'platinum', 4, 6000, 9999,
 '{"license_request": true, "all_features": true, "api_access_full": true, "batch_operations": true, "support_level": "premium"}',
 '{"max_licenses": 25, "max_devices_per_license": 5, "license_duration_days": 730, "api_rate_limit": 10000}',
 '{"upgrade_bonus": 500, "monthly_free_quota": 10, "dedicated_support": true, "beta_access": true}',
 '#E5E4E2'),

('钻石', 'diamond', 5, 10000, NULL,
 '{"license_request": true, "unlimited_features": true, "api_access_unlimited": true, "admin_features": true, "support_level": "exclusive"}',
 '{"max_licenses": 100, "max_devices_per_license": 10, "license_duration_days": 1095, "api_rate_limit": -1}',
 '{"upgrade_bonus": 1000, "monthly_free_quota": -1, "exclusive_support": true, "early_access": true, "custom_features": true}',
 '#B9F2FF');
```

### 2. UserPoints (用户积分记录表)

#### 表结构
```sql
CREATE TABLE user_points (
    id BIGSERIAL PRIMARY KEY,
    
    -- 关联信息
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,
    
    -- 积分类型分类
    point_type VARCHAR(50) NOT NULL,           -- 积分类型：earn(获得), spend(消费), expire(过期), adjust(调整)
    category VARCHAR(50) NOT NULL,             -- 业务分类：login, license, referral, payment, community, etc.
    subcategory VARCHAR(50),                   -- 子分类：daily_login, first_activation, etc.
    
    -- 积分数值
    points INTEGER NOT NULL,                   -- 积分变动数量（正数为获得，负数为消费）
    balance_before INTEGER NOT NULL,          -- 操作前积分余额
    balance_after INTEGER NOT NULL,           -- 操作后积分余额
    
    -- 关联信息
    source_type VARCHAR(50),                   -- 来源类型：manual, system, api, migration
    source_id BIGINT,                          -- 关联的源记录ID（如license_id, order_id等）
    source_description TEXT,                   -- 来源描述
    
    -- 积分生命周期
    earned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),  -- 积分获得时间
    expires_at TIMESTAMP WITH TIME ZONE,       -- 积分过期时间（NULL表示永不过期）
    expired_at TIMESTAMP WITH TIME ZONE,       -- 实际过期时间
    
    -- 操作信息
    operation_reason TEXT,                     -- 操作原因说明
    operator_id BIGINT,                        -- 操作人员ID（系统操作为NULL）
    batch_id VARCHAR(100),                     -- 批量操作标识
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- 状态：active, expired, cancelled, adjusted
    is_manual BOOLEAN NOT NULL DEFAULT FALSE,  -- 是否手动调整
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- 约束
    CONSTRAINT points_not_zero CHECK (points != 0),
    CONSTRAINT valid_balance CHECK (balance_after = balance_before + points),
    CONSTRAINT valid_balance_positive CHECK (balance_after >= 0)
);

-- 索引优化
CREATE INDEX idx_user_points_member_time ON user_points (member_id, created_at DESC);
CREATE INDEX idx_user_points_type_category ON user_points (point_type, category);
CREATE INDEX idx_user_points_expires ON user_points (expires_at) WHERE expires_at IS NOT NULL AND status = 'active';
CREATE INDEX idx_user_points_source ON user_points (source_type, source_id) WHERE source_id IS NOT NULL;
CREATE INDEX idx_user_points_batch ON user_points (batch_id) WHERE batch_id IS NOT NULL;

-- 分区表（可选，用于大数据量场景）
-- CREATE TABLE user_points_y2024 PARTITION OF user_points FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

COMMENT ON TABLE user_points IS '用户积分变动记录表，记录所有积分的获得、消费、过期等操作';
```

### 3. UserTypeTag (用户标签表)

#### 表结构
```sql
CREATE TABLE user_type_tag (
    id BIGSERIAL PRIMARY KEY,
    
    -- 标签基本信息
    tag_name VARCHAR(50) NOT NULL,             -- 标签名称：VIP用户、企业用户、教育用户
    tag_code VARCHAR(20) NOT NULL UNIQUE,      -- 标签代码：vip, enterprise, education
    tag_category VARCHAR(20) NOT NULL,         -- 标签分类：payment, business, special, system
    
    -- 权限加成配置
    permission_modifiers JSONB DEFAULT '{}',   -- 权限修正器
    quota_modifiers JSONB DEFAULT '{}',        -- 配额修正器
    feature_unlocks JSONB DEFAULT '{}',        -- 功能解锁配置
    
    -- 标签特权
    tag_benefits JSONB DEFAULT '{}',           -- 标签专属福利
    exclusive_features JSONB DEFAULT '{}',     -- 专属功能配置
    
    -- 获得条件
    acquisition_rules JSONB DEFAULT '{}',      -- 获得规则配置
    auto_grant_enabled BOOLEAN DEFAULT FALSE,  -- 是否支持自动授予
    
    -- 有效期管理
    default_duration_days INTEGER,             -- 默认有效期（天，NULL表示永久）
    max_duration_days INTEGER,                 -- 最大有效期（天）
    renewal_enabled BOOLEAN DEFAULT TRUE,      -- 是否支持续期
    
    -- 价格配置
    price_config JSONB DEFAULT '{}',           -- 价格配置（用于付费标签）
    
    -- 显示配置
    tag_icon VARCHAR(255),                     -- 标签图标URL
    tag_color VARCHAR(7),                      -- 标签颜色
    display_priority INTEGER DEFAULT 0,        -- 显示优先级
    description TEXT,                          -- 标签描述
    
    -- 状态管理
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_visible BOOLEAN NOT NULL DEFAULT TRUE,  -- 是否在用户界面显示
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- 约束
    CONSTRAINT valid_duration CHECK (default_duration_days IS NULL OR default_duration_days > 0)
);

-- 索引
CREATE INDEX idx_user_type_tag_category ON user_type_tag (tag_category, is_active);
CREATE INDEX idx_user_type_tag_active ON user_type_tag (is_active, is_visible);

-- 初始数据
INSERT INTO user_type_tag (tag_name, tag_code, tag_category, permission_modifiers, quota_modifiers, tag_benefits, default_duration_days, tag_color) VALUES
('VIP用户', 'vip', 'payment',
 '{"priority_support": true, "advanced_analytics": true, "feature_preview": true}',
 '{"license_multiplier": 1.5, "device_multiplier": 1.2, "duration_bonus_days": 30}',
 '{"monthly_bonus_points": 100, "exclusive_events": true, "priority_queue": true}',
 365, '#FF6B6B'),

('企业用户', 'enterprise', 'business',
 '{"bulk_operations": true, "admin_features": true, "api_full_access": true, "white_label": true}',
 '{"license_multiplier": 2.0, "device_multiplier": 2.0, "unlimited_support": true}',
 '{"dedicated_manager": true, "custom_training": true, "priority_development": true}',
 NULL, '#4ECDC4'),

('教育用户', 'education', 'special',
 '{"educational_features": true, "collaboration_tools": true, "classroom_management": true}',
 '{"license_multiplier": 1.2, "student_accounts": true, "educational_discount": 0.5}',
 '{"educational_resources": true, "teacher_training": true, "academic_support": true}',
 730, '#45B7D1'),

('开发者', 'developer', 'special',
 '{"api_unlimited": true, "beta_access": true, "debug_tools": true, "documentation_edit": true}',
 '{"api_rate_unlimited": true, "sandbox_access": true}',
 '{"developer_community": true, "early_access": true, "tech_support": true}',
 NULL, '#96CEB4');
```

### 4. MemberTypeTag (用户标签关联表)

#### 表结构
```sql
CREATE TABLE member_type_tag (
    id BIGSERIAL PRIMARY KEY,
    
    -- 关联信息
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,
    tag_id BIGINT NOT NULL REFERENCES user_type_tag(id) ON DELETE CASCADE,
    
    -- 授予信息
    granted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    granted_by_id BIGINT,                      -- 授予人ID（系统授予为NULL）
    grant_reason TEXT,                         -- 授予原因
    grant_method VARCHAR(50) NOT NULL,         -- 授予方式：payment, manual, auto, promotion
    
    -- 有效期管理
    expires_at TIMESTAMP WITH TIME ZONE,       -- 过期时间
    auto_renewal BOOLEAN DEFAULT FALSE,        -- 是否自动续期
    renewal_count INTEGER DEFAULT 0,           -- 续期次数
    
    -- 使用统计
    last_used_at TIMESTAMP WITH TIME ZONE,     -- 最后使用时间
    usage_count INTEGER DEFAULT 0,             -- 使用次数
    
    -- 状态管理
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    status VARCHAR(20) DEFAULT 'active',       -- 状态：active, expired, suspended, cancelled
    
    -- 备注信息
    notes TEXT,                                -- 备注信息
    metadata JSONB DEFAULT '{}',               -- 扩展元数据
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- 约束
    CONSTRAINT unique_member_tag UNIQUE (member_id, tag_id),
    CONSTRAINT valid_expiry CHECK (expires_at IS NULL OR expires_at > granted_at)
);

-- 索引
CREATE INDEX idx_member_type_tag_member ON member_type_tag (member_id, is_active);
CREATE INDEX idx_member_type_tag_expires ON member_type_tag (expires_at) WHERE expires_at IS NOT NULL AND is_active = TRUE;
CREATE INDEX idx_member_type_tag_granted ON member_type_tag (granted_at);
```

### 5. Member表扩展

#### 添加积分和等级字段
```sql
-- 为现有Member表添加积分相关字段
ALTER TABLE member ADD COLUMN total_points INTEGER NOT NULL DEFAULT 0;
ALTER TABLE member ADD COLUMN available_points INTEGER NOT NULL DEFAULT 0;  -- 可用积分（扣除已过期的）
ALTER TABLE member ADD COLUMN current_level_id BIGINT REFERENCES user_level(id);
ALTER TABLE member ADD COLUMN level_updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE member ADD COLUMN last_points_update TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- 创建索引
CREATE INDEX idx_member_total_points ON member (total_points DESC);
CREATE INDEX idx_member_level ON member (current_level_id);
CREATE INDEX idx_member_points_update ON member (last_points_update);

-- 添加约束
ALTER TABLE member ADD CONSTRAINT valid_points CHECK (total_points >= 0 AND available_points >= 0);
ALTER TABLE member ADD CONSTRAINT available_points_check CHECK (available_points <= total_points);

-- 注释
COMMENT ON COLUMN member.total_points IS '用户总积分数（包括已过期积分）';
COMMENT ON COLUMN member.available_points IS '用户可用积分数（排除已过期积分）';
COMMENT ON COLUMN member.current_level_id IS '当前用户等级ID';
COMMENT ON COLUMN member.level_updated_at IS '等级最后更新时间';
```

## 📊 查询优化策略

### 1. 常用查询场景优化

#### 用户权限快速查询
```sql
-- 创建用户权限视图（便于复杂查询）
CREATE VIEW user_permissions_view AS
SELECT 
    m.id as member_id,
    m.username,
    m.total_points,
    ul.level_name,
    ul.level_code,
    ul.base_permissions,
    ul.base_quota_config,
    array_agg(utt.tag_name) as active_tags,
    array_agg(utt.permission_modifiers) as tag_permissions,
    array_agg(utt.quota_modifiers) as tag_quotas
FROM member m
LEFT JOIN user_level ul ON m.current_level_id = ul.id
LEFT JOIN member_type_tag mtt ON m.id = mtt.member_id AND mtt.is_active = TRUE
LEFT JOIN user_type_tag utt ON mtt.tag_id = utt.id AND utt.is_active = TRUE
WHERE m.is_deleted = FALSE
GROUP BY m.id, m.username, m.total_points, ul.level_name, ul.level_code, ul.base_permissions, ul.base_quota_config;
```

#### 积分历史查询优化
```sql
-- 用户积分汇总视图
CREATE MATERIALIZED VIEW user_points_summary AS
SELECT 
    member_id,
    SUM(CASE WHEN point_type = 'earn' THEN points ELSE 0 END) as total_earned,
    SUM(CASE WHEN point_type = 'spend' THEN ABS(points) ELSE 0 END) as total_spent,
    SUM(CASE WHEN point_type = 'expire' THEN ABS(points) ELSE 0 END) as total_expired,
    COUNT(*) as transaction_count,
    MAX(created_at) as last_transaction,
    CURRENT_TIMESTAMP as refreshed_at
FROM user_points 
GROUP BY member_id;

-- 创建刷新索引
CREATE UNIQUE INDEX idx_user_points_summary_member ON user_points_summary (member_id);
CREATE INDEX idx_user_points_summary_refreshed ON user_points_summary (refreshed_at);

-- 定期刷新物化视图
-- REFRESH MATERIALIZED VIEW CONCURRENTLY user_points_summary;
```

### 2. 性能监控查询

#### 积分分布统计
```sql
-- 积分等级分布查询
WITH level_distribution AS (
    SELECT 
        ul.level_name,
        ul.level_code,
        ul.min_points,
        ul.max_points,
        COUNT(m.id) as user_count,
        ROUND(COUNT(m.id) * 100.0 / SUM(COUNT(m.id)) OVER (), 2) as percentage
    FROM user_level ul
    LEFT JOIN member m ON m.current_level_id = ul.id AND m.is_deleted = FALSE
    WHERE ul.is_active = TRUE
    GROUP BY ul.id, ul.level_name, ul.level_code, ul.min_points, ul.max_points
    ORDER BY ul.level_order
)
SELECT * FROM level_distribution;
```

## 🔧 数据维护策略

### 1. 积分过期处理
```sql
-- 积分过期处理存储过程
CREATE OR REPLACE FUNCTION expire_user_points()
RETURNS INTEGER AS $$
DECLARE
    expired_count INTEGER := 0;
    batch_size INTEGER := 1000;
    batch_id VARCHAR(100);
BEGIN
    -- 生成批次ID
    batch_id := 'expire_' || to_char(NOW(), 'YYYYMMDD_HH24MISS');
    
    -- 处理过期积分
    WITH expired_points AS (
        SELECT id, member_id, points, balance_after
        FROM user_points 
        WHERE expires_at <= NOW() 
          AND status = 'active'
          AND point_type = 'earn'
        LIMIT batch_size
    )
    UPDATE user_points 
    SET status = 'expired',
        expired_at = NOW(),
        batch_id = expire_user_points.batch_id
    FROM expired_points 
    WHERE user_points.id = expired_points.id;
    
    GET DIAGNOSTICS expired_count = ROW_COUNT;
    
    -- 更新用户可用积分
    UPDATE member 
    SET available_points = (
        SELECT COALESCE(SUM(points), 0)
        FROM user_points 
        WHERE member_id = member.id 
          AND status = 'active'
          AND (expires_at IS NULL OR expires_at > NOW())
    ),
    last_points_update = NOW()
    WHERE id IN (
        SELECT DISTINCT member_id 
        FROM user_points 
        WHERE batch_id = expire_user_points.batch_id
    );
    
    RETURN expired_count;
END;
$$ LANGUAGE plpgsql;
```

### 2. 等级自动更新
```sql
-- 用户等级自动更新函数
CREATE OR REPLACE FUNCTION update_user_level(p_member_id BIGINT)
RETURNS BOOLEAN AS $$
DECLARE
    current_points INTEGER;
    new_level_id BIGINT;
    old_level_id BIGINT;
    level_changed BOOLEAN := FALSE;
BEGIN
    -- 获取用户当前积分和等级
    SELECT total_points, current_level_id 
    INTO current_points, old_level_id
    FROM member 
    WHERE id = p_member_id;
    
    -- 根据积分计算新等级
    SELECT id INTO new_level_id
    FROM user_level 
    WHERE min_points <= current_points 
      AND (max_points IS NULL OR current_points <= max_points)
      AND is_active = TRUE
    ORDER BY level_order DESC
    LIMIT 1;
    
    -- 如果等级发生变化，更新用户记录
    IF old_level_id IS DISTINCT FROM new_level_id THEN
        UPDATE member 
        SET current_level_id = new_level_id,
            level_updated_at = NOW()
        WHERE id = p_member_id;
        
        level_changed := TRUE;
        
        -- 触发等级变更事件（可以通过NOTIFY实现）
        PERFORM pg_notify('user_level_changed', 
            json_build_object(
                'member_id', p_member_id,
                'old_level_id', old_level_id,
                'new_level_id', new_level_id,
                'points', current_points
            )::text
        );
    END IF;
    
    RETURN level_changed;
END;
$$ LANGUAGE plpgsql;
```

---

**下一步**: 查看[业务流程详细设计](16_业务流程详细设计.md)了解具体的业务逻辑实现
