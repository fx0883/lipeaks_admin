# å¤šç§Ÿæˆ·ç§¯åˆ†æ•°æ®æ¨¡å‹è¯¦ç»†è®¾è®¡

## ğŸ¯ æ•°æ®æ¨¡å‹è®¾è®¡ç›®æ ‡

### ğŸ” åŸºäºç°æœ‰ä»£ç åˆ†æçš„è®¾è®¡åŸåˆ™

**âœ… ç°æœ‰ä»£ç é›¶ä¿®æ”¹éªŒè¯**:
- åˆ†æäº†`users/models.py`ä¸­çš„Memberæ¨¡å‹ - ç¡®è®¤å®Œå…¨åŸå­ï¼Œæ— éœ€ä¿®æ”¹
- åˆ†æäº†`licenses/models.py`ä¸­çš„Licenseæ¨¡å‹ - ç¡®è®¤å®Œå…¨åŸå­ï¼Œå·²æœ‰æ‰€éœ€å­—æ®µ
- åˆ†æäº†`tenants/models.py`ä¸­çš„Tenantæ¨¡å‹ - ç¡®è®¤æ— éœ€ä¿®æ”¹
- LicenseAssignmentå’Œç§¯åˆ†ç³»ç»Ÿåœ¨ç°æœ‰ä»£ç ä¸­å®Œå…¨ä¸å­˜åœ¨ - å¯å®‰å…¨æ–°å»º

**âœ… è®¾è®¡åŸåˆ™**:
- **ç°æœ‰æ¨¡å‹é›¶ä¿®æ”¹**: æ‰€æœ‰ç°æœ‰æ•°æ®æ¨¡å‹ä¿æŒ100%ä¸å˜
- **å¤šç§Ÿæˆ·å®Œå…¨éš”ç¦»**: é€šè¿‡æ–°å¢TenantUserProfileç­‰è¡¨å®ç°ç§Ÿæˆ·æ•°æ®éš”ç¦»
- **é«˜æ€§èƒ½æŸ¥è¯¢**: ä¸“é—¨ä¸ºå¤šç§Ÿæˆ·åœºæ™¯ä¼˜åŒ–çš„ç´¢å¼•è®¾è®¡
- **çµæ´»æ‰©å±•**: æ”¯æŒç§Ÿæˆ·çº§ç§¯åˆ†æ”¿ç­–å’ŒåŠ¨æ€æƒé™é…ç½®  
- **å®‰å…¨éƒ¨ç½²**: æ–°åŠŸèƒ½å¯ç‹¬ç«‹éƒ¨ç½²ï¼Œæ”¯æŒå›æ»šï¼Œé›¶ä¸šåŠ¡é£é™©

## ğŸ“Š å®Œæ•´æ•°æ®æ¨¡å‹å…³ç³»å›¾

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚     Tenant      â”‚
                            â”‚    (ç§Ÿæˆ·)       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ 1:N
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚     Member      â”‚
                            â”‚    (ç”¨æˆ·)       â”‚
                            â”‚ + total_points  â”‚
                            â”‚ + current_level â”‚
                            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚   â”‚
                             1:N  â”‚   â”‚ N:M
                                  â”‚   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼   â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    UserPoints     â”‚           â”‚  MemberTypeTag    â”‚
          â”‚   (ç§¯åˆ†è®°å½•)       â”‚           â”‚  (ç”¨æˆ·æ ‡ç­¾å…³è”)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â”‚                               â”‚ N:1
                    â”‚                               â–¼
                    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚   UserTypeTag   â”‚
                    â”‚                     â”‚   (ç”¨æˆ·æ ‡ç­¾)     â”‚
                    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    UserLevel      â”‚
          â”‚   (ç”¨æˆ·ç­‰çº§)       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ƒï¸ æ ¸å¿ƒè¡¨ç»“æ„è®¾è®¡

### 1. UserLevel (ç”¨æˆ·ç­‰çº§è¡¨)

#### è¡¨ç»“æ„
```sql
CREATE TABLE user_level (
    id BIGSERIAL PRIMARY KEY,
    
    -- ç­‰çº§åŸºæœ¬ä¿¡æ¯
    level_name VARCHAR(50) NOT NULL,           -- ç­‰çº§åç§°ï¼šé’é“œã€ç™½é“¶ã€é»„é‡‘ã€é“‚é‡‘ã€é’»çŸ³
    level_code VARCHAR(20) NOT NULL UNIQUE,    -- ç­‰çº§ä»£ç ï¼šbronze, silver, gold, platinum, diamond
    level_order INTEGER NOT NULL UNIQUE,       -- ç­‰çº§é¡ºåºï¼š1, 2, 3, 4, 5
    
    -- ç§¯åˆ†é˜ˆå€¼
    min_points INTEGER NOT NULL,               -- è¾¾åˆ°æ­¤ç­‰çº§çš„æœ€å°ç§¯åˆ†
    max_points INTEGER,                        -- æ­¤ç­‰çº§çš„æœ€å¤§ç§¯åˆ†ï¼ˆNULLè¡¨ç¤ºæ— ä¸Šé™ï¼‰
    
    -- æƒé™é…ç½® (JSONBæ ¼å¼ï¼Œæ”¯æŒçµæ´»æŸ¥è¯¢)
    base_permissions JSONB NOT NULL DEFAULT '{}',      -- åŸºç¡€æƒé™é…ç½®
    base_quota_config JSONB NOT NULL DEFAULT '{}',     -- åŸºç¡€é…é¢é…ç½®
    
    -- ç­‰çº§ç‰¹æƒå’Œç¦åˆ©
    level_benefits JSONB DEFAULT '{}',         -- ç­‰çº§ä¸“å±ç¦åˆ©é…ç½®
    upgrade_rewards JSONB DEFAULT '{}',        -- å‡çº§åˆ°æ­¤ç­‰çº§çš„å¥–åŠ±
    
    -- æ˜¾ç¤ºé…ç½®
    level_icon VARCHAR(255),                   -- ç­‰çº§å›¾æ ‡URL
    level_color VARCHAR(7),                    -- ç­‰çº§ä¸»é¢˜è‰²(HEX)
    level_description TEXT,                    -- ç­‰çº§æè¿°è¯´æ˜
    
    -- çŠ¶æ€ç®¡ç†
    is_active BOOLEAN NOT NULL DEFAULT TRUE,   -- æ˜¯å¦å¯ç”¨
    sort_order INTEGER DEFAULT 0,              -- æ˜¾ç¤ºæ’åº
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- çº¦æŸ
    CONSTRAINT valid_point_range CHECK (min_points >= 0),
    CONSTRAINT valid_max_points CHECK (max_points IS NULL OR max_points >= min_points),
    CONSTRAINT valid_level_order CHECK (level_order > 0)
);

-- ç´¢å¼•
CREATE INDEX idx_user_level_points ON user_level (min_points, max_points);
CREATE INDEX idx_user_level_order ON user_level (level_order);
CREATE INDEX idx_user_level_active ON user_level (is_active) WHERE is_active = TRUE;

-- æ³¨é‡Š
COMMENT ON TABLE user_level IS 'ç”¨æˆ·ç­‰çº§é…ç½®è¡¨ï¼Œå®šä¹‰åŸºäºç§¯åˆ†çš„ç”¨æˆ·ç­‰çº§ä½“ç³»';
COMMENT ON COLUMN user_level.base_permissions IS 'åŸºç¡€æƒé™JSON: {"license_request": true, "api_access": false}';
COMMENT ON COLUMN user_level.base_quota_config IS 'åŸºç¡€é…é¢JSON: {"max_licenses": 10, "max_devices_per_license": 3}';
```

#### åˆå§‹æ•°æ®
```sql
INSERT INTO user_level (level_name, level_code, level_order, min_points, max_points, base_permissions, base_quota_config, level_benefits, level_color) VALUES
('é’é“œ', 'bronze', 1, 0, 999, 
 '{"license_request": true, "basic_features": true, "support_level": "standard"}',
 '{"max_licenses": 2, "max_devices_per_license": 1, "license_duration_days": 365, "api_rate_limit": 100}',
 '{"welcome_bonus": 50, "monthly_free_quota": 1}',
 '#CD7F32'),

('ç™½é“¶', 'silver', 2, 1000, 2999,
 '{"license_request": true, "basic_features": true, "analytics_basic": true, "support_level": "priority"}',
 '{"max_licenses": 5, "max_devices_per_license": 2, "license_duration_days": 365, "api_rate_limit": 500}',
 '{"upgrade_bonus": 100, "monthly_free_quota": 2, "feature_trial": ["analytics"]}',
 '#C0C0C0'),

('é»„é‡‘', 'gold', 3, 3000, 5999,
 '{"license_request": true, "advanced_features": true, "analytics_full": true, "api_access_basic": true, "support_level": "vip"}',
 '{"max_licenses": 10, "max_devices_per_license": 3, "license_duration_days": 730, "api_rate_limit": 2000}',
 '{"upgrade_bonus": 200, "monthly_free_quota": 5, "priority_support": true}',
 '#FFD700'),

('é“‚é‡‘', 'platinum', 4, 6000, 9999,
 '{"license_request": true, "all_features": true, "api_access_full": true, "batch_operations": true, "support_level": "premium"}',
 '{"max_licenses": 25, "max_devices_per_license": 5, "license_duration_days": 730, "api_rate_limit": 10000}',
 '{"upgrade_bonus": 500, "monthly_free_quota": 10, "dedicated_support": true, "beta_access": true}',
 '#E5E4E2'),

('é’»çŸ³', 'diamond', 5, 10000, NULL,
 '{"license_request": true, "unlimited_features": true, "api_access_unlimited": true, "admin_features": true, "support_level": "exclusive"}',
 '{"max_licenses": 100, "max_devices_per_license": 10, "license_duration_days": 1095, "api_rate_limit": -1}',
 '{"upgrade_bonus": 1000, "monthly_free_quota": -1, "exclusive_support": true, "early_access": true, "custom_features": true}',
 '#B9F2FF');
```

### 2. UserPoints (ç”¨æˆ·ç§¯åˆ†è®°å½•è¡¨)

#### è¡¨ç»“æ„
```sql
CREATE TABLE user_points (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,
    
    -- ç§¯åˆ†ç±»å‹åˆ†ç±»
    point_type VARCHAR(50) NOT NULL,           -- ç§¯åˆ†ç±»å‹ï¼šearn(è·å¾—), spend(æ¶ˆè´¹), expire(è¿‡æœŸ), adjust(è°ƒæ•´)
    category VARCHAR(50) NOT NULL,             -- ä¸šåŠ¡åˆ†ç±»ï¼šlogin, license, referral, payment, community, etc.
    subcategory VARCHAR(50),                   -- å­åˆ†ç±»ï¼šdaily_login, first_activation, etc.
    
    -- ç§¯åˆ†æ•°å€¼
    points INTEGER NOT NULL,                   -- ç§¯åˆ†å˜åŠ¨æ•°é‡ï¼ˆæ­£æ•°ä¸ºè·å¾—ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè´¹ï¼‰
    balance_before INTEGER NOT NULL,          -- æ“ä½œå‰ç§¯åˆ†ä½™é¢
    balance_after INTEGER NOT NULL,           -- æ“ä½œåç§¯åˆ†ä½™é¢
    
    -- å…³è”ä¿¡æ¯
    source_type VARCHAR(50),                   -- æ¥æºç±»å‹ï¼šmanual, system, api, migration
    source_id BIGINT,                          -- å…³è”çš„æºè®°å½•IDï¼ˆå¦‚license_id, order_idç­‰ï¼‰
    source_description TEXT,                   -- æ¥æºæè¿°
    
    -- ç§¯åˆ†ç”Ÿå‘½å‘¨æœŸ
    earned_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),  -- ç§¯åˆ†è·å¾—æ—¶é—´
    expires_at TIMESTAMP WITH TIME ZONE,       -- ç§¯åˆ†è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼‰
    expired_at TIMESTAMP WITH TIME ZONE,       -- å®é™…è¿‡æœŸæ—¶é—´
    
    -- æ“ä½œä¿¡æ¯
    operation_reason TEXT,                     -- æ“ä½œåŸå› è¯´æ˜
    operator_id BIGINT,                        -- æ“ä½œäººå‘˜IDï¼ˆç³»ç»Ÿæ“ä½œä¸ºNULLï¼‰
    batch_id VARCHAR(100),                     -- æ‰¹é‡æ“ä½œæ ‡è¯†
    
    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- çŠ¶æ€ï¼šactive, expired, cancelled, adjusted
    is_manual BOOLEAN NOT NULL DEFAULT FALSE,  -- æ˜¯å¦æ‰‹åŠ¨è°ƒæ•´
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- çº¦æŸ
    CONSTRAINT points_not_zero CHECK (points != 0),
    CONSTRAINT valid_balance CHECK (balance_after = balance_before + points),
    CONSTRAINT valid_balance_positive CHECK (balance_after >= 0)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_points_member_time ON user_points (member_id, created_at DESC);
CREATE INDEX idx_user_points_type_category ON user_points (point_type, category);
CREATE INDEX idx_user_points_expires ON user_points (expires_at) WHERE expires_at IS NOT NULL AND status = 'active';
CREATE INDEX idx_user_points_source ON user_points (source_type, source_id) WHERE source_id IS NOT NULL;
CREATE INDEX idx_user_points_batch ON user_points (batch_id) WHERE batch_id IS NOT NULL;

-- åˆ†åŒºè¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºå¤§æ•°æ®é‡åœºæ™¯ï¼‰
-- CREATE TABLE user_points_y2024 PARTITION OF user_points FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

COMMENT ON TABLE user_points IS 'ç”¨æˆ·ç§¯åˆ†å˜åŠ¨è®°å½•è¡¨ï¼Œè®°å½•æ‰€æœ‰ç§¯åˆ†çš„è·å¾—ã€æ¶ˆè´¹ã€è¿‡æœŸç­‰æ“ä½œ';
```

### 3. UserTypeTag (ç”¨æˆ·æ ‡ç­¾è¡¨)

#### è¡¨ç»“æ„
```sql
CREATE TABLE user_type_tag (
    id BIGSERIAL PRIMARY KEY,
    
    -- æ ‡ç­¾åŸºæœ¬ä¿¡æ¯
    tag_name VARCHAR(50) NOT NULL,             -- æ ‡ç­¾åç§°ï¼šVIPç”¨æˆ·ã€ä¼ä¸šç”¨æˆ·ã€æ•™è‚²ç”¨æˆ·
    tag_code VARCHAR(20) NOT NULL UNIQUE,      -- æ ‡ç­¾ä»£ç ï¼švip, enterprise, education
    tag_category VARCHAR(20) NOT NULL,         -- æ ‡ç­¾åˆ†ç±»ï¼špayment, business, special, system
    
    -- æƒé™åŠ æˆé…ç½®
    permission_modifiers JSONB DEFAULT '{}',   -- æƒé™ä¿®æ­£å™¨
    quota_modifiers JSONB DEFAULT '{}',        -- é…é¢ä¿®æ­£å™¨
    feature_unlocks JSONB DEFAULT '{}',        -- åŠŸèƒ½è§£é”é…ç½®
    
    -- æ ‡ç­¾ç‰¹æƒ
    tag_benefits JSONB DEFAULT '{}',           -- æ ‡ç­¾ä¸“å±ç¦åˆ©
    exclusive_features JSONB DEFAULT '{}',     -- ä¸“å±åŠŸèƒ½é…ç½®
    
    -- è·å¾—æ¡ä»¶
    acquisition_rules JSONB DEFAULT '{}',      -- è·å¾—è§„åˆ™é…ç½®
    auto_grant_enabled BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦æ”¯æŒè‡ªåŠ¨æˆäºˆ
    
    -- æœ‰æ•ˆæœŸç®¡ç†
    default_duration_days INTEGER,             -- é»˜è®¤æœ‰æ•ˆæœŸï¼ˆå¤©ï¼ŒNULLè¡¨ç¤ºæ°¸ä¹…ï¼‰
    max_duration_days INTEGER,                 -- æœ€å¤§æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
    renewal_enabled BOOLEAN DEFAULT TRUE,      -- æ˜¯å¦æ”¯æŒç»­æœŸ
    
    -- ä»·æ ¼é…ç½®
    price_config JSONB DEFAULT '{}',           -- ä»·æ ¼é…ç½®ï¼ˆç”¨äºä»˜è´¹æ ‡ç­¾ï¼‰
    
    -- æ˜¾ç¤ºé…ç½®
    tag_icon VARCHAR(255),                     -- æ ‡ç­¾å›¾æ ‡URL
    tag_color VARCHAR(7),                      -- æ ‡ç­¾é¢œè‰²
    display_priority INTEGER DEFAULT 0,        -- æ˜¾ç¤ºä¼˜å…ˆçº§
    description TEXT,                          -- æ ‡ç­¾æè¿°
    
    -- çŠ¶æ€ç®¡ç†
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_visible BOOLEAN NOT NULL DEFAULT TRUE,  -- æ˜¯å¦åœ¨ç”¨æˆ·ç•Œé¢æ˜¾ç¤º
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- çº¦æŸ
    CONSTRAINT valid_duration CHECK (default_duration_days IS NULL OR default_duration_days > 0)
);

-- ç´¢å¼•
CREATE INDEX idx_user_type_tag_category ON user_type_tag (tag_category, is_active);
CREATE INDEX idx_user_type_tag_active ON user_type_tag (is_active, is_visible);

-- åˆå§‹æ•°æ®
INSERT INTO user_type_tag (tag_name, tag_code, tag_category, permission_modifiers, quota_modifiers, tag_benefits, default_duration_days, tag_color) VALUES
('VIPç”¨æˆ·', 'vip', 'payment',
 '{"priority_support": true, "advanced_analytics": true, "feature_preview": true}',
 '{"license_multiplier": 1.5, "device_multiplier": 1.2, "duration_bonus_days": 30}',
 '{"monthly_bonus_points": 100, "exclusive_events": true, "priority_queue": true}',
 365, '#FF6B6B'),

('ä¼ä¸šç”¨æˆ·', 'enterprise', 'business',
 '{"bulk_operations": true, "admin_features": true, "api_full_access": true, "white_label": true}',
 '{"license_multiplier": 2.0, "device_multiplier": 2.0, "unlimited_support": true}',
 '{"dedicated_manager": true, "custom_training": true, "priority_development": true}',
 NULL, '#4ECDC4'),

('æ•™è‚²ç”¨æˆ·', 'education', 'special',
 '{"educational_features": true, "collaboration_tools": true, "classroom_management": true}',
 '{"license_multiplier": 1.2, "student_accounts": true, "educational_discount": 0.5}',
 '{"educational_resources": true, "teacher_training": true, "academic_support": true}',
 730, '#45B7D1'),

('å¼€å‘è€…', 'developer', 'special',
 '{"api_unlimited": true, "beta_access": true, "debug_tools": true, "documentation_edit": true}',
 '{"api_rate_unlimited": true, "sandbox_access": true}',
 '{"developer_community": true, "early_access": true, "tech_support": true}',
 NULL, '#96CEB4');
```

### 4. MemberTypeTag (ç”¨æˆ·æ ‡ç­¾å…³è”è¡¨)

#### è¡¨ç»“æ„
```sql
CREATE TABLE member_type_tag (
    id BIGSERIAL PRIMARY KEY,
    
    -- å…³è”ä¿¡æ¯
    member_id BIGINT NOT NULL REFERENCES member(id) ON DELETE CASCADE,
    tag_id BIGINT NOT NULL REFERENCES user_type_tag(id) ON DELETE CASCADE,
    
    -- æˆäºˆä¿¡æ¯
    granted_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    granted_by_id BIGINT,                      -- æˆäºˆäººIDï¼ˆç³»ç»Ÿæˆäºˆä¸ºNULLï¼‰
    grant_reason TEXT,                         -- æˆäºˆåŸå› 
    grant_method VARCHAR(50) NOT NULL,         -- æˆäºˆæ–¹å¼ï¼špayment, manual, auto, promotion
    
    -- æœ‰æ•ˆæœŸç®¡ç†
    expires_at TIMESTAMP WITH TIME ZONE,       -- è¿‡æœŸæ—¶é—´
    auto_renewal BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦è‡ªåŠ¨ç»­æœŸ
    renewal_count INTEGER DEFAULT 0,           -- ç»­æœŸæ¬¡æ•°
    
    -- ä½¿ç”¨ç»Ÿè®¡
    last_used_at TIMESTAMP WITH TIME ZONE,     -- æœ€åä½¿ç”¨æ—¶é—´
    usage_count INTEGER DEFAULT 0,             -- ä½¿ç”¨æ¬¡æ•°
    
    -- çŠ¶æ€ç®¡ç†
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    status VARCHAR(20) DEFAULT 'active',       -- çŠ¶æ€ï¼šactive, expired, suspended, cancelled
    
    -- å¤‡æ³¨ä¿¡æ¯
    notes TEXT,                                -- å¤‡æ³¨ä¿¡æ¯
    metadata JSONB DEFAULT '{}',               -- æ‰©å±•å…ƒæ•°æ®
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    CONSTRAINT unique_member_tag UNIQUE (member_id, tag_id),
    CONSTRAINT valid_expiry CHECK (expires_at IS NULL OR expires_at > granted_at)
);

-- ç´¢å¼•
CREATE INDEX idx_member_type_tag_member ON member_type_tag (member_id, is_active);
CREATE INDEX idx_member_type_tag_expires ON member_type_tag (expires_at) WHERE expires_at IS NOT NULL AND is_active = TRUE;
CREATE INDEX idx_member_type_tag_granted ON member_type_tag (granted_at);
```

### 5. Memberè¡¨æ‰©å±•

#### æ·»åŠ ç§¯åˆ†å’Œç­‰çº§å­—æ®µ
```sql
-- ä¸ºç°æœ‰Memberè¡¨æ·»åŠ ç§¯åˆ†ç›¸å…³å­—æ®µ
ALTER TABLE member ADD COLUMN total_points INTEGER NOT NULL DEFAULT 0;
ALTER TABLE member ADD COLUMN available_points INTEGER NOT NULL DEFAULT 0;  -- å¯ç”¨ç§¯åˆ†ï¼ˆæ‰£é™¤å·²è¿‡æœŸçš„ï¼‰
ALTER TABLE member ADD COLUMN current_level_id BIGINT REFERENCES user_level(id);
ALTER TABLE member ADD COLUMN level_updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE member ADD COLUMN last_points_update TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_member_total_points ON member (total_points DESC);
CREATE INDEX idx_member_level ON member (current_level_id);
CREATE INDEX idx_member_points_update ON member (last_points_update);

-- æ·»åŠ çº¦æŸ
ALTER TABLE member ADD CONSTRAINT valid_points CHECK (total_points >= 0 AND available_points >= 0);
ALTER TABLE member ADD CONSTRAINT available_points_check CHECK (available_points <= total_points);

-- æ³¨é‡Š
COMMENT ON COLUMN member.total_points IS 'ç”¨æˆ·æ€»ç§¯åˆ†æ•°ï¼ˆåŒ…æ‹¬å·²è¿‡æœŸç§¯åˆ†ï¼‰';
COMMENT ON COLUMN member.available_points IS 'ç”¨æˆ·å¯ç”¨ç§¯åˆ†æ•°ï¼ˆæ’é™¤å·²è¿‡æœŸç§¯åˆ†ï¼‰';
COMMENT ON COLUMN member.current_level_id IS 'å½“å‰ç”¨æˆ·ç­‰çº§ID';
COMMENT ON COLUMN member.level_updated_at IS 'ç­‰çº§æœ€åæ›´æ–°æ—¶é—´';
```

## ğŸ“Š æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

### 1. å¸¸ç”¨æŸ¥è¯¢åœºæ™¯ä¼˜åŒ–

#### ç”¨æˆ·æƒé™å¿«é€ŸæŸ¥è¯¢
```sql
-- åˆ›å»ºç”¨æˆ·æƒé™è§†å›¾ï¼ˆä¾¿äºå¤æ‚æŸ¥è¯¢ï¼‰
CREATE VIEW user_permissions_view AS
SELECT 
    m.id as member_id,
    m.username,
    m.total_points,
    ul.level_name,
    ul.level_code,
    ul.base_permissions,
    ul.base_quota_config,
    array_agg(utt.tag_name) as active_tags,
    array_agg(utt.permission_modifiers) as tag_permissions,
    array_agg(utt.quota_modifiers) as tag_quotas
FROM member m
LEFT JOIN user_level ul ON m.current_level_id = ul.id
LEFT JOIN member_type_tag mtt ON m.id = mtt.member_id AND mtt.is_active = TRUE
LEFT JOIN user_type_tag utt ON mtt.tag_id = utt.id AND utt.is_active = TRUE
WHERE m.is_deleted = FALSE
GROUP BY m.id, m.username, m.total_points, ul.level_name, ul.level_code, ul.base_permissions, ul.base_quota_config;
```

#### ç§¯åˆ†å†å²æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç”¨æˆ·ç§¯åˆ†æ±‡æ€»è§†å›¾
CREATE MATERIALIZED VIEW user_points_summary AS
SELECT 
    member_id,
    SUM(CASE WHEN point_type = 'earn' THEN points ELSE 0 END) as total_earned,
    SUM(CASE WHEN point_type = 'spend' THEN ABS(points) ELSE 0 END) as total_spent,
    SUM(CASE WHEN point_type = 'expire' THEN ABS(points) ELSE 0 END) as total_expired,
    COUNT(*) as transaction_count,
    MAX(created_at) as last_transaction,
    CURRENT_TIMESTAMP as refreshed_at
FROM user_points 
GROUP BY member_id;

-- åˆ›å»ºåˆ·æ–°ç´¢å¼•
CREATE UNIQUE INDEX idx_user_points_summary_member ON user_points_summary (member_id);
CREATE INDEX idx_user_points_summary_refreshed ON user_points_summary (refreshed_at);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
-- REFRESH MATERIALIZED VIEW CONCURRENTLY user_points_summary;
```

### 2. æ€§èƒ½ç›‘æ§æŸ¥è¯¢

#### ç§¯åˆ†åˆ†å¸ƒç»Ÿè®¡
```sql
-- ç§¯åˆ†ç­‰çº§åˆ†å¸ƒæŸ¥è¯¢
WITH level_distribution AS (
    SELECT 
        ul.level_name,
        ul.level_code,
        ul.min_points,
        ul.max_points,
        COUNT(m.id) as user_count,
        ROUND(COUNT(m.id) * 100.0 / SUM(COUNT(m.id)) OVER (), 2) as percentage
    FROM user_level ul
    LEFT JOIN member m ON m.current_level_id = ul.id AND m.is_deleted = FALSE
    WHERE ul.is_active = TRUE
    GROUP BY ul.id, ul.level_name, ul.level_code, ul.min_points, ul.max_points
    ORDER BY ul.level_order
)
SELECT * FROM level_distribution;
```

## ğŸ”§ æ•°æ®ç»´æŠ¤ç­–ç•¥

### 1. ç§¯åˆ†è¿‡æœŸå¤„ç†
```sql
-- ç§¯åˆ†è¿‡æœŸå¤„ç†å­˜å‚¨è¿‡ç¨‹
CREATE OR REPLACE FUNCTION expire_user_points()
RETURNS INTEGER AS $$
DECLARE
    expired_count INTEGER := 0;
    batch_size INTEGER := 1000;
    batch_id VARCHAR(100);
BEGIN
    -- ç”Ÿæˆæ‰¹æ¬¡ID
    batch_id := 'expire_' || to_char(NOW(), 'YYYYMMDD_HH24MISS');
    
    -- å¤„ç†è¿‡æœŸç§¯åˆ†
    WITH expired_points AS (
        SELECT id, member_id, points, balance_after
        FROM user_points 
        WHERE expires_at <= NOW() 
          AND status = 'active'
          AND point_type = 'earn'
        LIMIT batch_size
    )
    UPDATE user_points 
    SET status = 'expired',
        expired_at = NOW(),
        batch_id = expire_user_points.batch_id
    FROM expired_points 
    WHERE user_points.id = expired_points.id;
    
    GET DIAGNOSTICS expired_count = ROW_COUNT;
    
    -- æ›´æ–°ç”¨æˆ·å¯ç”¨ç§¯åˆ†
    UPDATE member 
    SET available_points = (
        SELECT COALESCE(SUM(points), 0)
        FROM user_points 
        WHERE member_id = member.id 
          AND status = 'active'
          AND (expires_at IS NULL OR expires_at > NOW())
    ),
    last_points_update = NOW()
    WHERE id IN (
        SELECT DISTINCT member_id 
        FROM user_points 
        WHERE batch_id = expire_user_points.batch_id
    );
    
    RETURN expired_count;
END;
$$ LANGUAGE plpgsql;
```

### 2. ç­‰çº§è‡ªåŠ¨æ›´æ–°
```sql
-- ç”¨æˆ·ç­‰çº§è‡ªåŠ¨æ›´æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION update_user_level(p_member_id BIGINT)
RETURNS BOOLEAN AS $$
DECLARE
    current_points INTEGER;
    new_level_id BIGINT;
    old_level_id BIGINT;
    level_changed BOOLEAN := FALSE;
BEGIN
    -- è·å–ç”¨æˆ·å½“å‰ç§¯åˆ†å’Œç­‰çº§
    SELECT total_points, current_level_id 
    INTO current_points, old_level_id
    FROM member 
    WHERE id = p_member_id;
    
    -- æ ¹æ®ç§¯åˆ†è®¡ç®—æ–°ç­‰çº§
    SELECT id INTO new_level_id
    FROM user_level 
    WHERE min_points <= current_points 
      AND (max_points IS NULL OR current_points <= max_points)
      AND is_active = TRUE
    ORDER BY level_order DESC
    LIMIT 1;
    
    -- å¦‚æœç­‰çº§å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°ç”¨æˆ·è®°å½•
    IF old_level_id IS DISTINCT FROM new_level_id THEN
        UPDATE member 
        SET current_level_id = new_level_id,
            level_updated_at = NOW()
        WHERE id = p_member_id;
        
        level_changed := TRUE;
        
        -- è§¦å‘ç­‰çº§å˜æ›´äº‹ä»¶ï¼ˆå¯ä»¥é€šè¿‡NOTIFYå®ç°ï¼‰
        PERFORM pg_notify('user_level_changed', 
            json_build_object(
                'member_id', p_member_id,
                'old_level_id', old_level_id,
                'new_level_id', new_level_id,
                'points', current_points
            )::text
        );
    END IF;
    
    RETURN level_changed;
END;
$$ LANGUAGE plpgsql;
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹[ä¸šåŠ¡æµç¨‹è¯¦ç»†è®¾è®¡](16_ä¸šåŠ¡æµç¨‹è¯¦ç»†è®¾è®¡.md)äº†è§£å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å®ç°
