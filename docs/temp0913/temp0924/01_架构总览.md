# 架构总览 - 多租户积分等级系统

## 🎯 设计理念

### 核心问题
1. **双重等级冲突**: 积分等级系统与用户分级系统并存，导致权限判断混乱
2. **多租户积分隔离**: 同一用户在不同租户下需要独立的积分和等级
3. **VIP期限管理**: 缺乏完整的VIP等标签期限管理机制
4. **Member表风险**: 直接修改Member表存储积分信息风险较高

### 解决思路
采用**多租户积分驱动的统一等级体系**：
- **积分为主体，标签为特权**: 统一以积分计算等级，消除双重标准
- **租户完全隔离**: 通过TenantUserProfile实现租户级积分和等级隔离
- **Member表保持不变**: 新增TenantUserProfile等表，零风险升级
- **完整VIP管理**: 支持期限、宽限期、自动续费等完整生命周期

## 🏗️ 整体架构设计

### 多租户积分等级系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API表现层 (Presentation Layer)                    │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │  租户隔离API     │ │   积分管理API    │ │   VIP管理API     │ │  许可证API  │ │
│  │ TenantAwareAPI   │ │  PointsAPI       │ │   TagsAPI        │ │ LicenseAPI  │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           应用服务层 (Application Layer)                     │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │  用户等级服务    │ │   积分管理服务   │ │   标签管理服务   │ │ 许可证集成   │ │
│  │UserLevelAppSvc   │ │ PointsMgmtSvc    │ │  TagMgmtSvc     │ │LicenseIntSvc│ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           领域服务层 (Domain Service Layer)                  │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │  积分引擎服务    │ │   权限计算服务   │ │   VIP期限服务    │ │ 等级升级服务│ │
│  │  PointsEngine    │ │ PermissionCalc   │ │  VipExpiration   │ │LevelUpgrade │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │  租户隔离服务    │ │   缓存管理服务   │ │   通知服务       │ │ 审计服务    │ │
│  │TenantIsolation   │ │  CacheManager    │ │ Notification     │ │ AuditSvc    │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           领域模型层 (Domain Model Layer)                    │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │TenantUserProfile │ │   UserLevel      │ │  UserTypeTag     │ │   Member    │ │
│  │   (租户用户档案) │ │   (用户等级)     │ │   (用户标签)     │ │ (原子模型)  │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │TenantUserPoints  │ │TenantUserTypeTag │ │LicenseAssignment │ │   License   │ │
│  │ (租户积分记录)   │ │ (租户标签关联)   │ │   (许可证分配)   │ │ (原子模型)  │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据访问层 (Data Access Layer)                        │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │   多租户查询     │ │   缓存Repository │ │   事务管理       │ │  数据迁移   │ │
│  │TenantQuerySet    │ │ CacheRepository  │ │TransactionMgr    │ │DataMigration│ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           基础设施层 (Infrastructure Layer)                  │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌─────────────┐ │
│  │  PostgreSQL      │ │      Redis       │ │      Celery      │ │   Logging   │ │
│  │ (多租户分区)     │ │  (租户隔离缓存)  │ │   (异步任务)     │ │  (审计日志) │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🧩 核心组件职责

### 1. 数据模型层
**职责**: 纯粹的数据容器，实现多租户隔离，不包含业务逻辑

**原子模型 (保持不变)**:
- **Member模型**: 保持原有的用户基础信息，完全不修改
- **License模型**: 保持原有的许可证基础信息，完全不修改

**新增租户隔离模型**:
- **TenantUserProfile**: 租户用户档案，存储用户在特定租户下的积分和等级
- **TenantUserPoints**: 租户积分记录，记录用户在租户下的积分变动
- **UserLevel**: 用户等级配置，定义积分阈值和权限配置
- **UserTypeTag**: 用户标签定义 (VIP、企业等)，定义额外权限
- **TenantUserTypeTag**: 租户用户标签关联，支持VIP期限管理

**许可证关联模型**:
- **LicenseAssignment**: 许可证分配模型，集成新的权限检查机制

### 2. 领域服务层
**职责**: 封装核心业务逻辑，实现多租户隔离和统一权限计算

**积分管理服务**:
- **PointsEngine**: 积分获取、消费、过期处理的核心引擎
- **LevelUpgradeService**: 等级升级、降级保护的业务逻辑

**权限与标签服务**:
- **TenantAwarePermissionService**: 租户隔离的权限计算服务
- **VipExpirationService**: VIP期限管理，支持宽限期和自动续期
- **TagLifecycleService**: 标签生命周期管理

**基础设施服务**:
- **TenantIsolationService**: 租户数据隔离服务
- **CacheManagerService**: 多租户缓存管理
- **NotificationService**: 通知服务 (积分变动、VIP过期等)

### 3. 应用服务层
**职责**: 协调多个领域服务，实现完整的用例场景，支持租户隔离

**用户等级管理**:
- **UserLevelApplicationService**: 协调用户等级查询和升级
- **PointsManagementService**: 协调积分获取、消费和查询

**标签与VIP管理**:
- **TagManagementService**: 协调标签的授予、续期、过期处理
- **VipLifecycleService**: 协调VIP的完整生命周期管理

**许可证集成**:
- **LicenseIntegrationService**: 集成新的权限检查到许可证分配流程

### 4. API表现层
**职责**: 处理HTTP请求，实现租户隔离，数据转换，权限控制

**租户隔离API**:
- **TenantUserProfileViewSet**: 租户用户档案管理API
- **TenantPointsViewSet**: 租户积分查询和管理API

**积分与等级API**:
- **UserLevelViewSet**: 用户等级查询API
- **PointsHistoryViewSet**: 积分历史查询API

**VIP管理API**:
- **UserTagViewSet**: 用户标签管理API
- **VipManagementViewSet**: VIP期限管理API

**许可证API** (更新):
- **LicenseAssignmentViewSet**: 集成新权限检查的许可证分配API

## 🔄 数据流设计

### 多租户权限计算流程

```
用户权限请求 → 租户识别 → 缓存检查 → 权限计算 → 缓存更新 → 返回权限
      ↓            ↓          ↓          ↓          ↓          ↓
用户+租户ID → 提取租户 → Redis查询 → 积分等级计算 → Redis存储 → 权限配置JSON
              ↓          ↓          ↓          ↓          ↓
           中间件识别 → cache_miss → TenantUserProfile → 30分钟TTL → API响应
```

### 积分获取与等级升级流程

```
用户行为触发 → 积分规则匹配 → 积分发放 → 等级重算 → 权限更新 → 通知推送
      ↓              ↓            ↓          ↓          ↓          ↓
每日登录/使用 → PointsEngine → 创建积分记录 → 检查升级 → 清除缓存 → 升级通知
      ↓              ↓            ↓          ↓          ↓          ↓
行为识别验证 → 计算奖励积分 → TenantUserPoints → LevelUpgrade → 权限重算 → Celery任务
```

### 许可证分配流程 (集成新权限系统)

```
许可证申请 → 租户权限查询 → 多层配额检查 → 分配执行 → 积分奖励 → 返回结果
      ↓              ↓              ↓          ↓          ↓          ↓
用户申请请求 → 计算用户权限 → 用户/License/租户配额 → 创建分配 → 积分发放 → 分配成功响应
      ↓              ↓              ↓          ↓          ↓          ↓
API参数验证 → PermissionService → 三级配额验证 → LicenseAssignment → PointsEngine → JSON响应
```

### VIP期限管理流程

```
VIP状态检查 → 期限计算 → 状态更新 → 自动续期 → 通知发送
      ↓          ↓          ↓          ↓          ↓
定时任务触发 → 过期时间对比 → 更新状态字段 → 支付处理 → 邮件/站内信
      ↓          ↓          ↓          ↓          ↓
Celery调度 → VipExpiration → TenantUserTypeTag → 支付网关 → Notification
```

## 🔧 技术特点

### 核心优势
1. **完全多租户隔离**: 每个租户的积分、等级、权限完全独立，支持不同的积分政策
2. **零风险升级**: Member和License表保持不变，通过新增表实现功能扩展
3. **统一权限体系**: 消除积分等级与用户分级的冲突，权限计算公式化
4. **高性能缓存**: 租户隔离的权限缓存，平均响应时间<100ms
5. **完整VIP管理**: 支持期限、宽限期、自动续费等完整生命周期
6. **灵活配置**: 积分规则、等级配置、标签权限均可动态调整

### 多租户技术特性
1. **数据隔离**: 所有用户相关数据按租户严格分区存储
2. **缓存隔离**: Redis缓存按租户命名空间隔离，避免数据泄露
3. **查询优化**: 所有查询自动添加租户条件，支持分区表优化
4. **事务安全**: 跨租户操作严格禁止，事务边界清晰

### 积分系统特性
1. **积分引擎**: 支持复杂的积分获取和消费规则
2. **等级自动升级**: 基于积分自动计算和更新用户等级
3. **过期管理**: 积分过期处理，可用积分实时计算
4. **审计完整**: 所有积分变动完整记录，支持追溯

### 考虑因素
1. **系统复杂度**: 多租户架构增加了系统复杂度，需要团队培训
2. **数据迁移**: 需要安全的数据迁移方案，建议灰度发布
3. **性能监控**: 需要完善的监控体系，确保多租户环境性能稳定
4. **缓存策略**: 需要合理的缓存失效策略，保证数据一致性

## 📊 与现有系统的兼容性

### 🔒 零代码修改验证
经过深度分析现有代码库确认：
- **✅ Member模型无需修改**: `users/models.py`中的Member模型保持完全原子性
- **✅ License模型无需修改**: `licenses/models.py`中的License模型保持完全原子性，已有`max_activations`字段
- **✅ Tenant模型无需修改**: `tenants/models.py`中的租户系统保持不变
- **✅ 所有新功能都是新增代码**: LicenseAssignment和积分系统都是全新模型

### 零风险改造策略
- **100%向下兼容**: 现有所有代码和API保持不变
- **新功能独立部署**: 通过新增表和服务实现，不影响现有业务
- **渐进式集成**: 支持逐步启用新功能，风险可控
- **回滚能力**: 可随时停用新功能，恢复到原有状态

### 影响范围评估
- **零风险**: 核心数据模型完全不变
- **低风险**: 新增表和服务，不影响现有业务
- **中风险**: API内部逻辑调整，需要充分测试
- **高收益**: 解决双重等级冲突，提供完整的多租户积分体系

### 数据兼容性
- **历史数据保留**: 现有用户类型数据转换为标签关联
- **权限平滑过渡**: 用户权限不会降级，只会增强
- **配额保持**: 现有许可证配额配置保持不变

## 🎯 成功标准

### 技术指标
- **代码测试覆盖率** > 95% (核心服务100%)
- **权限计算响应时间** < 100ms (平均), < 500ms (95%分位)
- **系统可用性** > 99.9%
- **多租户数据隔离率** = 100% (零泄露)

### 业务指标
- **支持并发用户** > 50,000 (多租户环境)
- **支持租户数量** > 1,000 (独立积分体系)
- **权限计算准确率** > 99.99% (无权限判断错误)
- **用户满意度** > 95% (统一清晰的等级体系)

### 性能指标
- **用户困惑度降低** 80% (统一等级路径)
- **权限计算错误率降低** 95% (公式化权限计算)
- **代码复杂度降低** 60% (单一逻辑体系)
- **用户参与度提升** 150% (明确积分激励)

## 🚀 实施路径

### 推荐阅读顺序
1. **[19_多租户积分设计修正.md](19_多租户积分设计修正.md)** - 核心设计方案
2. **[15_数据模型详细设计.md](15_数据模型详细设计.md)** - 完整数据模型
3. **[17_技术实现指南.md](17_技术实现指南.md)** - 具体技术实现
4. **[18_迁移实施方案.md](18_迁移实施方案.md)** - 安全迁移方案

---

**下一步**: 查看[领域模型设计](02_领域模型设计.md)了解LicenseAssignment的设计，然后重点学习[多租户积分设计修正](19_多租户积分设计修正.md)掌握核心方案
