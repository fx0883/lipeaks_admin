# 应用服务设计

## 🎯 设计目标

### 服务协调
- **编排领域服务**: 协调多个领域服务完成复杂的业务用例
- **事务管理**: 管理跨服务的数据一致性和事务边界
- **异常处理**: 统一处理各种异常情况和错误恢复

### 用例实现
- **完整业务流程**: 实现端到端的业务用例
- **参数验证**: 统一的输入参数验证和格式转换
- **结果封装**: 标准化的返回结果格式

## 🏗️ 应用服务架构

```
                     ┌─────────────────────────────────────┐
                     │           应用服务层                 │
                     └─────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
          ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
          │许可证管理应用服务│ │用户许可证应用服务│ │  报表应用服务   │
          │                 │ │                 │ │                 │
          │• 分配管理       │ │• 用户视角查询   │ │• 统计报表       │
          │• 批量操作       │ │• 自助服务       │ │• 审计报告       │
          │• 生命周期管理   │ │• 状态查询       │ │• 趋势分析       │
          └─────────────────┘ └─────────────────┘ └─────────────────┘
                    │                 │                 │
                    └─────────────────┼─────────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              │                       │                       │
     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
     │  通知应用服务   │     │  导入应用服务   │     │  导出应用服务   │
     │                 │     │                 │     │                 │
     │• 状态变更通知   │     │• 批量导入       │     │• 数据导出       │
     │• 到期提醒       │     │• 数据验证       │     │• 格式转换       │
     │• 异常警告       │     │• 错误处理       │     │• 文件生成       │
     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 🔧 核心应用服务详细设计

### 1. 许可证管理应用服务 (LicenseManagementApplicationService)

#### 职责范围
- 提供完整的许可证分配管理功能
- 协调多个领域服务实现复杂业务场景
- 处理管理员视角的所有许可证操作

#### 核心用例实现

##### 单个许可证分配用例
**方法**: assign_single_license()

**业务流程**:
```
输入验证 → 租户检查 → 配额验证 → 执行分配 → 更新计数 → 记录日志 → 发送通知 → 返回结果
    ↓          ↓          ↓          ↓          ↓          ↓          ↓          ↓
参数格式化 → 同租户验证 → License配额 → 创建关联 → 递增activations → 操作审计 → 状态通知 → 标准响应
```

**服务编排**:
1. **参数验证服务**: 验证输入参数的完整性和格式
2. **租户隔离服务**: 确保Member和License属于同一租户
3. **配额检查服务**: 验证License的剩余激活配额
4. **分配核心服务**: 执行具体的分配逻辑并更新License计数
5. **审计日志服务**: 记录分配操作日志
6. **通知服务**: 发送分配成功通知

**错误处理**:
- 参数错误: 返回具体的参数错误信息
- 租户错误: 返回跨租户访问错误
- 配额错误: 返回许可证配额不足错误
- 重复分配: 返回用户已拥有该许可证错误  
- 系统错误: 记录错误日志，返回通用错误信息

##### 批量许可证分配用例
**方法**: assign_batch_licenses()

**业务流程**:
```
批量参数验证 → 权限检查 → 逐个配额验证 → 事务性批量分配 → 结果汇总 → 批量通知
      ↓           ↓            ↓              ↓            ↓         ↓
  列表格式化 → 统一授权 → 分别检查配额 → 原子性操作 → 成功/失败统计 → 汇总通知
```

**特殊处理**:
- **部分失败处理**: 记录成功和失败的详细信息
- **事务管理**: 确保批量操作的原子性
- **性能优化**: 批量查询和批量插入优化
- **进度反馈**: 大批量操作的进度通知

##### 许可证撤销用例
**方法**: revoke_license_assignment()

**业务流程**:
```
撤销权限检查 → 状态验证 → 设备解绑 → 执行撤销 → 更新统计 → 记录日志 → 通知相关方
      ↓           ↓         ↓         ↓         ↓         ↓          ↓
  权限确认 → 可撤销状态 → 清理设备 → 状态变更 → 配额释放 → 操作审计 → 用户通知
```

**级联处理**:
- **设备绑定清理**: 清除关联的设备绑定记录
- **使用记录处理**: 标记使用记录为已终止
- **License计数更新**: 递减License.current_activations
- **配额释放**: 释放配额供其他用户申请
- **相关方通知**: 通知被撤销的用户

### 2. 用户许可证应用服务 (UserLicenseApplicationService)

#### 职责范围
- 提供面向最终用户的许可证查询和操作功能
- 实现用户自助服务场景
- 处理用户视角的许可证生命周期

#### 核心用例实现

##### 用户许可证查询用例
**方法**: get_user_licenses()

**业务流程**:
```
用户身份验证 → 权限范围确定 → 数据查询 → 结果过滤 → 状态计算 → 格式化返回
      ↓             ↓           ↓        ↓        ↓          ↓
  JWT Token解析 → 可访问范围 → 关联查询 → 敏感信息过滤 → 实时状态 → 用户友好格式
```

**查询优化**:
- **预加载关联**: 一次查询加载所有必要的关联数据
- **结果缓存**: 缓存用户的许可证列表以提高性能
- **分页支持**: 支持大量许可证的分页查询
- **状态实时计算**: 动态计算许可证的当前状态

##### 用户许可证激活用例
**方法**: activate_user_license()

**业务流程**:
```
激活权限检查 → 设备信息验证 → 并发数检查 → 执行激活 → 设备绑定 → 使用记录 → 返回凭证
      ↓             ↓            ↓          ↓        ↓        ↓          ↓
  分配状态确认 → 设备指纹验证 → 设备限制 → 状态变更 → 创建绑定 → 开始追踪 → 激活凭证
```

**安全控制**:
- **设备指纹验证**: 验证设备的合法性和唯一性
- **并发控制**: 严格控制同时激活的设备数量
- **异常检测**: 检测异常的激活模式
- **凭证管理**: 生成安全的激活凭证

### 3. 报表应用服务 (ReportingApplicationService)

#### 职责范围
- 生成各类许可证相关的统计报表
- 提供数据分析和趋势预测功能
- 支持合规性审计报告

#### 核心用例实现

##### 许可证使用统计报表
**方法**: generate_usage_report()

**统计维度**:
- **时间维度**: 按日、周、月、年统计
- **产品维度**: 按软件产品分类统计
- **用户维度**: 按用户组、部门统计
- **状态维度**: 按分配状态统计
- **租户维度**: 按租户隔离统计

**报表类型**:
- **使用率报表**: 许可证的使用率和闲置率
- **趋势分析报表**: 使用趋势和预测分析
- **异常报表**: 异常使用模式和风险预警
- **合规报表**: 满足审计要求的详细报表

##### 到期预警报表
**方法**: generate_expiry_alert_report()

**预警策略**:
- **分级预警**: 30天、7天、1天到期预警
- **批量预警**: 批量到期的集中预警
- **用户通知**: 自动向用户发送到期提醒
- **管理员报告**: 向管理员提供到期汇总

## 🔄 服务间协调模式

### 事务管理策略

#### 本地事务
**适用场景**: 单个数据库操作或简单的关联操作
```
@transaction.atomic
def assign_single_license(params):
    # 在同一个数据库事务中执行
    validate_parameters(params)
    check_permissions(params)
    create_assignment(params)
    log_operation(params)
```

#### 分布式事务
**适用场景**: 跨多个服务或外部系统的操作
```
try:
    # 第一阶段：准备
    assignment_id = prepare_assignment(params)
    notification_id = prepare_notification(params)
    
    # 第二阶段：提交
    commit_assignment(assignment_id)
    commit_notification(notification_id)
except Exception:
    # 补偿操作
    rollback_assignment(assignment_id)
    rollback_notification(notification_id)
```

#### Saga模式
**适用场景**: 长流程的分布式事务
```
Saga流程: 分配许可证 → 绑定设备 → 发送通知 → 更新统计
补偿流程: 撤销分配 ← 解绑设备 ← 取消通知 ← 回滚统计
```

### 异常处理策略

#### 分层异常处理
```
应用服务层异常:
├─ 业务逻辑异常 (BusinessLogicException)
│  ├─ 参数验证异常 (ParameterValidationException)
│  ├─ 权限不足异常 (PermissionDeniedException)
│  └─ 业务规则异常 (BusinessRuleException)
├─ 系统集成异常 (SystemIntegrationException)
│  ├─ 数据访问异常 (DataAccessException)
│  ├─ 外部服务异常 (ExternalServiceException)
│  └─ 网络通信异常 (NetworkException)
└─ 系统运行异常 (SystemRuntimeException)
   ├─ 配置错误异常 (ConfigurationException)
   ├─ 资源不足异常 (ResourceException)
   └─ 未知错误异常 (UnknownException)
```

#### 异常恢复机制
- **重试机制**: 对临时性错误进行自动重试
- **降级机制**: 在部分功能不可用时提供基础功能
- **熔断机制**: 在外部服务不可用时快速失败
- **补偿机制**: 对已执行的操作进行回滚或补偿

## 📊 性能优化策略

### 缓存策略
```
多层缓存结构:
┌─────────────────┐
│   应用层缓存     │ ← 用户会话、权限信息
├─────────────────┤
│   业务逻辑缓存   │ ← 配额信息、统计数据
├─────────────────┤
│   数据访问缓存   │ ← 查询结果、对象映射
└─────────────────┘
│   数据库缓存     │ ← 数据库查询缓存
└─────────────────┘
```

### 异步处理模式
```
同步操作:           异步操作:
├─ 核心业务逻辑     ├─ 审计日志记录
├─ 数据一致性操作   ├─ 通知发送
└─ 实时状态查询     ├─ 统计数据计算
                    ├─ 报表生成
                    └─ 数据同步
```

### 批量操作优化
- **批量查询**: 使用IN查询减少数据库交互
- **批量插入**: 使用batch_create减少插入开销
- **批量更新**: 使用bulk_update提高更新效率
- **并行处理**: 对独立的操作进行并行处理

---

**下一步**: 查看[数据访问层设计](05_数据访问层设计.md)了解数据持久化的具体实现
