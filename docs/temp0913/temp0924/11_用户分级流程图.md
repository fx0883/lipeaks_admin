# 用户分级系统流程图

## 🔄 用户分级核心流程

### 1. 用户注册与分级流程

```
用户注册请求
    │
    ▼
┌─────────────────┐
│  创建Member记录  │
│                 │
│ 1. 基础信息验证 │
│ 2. 租户关联     │
│ 3. 默认类型分配 │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐       ┌─────────────────┐
│  分配默认类型   │────── │   一般用户       │
│                 │       │ (normal)        │
│ user_type_id =  │       │ Level: 1        │
│ normal_type.id  │       │ 配额: 2个许可证  │
└─────────┬───────┘       └─────────────────┘
          │
          ▼
┌─────────────────┐
│  初始化权限配置 │
│                 │
│ 1. 加载类型权限 │
│ 2. 设置配额限制 │
│ 3. 激活账户     │
└─────────────────┘
```

### 2. 用户升级流程

```
升级触发
    │
    ├─ 手动升级 ──────────────────┐
    │                            │
    ├─ 付费升级 ──────────────────┤
    │                            │
    ├─ 自动升级 ──────────────────┤
    │                            │
    └─ 邀请升级 ──────────────────┤
                                 │
                                 ▼
                      ┌─────────────────┐
                      │   升级条件检查   │
                      │                 │
                      │ 1. 当前类型验证 │
                      │ 2. 目标类型检查 │
                      │ 3. 升级权限验证 │
                      │ 4. 前置条件满足 │
                      └─────────┬───────┘
                                │
                               ▼ [检查通过]
                      ┌─────────────────┐
                      │   执行升级操作   │
                      │                 │
                      │ 1. 更新用户类型 │
                      │ 2. 重新计算配额 │
                      │ 3. 更新权限缓存 │
                      │ 4. 记录升级日志 │
                      └─────────┬───────┘
                                │
                                ▼
                      ┌─────────────────┐
                      │   升级后处理     │
                      │                 │
                      │ 1. 发送通知     │
                      │ 2. 更新统计     │
                      │ 3. 触发事件     │
                      └─────────────────┘
```

### 3. 许可证申请流程（集成用户分级）

```
用户申请许可证
    │
    ▼
┌─────────────────┐
│  获取用户类型   │
│                 │
│ SELECT user_type│
│ FROM member     │
│ WHERE id = ?    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐      ┌─────────────────┐
│  加载类型配置   │──────│  用户类型配置    │
│                 │      │                 │
│ 1. 权限配置     │      │ normal:         │
│ 2. 配额配置     │      │  max_licenses:2 │
│ 3. 限制配置     │      │ vip:            │
└─────────┬───────┘      │  max_licenses:10│
          │              │ super_vip:      │
          ▼              │  max_licenses:50│
┌─────────────────┐      └─────────────────┘
│  多层配额检查   │
│                 │
│ 1. 用户类型配额 │ ← 检查当前用户已申请的许可证数量
│ 2. License配额  │ ← 检查目标License的剩余配额
│ 3. 租户配额     │ ← 检查租户级别的配额限制
└─────────┬───────┘
          │
          ▼ [所有检查通过]
┌─────────────────┐
│  创建分配记录   │
│                 │
│ 1. 创建assignment│
│ 2. 更新License计数│
│ 3. 记录操作日志 │
│ 4. 发送通知     │
└─────────────────┘
```

## 📊 用户分级决策树

### 用户类型判断逻辑

```
新用户注册
    │
    ▼
[是否企业用户?] ─── YES ──→ [企业规模?] ─┬─ 大型 ──→ 超级VIP
    │                                  ├─ 中型 ──→ VIP  
    NO                                 └─ 小型 ──→ VIP
    │
    ▼
[是否付费用户?] ─── YES ──→ [付费等级?] ─┬─ 高级 ──→ 超级VIP
    │                                  └─ 基础 ──→ VIP
    NO
    │
    ▼
[是否邀请用户?] ─── YES ──→ [邀请人等级?] ─┬─ 超级VIP ──→ VIP
    │                                    └─ VIP ──────→ 一般用户
    NO
    │
    ▼
分配默认类型 ──→ 一般用户
```

### 升级路径设计

```
升级路径矩阵：

一般用户 (Level 1)
    │
    ├─ 付费升级 ────────────────→ VIP用户 (Level 2)
    │                              │
    ├─ 使用量升级 ──────────────────┤
    │                              │
    └─ 邀请升级 ────────────────────┤
                                   │
                              ├─ 付费升级 ──→ 超级VIP (Level 3)
                              │
                              ├─ 企业升级 ──→ 超级VIP (Level 3)
                              │
                              └─ 特殊邀请 ──→ 超级VIP (Level 3)

特殊升级路径：
一般用户 ─── 企业认证 ─────────→ 超级VIP (Level 3)
```

## 🎯 权限控制流程

### 权限检查决策流程

```
API请求到达
    │
    ▼
┌─────────────────┐
│  身份认证检查   │
│                 │
│ 1. JWT Token    │
│ 2. 用户状态     │
│ 3. 会话有效性   │
└─────────┬───────┘
          │
          ▼ [认证通过]
┌─────────────────┐
│  获取用户类型   │
│                 │
│ SELECT ut.*     │
│ FROM user_type ut│
│ JOIN member m   │
│ WHERE m.id = ?  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐      ┌─────────────────┐
│  加载权限配置   │──────│  权限配置缓存    │
│                 │      │                 │
│ 1. 功能权限     │      │ Redis Cache:    │
│ 2. 操作权限     │      │ user_perms:{id} │
│ 3. 数据权限     │      │ TTL: 30分钟     │
└─────────┬───────┘      └─────────────────┘
          │
          ▼
┌─────────────────┐
│  权限匹配检查   │
│                 │
│ 请求权限 ∈ 用户权限 ?
│                 │
│ YES ──→ 允许访问 │
│ NO  ──→ 拒绝访问 │
└─────────────────┘
```

### 配额控制流程

```
许可证申请请求
    │
    ▼
┌─────────────────┐
│  用户类型配额   │
│                 │
│ current_licenses │
│      ≤          │
│ type.max_licenses?│
└─────────┬───────┘
          │
          ▼ [配额充足]
┌─────────────────┐
│  License配额    │
│                 │
│ current_activations│
│      <          │
│ max_activations? │
└─────────┬───────┘
          │
          ▼ [配额充足]
┌─────────────────┐
│  租户级配额     │
│                 │
│ tenant_usage    │
│      ≤          │
│ tenant_limit?   │
└─────────┬───────┘
          │
          ▼ [所有检查通过]
┌─────────────────┐
│  执行许可证分配 │
│                 │
│ 1. 创建assignment│
│ 2. 更新计数器   │
│ 3. 记录日志     │
└─────────────────┘
```

## 🔄 系统集成架构

### 服务间调用关系

```
                    API Gateway
                         │
            ┌────────────┼────────────┐
            │            │            │
    ┌───────▼───────┐ ┌──▼──┐ ┌──────▼──────┐
    │ User Service  │ │Auth │ │License Mgmt │
    │               │ │     │ │   Service   │
    │• 用户类型管理  │ │     │ │             │
    │• 升级处理     │ │     │ │• 分配管理    │
    │• 权限检查     │ │     │ │• 配额检查    │
    └───────┬───────┘ └──┬──┘ └──────┬──────┘
            │            │           │
            └────────────┼───────────┘
                         │
                ┌────────▼────────┐
                │  Domain Events  │
                │                 │
                │• UserUpgraded   │
                │• QuotaExceeded  │
                │• PermissionDenied│
                └─────────────────┘
```

### 事件驱动架构

```
用户升级事件流：

用户升级 ──→ UserUpgradeEvent ──┬──→ 权限服务 (更新权限缓存)
                                │
                                ├──→ 配额服务 (重新计算配额)
                                │
                                ├──→ 通知服务 (发送升级通知)
                                │
                                ├──→ 统计服务 (更新用户统计)
                                │
                                └──→ 审计服务 (记录升级日志)

配额超限事件流：

配额检查失败 ──→ QuotaExceededEvent ──┬──→ 通知服务 (提醒用户升级)
                                      │
                                      ├──→ 推荐服务 (推荐升级方案)
                                      │
                                      └──→ 统计服务 (记录拒绝统计)
```

---

这个流程图清晰地展示了用户分级系统的各个关键流程，包括用户注册、升级、权限检查和许可证申请等核心业务场景的处理逻辑。
