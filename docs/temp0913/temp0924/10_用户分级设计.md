# 用户分级设计方案

## 🎯 需求分析

### 业务需求
- **一般用户**: 基础功能使用者
- **VIP用户**: 享有更多权限和配额的用户
- **超级VIP用户**: 最高级别的用户，拥有特殊权限

### 设计目标
- **可扩展性**: 支持未来增加更多用户级别
- **灵活配置**: 每个级别可以有不同的权限和配额
- **向下兼容**: 不影响现有Member模型的原子性
- **业务驱动**: 支持基于用户级别的许可证分配策略

## 🏗️ 整体架构设计

### 用户分级架构图

```
                    ┌─────────────────────────────────────┐
                    │           用户分级系统              │
                    └─────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
   │  用户类型管理   │     │  权限配置管理   │     │  配额策略管理   │
   │                 │     │                 │     │                 │
   │• 类型定义       │     │• 功能权限       │     │• 许可证配额     │
   │• 等级层次       │     │• 操作权限       │     │• 使用限制       │
   │• 升级规则       │     │• 数据权限       │     │• 时间限制       │
   └─────────────────┘     └─────────────────┘     └─────────────────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    │
                    ┌─────────────────┴───────────────────┐
                    │           数据模型层                 │
                    │                                     │
                    │ UserType ←→ Member ←→ LicenseQuota  │
                    │    ↓           ↓           ↓        │
                    │ 类型定义    用户实例    配额策略     │
                    └─────────────────────────────────────┘
```

## 📊 数据模型设计

### 核心表结构关系图

```
     ┌─────────────────┐         ┌─────────────────┐
     │   UserType      │         │   Tenant        │
     │   (用户类型)     │         │   (租户)        │
     │                 │         │                 │
     │ + name          │         │ + name          │
     │ + code          │         │ + settings      │
     │ + level         │         └─────────┬───────┘
     │ + permissions   │                   │
     │ + quota_config  │                   │ 1:N
     └─────────┬───────┘                   ▼
               │                  ┌─────────────────┐
               │ 1:N             │     Member      │
               │                 │   (成员用户)     │
               └─────────────────┤                 │
                                 │ + user_type_id  │
                                 │ + upgrade_date  │
                                 │ + expire_date   │
                                 └─────────┬───────┘
                                           │
                                           │ 1:N
                                           ▼
                                 ┌─────────────────┐
                                 │LicenseAssignment│
                                 │   (许可证分配)   │
                                 │                 │
                                 │ + member_id     │
                                 │ + license_id    │
                                 │ + quota_override│
                                 └─────────────────┘
```

### 1. UserType 用户类型表

#### 表结构设计
```sql
CREATE TABLE user_type (
    id BIGSERIAL PRIMARY KEY,
    
    -- 基本信息
    name VARCHAR(50) NOT NULL,                    -- 类型名称：一般用户、VIP用户、超级VIP用户
    code VARCHAR(20) NOT NULL UNIQUE,            -- 类型代码：normal、vip、super_vip
    description TEXT,                             -- 类型描述
    
    -- 等级层次
    level INTEGER NOT NULL DEFAULT 1,            -- 等级数值，数值越大等级越高
    parent_type_id BIGINT REFERENCES user_type(id), -- 父级类型，支持层级结构
    
    -- 权限配置
    permissions JSONB DEFAULT '{}',              -- 权限配置
    features JSONB DEFAULT '{}',                 -- 功能特性配置
    
    -- 配额配置
    license_quota_config JSONB DEFAULT '{}',     -- 许可证配额配置
    usage_limits JSONB DEFAULT '{}',             -- 使用限制配置
    
    -- 升级配置
    upgrade_requirements JSONB DEFAULT '{}',     -- 升级条件
    auto_upgrade_enabled BOOLEAN DEFAULT FALSE,  -- 是否支持自动升级
    
    -- 状态管理
    is_active BOOLEAN NOT NULL DEFAULT TRUE,     -- 是否启用
    is_default BOOLEAN NOT NULL DEFAULT FALSE,   -- 是否默认类型
    
    -- 审计字段
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by_id BIGINT,
    
    -- 约束
    CONSTRAINT valid_level CHECK (level > 0),
    CONSTRAINT unique_default_type UNIQUE (is_default) WHERE is_default = TRUE
);

-- 索引
CREATE INDEX idx_user_type_code ON user_type (code);
CREATE INDEX idx_user_type_level ON user_type (level);
CREATE INDEX idx_user_type_active ON user_type (is_active) WHERE is_active = TRUE;

-- 注释
COMMENT ON TABLE user_type IS '用户类型表，定义不同级别用户的权限和配额';
COMMENT ON COLUMN user_type.level IS '等级数值，1=一般用户，2=VIP用户，3=超级VIP用户';
COMMENT ON COLUMN user_type.permissions IS '权限配置：{"license_assign": true, "admin_access": false}';
COMMENT ON COLUMN user_type.license_quota_config IS '许可证配额：{"max_licenses": 5, "max_devices_per_license": 3}';
```

#### 初始数据配置
```sql
-- 插入默认用户类型
INSERT INTO user_type (name, code, level, description, permissions, license_quota_config, is_default) VALUES
('一般用户', 'normal', 1, '基础功能用户', 
 '{"license_request": true, "basic_features": true}',
 '{"max_licenses": 2, "max_devices_per_license": 1, "license_duration_days": 365}',
 TRUE),

('VIP用户', 'vip', 2, '高级功能用户',
 '{"license_request": true, "advanced_features": true, "priority_support": true}',
 '{"max_licenses": 10, "max_devices_per_license": 3, "license_duration_days": 730}',
 FALSE),

('超级VIP用户', 'super_vip', 3, '最高级用户',
 '{"license_request": true, "all_features": true, "priority_support": true, "batch_operations": true}',
 '{"max_licenses": 50, "max_devices_per_license": 10, "license_duration_days": 1095, "unlimited_usage": true}',
 FALSE);
```

### 2. Member表扩展设计

#### 添加用户类型关联
```sql
-- 为Member表添加用户类型字段
ALTER TABLE member ADD COLUMN user_type_id BIGINT REFERENCES user_type(id);
ALTER TABLE member ADD COLUMN user_type_upgrade_date TIMESTAMP WITH TIME ZONE;
ALTER TABLE member ADD COLUMN user_type_expire_date TIMESTAMP WITH TIME ZONE;
ALTER TABLE member ADD COLUMN user_type_notes TEXT;

-- 创建索引
CREATE INDEX idx_member_user_type ON member (user_type_id);
CREATE INDEX idx_member_type_expire ON member (user_type_expire_date) 
WHERE user_type_expire_date IS NOT NULL;

-- 注释
COMMENT ON COLUMN member.user_type_id IS '用户类型ID，关联user_type表';
COMMENT ON COLUMN member.user_type_upgrade_date IS '用户类型升级时间';
COMMENT ON COLUMN member.user_type_expire_date IS '用户类型过期时间，NULL表示永不过期';
COMMENT ON COLUMN member.user_type_notes IS '用户类型相关备注';
```

#### 数据迁移脚本
```sql
-- 为现有用户设置默认类型
UPDATE member 
SET user_type_id = (SELECT id FROM user_type WHERE code = 'normal' AND is_default = TRUE)
WHERE user_type_id IS NULL;

-- 添加非空约束
ALTER TABLE member ALTER COLUMN user_type_id SET NOT NULL;
```

## 🔧 业务逻辑设计

### 用户类型服务 (UserTypeService)

#### 核心功能设计

##### 1. 用户类型管理
```
功能模块                    描述
─────────────────────      ──────────────────────────
类型定义管理                创建、修改、删除用户类型
权限配置管理                配置每个类型的功能权限
配额策略管理                设置许可证配额和限制
升级规则管理                定义用户升级条件和流程
```

##### 2. 用户升级服务
```
升级触发方式               说明
─────────────────────      ──────────────────────────
手动升级                    管理员手动操作升级
自动升级                    基于条件自动触发升级
付费升级                    基于付费购买升级
时间升级                    基于时间周期升级
```

##### 3. 权限检查服务
```
权限检查范围               检查内容
─────────────────────      ──────────────────────────
功能权限                    用户可以使用哪些功能
许可证权限                  用户可以申请多少许可证
操作权限                    用户可以执行哪些操作
数据权限                    用户可以访问哪些数据
```

### 与许可证分配的集成

#### 分配策略调整

##### 基于用户类型的配额控制
```
一般用户限制：
├─ 最大许可证数量: 2个
├─ 每个许可证最大设备数: 1台
├─ 许可证有效期: 1年
└─ 不支持批量操作

VIP用户权限：
├─ 最大许可证数量: 10个  
├─ 每个许可证最大设备数: 3台
├─ 许可证有效期: 2年
├─ 支持优先级处理
└─ 支持高级功能

超级VIP用户权限：
├─ 最大许可证数量: 50个
├─ 每个许可证最大设备数: 10台
├─ 许可证有效期: 3年
├─ 支持批量操作
├─ 支持所有高级功能
└─ 无使用限制
```

##### 许可证分配流程调整
```
原流程: 用户申请 → 配额检查 → 创建分配
新流程: 用户申请 → 用户类型检查 → 类型配额检查 → License配额检查 → 创建分配
```

## 🚀 扩展性设计

### 1. 灵活的类型系统

#### 层级化用户类型
```
用户类型层级示例：

基础用户 (Level 1)
├─ 试用用户 (Level 1.1)
└─ 标准用户 (Level 1.2)

VIP用户 (Level 2)  
├─ 金牌VIP (Level 2.1)
├─ 白金VIP (Level 2.2)
└─ 钻石VIP (Level 2.3)

企业用户 (Level 3)
├─ 小型企业 (Level 3.1)
├─ 中型企业 (Level 3.2)
└─ 大型企业 (Level 3.3)
```

#### 动态权限配置
```json
{
  "permissions": {
    "license_management": {
      "request": true,
      "batch_request": false,
      "transfer": false,
      "revoke_own": true
    },
    "features": {
      "advanced_analytics": false,
      "api_access": true,
      "custom_branding": false,
      "priority_support": false
    },
    "limits": {
      "api_rate_limit": 1000,
      "concurrent_sessions": 3,
      "storage_quota_gb": 10
    }
  }
}
```

### 2. 可配置的升级机制

#### 升级条件配置
```json
{
  "upgrade_requirements": {
    "to_vip": {
      "methods": [
        {
          "type": "payment",
          "amount": 99.00,
          "currency": "CNY",
          "duration_months": 12
        },
        {
          "type": "usage_based", 
          "criteria": {
            "active_licenses": 5,
            "usage_days": 30,
            "feature_usage_score": 80
          }
        }
      ]
    },
    "to_super_vip": {
      "methods": [
        {
          "type": "payment",
          "amount": 299.00,
          "currency": "CNY", 
          "duration_months": 12
        },
        {
          "type": "invitation",
          "required_referrals": 5,
          "enterprise_customer": true
        }
      ]
    }
  }
}
```

### 3. 未来扩展方向

#### 可扩展的功能模块
```
当前功能模块              未来扩展方向
─────────────────────    ──────────────────────────
基础用户分级             → 细分行业用户类型
简单权限控制             → 基于角色的复杂权限系统
固定配额管理             → 动态配额和弹性计费
手动升级流程             → 智能推荐升级系统
单一升级路径             → 多维度升级路径
```

#### 集成扩展点
```
扩展接口                  说明
─────────────────────    ──────────────────────────
UserTypePlugin          用户类型插件接口
UpgradeStrategyPlugin   升级策略插件接口  
QuotaCalculatorPlugin   配额计算插件接口
PermissionProviderPlugin 权限提供者插件接口
NotificationPlugin      通知插件接口
```

## 💡 实施建议

### 阶段性实施计划

#### 第一阶段：基础框架 (2周)
1. 创建UserType表和基础数据
2. 扩展Member表增加类型关联
3. 实现基础的用户类型服务
4. 集成到现有许可证分配流程

#### 第二阶段：权限集成 (2周)  
1. 实现基于用户类型的权限检查
2. 调整API权限控制逻辑
3. 实现用户类型配额检查
4. 添加用户类型管理界面

#### 第三阶段：升级机制 (2周)
1. 实现用户升级服务
2. 支持手动和自动升级
3. 添加升级审批流程
4. 实现升级通知机制

#### 第四阶段：高级功能 (2周)
1. 实现层级化用户类型
2. 支持动态权限配置
3. 实现智能升级推荐
4. 添加用户类型分析报表

### 技术实施要点

#### 1. 数据一致性保证
- 使用数据库事务确保用户升级的原子性
- 实现软删除机制，保留用户类型变更历史
- 定期同步检查用户类型与权限的一致性

#### 2. 性能优化策略
- 缓存用户类型权限配置
- 使用Redis缓存用户等级信息
- 批量处理用户类型变更操作

#### 3. 安全考虑
- 用户类型升级需要审批流程
- 记录所有用户类型变更的审计日志
- 防止用户类型降级导致的权限提升

---

**下一步**: 这个用户分级系统设计既满足了当前的三级分类需求，又为未来的扩展预留了充分的空间。通过层级化和可配置的设计，可以灵活应对各种业务场景的变化。
