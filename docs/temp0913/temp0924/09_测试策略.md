# æµ‹è¯•ç­–ç•¥

## ğŸ¯ æµ‹è¯•ç›®æ ‡

### è´¨é‡ä¿è¯
- **åŠŸèƒ½æ­£ç¡®æ€§**: ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æŒ‰ç…§éœ€æ±‚è§„èŒƒæ­£ç¡®å®ç°
- **æ€§èƒ½è¾¾æ ‡**: éªŒè¯ç³»ç»Ÿæ€§èƒ½æ»¡è¶³é¢„æœŸæŒ‡æ ‡
- **å®‰å…¨æ€§**: éªŒè¯ç³»ç»Ÿå®‰å…¨æœºåˆ¶çš„æœ‰æ•ˆæ€§
- **ç¨³å®šæ€§**: ç¡®ä¿ç³»ç»Ÿåœ¨å„ç§æ¡ä»¶ä¸‹ç¨³å®šè¿è¡Œ

### é£é™©æ§åˆ¶
- **å›å½’é£é™©**: é˜²æ­¢æ–°åŠŸèƒ½å½±å“ç°æœ‰åŠŸèƒ½
- **é›†æˆé£é™©**: ç¡®ä¿å„ç»„ä»¶æ­£ç¡®é›†æˆ
- **æ€§èƒ½é£é™©**: é¿å…æ€§èƒ½é€€åŒ–
- **å®‰å…¨é£é™©**: é˜²æ­¢å®‰å…¨æ¼æ´

## ğŸ“Š æµ‹è¯•ç­–ç•¥çŸ©é˜µ

```
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚    å•å…ƒæµ‹è¯•  â”‚   é›†æˆæµ‹è¯•  â”‚   ç³»ç»Ÿæµ‹è¯•  â”‚   éªŒæ”¶æµ‹è¯•  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åŠŸèƒ½æµ‹è¯•     â”‚     âœ“âœ“âœ“     â”‚     âœ“âœ“âœ“     â”‚     âœ“âœ“âœ“     â”‚     âœ“âœ“âœ“     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ€§èƒ½æµ‹è¯•     â”‚      âœ“      â”‚     âœ“âœ“      â”‚     âœ“âœ“âœ“     â”‚     âœ“âœ“      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®‰å…¨æµ‹è¯•     â”‚      âœ“      â”‚     âœ“âœ“      â”‚     âœ“âœ“âœ“     â”‚     âœ“âœ“      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å…¼å®¹æ€§æµ‹è¯•   â”‚      -      â”‚     âœ“âœ“      â”‚     âœ“âœ“âœ“     â”‚     âœ“âœ“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹: âœ“âœ“âœ“ é‡ç‚¹å…³æ³¨  âœ“âœ“ ä¸€èˆ¬å…³æ³¨  âœ“ è½»åº¦å…³æ³¨  - ä¸æ¶‰åŠ
```

## ğŸ”§ å•å…ƒæµ‹è¯•ç­–ç•¥

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡
```
ç»„ä»¶ç±»å‹           è¦†ç›–ç‡ç›®æ ‡    é‡ç‚¹æµ‹è¯•å†…å®¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é¢†åŸŸæœåŠ¡å±‚          95%+        ä¸šåŠ¡é€»è¾‘ã€è¾¹ç•Œæ¡ä»¶ã€å¼‚å¸¸å¤„ç†
åº”ç”¨æœåŠ¡å±‚          90%+        æœåŠ¡åè°ƒã€äº‹åŠ¡ç®¡ç†ã€é”™è¯¯å¤„ç†
æ•°æ®è®¿é—®å±‚          95%+        æŸ¥è¯¢é€»è¾‘ã€æ•°æ®å®Œæ•´æ€§ã€æ€§èƒ½
APIæ§åˆ¶å™¨å±‚         85%+        è¯·æ±‚å¤„ç†ã€æƒé™æ§åˆ¶ã€å“åº”æ ¼å¼
```

### å•å…ƒæµ‹è¯•æ¡†æ¶è®¾è®¡

#### æµ‹è¯•åŸºç±»
```python
import pytest
from unittest.mock import Mock, patch, MagicMock
from django.test import TestCase, TransactionTestCase
from django.db import transaction

class BaseServiceTestCase(TestCase):
    """æœåŠ¡å±‚æµ‹è¯•åŸºç±»"""
    
    def setUp(self):
        """æµ‹è¯•ç¯å¢ƒå‡†å¤‡"""
        self.setup_test_data()
        self.setup_mocks()
    
    def setup_test_data(self):
        """è®¾ç½®æµ‹è¯•æ•°æ®"""
        self.test_tenant = self.create_test_tenant()
        self.test_member = self.create_test_member()
        self.test_license = self.create_test_license()
    
    def setup_mocks(self):
        """è®¾ç½®Mockå¯¹è±¡"""
        self.mock_repository = Mock()
        self.mock_permission_service = Mock()
        self.mock_audit_service = Mock()
    
    def create_test_tenant(self):
        """åˆ›å»ºæµ‹è¯•ç§Ÿæˆ·"""
        return Tenant.objects.create(
            name="æµ‹è¯•ç§Ÿæˆ·",
            code="test_tenant",
            is_active=True
        )
    
    def create_test_member(self):
        """åˆ›å»ºæµ‹è¯•æˆå‘˜"""
        return Member.objects.create(
            username="testuser",
            email="test@example.com",
            tenant=self.test_tenant
        )
    
    def create_test_license(self):
        """åˆ›å»ºæµ‹è¯•è®¸å¯è¯"""
        return License.objects.create(
            license_key="TEST-KEY-123",
            tenant=self.test_tenant,
            max_activations=5,
            status='activated'
        )

class BaseAPITestCase(TestCase):
    """APIæµ‹è¯•åŸºç±»"""
    
    def setUp(self):
        """APIæµ‹è¯•ç¯å¢ƒå‡†å¤‡"""
        self.setup_test_users()
        self.setup_authentication()
    
    def setup_test_users(self):
        """è®¾ç½®æµ‹è¯•ç”¨æˆ·"""
        self.super_admin = User.objects.create_user(
            username="superadmin",
            email="super@example.com",
            is_super_admin=True
        )
        
        self.tenant_admin = User.objects.create_user(
            username="tenantadmin",
            email="tenant@example.com",
            tenant=self.test_tenant,
            is_admin=True
        )
        
        self.normal_member = Member.objects.create_user(
            username="member",
            email="member@example.com",
            tenant=self.test_tenant
        )
    
    def setup_authentication(self):
        """è®¾ç½®è®¤è¯"""
        from rest_framework_simplejwt.tokens import RefreshToken
        
        # ä¸ºä¸åŒç”¨æˆ·ç”ŸæˆJWT Token
        self.super_admin_token = str(RefreshToken.for_user(self.super_admin).access_token)
        self.tenant_admin_token = str(RefreshToken.for_user(self.tenant_admin).access_token)
        self.member_token = str(RefreshToken.for_user(self.normal_member).access_token)
    
    def auth_headers(self, user_type='super_admin'):
        """è·å–è®¤è¯å¤´"""
        token_map = {
            'super_admin': self.super_admin_token,
            'tenant_admin': self.tenant_admin_token,
            'member': self.member_token
        }
        return {'HTTP_AUTHORIZATION': f'Bearer {token_map[user_type]}'}
```

#### é¢†åŸŸæœåŠ¡æµ‹è¯•ç¤ºä¾‹
```python
class TestLicenseAssignmentDomainService(BaseServiceTestCase):
    """è®¸å¯è¯åˆ†é…é¢†åŸŸæœåŠ¡æµ‹è¯•"""
    
    def setUp(self):
        super().setUp()
        self.service = LicenseAssignmentDomainService()
        self.service.repository = self.mock_repository
        self.service.permission_service = self.mock_permission_service
        self.service.audit_service = self.mock_audit_service
    
    def test_assign_license_success(self):
        """æµ‹è¯•æˆåŠŸåˆ†é…è®¸å¯è¯"""
        # Arrange
        self.mock_permission_service.can_assign_license.return_value = True
        self.mock_repository.check_quota.return_value = True
        self.mock_repository.is_already_assigned.return_value = False
        self.mock_repository.create_assignment.return_value = Mock(id=100)
        
        # Act
        result = self.service.assign_license_to_member(
            member_id=self.test_member.id,
            license_id=self.test_license.id,
            assigned_by_id=1
        )
        
        # Assert
        self.assertTrue(result['success'])
        self.assertEqual(result['assignment_id'], 100)
        
        # éªŒè¯è°ƒç”¨é¡ºåº
        self.mock_permission_service.can_assign_license.assert_called_once()
        self.mock_repository.check_quota.assert_called_once()
        self.mock_repository.is_already_assigned.assert_called_once()
        self.mock_repository.create_assignment.assert_called_once()
        self.mock_audit_service.log_assignment_operation.assert_called_once()
    
    def test_assign_license_permission_denied(self):
        """æµ‹è¯•æƒé™ä¸è¶³çš„æƒ…å†µ"""
        # Arrange
        self.mock_permission_service.can_assign_license.return_value = False
        
        # Act & Assert
        with self.assertRaises(PermissionDeniedException):
            self.service.assign_license_to_member(
                member_id=self.test_member.id,
                license_id=self.test_license.id,
                assigned_by_id=1
            )
        
        # éªŒè¯æ²¡æœ‰æ‰§è¡Œåç»­æ“ä½œ
        self.mock_repository.check_quota.assert_not_called()
    
    def test_assign_license_quota_exceeded(self):
        """æµ‹è¯•é…é¢è¶…é™çš„æƒ…å†µ"""
        # Arrange
        self.mock_permission_service.can_assign_license.return_value = True
        self.mock_repository.check_quota.return_value = False
        self.mock_repository.get_quota_info.return_value = (5, 5)
        
        # Act & Assert
        with self.assertRaises(QuotaExceededException) as context:
            self.service.assign_license_to_member(
                member_id=self.test_member.id,
                license_id=self.test_license.id
            )
        
        # éªŒè¯å¼‚å¸¸è¯¦æƒ…
        exception = context.exception
        self.assertEqual(exception.error_code, 'QUOTA_EXCEEDED')
        self.assertEqual(exception.details['license_id'], self.test_license.id)
    
    @patch('licenses.services.timezone.now')
    def test_assign_license_with_expiry(self, mock_now):
        """æµ‹è¯•å¸¦è¿‡æœŸæ—¶é—´çš„åˆ†é…"""
        # Arrange
        mock_now.return_value = datetime(2024, 9, 24, 10, 0, 0, tzinfo=timezone.utc)
        expected_expiry = datetime(2024, 12, 24, 10, 0, 0, tzinfo=timezone.utc)
        
        self.mock_permission_service.can_assign_license.return_value = True
        self.mock_repository.check_quota.return_value = True
        self.mock_repository.is_already_assigned.return_value = False
        
        # Act
        result = self.service.assign_license_to_member(
            member_id=self.test_member.id,
            license_id=self.test_license.id,
            expires_days=90
        )
        
        # Assert
        self.assertTrue(result['success'])
        
        # éªŒè¯è¿‡æœŸæ—¶é—´è®¡ç®—
        call_args = self.mock_repository.create_assignment.call_args[1]
        self.assertEqual(call_args['expires_at'], expected_expiry)
```

#### APIæµ‹è¯•ç¤ºä¾‹
```python
class TestLicenseAssignmentAPI(BaseAPITestCase):
    """è®¸å¯è¯åˆ†é…APIæµ‹è¯•"""
    
    def test_create_assignment_success(self):
        """æµ‹è¯•æˆåŠŸåˆ›å»ºåˆ†é…"""
        # Arrange
        data = {
            'member_id': self.test_member.id,
            'license_id': self.test_license.id,
            'assignment_type': 'direct',
            'max_concurrent_devices': 3
        }
        
        # Act
        response = self.client.post(
            '/api/v1/license-assignments/',
            data=data,
            content_type='application/json',
            **self.auth_headers('super_admin')
        )
        
        # Assert
        self.assertEqual(response.status_code, 201)
        self.assertTrue(response.json()['success'])
        self.assertIn('assignment_id', response.json()['data'])
        
        # éªŒè¯æ•°æ®åº“è®°å½•
        assignment = LicenseAssignment.objects.get(
            id=response.json()['data']['assignment_id']
        )
        self.assertEqual(assignment.member_id, self.test_member.id)
        self.assertEqual(assignment.license_id, self.test_license.id)
    
    def test_create_assignment_permission_denied(self):
        """æµ‹è¯•æƒé™ä¸è¶³"""
        # Arrange
        data = {
            'member_id': self.test_member.id,
            'license_id': self.test_license.id
        }
        
        # Act - ä½¿ç”¨æ™®é€šæˆå‘˜token
        response = self.client.post(
            '/api/v1/license-assignments/',
            data=data,
            content_type='application/json',
            **self.auth_headers('member')
        )
        
        # Assert
        self.assertEqual(response.status_code, 403)
    
    def test_get_assignments_list(self):
        """æµ‹è¯•è·å–åˆ†é…åˆ—è¡¨"""
        # Arrange - åˆ›å»ºæµ‹è¯•æ•°æ®
        assignment = LicenseAssignment.objects.create(
            member=self.test_member,
            license=self.test_license,
            status='active'
        )
        
        # Act
        response = self.client.get(
            '/api/v1/license-assignments/',
            **self.auth_headers('super_admin')
        )
        
        # Assert
        self.assertEqual(response.status_code, 200)
        data = response.json()
        self.assertTrue(data['success'])
        self.assertGreater(data['data']['count'], 0)
        
        # éªŒè¯è¿”å›æ•°æ®æ ¼å¼
        first_assignment = data['data']['results'][0]
        self.assertIn('id', first_assignment)
        self.assertIn('member', first_assignment)
        self.assertIn('license', first_assignment)
        self.assertIn('status', first_assignment)
    
    def test_batch_assign_licenses(self):
        """æµ‹è¯•æ‰¹é‡åˆ†é…è®¸å¯è¯"""
        # Arrange
        member2 = Member.objects.create(
            username="testuser2",
            email="test2@example.com",
            tenant=self.test_tenant
        )
        
        data = {
            'assignments': [
                {
                    'member_id': self.test_member.id,
                    'license_id': self.test_license.id,
                    'assignment_type': 'group'
                },
                {
                    'member_id': member2.id,
                    'license_id': self.test_license.id,
                    'assignment_type': 'group'
                }
            ],
            'common_settings': {
                'expires_days': 365,
                'assignment_notes': 'æ‰¹é‡åˆ†é…æµ‹è¯•'
            }
        }
        
        # Act
        response = self.client.post(
            '/api/v1/license-assignments/batch-assign/',
            data=data,
            content_type='application/json',
            **self.auth_headers('super_admin')
        )
        
        # Assert
        self.assertEqual(response.status_code, 200)
        result = response.json()
        self.assertTrue(result['success'])
        self.assertEqual(len(result['results']), 2)
        
        # éªŒè¯æ•°æ®åº“è®°å½•
        assignments = LicenseAssignment.objects.filter(
            license=self.test_license,
            assignment_notes__contains='æ‰¹é‡åˆ†é…æµ‹è¯•'
        )
        self.assertEqual(assignments.count(), 2)
```

## ğŸ”„ é›†æˆæµ‹è¯•ç­–ç•¥

### æµ‹è¯•åœºæ™¯è®¾è®¡

#### è·¨æœåŠ¡é›†æˆæµ‹è¯•
```python
class TestLicenseAssignmentIntegration(TransactionTestCase):
    """è®¸å¯è¯åˆ†é…é›†æˆæµ‹è¯•"""
    
    def setUp(self):
        """é›†æˆæµ‹è¯•ç¯å¢ƒå‡†å¤‡"""
        self.setup_test_environment()
        self.setup_real_services()
    
    def setup_real_services(self):
        """è®¾ç½®çœŸå®æœåŠ¡å®ä¾‹"""
        self.domain_service = LicenseAssignmentDomainService()
        self.application_service = LicenseManagementApplicationService()
        self.permission_service = PermissionValidationService()
        self.audit_service = AuditLogService()
    
    def test_complete_assignment_workflow(self):
        """æµ‹è¯•å®Œæ•´çš„åˆ†é…å·¥ä½œæµ"""
        # 1. åˆ›å»ºåˆ†é…è¯·æ±‚
        assignment_data = {
            'member_id': self.test_member.id,
            'license_id': self.test_license.id,
            'assigned_by_id': self.test_admin.id,
            'assignment_type': 'direct',
            'expires_days': 365
        }
        
        # 2. æ‰§è¡Œåˆ†é…
        result = self.application_service.assign_license_to_member(assignment_data)
        
        # 3. éªŒè¯åˆ†é…æˆåŠŸ
        self.assertTrue(result['success'])
        assignment_id = result['assignment_id']
        
        # 4. éªŒè¯æ•°æ®åº“çŠ¶æ€
        assignment = LicenseAssignment.objects.get(id=assignment_id)
        self.assertEqual(assignment.status, 'assigned')
        self.assertEqual(assignment.member, self.test_member)
        self.assertEqual(assignment.license, self.test_license)
        
        # 5. æµ‹è¯•æ¿€æ´»æµç¨‹
        activation_result = self.application_service.activate_assignment(
            assignment_id=assignment_id,
            device_info={
                'device_id': 'TEST-DEVICE-001',
                'hardware_fingerprint': 'test-fingerprint-123'
            }
        )
        
        # 6. éªŒè¯æ¿€æ´»æˆåŠŸ
        self.assertTrue(activation_result['success'])
        
        # 7. éªŒè¯çŠ¶æ€å˜æ›´
        assignment.refresh_from_db()
        self.assertEqual(assignment.status, 'active')
        self.assertIsNotNone(assignment.activated_at)
        
        # 8. éªŒè¯å®¡è®¡æ—¥å¿—
        audit_logs = SecurityAuditLog.objects.filter(
            details__assignment_id=assignment_id
        )
        self.assertGreater(audit_logs.count(), 0)
    
    def test_quota_enforcement_integration(self):
        """æµ‹è¯•é…é¢å¼ºåˆ¶æ‰§è¡Œçš„é›†æˆ"""
        # 1. è®¾ç½®è®¸å¯è¯æœ€å¤§æ¿€æ´»æ•°ä¸º2
        self.test_license.max_activations = 2
        self.test_license.save()
        
        # 2. åˆ›å»ºç¬¬ä¸€ä¸ªåˆ†é… - åº”è¯¥æˆåŠŸ
        result1 = self.application_service.assign_license_to_member({
            'member_id': self.test_member.id,
            'license_id': self.test_license.id,
            'assigned_by_id': self.test_admin.id
        })
        self.assertTrue(result1['success'])
        
        # 3. åˆ›å»ºç¬¬äºŒä¸ªæˆå‘˜å’Œåˆ†é… - åº”è¯¥æˆåŠŸ
        member2 = Member.objects.create(
            username="testuser2",
            email="test2@example.com",
            tenant=self.test_tenant
        )
        
        result2 = self.application_service.assign_license_to_member({
            'member_id': member2.id,
            'license_id': self.test_license.id,
            'assigned_by_id': self.test_admin.id
        })
        self.assertTrue(result2['success'])
        
        # 4. åˆ›å»ºç¬¬ä¸‰ä¸ªæˆå‘˜å’Œåˆ†é… - åº”è¯¥å¤±è´¥
        member3 = Member.objects.create(
            username="testuser3",
            email="test3@example.com",
            tenant=self.test_tenant
        )
        
        result3 = self.application_service.assign_license_to_member({
            'member_id': member3.id,
            'license_id': self.test_license.id,
            'assigned_by_id': self.test_admin.id
        })
        self.assertFalse(result3['success'])
        self.assertIn('é…é¢', result3['error'])
    
    def test_tenant_isolation_integration(self):
        """æµ‹è¯•ç§Ÿæˆ·éš”ç¦»çš„é›†æˆ"""
        # 1. åˆ›å»ºå¦ä¸€ä¸ªç§Ÿæˆ·å’Œç›¸å…³æ•°æ®
        other_tenant = Tenant.objects.create(
            name="å…¶ä»–ç§Ÿæˆ·",
            code="other_tenant"
        )
        
        other_member = Member.objects.create(
            username="otheruser",
            email="other@example.com", 
            tenant=other_tenant
        )
        
        # 2. å°è¯•è·¨ç§Ÿæˆ·åˆ†é… - åº”è¯¥å¤±è´¥
        result = self.application_service.assign_license_to_member({
            'member_id': other_member.id,  # ä¸åŒç§Ÿæˆ·çš„æˆå‘˜
            'license_id': self.test_license.id,  # åŸç§Ÿæˆ·çš„è®¸å¯è¯
            'assigned_by_id': self.test_admin.id
        })
        
        # 3. éªŒè¯å¤±è´¥
        self.assertFalse(result['success'])
        self.assertIn('ç§Ÿæˆ·', result['error'])
        
        # 4. éªŒè¯æ²¡æœ‰åˆ›å»ºåˆ†é…è®°å½•
        assignments = LicenseAssignment.objects.filter(
            member=other_member,
            license=self.test_license
        )
        self.assertEqual(assignments.count(), 0)
```

## âš¡ æ€§èƒ½æµ‹è¯•ç­–ç•¥

### æ€§èƒ½æµ‹è¯•åœºæ™¯

#### è´Ÿè½½æµ‹è¯•
```python
import time
import concurrent.futures
from django.test import TestCase
from django.test.utils import override_settings

class TestLicenseAssignmentPerformance(TestCase):
    """è®¸å¯è¯åˆ†é…æ€§èƒ½æµ‹è¯•"""
    
    def setUp(self):
        self.setup_performance_test_data()
    
    def setup_performance_test_data(self):
        """è®¾ç½®æ€§èƒ½æµ‹è¯•æ•°æ®"""
        # åˆ›å»ºå¤§é‡æµ‹è¯•æ•°æ®
        self.tenant = Tenant.objects.create(name="æ€§èƒ½æµ‹è¯•ç§Ÿæˆ·")
        
        # åˆ›å»º1000ä¸ªæˆå‘˜
        self.members = []
        for i in range(1000):
            member = Member.objects.create(
                username=f"perfuser{i}",
                email=f"perf{i}@example.com",
                tenant=self.tenant
            )
            self.members.append(member)
        
        # åˆ›å»º100ä¸ªè®¸å¯è¯
        self.licenses = []
        for i in range(100):
            license = License.objects.create(
                license_key=f"PERF-KEY-{i:03d}",
                tenant=self.tenant,
                max_activations=50
            )
            self.licenses.append(license)
    
    def test_batch_assignment_performance(self):
        """æµ‹è¯•æ‰¹é‡åˆ†é…æ€§èƒ½"""
        # æµ‹è¯•åœºæ™¯ï¼šåŒæ—¶åˆ†é…100ä¸ªè®¸å¯è¯ç»™100ä¸ªç”¨æˆ·
        start_time = time.time()
        
        service = LicenseManagementApplicationService()
        
        # å‡†å¤‡æ‰¹é‡åˆ†é…æ•°æ®
        assignments_data = []
        for i in range(100):
            assignments_data.append({
                'member_id': self.members[i].id,
                'license_id': self.licenses[i % 10].id,  # é‡å¤ä½¿ç”¨å‰10ä¸ªè®¸å¯è¯
                'assignment_type': 'direct'
            })
        
        # æ‰§è¡Œæ‰¹é‡åˆ†é…
        result = service.batch_assign_licenses(assignments_data)
        
        end_time = time.time()
        execution_time = end_time - start_time
        
        # æ€§èƒ½æ–­è¨€
        self.assertTrue(result['success'])
        self.assertLess(execution_time, 5.0)  # åº”è¯¥åœ¨5ç§’å†…å®Œæˆ
        
        # éªŒè¯åˆ†é…æˆåŠŸ
        successful_assignments = sum(1 for r in result['results'] if r['success'])
        self.assertGreater(successful_assignments, 90)  # è‡³å°‘90%æˆåŠŸç‡
    
    def test_concurrent_assignment_performance(self):
        """æµ‹è¯•å¹¶å‘åˆ†é…æ€§èƒ½"""
        def assign_license(member_license_pair):
            """å•ä¸ªåˆ†é…æ“ä½œ"""
            member, license = member_license_pair
            service = LicenseManagementApplicationService()
            return service.assign_license_to_member({
                'member_id': member.id,
                'license_id': license.id,
                'assignment_type': 'concurrent_test'
            })
        
        # å‡†å¤‡å¹¶å‘æµ‹è¯•æ•°æ®
        test_pairs = []
        for i in range(50):
            test_pairs.append((
                self.members[i],
                self.licenses[0]  # æ‰€æœ‰è¯·æ±‚éƒ½å°è¯•åˆ†é…åŒä¸€ä¸ªè®¸å¯è¯
            ))
        
        start_time = time.time()
        
        # ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œå¹¶å‘åˆ†é…
        with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
            futures = [executor.submit(assign_license, pair) for pair in test_pairs]
            results = [future.result() for future in concurrent.futures.as_completed(futures)]
        
        end_time = time.time()
        execution_time = end_time - start_time
        
        # æ€§èƒ½æ–­è¨€
        self.assertLess(execution_time, 10.0)  # åº”è¯¥åœ¨10ç§’å†…å®Œæˆ
        
        # éªŒè¯å¹¶å‘æ§åˆ¶
        successful_results = [r for r in results if r['success']]
        # ç”±äºé…é¢é™åˆ¶ï¼ŒæˆåŠŸçš„åˆ†é…æ•°é‡åº”è¯¥å°äºç­‰äºè®¸å¯è¯çš„æœ€å¤§æ¿€æ´»æ•°
        self.assertLessEqual(len(successful_results), self.licenses[0].max_activations)
    
    def test_query_performance(self):
        """æµ‹è¯•æŸ¥è¯¢æ€§èƒ½"""
        # å…ˆåˆ›å»ºå¤§é‡åˆ†é…è®°å½•
        assignments = []
        for i in range(1000):
            assignment = LicenseAssignment.objects.create(
                member=self.members[i % len(self.members)],
                license=self.licenses[i % len(self.licenses)],
                status='active'
            )
            assignments.append(assignment)
        
        repository = LicenseAssignmentRepository()
        
        # æµ‹è¯•æŒ‰æˆå‘˜æŸ¥è¯¢æ€§èƒ½
        start_time = time.time()
        for i in range(100):
            member_assignments = repository.find_by_member_with_details(
                self.members[i].id
            )
            list(member_assignments)  # å¼ºåˆ¶æ‰§è¡ŒæŸ¥è¯¢
        
        query_time = time.time() - start_time
        
        # æ€§èƒ½æ–­è¨€
        self.assertLess(query_time, 2.0)  # 100æ¬¡æŸ¥è¯¢åº”è¯¥åœ¨2ç§’å†…å®Œæˆ
        
        # æµ‹è¯•ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½
        start_time = time.time()
        stats = repository.get_assignment_statistics(self.tenant.id)
        stats_time = time.time() - start_time
        
        self.assertLess(stats_time, 0.5)  # ç»Ÿè®¡æŸ¥è¯¢åº”è¯¥åœ¨0.5ç§’å†…å®Œæˆ
```

### å‹åŠ›æµ‹è¯•
```python
class TestSystemStressTest(TestCase):
    """ç³»ç»Ÿå‹åŠ›æµ‹è¯•"""
    
    @override_settings(DEBUG=False)
    def test_high_load_assignment_stress(self):
        """é«˜è´Ÿè½½åˆ†é…å‹åŠ›æµ‹è¯•"""
        # æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç³»ç»Ÿè¡Œä¸º
        
        # åˆ›å»ºå¤§é‡æµ‹è¯•æ•°æ®
        tenant = Tenant.objects.create(name="å‹åŠ›æµ‹è¯•ç§Ÿæˆ·")
        
        # åˆ›å»º5000ä¸ªæˆå‘˜
        Member.objects.bulk_create([
            Member(
                username=f"stressuser{i}",
                email=f"stress{i}@example.com",
                tenant=tenant
            ) for i in range(5000)
        ])
        
        # åˆ›å»º500ä¸ªè®¸å¯è¯ï¼Œæ¯ä¸ªè®¸å¯è¯å…è®¸100ä¸ªæ¿€æ´»
        License.objects.bulk_create([
            License(
                license_key=f"STRESS-KEY-{i:04d}",
                tenant=tenant,
                max_activations=100,
                status='activated'
            ) for i in range(500)
        ])
        
        members = Member.objects.filter(tenant=tenant)
        licenses = License.objects.filter(tenant=tenant)
        
        def stress_assignment_operation():
            """å‹åŠ›æµ‹è¯•æ“ä½œ"""
            import random
            service = LicenseManagementApplicationService()
            
            # éšæœºé€‰æ‹©æˆå‘˜å’Œè®¸å¯è¯
            member = random.choice(members)
            license = random.choice(licenses)
            
            try:
                result = service.assign_license_to_member({
                    'member_id': member.id,
                    'license_id': license.id,
                    'assignment_type': 'stress_test'
                })
                return result['success']
            except Exception:
                return False
        
        # æ‰§è¡Œå‹åŠ›æµ‹è¯•
        start_time = time.time()
        success_count = 0
        total_operations = 1000
        
        with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
            futures = [
                executor.submit(stress_assignment_operation) 
                for _ in range(total_operations)
            ]
            
            for future in concurrent.futures.as_completed(futures):
                if future.result():
                    success_count += 1
        
        end_time = time.time()
        execution_time = end_time - start_time
        
        # å‹åŠ›æµ‹è¯•è¯„ä¼°
        success_rate = success_count / total_operations
        throughput = total_operations / execution_time
        
        # æ–­è¨€ç³»ç»Ÿåœ¨å‹åŠ›ä¸‹çš„è¡¨ç°
        self.assertGreater(success_rate, 0.8)  # æˆåŠŸç‡åº”è¯¥å¤§äº80%
        self.assertGreater(throughput, 20)     # ååé‡åº”è¯¥å¤§äº20 ops/sec
        self.assertLess(execution_time, 60)    # æ€»æ—¶é—´åº”è¯¥å°äº60ç§’
        
        print(f"å‹åŠ›æµ‹è¯•ç»“æœ:")
        print(f"  æˆåŠŸç‡: {success_rate:.2%}")
        print(f"  ååé‡: {throughput:.2f} ops/sec")
        print(f"  æ‰§è¡Œæ—¶é—´: {execution_time:.2f} seconds")
```

## ğŸ”’ å®‰å…¨æµ‹è¯•ç­–ç•¥

### æƒé™æ§åˆ¶æµ‹è¯•
```python
class TestSecurityAndPermissions(BaseAPITestCase):
    """å®‰å…¨å’Œæƒé™æµ‹è¯•"""
    
    def test_unauthorized_access_blocked(self):
        """æµ‹è¯•æœªæˆæƒè®¿é—®è¢«é˜»æ­¢"""
        # æµ‹è¯•æ— Tokenè®¿é—®
        response = self.client.get('/api/v1/license-assignments/')
        self.assertEqual(response.status_code, 401)
        
        # æµ‹è¯•æ— æ•ˆTokenè®¿é—®
        response = self.client.get(
            '/api/v1/license-assignments/',
            HTTP_AUTHORIZATION='Bearer invalid-token'
        )
        self.assertEqual(response.status_code, 401)
    
    def test_cross_tenant_access_blocked(self):
        """æµ‹è¯•è·¨ç§Ÿæˆ·è®¿é—®è¢«é˜»æ­¢"""
        # åˆ›å»ºå¦ä¸€ä¸ªç§Ÿæˆ·çš„æ•°æ®
        other_tenant = Tenant.objects.create(name="å…¶ä»–ç§Ÿæˆ·")
        other_member = Member.objects.create(
            username="otheruser",
            email="other@example.com",
            tenant=other_tenant
        )
        other_license = License.objects.create(
            license_key="OTHER-KEY-123",
            tenant=other_tenant
        )
        other_assignment = LicenseAssignment.objects.create(
            member=other_member,
            license=other_license
        )
        
        # ç§Ÿæˆ·ç®¡ç†å‘˜å°è¯•è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®
        response = self.client.get(
            f'/api/v1/license-assignments/{other_assignment.id}/',
            **self.auth_headers('tenant_admin')
        )
        
        # åº”è¯¥è¢«æ‹’ç»æˆ–è¿”å›404
        self.assertIn(response.status_code, [403, 404])
    
    def test_privilege_escalation_blocked(self):
        """æµ‹è¯•æƒé™æå‡è¢«é˜»æ­¢"""
        # æ™®é€šæˆå‘˜å°è¯•åˆ›å»ºåˆ†é…
        data = {
            'member_id': self.test_member.id,
            'license_id': self.test_license.id
        }
        
        response = self.client.post(
            '/api/v1/license-assignments/',
            data=data,
            content_type='application/json',
            **self.auth_headers('member')
        )
        
        self.assertEqual(response.status_code, 403)
    
    def test_input_validation_security(self):
        """æµ‹è¯•è¾“å…¥éªŒè¯å®‰å…¨æ€§"""
        # SQLæ³¨å…¥å°è¯•
        malicious_data = {
            'member_id': "1; DROP TABLE license_assignment; --",
            'license_id': self.test_license.id
        }
        
        response = self.client.post(
            '/api/v1/license-assignments/',
            data=malicious_data,
            content_type='application/json',
            **self.auth_headers('super_admin')
        )
        
        # åº”è¯¥è¿”å›400é”™è¯¯ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ¶æ„SQL
        self.assertEqual(response.status_code, 400)
        
        # XSSå°è¯•
        xss_data = {
            'member_id': self.test_member.id,
            'license_id': self.test_license.id,
            'assignment_notes': '<script>alert("XSS")</script>'
        }
        
        response = self.client.post(
            '/api/v1/license-assignments/',
            data=xss_data,
            content_type='application/json',
            **self.auth_headers('super_admin')
        )
        
        if response.status_code == 201:
            # æ£€æŸ¥è¿”å›çš„æ•°æ®æ˜¯å¦è¢«æ­£ç¡®è½¬ä¹‰
            assignment_id = response.json()['data']['assignment_id']
            assignment = LicenseAssignment.objects.get(id=assignment_id)
            self.assertNotIn('<script>', assignment.assignment_notes)
```

## ğŸ“Š æµ‹è¯•æ‰§è¡Œå’ŒæŠ¥å‘Š

### è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹
```python
# pytesté…ç½®æ–‡ä»¶ - pytest.ini
[tool:pytest]
DJANGO_SETTINGS_MODULE = core.settings_test
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    --verbose
    --tb=short
    --cov=licenses
    --cov-report=html
    --cov-report=term-missing
    --cov-fail-under=85
    --maxfail=10
markers =
    unit: Unit tests
    integration: Integration tests  
    performance: Performance tests
    security: Security tests
    slow: Slow running tests
```

### æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿
```python
class TestReportGenerator:
    """æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå™¨"""
    
    def generate_test_report(self, test_results):
        """ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"""
        report = {
            'summary': {
                'total_tests': test_results['total'],
                'passed': test_results['passed'],
                'failed': test_results['failed'],
                'skipped': test_results['skipped'],
                'success_rate': test_results['passed'] / test_results['total'],
                'execution_time': test_results['duration']
            },
            'coverage': {
                'overall': test_results['coverage']['total'],
                'by_component': test_results['coverage']['by_file']
            },
            'performance_metrics': {
                'avg_response_time': test_results['performance']['avg_response'],
                'max_response_time': test_results['performance']['max_response'],
                'throughput': test_results['performance']['throughput']
            },
            'security_checks': {
                'authentication': test_results['security']['auth_tests'],
                'authorization': test_results['security']['authz_tests'],
                'input_validation': test_results['security']['validation_tests']
            }
        }
        
        return report
```

### æŒç»­é›†æˆé…ç½®
```yaml
# CI/CD æµæ°´çº¿é…ç½®ç¤ºä¾‹
name: License Assignment Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: lipeaks_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    
    - name: Install dependencies
      run: |
        pip install -r requirements-test.txt
    
    - name: Run unit tests
      run: |
        pytest tests/unit/ -m "unit" --cov=licenses
    
    - name: Run integration tests  
      run: |
        pytest tests/integration/ -m "integration"
    
    - name: Run performance tests
      run: |
        pytest tests/performance/ -m "performance"
    
    - name: Run security tests
      run: |
        pytest tests/security/ -m "security"
    
    - name: Generate test report
      run: |
        pytest --html=report.html --self-contained-html
    
    - name: Upload test results
      uses: actions/upload-artifact@v2
      with:
        name: test-results
        path: report.html
```

## ğŸ¯ æµ‹è¯•æˆåŠŸæ ‡å‡†

### æµ‹è¯•è¦†ç›–ç‡æ ‡å‡†
- **æ•´ä½“è¦†ç›–ç‡**: â‰¥ 85%
- **å…³é”®ä¸šåŠ¡é€»è¾‘**: â‰¥ 95%
- **APIç«¯ç‚¹**: â‰¥ 80%
- **é”™è¯¯å¤„ç†**: â‰¥ 90%

### æ€§èƒ½æ ‡å‡†
- **APIå“åº”æ—¶é—´**: 95%è¯·æ±‚ < 500ms
- **æ•°æ®åº“æŸ¥è¯¢**: å¹³å‡ < 100ms
- **å¹¶å‘å¤„ç†**: æ”¯æŒ1000+å¹¶å‘ç”¨æˆ·
- **ç³»ç»Ÿååé‡**: â‰¥ 100 requests/second

### å®‰å…¨æ ‡å‡†
- **æƒé™æ§åˆ¶**: 100%æµ‹è¯•é€šè¿‡
- **è¾“å…¥éªŒè¯**: 100%æµ‹è¯•é€šè¿‡
- **ç§Ÿæˆ·éš”ç¦»**: 100%æµ‹è¯•é€šè¿‡
- **å®‰å…¨æ¼æ´**: 0ä¸ªé«˜å±æ¼æ´

---

**å®æ–½å®Œæˆ**: è‡³æ­¤ï¼Œè®¸å¯è¯ä¸æˆå‘˜ç”¨æˆ·å…³è”çš„é¢†åŸŸæœåŠ¡æ¨¡å¼å®Œæ•´å®æ–½æ–¹æ¡ˆå·²ç»åˆ¶å®šå®Œæ¯•ã€‚è¯·æŒ‰ç…§æ–‡æ¡£é¡ºåºå®æ–½ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µçš„è´¨é‡æ ‡å‡†ã€‚
