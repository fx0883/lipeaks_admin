# 联系人订单管理API

本文档介绍了联系人订单管理API，用于获取特定联系人的所有订单及订单详情。

## 1. 获取联系人订单列表

获取特定联系人的所有订单，支持分页、排序和筛选。

### 请求

```
GET /api/v1/orders/contacts/{contact_id}/orders/
```

### 路径参数

| 参数名 | 类型 | 描述 |
| --- | --- | --- |
| contact_id | integer | 联系人ID |

### 查询参数

| 参数名 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| payment_status | string | 否 | 按支付状态筛选订单 |
| service_type | string | 否 | 按服务类型筛选订单 |
| order_date_from | string | 否 | 按订单日期范围筛选（起始），格式YYYY-MM-DD |
| order_date_to | string | 否 | 按订单日期范围筛选（结束），格式YYYY-MM-DD |
| search | string | 否 | 搜索订单编号、译员等信息 |
| page | integer | 否 | 页码，默认为1 |
| page_size | integer | 否 | 每页数量，默认为10 |
| ordering | string | 否 | 排序字段，可用字段: created_at, order_date, customer_total_amount, payment_status |

### 响应

```json
{
  "count": 2,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 18,
      "customer_name": "北京科技有限公司",
      "created_by_info": {
        "id": 1,
        "username": "admin",
        "display_name": "管理员"
      },
      "customer_contact_info": {
        "id": 12,
        "username": "lisi",
        "display_name": "李四",
        "phone": "13900139000",
        "email": "lisi@example.com"
      },
      "profit": 600.00,
      "profit_rate": 0.30,
      "formatted_profit": "¥600.00",
      "formatted_profit_rate": "30.00%",
      "created_at": "2025-07-10T11:22:33Z",
      "updated_at": "2025-07-10T11:22:33Z",
      "is_deleted": false,
      "order_number": "PQ-202507-1234",
      "service_type": "校对服务",
      "language": "中英",
      "customer_count": "3000字",
      "customer_total_amount": "2000.00",
      "payment_status": "paid",
      "payment_status_display": "已支付"
    },
    {
      "id": 19,
      "customer_name": "北京科技有限公司",
      "created_by_info": {
        "id": 1,
        "username": "admin",
        "display_name": "管理员"
      },
      "customer_contact_info": {
        "id": 12,
        "username": "lisi",
        "display_name": "李四",
        "phone": "13900139000",
        "email": "lisi@example.com"
      },
      "profit": 800.00,
      "profit_rate": 0.40,
      "formatted_profit": "¥800.00",
      "formatted_profit_rate": "40.00%",
      "created_at": "2025-07-12T14:25:36Z",
      "updated_at": "2025-07-12T14:25:36Z",
      "is_deleted": false,
      "order_number": "PQ-202507-5432",
      "service_type": "文档翻译",
      "language": "中英",
      "customer_count": "2000字",
      "customer_total_amount": "2000.00",
      "payment_status": "unpaid",
      "payment_status_display": "未支付"
    }
  ]
}
```

### 示例

```bash
# 获取联系人ID为12的所有订单
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/contacts/12/orders/' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

# 获取联系人ID为12的已支付订单
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/contacts/12/orders/?payment_status=paid' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

# 按日期范围筛选联系人订单
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/contacts/12/orders/?order_date_from=2025-07-01&order_date_to=2025-07-31' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

# 搜索联系人订单
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/contacts/12/orders/?search=校对' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```

## 2. 获取联系人订单详情

获取特定联系人的指定订单详情。

### 请求

```
GET /api/v1/orders/contacts/{contact_id}/orders/{id}/
```

### 路径参数

| 参数名 | 类型 | 描述 |
| --- | --- | --- |
| contact_id | integer | 联系人ID |
| id | integer | 订单ID |

### 响应

```json
{
  "id": 18,
  "customer": {
    "id": 3,
    "name": "北京科技有限公司",
    "code": "BJ001",
    "contact_name": "李四",
    "contact_phone": "13900139000",
    "contact_email": "lisi@example.com"
  },
  "customer_contact": {
    "id": 12,
    "username": "lisi",
    "display_name": "李四",
    "phone": "13900139000",
    "email": "lisi@example.com"
  },
  "history_count": 1,
  "profit": 600.00,
  "profit_rate": 0.30,
  "formatted_profit": "¥600.00",
  "formatted_profit_rate": "30.00%",
  "created_at": "2025-07-10T11:22:33Z",
  "updated_at": "2025-07-10T11:22:33Z",
  "is_deleted": false,
  "order_number": "PQ-202507-1234",
  "source_platform": "邮件咨询",
  "project_manager": "八组",
  "customer_type": "新客户",
  "order_date": "2025-07-10",
  "service_type": "校对服务",
  "service_type_display": "校对服务",
  "language": "中英",
  "customer_count": "3000字",
  "translation_count": "3000字",
  "service_time": "2025-07-12",
  "project_location": "线上",
  "translator": "王五",
  "customer_price": "0.67元/字",
  "customer_total_amount": "2000.00",
  "translator_fee": "1200.00",
  "translator_price": "0.4元/字",
  "translator_payment_status": "已付款",
  "translator_payment_method": "微信",
  "project_fee": "200.00",
  "project_details": "英文论文校对",
  "cost_details": "术语表制作费用200元",
  "refund_amount": "0.00",
  "refund_reason": null,
  "payment_status": "paid",
  "payment_status_display": "已支付",
  "payment_date": "2025-07-10",
  "payment_method": "支付宝",
  "payment_remarks": "已确认收款",
  "invoice_status": "issued",
  "invoice_status_display": "已开具",
  "invoice_info": "已开具电子发票",
  "contract_number": null,
  "contract_info": null,
  "contract_remarks": null,
  "delivery_address": null,
  "order_address": "北京市海淀区xx路xx号",
  "remarks": "客户要求重点检查专业术语",
  "follow_up_record": "2025-07-11已电话回访，客户表示满意",
  "tenant": 1
}
```

### 示例

```bash
# 获取联系人ID为12的订单ID为18的详情
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/contacts/12/orders/18/' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```

## 联系人订单API说明

### 联系人与客户的关系

在系统中：
- 一个客户（Customer）可以有多个联系人（Contact/Member）
- 一个联系人只属于一个客户
- 订单（Order）与客户（Customer）和联系人（Contact/Member）都有关联
- 联系人订单API筛选的是`customer_contact_id`字段为指定联系人ID的订单

### 过滤参数

联系人订单API支持以下过滤参数：

1. **按支付状态筛选**：
   - `payment_status=paid` - 已支付的订单
   - `payment_status=unpaid` - 未支付的订单

2. **按服务类型筛选**：
   - `service_type=文档翻译`
   - `service_type=口译服务`
   - `service_type=校对服务`

3. **按日期范围筛选**：
   - `order_date_from=2025-07-01` - 起始日期
   - `order_date_to=2025-07-31` - 结束日期

4. **搜索功能**：
   - `search=关键词` - 搜索订单编号、译员等信息

### 排序选项

联系人订单API支持以下排序选项：

- `ordering=created_at` - 按创建时间升序
- `ordering=-created_at` - 按创建时间降序
- `ordering=order_date` - 按订单日期升序
- `ordering=-order_date` - 按订单日期降序
- `ordering=customer_total_amount` - 按客户总金额升序
- `ordering=-customer_total_amount` - 按客户总金额降序
- `ordering=payment_status` - 按支付状态升序
- `ordering=-payment_status` - 按支付状态降序

### 注意事项

- 联系人订单API只返回特定联系人的订单数据，必须提供有效的联系人ID
- 用户必须拥有查看该联系人订单的权限
- 接口默认返回未删除的订单（is_deleted=False）
- 支持分页功能，可通过page和page_size参数控制 