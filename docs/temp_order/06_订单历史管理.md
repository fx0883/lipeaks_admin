# 订单历史管理API

本文档介绍了订单历史管理API，用于查询、比较和还原订单历史版本。

## 1. 获取订单历史记录列表

获取指定订单的所有历史记录。

### 请求

```
GET /api/v1/orders/{order_id}/history/
```

### 路径参数

| 参数名 | 类型 | 描述 |
| --- | --- | --- |
| order_id | integer | 订单ID |

### 查询参数

| 参数名 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| ordering | string | 否 | 排序字段，可用字段: version, modified_at，默认为-version（按版本降序） |
| page | integer | 否 | 页码，默认为1 |
| page_size | integer | 否 | 每页数量，默认为10 |

### 响应

```json
{
  "count": 3,
  "next": null,
  "previous": null,
  "results": [
    {
      "id": 5,
      "order": 63,
      "version": 3,
      "modified_by": 1,
      "modified_by_name": "admin",
      "modified_at": "2025-07-12T10:30:45Z",
      "change_details": "{\"action\": \"update\", \"changes\": {\"payment_status\": {\"old\": \"unpaid\", \"new\": \"paid\"}, \"payment_date\": {\"old\": null, \"new\": \"2025-07-12\"}, \"payment_method\": {\"old\": null, \"new\": \"\\u5fae\\u4fe1\\u652f\\u4ed8\"}}}",
      "change_details_data": {
        "action": "update",
        "changes": {
          "payment_status": {
            "old": "unpaid",
            "new": "paid"
          },
          "payment_date": {
            "old": null,
            "new": "2025-07-12"
          },
          "payment_method": {
            "old": null,
            "new": "微信支付"
          }
        }
      },
      "snapshot": "{...}", // 实际包含完整的订单数据快照
      "snapshot_data": {
        "id": 63,
        "order_number": "PQ-202507-3456",
        "customer_id": 3,
        "customer_name": "北京科技有限公司",
        "payment_status": "paid",
        "payment_date": "2025-07-12",
        "payment_method": "微信支付",
        // ... 更多订单字段
      }
    },
    {
      "id": 4,
      "order": 63,
      "version": 2,
      "modified_by": 1,
      "modified_by_name": "admin",
      "modified_at": "2025-07-11T16:45:20Z",
      "change_details": "{\"action\": \"update\", \"changes\": {\"translator_fee\": {\"old\": \"0.00\", \"new\": \"500.00\"}, \"translator\": {\"old\": null, \"new\": \"\\u5f20\\u4e09\"}}}",
      "change_details_data": {
        "action": "update",
        "changes": {
          "translator_fee": {
            "old": "0.00",
            "new": "500.00"
          },
          "translator": {
            "old": null,
            "new": "张三"
          }
        }
      },
      "snapshot": "{...}",
      "snapshot_data": {
        // 订单快照数据
      }
    },
    {
      "id": 3,
      "order": 63,
      "version": 1,
      "modified_by": 1,
      "modified_by_name": "admin",
      "modified_at": "2025-07-10T09:15:30Z",
      "change_details": "{\"action\": \"create\", \"message\": \"创建订单\"}",
      "change_details_data": {
        "action": "create",
        "message": "创建订单"
      },
      "snapshot": "{...}",
      "snapshot_data": {
        // 订单快照数据
      }
    }
  ]
}
```

### 示例

```bash
# 获取订单ID为63的所有历史记录
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/63/history/' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

# 按修改时间排序
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/63/history/?ordering=modified_at' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```

## 2. 获取订单历史记录详情

获取指定订单的特定版本历史记录详情。

### 请求

```
GET /api/v1/orders/{order_id}/history/{version}/
```

### 路径参数

| 参数名 | 类型 | 描述 |
| --- | --- | --- |
| order_id | integer | 订单ID |
| version | integer | 版本号 |

### 响应

```json
{
  "id": 5,
  "order": 63,
  "version": 3,
  "modified_by": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "display_name": "系统管理员"
  },
  "modified_by_name": "admin",
  "modified_at": "2025-07-12T10:30:45Z",
  "change_details": "{\"action\": \"update\", \"changes\": {\"payment_status\": {\"old\": \"unpaid\", \"new\": \"paid\"}, \"payment_date\": {\"old\": null, \"new\": \"2025-07-12\"}, \"payment_method\": {\"old\": null, \"new\": \"\\u5fae\\u4fe1\\u652f\\u4ed8\"}}}",
  "change_details_data": {
    "action": "update",
    "changes": {
      "payment_status": {
        "old": "unpaid",
        "new": "paid"
      },
      "payment_date": {
        "old": null,
        "new": "2025-07-12"
      },
      "payment_method": {
        "old": null,
        "new": "微信支付"
      }
    }
  },
  "snapshot": "{...}", // 实际包含完整的订单数据快照
  "snapshot_data": {
    "id": 63,
    "order_number": "PQ-202507-3456",
    "customer_id": 3,
    "customer_name": "北京科技有限公司",
    "source_platform": "官网",
    "project_manager": "五组",
    "customer_type": "老客户",
    "order_date": "2025-07-10",
    "service_type": "文档翻译",
    "language": "中英",
    "customer_count": "1000字",
    "translation_count": "1000字",
    "service_time": "2025-07-15",
    "project_location": "线上",
    "customer_contact_id": 12,
    "translator": "张三",
    "customer_price": "0.5元/字",
    "customer_total_amount": "500.00",
    "translator_fee": "500.00",
    "translator_price": "0.5元/字",
    "translator_payment_status": "待付款",
    "translator_payment_method": "支付宝",
    "project_fee": "0.00",
    "project_details": null,
    "cost_details": null,
    "refund_amount": "0.00",
    "refund_reason": null,
    "payment_status": "paid",
    "payment_date": "2025-07-12",
    "payment_method": "微信支付",
    "payment_remarks": null,
    "invoice_status": "not_required",
    "invoice_info": null,
    "contract_number": null,
    "contract_info": null,
    "contract_remarks": null,
    "delivery_address": null,
    "order_address": null,
    "remarks": null,
    "follow_up_record": null,
    "tenant_id": 1,
    "created_at": "2025-07-10T09:15:30Z",
    "updated_at": "2025-07-12T10:30:45Z",
    "is_deleted": false
  }
}
```

### 示例

```bash
# 获取订单ID为63的版本3历史记录详情
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/63/history/3/' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```

## 3. 比较订单历史版本

比较指定订单的两个历史版本的差异。

### 请求

```
GET /api/v1/orders/{order_id}/history/compare/
```

### 路径参数

| 参数名 | 类型 | 描述 |
| --- | --- | --- |
| order_id | integer | 订单ID |

### 查询参数

| 参数名 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| version1 | integer | 是 | 第一个版本号 |
| version2 | integer | 是 | 第二个版本号 |

### 响应

```json
{
  "order_id": 63,
  "order_number": "PQ-202507-3456",
  "version1": 2,
  "version2": 3,
  "differences": {
    "payment_status": {
      "version1": "unpaid",
      "version2": "paid"
    },
    "payment_date": {
      "version1": null,
      "version2": "2025-07-12"
    },
    "payment_method": {
      "version1": null,
      "version2": "微信支付"
    },
    "updated_at": {
      "version1": "2025-07-11T16:45:20Z",
      "version2": "2025-07-12T10:30:45Z"
    }
  }
}
```

### 示例

```bash
# 比较订单ID为63的版本2和版本3的差异
curl -X 'GET' \
  'http://localhost:8000/api/v1/orders/63/history/compare/?version1=2&version2=3' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```

## 4. 还原到历史版本

将订单还原到指定的历史版本。

### 请求

```
POST /api/v1/orders/{order_id}/history/{version}/restore/
```

### 路径参数

| 参数名 | 类型 | 描述 |
| --- | --- | --- |
| order_id | integer | 订单ID |
| version | integer | 要还原到的版本号 |

### 请求体

无需请求体。

### 响应

成功时返回还原后的订单完整数据（与[获取订单详情](01_订单基础操作.md#2-获取订单详情)接口响应格式相同）。

### 示例

```bash
# 将订单ID为63还原到版本2
curl -X 'POST' \
  'http://localhost:8000/api/v1/orders/63/history/2/restore/' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```

## 订单历史管理说明

### 历史记录机制

1. **历史记录创建时机**：
   - 订单创建时（版本1）
   - 订单信息更新时
   - 订单还原到历史版本时

2. **版本号**：
   - 从1开始递增
   - 每个订单的版本号是独立的

3. **历史记录内容**：
   - `version`：版本号
   - `modified_by`：修改人信息
   - `modified_at`：修改时间
   - `change_details`：变更详情，包含修改的字段及新旧值
   - `snapshot`：订单完整快照，即该版本时订单的完整状态

### 比较功能

比较功能可以清晰展示两个版本之间的具体差异：

1. 支持任意两个版本的比较（不限于相邻版本）
2. 差异结果包含字段名、版本1的值和版本2的值
3. 仅显示有差异的字段，相同字段不会显示

### 还原功能

还原功能用于将订单回滚到历史版本状态：

1. 仅管理员有权限使用还原功能
2. 执行还原操作后会自动创建一个新的历史记录，记录还原操作本身
3. 还原时会保留以下系统字段不变：id、created_at、tenant等
4. 还原会替换除系统字段外的所有订单信息

### 注意事项

- 历史记录不能被修改或删除，确保审计跟踪的完整性
- 历史记录的快照是完整的订单数据副本，包括关联信息的ID
- 比较功能在处理大量差异时可能会有性能消耗
- 还原操作是一个敏感操作，应谨慎使用并限制权限 