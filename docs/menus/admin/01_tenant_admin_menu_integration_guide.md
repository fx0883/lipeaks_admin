# 租户管理员菜单集成指南

## 概述

本文档为前端开发人员提供在管理员用户列表中添加"设置当前租户菜单"功能的集成指南。该功能仅对租户管理员角色可见，允许租户管理员自定义其租户的菜单配置。

> **重要说明**：当前后端API实现仅允许超级管理员设置菜单权限。前端集成时需按照需求调整API权限验证，使租户管理员能够设置其租户内用户的菜单。

## 功能需求

1. 在管理员用户列表页面中添加"设置菜单"按钮
2. 只有租户管理员才能看到并使用此功能
3. 点击按钮后显示可配置菜单的界面，允许选择/取消选择菜单项
4. 提供保存/取消操作
5. 实时预览菜单树结构

## 用户界面设计

### 1. 管理员列表页面

```
+---------------------------------------+
|         管理员用户列表                   |
+---------------------------------------+
| 用户名 | 角色        | 状态  | 操作      |
+---------------------------------------+
| admin1 | 租户管理员   | 正常  | 详情 设置菜单 |
| admin2 | 超级管理员   | 正常  | 详情      |
| admin3 | 租户管理员   | 冻结  | 详情 设置菜单 |
+---------------------------------------+
```

设计说明：
- "设置菜单"按钮只对租户管理员显示
- 当用户无菜单设置权限时，按钮应隐藏或禁用

### 2. 菜单配置弹窗

```
+-----------------------------------------------+
|  设置租户菜单                           [关闭] |
+-----------------------------------------------+
|                                               |
|  [ ] 所有菜单                                 |
|                                               |
|  [✓] 用户管理                                 |
|     [✓] 用户列表                              |
|     [✓] 用户详情                              |
|                                               |
|  [✓] 内容管理                                 |
|     [✓] 文章管理                              |
|     [ ] 分类管理                              |
|     [ ] 标签管理                              |
|                                               |
|  [ ] 系统设置                                 |
|     [ ] 基本设置                              |
|     [ ] 高级设置                              |
|                                               |
|   [预览]         [取消]       [保存]           |
+-----------------------------------------------+
```

### 3. 菜单预览弹窗

```
+-----------------------------------------------+
|  菜单预览                              [关闭] |
+-----------------------------------------------+
|                                               |
|  +-- 用户管理                                 |
|  |   +-- 用户列表                             |
|  |   +-- 用户详情                             |
|  |                                            |
|  +-- 内容管理                                 |
|      +-- 文章管理                             |
|                                               |
|                          [返回]               |
+-----------------------------------------------+
```

## API 接口说明

> **重要提示**: 
> 1. 所有API路径均以 `/api/v1/menus/` 为前缀
> 2. **当前API权限限制**：目前后端API实现仅允许超级管理员操作这些接口，需要修改权限控制以允许租户管理员操作其租户内用户的菜单

### 1. 获取可配置的菜单列表

**请求**:
- URL: `/api/v1/menus/`
- 方法: `GET`
- 当前权限: 需要用户登录，超级管理员权限
- 目标权限: 需要用户登录，租户管理员权限

**响应**:
```json
{
  "success": true,
  "code": 2000,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "name": "User",
      "title": "用户管理",
      "icon": "user",
      "path": "/user",
      "is_active": true,
      "children": [
        {
          "id": 2,
          "name": "UserList",
          "title": "用户列表",
          "icon": "list",
          "path": "/user/list",
          "is_active": true
        },
        {
          "id": 3,
          "name": "UserDetail",
          "title": "用户详情",
          "icon": "profile",
          "path": "/user/detail",
          "is_active": true
        }
      ]
    },
    {
      "id": 4,
      "name": "Content",
      "title": "内容管理",
      "icon": "file-text",
      "path": "/content",
      "is_active": true,
      "children": [...]
    }
  ]
}
```

### 2. 获取指定用户的菜单配置

**请求**:
- URL: `/api/v1/menus/admins/{user_id}/menus/`
- 方法: `GET`
- 当前权限: 需要用户登录，超级管理员权限
- 目标权限: 需要用户登录，租户管理员权限（仅限同一租户内用户）

**响应**:
```json
{
  "user_id": 101,
  "username": "admin123",
  "menus": [
    {
      "id": 1,
      "name": "用户管理",
      "code": "user_management",
      "is_active": true
    },
    {
      "id": 4,
      "name": "内容管理",
      "code": "content_management",
      "is_active": true
    }
  ]
}
```

### 3. 为用户分配菜单

**请求**:
- URL: `/api/v1/menus/admins/{user_id}/menus/`
- 方法: `POST`
- 当前权限: 需要用户登录，超级管理员权限
- 目标权限: 需要用户登录，租户管理员权限（仅限同一租户内用户）
- 请求体:
```json
{
  "menu_ids": [1, 2, 4, 5]
}
```

**响应**:
```json
{
  "assigned_menus": [
    {
      "id": 1,
      "name": "用户管理"
    },
    {
      "id": 2,
      "name": "用户列表"
    },
    {
      "id": 4,
      "name": "内容管理"
    },
    {
      "id": 5,
      "name": "文章管理"
    }
  ]
}
```

### 4. 删除用户菜单配置

**请求**:
- URL: `/api/v1/menus/admins/{user_id}/menus/{menu_id}/`
- 方法: `DELETE`
- 当前权限: 需要用户登录，超级管理员权限
- 目标权限: 需要用户登录，租户管理员权限（仅限同一租户内用户）

**响应**:
- 状态码: `204 No Content`

### 5. 批量删除用户菜单

**请求**:
- URL: `/api/v1/menus/admins/{user_id}/menus/batch/`
- 方法: `DELETE`
- 当前权限: 需要用户登录，超级管理员权限
- 目标权限: 需要用户登录，租户管理员权限（仅限同一租户内用户）
- 请求体:
```json
{
  "menu_ids": [2, 5]
}
```

**响应**:
- 状态码: `204 No Content`

## 前端实现流程

### 1. 管理员用户列表页面

1. 根据用户角色判断是否显示"设置菜单"按钮
2. 从用户对象获取 `is_tenant_admin` 属性确定其角色
3. 为"设置菜单"按钮添加点击事件，传递用户ID

```javascript
// 伪代码示例
function renderAdminActions(user) {
  const actions = [
    <Button key="view" onClick={() => viewUser(user.id)}>详情</Button>
  ];
  
  // 只对同一租户内的管理员用户显示"设置菜单"按钮
  const currentUser = getCurrentUser(); // 获取当前登录用户
  if (currentUser.is_tenant_admin && 
      user.tenant === currentUser.tenant && 
      !user.is_super_admin) {
    actions.push(
      <Button key="menu" onClick={() => openMenuSetting(user.id)}>设置菜单</Button>
    );
  }
  
  return actions;
}
```

### 2. 菜单配置弹窗

1. 打开弹窗时加载所有可用菜单和用户当前菜单配置
2. 使用树形组件展示菜单层级结构
3. 根据用户菜单配置设置选中状态
4. 提供全选/全不选功能
5. 提供预览、取消和保存按钮

### 3. 预览功能

1. 根据当前选择的菜单创建预览数据
2. 使用树形组件显示预览结果
3. 提供返回按钮返回到配置页面

### 4. 保存功能

1. 收集所有选中的菜单ID
2. 调用API更新用户菜单配置
3. 成功后显示提示并关闭弹窗
4. 可选择刷新用户列表页面

## 注意事项

1. **权限验证**: 后端API当前仅限超级管理员使用，需要修改API权限控制或在前端进行权限验证
2. **菜单层级**: 前端需处理多级菜单的选择逻辑（如选择子菜单时自动选择父菜单）
3. **性能优化**: 菜单树层级可能较深，注意优化渲染性能
4. **错误处理**: 添加适当的错误处理机制，特别是API调用失败时
5. **用户体验**: 提供加载状态指示和操作反馈
6. **租户隔离**: 确保租户管理员只能操作其租户内的用户菜单

## 扩展功能建议

1. 菜单拖拽排序功能
2. 菜单权限与角色关联
3. 菜单修改历史记录
4. 快速复制其他用户的菜单配置

## 技术实现建议

1. 使用Tree组件实现菜单树状结构
2. 使用Modal组件实现弹窗
3. 使用Redux/Vuex管理菜单配置状态
4. 使用React Hooks/Vue Composition API实现业务逻辑

---

如有任何问题，请联系系统架构团队。 