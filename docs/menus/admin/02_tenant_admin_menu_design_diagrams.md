# 租户管理员菜单设计图

## 系统架构图

```
+-----------------+     +------------------+     +--------------------+
| 前端应用         | <=> | API接口层        | <=> | 后端业务逻辑       |
| (React/Vue)     |     | (REST API)       |     | (Django/DRF)       |
+-----------------+     +------------------+     +--------------------+
        |                                                |
        |                                                |
        v                                                v
+-----------------+                              +--------------------+
| 状态管理        |                              | 数据库             |
| (Redux/Vuex)    |                              | (PostgreSQL)       |
+-----------------+                              +--------------------+
```

## 数据流程图

```
+-------------+     +-------------+     +--------------+     +-------------+
| 获取用户列表 | --> | 显示菜单按钮 | --> | 打开菜单设置 | --> | 获取可用菜单 |
+-------------+     +-------------+     +--------------+     +-------------+
                                                                    |
                                                                    v
+-------------+     +-------------+     +--------------+     +-------------+
| 关闭对话框  | <-- |  提交结果   | <-- |  选择菜单项  | <-- | 加载用户菜单 |
+-------------+     +-------------+     +--------------+     +-------------+
        |
        v
+-------------+
| 更新成功提示 |
+-------------+
```

## 组件结构图

```
+-------------------------------------------+
| AdminUserListPage                         |
| +---------------------------------------+ |
| | UserTable                             | |
| | +-----------------------------------+ | |
| | | UserRow                           | | |
| | | +---------+  +-------+  +-------+ | | |
| | | | UserInfo |  | 详情  |  | 设置菜单 | | |
| | | +---------+  +-------+  +-------+ | | |
| | |                                   | | |
| | +-----------------------------------+ | |
| +---------------------------------------+ |
+-------------------------------------------+
               |
               v
+-------------------------------------------+
| MenuSettingModal                          |
| +---------------------------------------+ |
| | MenuTree                              | |
| | +---+------------------------------+  | |
| | | ✓ | 用户管理                    |  | |
| | |   | +---+----------------------+ |  | |
| | |   | | ✓ | 用户列表            | |  | |
| | |   | +---+----------------------+ |  | |
| | |   | +---+----------------------+ |  | |
| | |   | | ✓ | 用户详情            | |  | |
| | |   | +---+----------------------+ |  | |
| | +---+------------------------------+  | |
| | +---+------------------------------+  | |
| | | ✓ | 内容管理                    |  | |
| | |   | +---+----------------------+ |  | |
| | |   | | ✓ | 文章管理            | |  | |
| | |   | +---+----------------------+ |  | |
| | +---+------------------------------+  | |
| |                                       | |
| | +-------+ +-------+ +-------+         | |
| | | 预览  | | 取消  | | 保存  |         | |
| | +-------+ +-------+ +-------+         | |
| +---------------------------------------+ |
+-------------------------------------------+
               |
               v
+-------------------------------------------+
| MenuPreviewModal                          |
| +---------------------------------------+ |
| | PreviewTree                           | |
| | +--------------------------------+    | |
| | | 用户管理                       |    | |
| | | +----------------------------+ |    | |
| | | | 用户列表                  | |    | |
| | | +----------------------------+ |    | |
| | | +----------------------------+ |    | |
| | | | 用户详情                  | |    | |
| | | +----------------------------+ |    | |
| | +--------------------------------+    | |
| | +--------------------------------+    | |
| | | 内容管理                       |    | |
| | | +----------------------------+ |    | |
| | | | 文章管理                  | |    | |
| | | +----------------------------+ |    | |
| | +--------------------------------+    | |
| |                                       | |
| |                           +-------+   | |
| |                           | 返回  |   | |
| |                           +-------+   | |
| +---------------------------------------+ |
+-------------------------------------------+
```

## API交互时序图

```
+--------+          +--------+          +--------+          +--------+
| 前端   |          | API    |          | 业务层 |          | 数据库 |
+--------+          +--------+          +--------+          +--------+
    |                   |                   |                   |
    | 获取用户列表       |                   |                   |
    |------------------>|                   |                   |
    |                   | 查询用户及角色信息 |                   |
    |                   |------------------>|                   |
    |                   |                   | 数据库查询        |
    |                   |                   |------------------>|
    |                   |                   |                   |
    |                   |                   | 返回用户数据      |
    |                   |                   |<------------------|
    |                   | 返回用户列表      |                   |
    |<------------------|                   |                   |
    |                   |                   |                   |
    | 点击设置菜单       |                   |                   |
    |                   |                   |                   |
    | 获取可用菜单       |                   |                   |
    |------------------>|                   |                   |
    |                   | 查询菜单数据      |                   |
    |                   |------------------>|                   |
    |                   |                   | 数据库查询        |
    |                   |                   |------------------>|
    |                   |                   |                   |
    |                   |                   | 返回菜单数据      |
    |                   |                   |<------------------|
    |                   | 返回菜单列表      |                   |
    |<------------------|                   |                   |
    |                   |                   |                   |
    | 获取用户菜单配置   |                   |                   |
    |------------------>|                   |                   |
    |                   | 查询用户菜单关系  |                   |
    |                   |------------------>|                   |
    |                   |                   | 数据库查询        |
    |                   |                   |------------------>|
    |                   |                   |                   |
    |                   |                   | 返回关联数据      |
    |                   |                   |<------------------|
    |                   | 返回用户菜单配置  |                   |
    |<------------------|                   |                   |
    |                   |                   |                   |
    | 提交菜单设置       |                   |                   |
    |------------------>|                   |                   |
    |                   | 更新用户菜单      |                   |
    |                   |------------------>|                   |
    |                   |                   | 事务操作          |
    |                   |                   |------------------>|
    |                   |                   |                   |
    |                   |                   | 操作完成          |
    |                   |                   |<------------------|
    |                   | 返回更新结果      |                   |
    |<------------------|                   |                   |
    |                   |                   |                   |
```

## 数据模型图

```
+---------------+       +---------------+       +---------------+
| User          |       | UserMenu      |       | Menu          |
+---------------+       +---------------+       +---------------+
| id            |<----->| user_id       |<----->| id            |
| username      |       | menu_id       |       | name          |
| email         |       | is_active     |       | code          |
| is_admin      |       | created_at    |       | title         |
| is_super_admin|       | updated_at    |       | icon          |
| tenant_id     |       |               |       | path          |
| ...           |       |               |       | parent_id     |
+---------------+       +---------------+       | rank          |
                                                | is_active     |
                                                | ...           |
                                                +---------------+
```

## 状态转换图

```
       +-------------------+
       | 初始状态          |
       | 菜单未加载        |
       +-------------------+
                |
                v
       +-------------------+
       | 加载中状态        |
       | 请求数据中        |
       +-------------------+
                |
                +-----------------+
                |                 |
                v                 v
       +-------------------+    +-------------------+
       | 加载完成          |    | 加载失败          |
       | 显示菜单树        |    | 显示错误信息      |
       +-------------------+    +-------------------+
                |
                v
       +-------------------+
       | 编辑状态          |
       | 选择/取消选择菜单 |
       +-------------------+
                |
                +-----------------+
                |                 |
                v                 v
       +-------------------+    +-------------------+
       | 提交状态          |    | 取消状态          |
       | 保存选择变更      |    | 放弃编辑          |
       +-------------------+    +-------------------+
                |                 |
                v                 v
       +-------------------+    +-------------------+
       | 提交成功          |    | 关闭对话框        |
       | 显示成功提示      |    | 返回列表页        |
       +-------------------+    +-------------------+
                |
                v
       +-------------------+
       | 完成状态          |
       | 关闭对话框        |
       +-------------------+
```

## 前端组件详细设计

### AdminUserList 组件

```
+-----------------------------------------------+
| AdminUserList                                 |
| +-------------------------------------------+ |
| | <搜索框>  <筛选条件>  <刷新>  <新增用户> | |
| +-------------------------------------------+ |
| +-------------------------------------------+ |
| | <表格>                                    | |
| | +---------------------------------------+ | |
| | | 用户名 | 角色 | 状态 | 邮箱 | 操作    | | |
| | +---------------------------------------+ | |
| | | admin1 | 租户管理员 | 正常 | ... | 操作 | | |
| | +---------------------------------------+ | |
| | | admin2 | 超级管理员 | 正常 | ... | 操作 | | |
| | +---------------------------------------+ | |
| +-------------------------------------------+ |
| +-------------------------------------------+ |
| | <分页器>                                  | |
| +-------------------------------------------+ |
+-----------------------------------------------+
```

### MenuSettingModal 组件

```
+-----------------------------------------------+
| MenuSettingModal                              |
| +-------------------------------------------+ |
| | 设置租户菜单                        [关闭] | |
| +-------------------------------------------+ |
| |                                           | |
| | <搜索栏> <全选/全不选>                    | |
| |                                           | |
| | +---------------------------------------+ | |
| | | [✓] 所有菜单                         | | |
| | |                                       | | |
| | | [✓] 用户管理                         | | |
| | |    [✓] 用户列表                      | | |
| | |    [✓] 用户详情                      | | |
| | |                                       | | |
| | | [✓] 内容管理                         | | |
| | |    [✓] 文章管理                      | | |
| | |    [ ] 分类管理                      | | |
| | |    [ ] 标签管理                      | | |
| | |                                       | | |
| | | [ ] 系统设置                         | | |
| | |    [ ] 基本设置                      | | |
| | |    [ ] 高级设置                      | | |
| | +---------------------------------------+ | |
| |                                           | |
| | +---------------------------------------+ | |
| | | [预览]        [取消]       [保存]     | | |
| | +---------------------------------------+ | |
| +-------------------------------------------+ |
+-----------------------------------------------+
```

### MenuTreeItem 组件

```
+-----------------------------------------------+
| MenuTreeItem                                  |
| +-------------------------------------------+ |
| | [✓] 用户管理 (展开/折叠按钮)             | |
| |                                           | |
| | +---------------------------------------+ | |
| | |    [✓] 用户列表                      | | |
| | +---------------------------------------+ | |
| | +---------------------------------------+ | |
| | |    [✓] 用户详情                      | | |
| | +---------------------------------------+ | |
| +-------------------------------------------+ |
+-----------------------------------------------+
```

## 前后端交互流程

1. **初始化**
   - 前端加载管理员用户列表
   - 根据用户角色决定是否显示"设置菜单"按钮

2. **打开菜单设置**
   - 用户点击"设置菜单"按钮
   - 前端发起两个并行请求：
     1. 获取所有可用菜单 (`GET /api/menus/`)
     2. 获取该用户当前菜单配置 (`GET /api/menus/admins/{user_id}/menus/`)
   - 显示加载状态

3. **展示菜单树**
   - 将所有可用菜单构建为树形结构
   - 根据用户当前菜单配置标记选中状态
   - 处理父子菜单关联逻辑

4. **用户操作**
   - 用户选择或取消选择菜单项
   - 父菜单选择影响所有子菜单
   - 子菜单全选会自动选中父菜单

5. **预览功能**
   - 用户点击预览按钮
   - 根据当前选择的菜单构建预览数据
   - 打开预览对话框显示菜单树

6. **提交变更**
   - 用户点击保存按钮
   - 收集所有选中的菜单ID
   - 发送请求更新用户菜单配置 (`POST /api/menus/admins/{user_id}/menus/`)
   - 显示提交状态

7. **完成流程**
   - 服务器返回成功响应
   - 显示成功提示
   - 关闭对话框
   - 可选择刷新用户列表 