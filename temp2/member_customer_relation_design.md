# 成员与客户关系设计文档

## 1. 概述

本文档详细描述成员(Member)与客户(Customer)之间关系的设计方案，包括数据结构、关系类型、展示方式和交互流程。成员与客户之间的关系是系统中的重要业务逻辑，需要清晰地设计和实现。

## 2. 关系数据结构

### 2.1 关系模型

成员与客户之间的关系通过中间表（CustomerMemberRelation）进行管理，主要包含以下字段：

- **id**: 关系ID，主键
- **customer_id**: 客户ID，外键
- **customer_name**: 客户名称（冗余字段，便于展示）
- **member_id**: 成员ID，外键
- **member_name**: 成员姓名（冗余字段，便于展示）
- **member_email**: 成员邮箱（冗余字段，便于展示）
- **member_phone**: 成员电话（冗余字段，便于展示）
- **role**: 成员在客户中的角色
- **is_primary**: 是否为主要关系
- **department**: 部门（可选）
- **notes**: 备注（可选）
- **created_at**: 创建时间
- **updated_at**: 更新时间

### 2.2 关系类型

成员在客户中可以担任不同的角色，常见的角色包括：

1. **决策者**：负责做出购买决策
2. **影响者**：影响购买决策
3. **技术联系人**：负责技术相关事宜
4. **财务联系人**：负责财务相关事宜
5. **行政联系人**：负责行政相关事宜
6. **项目经理**：负责项目管理
7. **最终用户**：系统的实际使用者
8. **其他**：其他角色

### 2.3 主要关系

一个客户可以有多个联系人（成员），但只能有一个主要联系人。同样，一个成员可以关联多个客户，但只能将其中一个设为主要客户。主要关系通过`is_primary`字段标识。

## 3. 关系展示方式

### 3.1 在成员详情页中展示关联客户

在成员详情页的"关联客户"标签页中，展示该成员关联的所有客户。展示内容包括：

1. **客户基本信息**：
   - 客户ID
   - 客户名称
   - 客户类型
   - 客户状态

2. **关系信息**：
   - 角色
   - 是否为主要关系
   - 部门（如有）
   - 关系创建时间

3. **操作按钮**：
   - 编辑关系
   - 删除关系
   - 设为主要关系（仅非主要关系显示）

### 3.2 在客户详情页中展示关联成员

在客户详情页的"联系人"标签页中，展示该客户关联的所有成员。展示内容包括：

1. **成员基本信息**：
   - 成员ID
   - 成员姓名
   - 成员邮箱
   - 成员电话

2. **关系信息**：
   - 角色
   - 是否为主要联系人
   - 部门（如有）
   - 关系创建时间

3. **操作按钮**：
   - 编辑关系
   - 删除关系
   - 设为主要联系人（仅非主要联系人显示）

## 4. 关系管理功能

### 4.1 创建关系

#### 4.1.1 从成员详情页创建关系

在成员详情页的"关联客户"标签页中，用户可以点击"添加客户关系"按钮，弹出客户关系创建表单对话框。表单包含以下字段：

- **客户**：下拉选择框，选择要关联的客户
- **角色**：输入框，输入成员在客户中的角色
- **是否主要关系**：开关，设置是否为主要关系
- **部门**：输入框，输入成员所在部门（可选）
- **备注**：文本域，输入备注信息（可选）

#### 4.1.2 从客户详情页创建关系

在客户详情页的"联系人"标签页中，用户可以点击"添加联系人"按钮，弹出联系人关系创建表单对话框。表单包含以下字段：

- **成员**：下拉选择框，选择要关联的成员
- **角色**：输入框，输入成员在客户中的角色
- **是否主要联系人**：开关，设置是否为主要联系人
- **部门**：输入框，输入成员所在部门（可选）
- **备注**：文本域，输入备注信息（可选）

### 4.2 编辑关系

#### 4.2.1 从成员详情页编辑关系

在成员详情页的"关联客户"标签页中，用户可以点击特定客户关系的"编辑"按钮，弹出客户关系编辑表单对话框。表单包含与创建关系相同的字段，但客户字段不可编辑。

#### 4.2.2 从客户详情页编辑关系

在客户详情页的"联系人"标签页中，用户可以点击特定联系人关系的"编辑"按钮，弹出联系人关系编辑表单对话框。表单包含与创建关系相同的字段，但成员字段不可编辑。

### 4.3 删除关系

#### 4.3.1 从成员详情页删除关系

在成员详情页的"关联客户"标签页中，用户可以点击特定客户关系的"删除"按钮，弹出确认对话框。确认后，删除该关系。

#### 4.3.2 从客户详情页删除关系

在客户详情页的"联系人"标签页中，用户可以点击特定联系人关系的"删除"按钮，弹出确认对话框。确认后，删除该关系。

### 4.4 设置主要关系

#### 4.4.1 从成员详情页设置主要关系

在成员详情页的"关联客户"标签页中，用户可以点击非主要关系的"设为主要"按钮，将该关系设置为主要关系。系统会自动将其他关系的`is_primary`设为`false`。

#### 4.4.2 从客户详情页设置主要关系

在客户详情页的"联系人"标签页中，用户可以点击非主要联系人的"设为主要"按钮，将该联系人设置为主要联系人。系统会自动将其他联系人的`is_primary`设为`false`。

## 5. 数据流设计

### 5.1 API调用流程

#### 5.1.1 获取关系列表

1. 前端调用API获取关系列表
2. 后端根据参数（成员ID或客户ID）查询关系数据
3. 返回关系列表数据，包括分页信息
4. 前端渲染关系列表

#### 5.1.2 创建关系

1. 用户填写关系表单并提交
2. 前端验证表单数据
3. 调用API创建关系
4. 后端验证数据并创建关系记录
5. 如果设置了主要关系，后端会更新其他关系的`is_primary`字段
6. 返回创建结果
7. 前端刷新关系列表

#### 5.1.3 更新关系

1. 用户编辑关系表单并提交
2. 前端验证表单数据
3. 调用API更新关系
4. 后端验证数据并更新关系记录
5. 如果设置了主要关系，后端会更新其他关系的`is_primary`字段
6. 返回更新结果
7. 前端刷新关系列表

#### 5.1.4 删除关系

1. 用户确认删除操作
2. 调用API删除关系
3. 后端删除关系记录
4. 返回删除结果
5. 前端刷新关系列表

#### 5.1.5 设置主要关系

1. 用户点击"设为主要"按钮
2. 调用API设置主要关系
3. 后端更新关系记录，将该关系的`is_primary`设为`true`，其他关系的`is_primary`设为`false`
4. 返回更新结果
5. 前端刷新关系列表

### 5.2 状态管理

在Vuex中管理成员与客户关系的状态：

```typescript
// 关系状态结构
interface RelationState {
  // 成员关联的客户列表
  memberCustomers: {
    data: CustomerRelation[];
    total: number;
    loading: boolean;
    error: Error | null;
  };
  // 客户关联的成员列表
  customerMembers: {
    data: MemberRelation[];
    total: number;
    loading: boolean;
    error: Error | null;
  };
  // 当前操作的关系
  currentRelation: {
    data: Relation | null;
    loading: boolean;
    error: Error | null;
  };
  // 加载状态
  loading: {
    create: boolean;
    update: boolean;
    delete: boolean;
    setPrimary: boolean;
  };
}
```

## 6. 交互流程

### 6.1 创建关系流程

1. 用户进入成员详情页或客户详情页
2. 用户点击"添加客户关系"或"添加联系人"按钮
3. 系统弹出创建关系表单对话框
4. 用户填写表单并提交
5. 系统验证表单数据
6. 如果验证通过，系统创建关系记录
7. 如果设置了主要关系，系统会更新其他关系的`is_primary`字段
8. 系统显示创建成功提示，并刷新关系列表
9. 如果验证失败，系统显示错误提示

### 6.2 编辑关系流程

1. 用户进入成员详情页或客户详情页
2. 用户点击特定关系的"编辑"按钮
3. 系统弹出编辑关系表单对话框，并填充当前关系数据
4. 用户修改表单并提交
5. 系统验证表单数据
6. 如果验证通过，系统更新关系记录
7. 如果设置了主要关系，系统会更新其他关系的`is_primary`字段
8. 系统显示更新成功提示，并刷新关系列表
9. 如果验证失败，系统显示错误提示

### 6.3 删除关系流程

1. 用户进入成员详情页或客户详情页
2. 用户点击特定关系的"删除"按钮
3. 系统弹出确认对话框
4. 用户确认删除操作
5. 系统删除关系记录
6. 系统显示删除成功提示，并刷新关系列表

### 6.4 设置主要关系流程

1. 用户进入成员详情页或客户详情页
2. 用户点击非主要关系的"设为主要"按钮
3. 系统更新关系记录，将该关系的`is_primary`设为`true`，其他关系的`is_primary`设为`false`
4. 系统显示设置成功提示，并刷新关系列表

## 7. 权限控制

### 7.1 权限定义

| 权限标识 | 描述 | 适用角色 |
|---------|------|---------|
| member:relation:view | 查看成员与客户关系 | 超级管理员、租户管理员、普通成员(仅自己的关系) |
| member:relation:create | 创建成员与客户关系 | 超级管理员、租户管理员 |
| member:relation:edit | 编辑成员与客户关系 | 超级管理员、租户管理员、普通成员(仅自己的关系) |
| member:relation:delete | 删除成员与客户关系 | 超级管理员、租户管理员 |
| member:relation:setPrimary | 设置主要关系 | 超级管理员、租户管理员、普通成员(仅自己的关系) |

### 7.2 权限控制实现

在前端，通过指令和组件级别的权限控制：

```vue
<template>
  <!-- 使用v-auth指令控制按钮显示 -->
  <el-button v-auth="'member:relation:create'" type="primary">
    {{ $t('member.customerRelation.createRelation') }}
  </el-button>
  
  <!-- 使用ReAuth组件控制内容显示 -->
  <ReAuth auth="member:relation:edit">
    <el-button type="primary">
      {{ $t('member.customerRelation.editRelation') }}
    </el-button>
  </ReAuth>
</template>
```

在后端，通过权限中间件进行权限检查：

```python
@api_view(['POST'])
@permission_required('member.relation.create')
def create_relation(request):
    # 创建关系的逻辑
    pass
```

## 8. 数据验证

### 8.1 前端验证

在前端，对表单数据进行验证：

1. **客户/成员**：必填，必须选择有效的客户/成员
2. **角色**：必填，长度限制（2-50个字符）
3. **是否主要关系**：布尔值
4. **部门**：可选，长度限制（0-100个字符）
5. **备注**：可选，长度限制（0-500个字符）

### 8.2 后端验证

在后端，对API请求数据进行验证：

1. **客户/成员**：必填，必须存在于数据库中
2. **角色**：必填，长度限制（2-50个字符）
3. **是否主要关系**：布尔值
4. **部门**：可选，长度限制（0-100个字符）
5. **备注**：可选，长度限制（0-500个字符）

此外，后端还需要进行以下业务逻辑验证：

1. 检查客户和成员是否已经存在关系
2. 检查用户是否有权限操作该关系
3. 如果设置主要关系，需要更新其他关系的`is_primary`字段

## 9. 错误处理

### 9.1 前端错误处理

1. **表单验证错误**：在表单字段下方显示错误提示
2. **API请求错误**：显示错误通知，包含错误信息
3. **权限错误**：显示权限错误提示，引导用户获取权限

### 9.2 后端错误处理

1. **验证错误**：返回400状态码，包含详细的错误信息
2. **权限错误**：返回403状态码，包含权限错误信息
3. **资源不存在**：返回404状态码，包含资源不存在信息
4. **服务器错误**：返回500状态码，包含服务器错误信息

## 10. 国际化支持

### 10.1 中文语言包

```yaml
member:
  customerRelation:
    relationList: '关联客户'
    createRelation: '添加客户关系'
    editRelation: '编辑客户关系'
    deleteRelation: '删除客户关系'
    deleteConfirm: '确定要删除与客户 {name} 的关系吗？'
    noRelations: '暂无关联客户'
    customerId: '客户ID'
    customerName: '客户名称'
    role: '角色'
    isPrimary: '主要关系'
    setPrimary: '设为主要'
    department: '部门'
    notes: '备注'
    createSuccess: '创建关系成功'
    updateSuccess: '更新关系成功'
    deleteSuccess: '删除关系成功'
    setPrimarySuccess: '设置主要关系成功'
```

### 10.2 英文语言包

```yaml
member:
  customerRelation:
    relationList: 'Related Customers'
    createRelation: 'Add Customer Relation'
    editRelation: 'Edit Customer Relation'
    deleteRelation: 'Delete Customer Relation'
    deleteConfirm: 'Are you sure you want to delete relation with customer {name}?'
    noRelations: 'No related customers'
    customerId: 'Customer ID'
    customerName: 'Customer Name'
    role: 'Role'
    isPrimary: 'Primary Relation'
    setPrimary: 'Set as Primary'
    department: 'Department'
    notes: 'Notes'
    createSuccess: 'Relation created successfully'
    updateSuccess: 'Relation updated successfully'
    deleteSuccess: 'Relation deleted successfully'
    setPrimarySuccess: 'Primary relation set successfully'
```

## 11. 总结

本文档详细描述了成员与客户关系的设计方案，包括数据结构、关系类型、展示方式和交互流程。通过清晰的设计和实现，可以有效管理成员与客户之间的关系，满足业务需求。

关系管理功能将集成到成员管理和客户管理模块中，提供双向的关系管理能力。用户可以从成员详情页管理关联客户，也可以从客户详情页管理关联成员，实现灵活的关系管理。 