# 统计与监控 API 使用文档

## 📊 模块概述

统计与监控模块提供反馈统计数据和系统健康检查功能。

**API 数量**: 3 个  
**主要功能**: 反馈统计、系统健康、Redis状态

## 📑 API 列表

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/statistics/` | 获取反馈统计数据 | 仅管理员 |
| GET | `/health/` | 系统健康检查 | 仅管理员 |
| GET | `/health/redis/` | Redis详细状态 | 仅管理员 |

---

## 反馈统计

### 1. 获取统计数据

**接口**: `GET /statistics/`

**用途**: 获取全面的反馈统计信息，用于管理仪表板和数据分析。

**查询参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| software | integer | 按软件ID筛选 |
| date_from | date | 开始日期（YYYY-MM-DD） |
| date_to | date | 结束日期（YYYY-MM-DD） |

**返回数据结构**:

### 基础统计

| 字段 | 类型 | 说明 |
|------|------|------|
| total_feedbacks | integer | 总反馈数 |
| open_feedbacks | integer | 未解决反馈数 |
| resolved_feedbacks | integer | 已解决反馈数 |
| avg_resolution_time | string | 平均解决时间 |

### 分类统计

**按类型分布** (`feedbacks_by_type`):
```json
{
  "bug": 60,
  "feature": 40,
  "improvement": 30,
  "question": 15,
  "other": 5
}
```

**按状态分布** (`feedbacks_by_status`):
```json
{
  "submitted": 10,
  "reviewing": 5,
  "confirmed": 10,
  "in_progress": 15,
  "resolved": 100,
  "closed": 5,
  "rejected": 3,
  "duplicate": 2
}
```

**按优先级分布** (`feedbacks_by_priority`):
```json
{
  "critical": 10,
  "high": 30,
  "medium": 80,
  "low": 30
}
```

### 热门反馈

**最受关注的反馈** (`top_voted_feedbacks`):
- 返回投票数最多的10个反馈
- 包含标题、投票数、状态

**最新反馈** (`recent_feedbacks`):
- 返回最近提交的10个反馈
- 包含标题、状态、创建时间

### 趋势数据

**每日趋势** (`daily_trend`):
- 最近30天的每日反馈数量
- 用于绘制趋势图表

数据格式：
```json
[
  { "date": "2025-10-01", "count": 5 },
  { "date": "2025-10-02", "count": 8 }
]
```

---

## 系统健康检查

### 2. 系统健康状态

**接口**: `GET /health/`

**用途**: 检查系统各组件的健康状况，用于运维监控。

**返回字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| status | string | healthy\|degraded\|unhealthy |
| components | object | 各组件状态 |
| recommendations | array | 系统建议 |

**系统状态说明**:

| 状态 | 说明 | 含义 |
|------|------|------|
| healthy | 健康 | 所有组件正常运行 |
| degraded | 降级 | 部分组件异常，但系统可用 |
| unhealthy | 不健康 | 关键组件故障，系统不可用 |

**组件状态详解**:

#### Redis 组件

| 字段 | 说明 |
|------|------|
| available | 是否可用 |
| mode | redis\|unavailable\|database |
| version | Redis版本号 |
| connected_clients | 连接客户端数 |
| used_memory_human | 内存使用量 |
| uptime_days | 运行天数 |
| error | 错误信息（如有） |

#### 数据库组件

| 字段 | 说明 |
|------|------|
| available | 是否可用 |
| type | mysql\|postgresql\|sqlite |

#### Celery 组件

| 字段 | 说明 |
|------|------|
| available | 是否可用 |
| mode | async\|sync\|database |
| fallback_enabled | 是否启用降级 |
| broker | Broker URL |

#### 邮件组件

| 字段 | 说明 |
|------|------|
| available | 是否可用 |
| mode | smtp\|console |
| backend | 邮件后端类型 |

**系统建议示例**:
```json
[
  "Redis is not available. Email tasks will run synchronously.",
  "Consider setting up Redis or using external Redis service (Upstash).",
  "Email backend is set to console. Configure SMTP for production."
]
```

---

### 3. Redis 详细状态

**接口**: `GET /health/redis/`

**用途**: 获取 Redis 的详细运行信息。

**返回字段**: 同健康检查中的 Redis 组件

**Redis 不可用时的建议**:

返回 `suggestions` 数组，包含：

| 优先级 | 建议 | 说明 |
|--------|------|------|
| high | 使用外部 Redis | 推荐 Upstash 免费服务 |
| medium | 使用数据库 Broker | 临时方案，性能较低 |

---

## 数据可视化建议

### 统计仪表板设计

**关键指标卡片**:
```
┌──────────┬──────────┬──────────┬──────────┐
│ 总反馈数  │ 未解决   │ 已解决   │ 平均解决 │
│   150    │   25     │  100     │  3.5天   │
└──────────┴──────────┴──────────┴──────────┘
```

**图表建议**:

1. **饼图 - 反馈类型分布**
   - Bug: 40%
   - 功能请求: 27%
   - 改进建议: 20%
   - 问题咨询: 10%
   - 其他: 3%

2. **柱状图 - 反馈状态分布**
   - 横轴：各状态
   - 纵轴：数量
   - 不同颜色区分状态

3. **折线图 - 每日反馈趋势**
   - 横轴：日期
   - 纵轴：反馈数量
   - 显示最近30天趋势

4. **表格 - 热门反馈TOP 10**
   - 标题
   - 投票数
   - 状态
   - 链接

---

## 健康监控设计

### 监控仪表板布局

```
┌─────────────────────────────────────┐
│  系统健康状态：✅ 正常               │
├─────────────────────────────────────┤
│  组件状态：                          │
│                                     │
│  [✅] Redis       正常 (v7.0.0)    │
│  [✅] 数据库      正常 (MySQL)     │
│  [✅] Celery      异步模式          │
│  [✅] 邮件服务    SMTP模式          │
├─────────────────────────────────────┤
│  系统建议：                          │
│  - 无                               │
└─────────────────────────────────────┘
```

**降级状态显示**:
```
┌─────────────────────────────────────┐
│  系统健康状态：⚠️ 降级               │
├─────────────────────────────────────┤
│  组件状态：                          │
│                                     │
│  [❌] Redis       不可用             │
│       错误：Connection refused      │
│  [✅] 数据库      正常              │
│  [⚠️] Celery      同步模式（降级）   │
│  [✅] 邮件服务    正常              │
├─────────────────────────────────────┤
│  系统建议：                          │
│  ⚠️ Redis不可用，邮件将同步发送      │
│  💡 建议配置Redis或使用Upstash      │
└─────────────────────────────────────┘
```

---

## 监控告警建议

### 告警规则

| 指标 | 告警阈值 | 级别 |
|------|---------|------|
| 系统状态 = unhealthy | 立即 | 严重 |
| Redis 不可用 | 5分钟 | 警告 |
| 邮件发送失败率 > 10% | 1小时 | 警告 |
| 未解决反馈 > 100 | 每天 | 提示 |
| 数据库连接失败 | 立即 | 严重 |

### 监控频率建议

| 监控项 | 建议频率 | 说明 |
|--------|---------|------|
| 系统健康 | 每30秒 | 实时监控 |
| Redis状态 | 每1分钟 | 检测连接 |
| 统计数据 | 每5分钟 | 数据更新 |
| 邮件日志 | 每10分钟 | 失败检测 |

---

## 数据分析应用

### 反馈分析维度

**时间维度**:
- 每日反馈数量趋势
- 每周反馈类型分布
- 月度解决率统计

**类型维度**:
- Bug 占比
- 功能请求占比
- 用户最关注的功能

**软件维度**:
- 各软件反馈数对比
- 各软件解决率对比
- 问题集中的软件

**用户维度**:
- 活跃用户排名
- 用户反馈质量评分
- 用户满意度

### 管理决策支持

**从统计数据可以获得**:
- 哪些软件问题最多
- 用户最需要哪些功能
- 团队处理效率如何
- 哪些反馈最紧急

**数据应用场景**:
- 产品规划：根据功能请求投票排序
- 资源分配：优先处理高票反馈
- 质量评估：Bug数量和类型分析
- 团队考核：平均响应时间和解决率

---

## 注意事项

### 统计数据
1. **缓存**: 统计数据有5分钟缓存
2. **权限**: 只有管理员可见
3. **筛选**: 使用日期范围避免数据量过大
4. **时区**: 统计使用UTC时区

### 健康检查
1. **频率**: 建议30-60秒检查一次
2. **告警**: 状态异常时及时通知
3. **历史**: 建议记录健康检查历史
4. **可视化**: 使用图表展示趋势

### Redis监控
1. **内存**: 监控内存使用率
2. **连接**: 监控连接数
3. **性能**: 监控响应时间
4. **告警**: 不可用时及时处理

---

**下一步**: [06_前端对接指南.md](06_前端对接指南.md)
