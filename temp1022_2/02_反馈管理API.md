# 反馈管理 API 使用文档

## 💬 模块概述

反馈管理模块是系统的核心功能，提供完整的反馈生命周期管理。

**API 数量**: 13 个  
**核心功能**: 反馈提交、查询、更新、状态流转、邮件通知

## 📑 API 列表

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/feedbacks/` | 获取反馈列表 | 分权限查看 |
| POST | `/feedbacks/` | 提交反馈 | 所有人（含匿名） |
| GET | `/feedbacks/{id}/` | 获取反馈详情 | 分权限查看 |
| PUT | `/feedbacks/{id}/` | 完整更新反馈 | 作者或管理员 |
| PATCH | `/feedbacks/{id}/` | 部分更新反馈 | 作者或管理员 |
| DELETE | `/feedbacks/{id}/` | 删除反馈 | 作者或管理员 |
| PATCH | `/feedbacks/{id}/status/` | 修改状态 | 仅管理员 |
| POST | `/feedbacks/{id}/verify-email/` | 验证邮箱 | 公开 |
| PATCH | `/feedbacks/{id}/notifications/` | 通知设置 | 反馈作者 |

---

## 反馈列表查询

### 1. 获取反馈列表

**接口**: `GET /feedbacks/`

**权限规则**:
- **超级管理员**: 查看所有租户的反馈
- **租户管理员**: 查看本租户的所有反馈
- **普通用户**: 只能查看自己提交的反馈

**查询参数**:

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| software | integer | 按软件ID筛选 | `1` |
| software_version | integer | 按版本ID筛选 | `10` |
| feedback_type | string | 按类型筛选 | `bug` |
| status | string | 按状态筛选 | `submitted` |
| priority | string | 按优先级筛选 | `high` |
| user | integer | 按用户ID筛选（仅管理员） | `5` |
| email_verified | boolean | 按邮箱验证状态筛选 | `true` |
| search | string | 全文搜索 | `崩溃` |
| ordering | string | 排序字段 | `-created_at` |
| page | integer | 页码 | `1` |
| page_size | integer | 每页数量 | `20` |

**反馈类型 (feedback_type)**:

| 值 | 显示名称 | 说明 |
|---|---------|------|
| bug | Bug 报告 | 软件缺陷、错误 |
| feature | 功能请求 | 新功能建议 |
| improvement | 改进建议 | 现有功能优化 |
| question | 问题咨询 | 使用问题 |
| other | 其他 | 其他类型 |

**反馈优先级 (priority)**:

| 值 | 显示名称 | 说明 |
|---|---------|------|
| critical | 紧急 | 严重影响使用 |
| high | 高 | 重要但可临时规避 |
| medium | 中 | 一般问题 |
| low | 低 | 轻微问题 |

**排序选项**:
- `created_at`: 创建时间升序
- `-created_at`: 创建时间降序（最新）
- `vote_count`: 投票数升序
- `-vote_count`: 投票数降序（最热门）
- `reply_count`: 回复数升序
- `-reply_count`: 回复数降序（最活跃）

**返回数据结构**:

分页响应格式：
```json
{
  "count": 100,           // 总记录数
  "next": "URL",          // 下一页URL（无下一页则为null）
  "previous": "URL",      // 上一页URL（无上一页则为null）
  "results": [...]        // 当前页数据数组
}
```

每条反馈数据包含：
- 基本信息：ID、标题、描述、类型、优先级、状态
- 软件信息：软件名称、版本号
- 提交者信息：用户名、邮箱
- 统计信息：投票数、回复数、浏览数
- 时间信息：创建时间、更新时间

---

## 反馈提交

### 2. 提交反馈

**接口**: `POST /feedbacks/`

**权限**: 所有人（包括匿名用户）

**请求字段**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| title | string | ✅ | 反馈标题（最多200字符） |
| description | string | ✅ | 详细描述 |
| feedback_type | string | ✅ | bug\|feature\|improvement\|question\|other |
| priority | string | ❌ | critical\|high\|medium\|low（默认medium） |
| software | integer | ✅ | 软件ID |
| software_version | integer | ❌ | 版本ID（建议提供） |
| contact_email | string | ❌* | 联系邮箱（匿名用户必填） |
| contact_name | string | ❌ | 联系人姓名 |
| environment_info | object | ❌ | 环境信息（JSON对象） |

**匿名提交说明**:
- 未登录用户可以提交反馈
- 必须提供 `contact_email` 字段
- 系统会发送验证邮件
- 邮箱验证后才能接收后续通知

**环境信息建议字段**:
- `os`: 操作系统
- `browser`: 浏览器
- `screen_resolution`: 屏幕分辨率
- `user_agent`: User Agent
- 其他有助于问题诊断的信息

**返回数据**:
- 创建成功返回完整的反馈对象
- 包含系统生成的ID
- 包含当前状态（默认为 `submitted`）
- 匿名提交会包含 `email_verification_sent_at` 字段

---

## 反馈查询

### 3. 获取反馈详情

**接口**: `GET /feedbacks/{id}/`

**功能**: 获取单个反馈的完整信息

**权限规则**:
- 管理员可以查看所有反馈
- 普通用户只能查看自己的反馈
- 反馈作者可以查看自己提交的反馈

**返回的完整信息**:

| 数据模块 | 包含内容 |
|---------|---------|
| 基本信息 | ID、标题、描述、类型、优先级、状态 |
| 软件信息 | 软件详情、版本详情 |
| 用户信息 | 提交者信息、联系方式 |
| 环境信息 | environment_info JSON对象 |
| 互动数据 | 所有回复列表、投票统计、用户投票状态 |
| 附件列表 | 所有附件的详细信息 |
| 状态历史 | 所有状态变更记录 |
| 统计数据 | 浏览数、回复数、投票数 |
| 时间信息 | 创建、更新、解决时间 |

**特殊行为**:
- 每次查看详情会自动增加 `view_count`（浏览计数）
- 返回当前用户的投票状态 (`user_vote`)

---

## 反馈更新

### 4-5. 更新反馈

**接口**: 
- `PUT /feedbacks/{id}/` - 完整更新（需要所有字段）
- `PATCH /feedbacks/{id}/` - 部分更新（只需要修改的字段）

**权限**:
- **管理员**: 可以更新任何反馈
- **反馈作者**: 只能更新自己的反馈，且满足条件：
  - 反馈还未被回复
  - 反馈状态为 `submitted` 或 `reviewing`

**可更新字段**:
- `title`: 标题
- `description`: 描述
- `feedback_type`: 反馈类型
- `priority`: 优先级
- `environment_info`: 环境信息

**不可更新字段**:
- `software`: 软件（不允许修改）
- `software_version`: 版本（不允许修改）
- `status`: 状态（需要使用专门的状态变更接口）
- `user`: 提交者（系统自动设置）

**使用建议**:
- 优先使用 `PATCH` 方法，只传要修改的字段
- 提供清晰的错误提示给用户

---

### 6. 删除反馈

**接口**: `DELETE /feedbacks/{id}/`

**权限**: 同更新权限

**行为**: 软删除（数据保留，只标记为已删除）

**限制**:
- 已被回复的反馈，普通用户无法删除
- 管理员可以删除任何反馈

**返回**: 204 No Content（删除成功）

---

## 反馈状态管理

### 7. 修改反馈状态

**接口**: `PATCH /feedbacks/{id}/status/`

**权限**: 仅管理员

**请求字段**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | ✅ | 新状态 |
| reason | string | ❌ | 变更原因（建议填写） |

**反馈状态 (status)**:

| 值 | 显示名称 | 说明 |
|---|---------|------|
| submitted | 已提交 | 初始状态 |
| reviewing | 审核中 | 正在评估 |
| confirmed | 已确认 | 确认是有效反馈 |
| in_progress | 处理中 | 正在开发/修复 |
| resolved | 已解决 | 问题已解决 |
| closed | 已关闭 | 反馈已关闭 |
| rejected | 已拒绝 | 不接受的反馈 |
| duplicate | 重复 | 与其他反馈重复 |

**状态流转规则**:

```
submitted (已提交)
    ├→ reviewing (审核中)
    ├→ rejected (已拒绝)
    └→ duplicate (重复)

reviewing (审核中)
    ├→ confirmed (已确认)
    ├→ rejected (已拒绝)
    └→ duplicate (重复)

confirmed (已确认)
    ├→ in_progress (处理中)
    ├→ rejected (已拒绝)
    └→ duplicate (重复)

in_progress (处理中)
    ├→ resolved (已解决)
    └→ rejected (已拒绝)

resolved (已解决)
    ├→ closed (已关闭)
    └→ in_progress (重新处理)

closed (已关闭)
    └→ submitted (重新开放)

rejected (已拒绝)
    └→ submitted (重新开放)

duplicate (重复)
    └→ submitted (重新开放)
```

**允许的状态转换表**:

| 当前状态 | 可转换为 |
|---------|---------|
| submitted | reviewing, rejected, duplicate |
| reviewing | confirmed, rejected, duplicate |
| confirmed | in_progress, rejected, duplicate |
| in_progress | resolved, rejected |
| resolved | closed, in_progress |
| closed | submitted |
| rejected | submitted |
| duplicate | submitted |

**自动触发的操作**:
- 状态变更后会创建状态历史记录
- 系统会自动发送邮件通知反馈提交者
- 如果状态变为 `resolved`，会记录解决时间

**注意事项**:
- 必须按照规定的流程转换状态
- 不合法的状态转换会返回 400 错误
- 建议在变更状态时填写 `reason` 字段

---

## 邮件验证

### 8. 验证邮箱

**接口**: `POST /feedbacks/{id}/verify-email/`

**权限**: 公开（不需要认证）

**用途**: 匿名用户提交反馈后，点击验证邮件中的链接来验证邮箱。

**请求字段**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| token | string | ✅ | 验证令牌 |

**验证流程**:

```
1. 匿名用户提交反馈
   ↓
2. 系统生成验证令牌，发送验证邮件
   ↓
3. 用户点击邮件中的验证链接
   ↓
4. 前端调用验证接口，传入 token
   ↓
5. 验证成功，标记 email_verified = true
```

**令牌有效期**: 24小时

**验证成功后**:
- 用户会收到后续的状态变更通知
- 用户会收到新回复通知

**错误情况**:
- 令牌无效：返回 400
- 令牌过期：返回 400，提示重新提交反馈
- 已经验证过：返回 200，提示已验证

**前端实现建议**:
- 验证链接格式：`https://your-domain.com/verify?feedback_id={id}&token={token}`
- 页面加载时自动调用验证接口
- 显示验证结果（成功/失败）

---

## 通知设置

### 9. 开启/关闭邮件通知

**接口**: `PATCH /feedbacks/{id}/notifications/`

**权限**: 反馈提交者

**用途**: 控制是否接收该反馈的邮件通知

**请求字段**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| enabled | boolean | ✅ | true=开启，false=关闭 |

**通知类型**:
- 新回复通知
- 状态变更通知

**使用场景**:
- 用户觉得某个反馈已不再重要，可以关闭通知
- 避免收到过多邮件

---

## 业务流程详解

### 反馈提交完整流程

```
┌─────────────────────────────────────┐
│ 1. 用户选择软件和版本                  │
├─────────────────────────────────────┤
│ 2. 填写反馈表单                       │
│    - 标题                            │
│    - 描述                            │
│    - 类型（bug/feature/...）         │
│    - 优先级                          │
│    - 环境信息（可选）                 │
├─────────────────────────────────────┤
│ 3. 调用 POST /feedbacks/             │
│    - 已登录用户：直接提交              │
│    - 匿名用户：必须填写邮箱            │
├─────────────────────────────────────┤
│ 4. 系统处理                          │
│    - 保存反馈（status: submitted）    │
│    - 发送验证邮件（匿名用户）          │
│    - 返回反馈ID                       │
├─────────────────────────────────────┤
│ 5. 用户验证邮箱（匿名用户）            │
│    - 点击邮件中的链接                 │
│    - 调用验证接口                     │
├─────────────────────────────────────┤
│ 6. 反馈提交完成                       │
└─────────────────────────────────────┘
```

### 反馈处理完整流程

```
┌─────────────────────────────────────┐
│ 管理员查看反馈列表                    │
│ GET /feedbacks/?status=submitted    │
├─────────────────────────────────────┤
│ 选择反馈查看详情                      │
│ GET /feedbacks/{id}/                │
├─────────────────────────────────────┤
│ 添加回复（可选）                      │
│ POST /feedbacks/{id}/replies/       │
│ → 用户收到邮件通知                    │
├─────────────────────────────────────┤
│ 修改状态：submitted → reviewing       │
│ PATCH /feedbacks/{id}/status/       │
│ → 用户收到状态变更邮件                │
├─────────────────────────────────────┤
│ 继续处理...                          │
│ reviewing → confirmed → in_progress  │
│ → resolved → closed                  │
│ 每次变更都会通知用户                  │
└─────────────────────────────────────┘
```

---

## 字段说明

### 反馈对象字段详解

**基本字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| id | integer | 反馈唯一标识 |
| title | string | 反馈标题 |
| description | string | 详细描述 |
| feedback_type | string | 反馈类型 |
| type_display | string | 类型的显示名称 |
| priority | string | 优先级 |
| priority_display | string | 优先级显示名称 |
| status | string | 当前状态 |
| status_display | string | 状态显示名称 |

**关联对象**:
| 字段 | 类型 | 说明 |
|------|------|------|
| software | integer | 软件ID |
| software_name | string | 软件名称 |
| software_detail | object | 软件完整对象（仅详情接口） |
| software_version | integer/null | 版本ID |
| version_number | string | 版本号 |
| version_detail | object | 版本完整对象（仅详情接口） |

**用户信息**:
| 字段 | 类型 | 说明 |
|------|------|------|
| user | integer/null | 用户ID（匿名为null） |
| user_info | object | 用户详细信息（仅详情接口） |
| contact_email | string | 联系邮箱 |
| contact_name | string | 联系人姓名 |
| email_verified | boolean | 邮箱是否已验证 |

**统计信息**:
| 字段 | 类型 | 说明 |
|------|------|------|
| vote_count | integer | 投票总数（赞成-反对） |
| reply_count | integer | 回复数量 |
| view_count | integer | 浏览次数 |

**时间字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| created_at | datetime | 创建时间 |
| updated_at | datetime | 最后更新时间 |
| resolved_at | datetime/null | 解决时间 |

**详情接口额外字段**:
- `attachments`: 附件列表数组
- `replies`: 回复列表数组
- `user_vote`: 当前用户的投票（1/-1/null）
- `status_history`: 状态变更历史数组
- `environment_info`: 环境信息对象

---

## 使用建议

### 列表页面设计

**功能建议**:
1. **筛选器**: 类型、状态、优先级下拉选择
2. **搜索框**: 支持全文搜索
3. **排序**: 最新、最热、最多回复
4. **分页**: 每页10-20条
5. **状态标签**: 用不同颜色区分状态
6. **统计信息**: 显示投票数、回复数

**推荐字段显示**:
- 标题
- 类型标签
- 状态标签
- 优先级标签
- 软件名称
- 投票数、回复数
- 提交时间

### 详情页面设计

**推荐布局**:

```
┌───────────────────────────────────────┐
│ 标题 + 类型/状态/优先级标签              │
├───────────────────────────────────────┤
│ 提交者 | 软件 | 版本 | 创建时间         │
├───────────────────────────────────────┤
│ 详细描述                               │
├───────────────────────────────────────┤
│ 环境信息（展开/折叠）                   │
├───────────────────────────────────────┤
│ 附件列表（图片预览 + 文件下载）          │
├───────────────────────────────────────┤
│ 投票按钮（👍 赞成 | 👎 反对）           │
├───────────────────────────────────────┤
│ 回复列表                               │
│  - 管理员回复                          │
│  - 回复时间                            │
├───────────────────────────────────────┤
│ 状态历史时间线                         │
├───────────────────────────────────────┤
│ 操作按钮（管理员）                      │
│  - 添加回复                            │
│  - 修改状态                            │
│  - 编辑/删除                           │
└───────────────────────────────────────┘
```

### 提交表单设计

**表单字段**:
1. **软件选择** (必填)
   - 第一步：选择分类
   - 第二步：选择该分类下的软件
   - 第三步：选择软件版本（可选）

2. **反馈类型** (必填)
   - 单选：Bug报告 | 功能请求 | 改进建议 | 问题咨询 | 其他

3. **优先级** (可选)
   - 单选：紧急 | 高 | 中 | 低（默认中）

4. **标题** (必填)
   - 单行输入框，最多200字符
   - 提示：简短描述问题或建议

5. **详细描述** (必填)
   - 多行文本框
   - 提示：详细说明问题或建议

6. **联系邮箱** (匿名用户必填)
   - 用于接收通知
   - 需要验证

7. **附件上传** (可选)
   - 支持多文件
   - 显示上传进度

**表单验证**:
- 前端验证：标题长度、邮箱格式
- 后端验证：所有字段完整性和合法性

---

## 注意事项

### 1. 权限控制
- 反馈列表接口会根据用户角色自动过滤数据
- 普通用户看不到其他人的反馈
- 管理员能看到所有反馈

### 2. 邮件通知
- 状态变更会自动发邮件
- 新回复会自动发邮件
- 用户可以关闭通知

### 3. 数据安全
- 所有修改操作都有权限检查
- 敏感字段（如内部备注）普通用户看不到
- 软删除保证数据可恢复

### 4. 性能考虑
- 使用分页避免一次加载过多数据
- 详情页访问会增加浏览计数
- 建议缓存软件列表等静态数据

---

**下一步**: [03_反馈互动API.md](03_反馈互动API.md)
