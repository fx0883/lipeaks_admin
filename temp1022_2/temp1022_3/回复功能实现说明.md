# 反馈回复功能实现说明

## 更新日期
2025-10-24

## 功能概述

反馈详情页面已完整实现回复功能，包括查看回复、添加回复（公开/内部备注）。

## 已实现功能

### 1. 回复数据加载

**Composable**: `src/composables/useFeedback.ts` - `useFeedbackReplies()`

**API调用**: `GET /api/v1/feedbacks/{feedback_pk}/replies/`

**数据处理**:
```typescript
// 支持多种数据格式
if (response.data.results && Array.isArray(response.data.results)) {
  replies.value = response.data.results;
} else if (response.data.data && Array.isArray(response.data.data)) {
  // 双层嵌套格式
  replies.value = response.data.data;
} else if (Array.isArray(response.data)) {
  // 直接数组格式
  replies.value = response.data;
}
```

### 2. 回复显示逻辑

**文件**: `src/views/feedback/feedbacks/detail.vue`

**实现方式**:
- 使用 `displayReplies` 计算属性
- 优先显示独立加载的回复
- 回退到反馈详情中的回复

```typescript
const displayReplies = computed(() => {
  if (replies.value && replies.value.length > 0) {
    return replies.value;
  }
  return feedback.value?.replies || [];
});
```

### 3. 回复表单（仅管理员可见）

**UI组件**:
- 多行文本输入框（4行）
- 内部备注复选框
- 发送按钮（带加载状态）

**权限控制**:
```typescript
const isAdmin = computed(() => {
  return userStore.isAdmin || userStore.isSuperAdmin;
});
```

### 4. 添加回复功能

**API调用**: `POST /api/v1/feedbacks/{feedback_pk}/replies/`

**请求参数**:
```typescript
{
  content: string,          // 必填，回复内容
  is_internal_note: boolean // 可选，是否为内部备注，默认false
}
```

**提交流程**:
1. 验证回复内容不为空
2. 调用 `addReply()` API
3. 成功后：
   - 清空输入框
   - 重置内部备注复选框
   - 刷新回复列表
   - 刷新反馈详情（更新回复计数）

### 5. 回复显示

**回复项包含**:
- 回复者用户名
- 内部备注标签（黄色警告标签）
- 回复时间
- 回复内容（支持多行显示）

**样式设计**:
- 灰色背景卡片
- 圆角边框
- 悬停效果
- 响应式布局

## UI结构

```
┌─────────────────────────────────────┐
│  💬 回复 (5)                        │
├─────────────────────────────────────┤
│  [管理员专用] 回复表单                │
│  ┌───────────────────────────────┐  │
│  │ 输入回复内容...              │  │
│  │                              │  │
│  │                              │  │
│  │                              │  │
│  └───────────────────────────────┘  │
│  □ 内部备注（用户不可见）    [发送]  │
├─────────────────────────────────────┤
│  回复列表                            │
│  ┌───────────────────────────────┐  │
│  │ admin  [内部]      10:00     │  │
│  │ 这是一个内部备注...           │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ admin              11:30     │  │
│  │ 问题已在v2.1.1中修复          │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

## 回复类型说明

### 公开回复
- **可见性**: 所有能查看反馈的用户都能看到
- **邮件通知**: 自动发送邮件通知反馈提交者
- **用途**: 
  - 告知用户问题处理进度
  - 请求用户提供更多信息
  - 告知问题已解决的版本
  - 感谢用户的反馈

### 内部备注
- **可见性**: 仅管理员可见
- **邮件通知**: 不触发邮件通知
- **标识**: 黄色"内部"标签
- **用途**:
  - 团队内部讨论
  - 记录技术细节
  - 标注处理思路
  - 记录待办事项

## 权限控制

### 查看回复
- **管理员**: 看到所有回复（包括内部备注）
- **普通用户**: 只看到公开回复（`is_internal_note=false`）

### 添加回复
- **仅管理员**: 只有管理员可以添加回复
- **普通用户**: 回复表单不显示

## API响应格式

### 获取回复列表响应

支持3种格式：

```json
// 格式1: 直接数组
{
  "success": true,
  "data": [
    {
      "id": 1,
      "feedback": 123,
      "content": "回复内容",
      "user": {
        "id": 2,
        "username": "admin",
        "email": "admin@example.com"
      },
      "is_internal_note": false,
      "created_at": "2025-10-24T10:00:00Z",
      "updated_at": "2025-10-24T10:00:00Z"
    }
  ]
}

// 格式2: 分页格式
{
  "success": true,
  "data": {
    "results": [...],
    "pagination": {...}
  }
}

// 格式3: 双层嵌套
{
  "success": true,
  "data": {
    "data": [...]
  }
}
```

### 添加回复响应

```json
{
  "success": true,
  "code": 2000,
  "message": "操作成功",
  "data": {
    "id": 6,
    "feedback": 123,
    "content": "感谢反馈，我们会尽快处理",
    "user": {
      "id": 2,
      "username": "admin",
      "email": "admin@example.com"
    },
    "is_internal_note": false,
    "created_at": "2025-10-24T14:30:00Z",
    "updated_at": "2025-10-24T14:30:00Z"
  }
}
```

## 数据流程

### 页面加载
```
用户访问反馈详情页
    ↓
并行加载两个API
    ├→ getFeedbackDetail()     // 获取反馈详情
    └→ getFeedbackReplies()    // 获取回复列表
    ↓
数据渲染到页面
```

### 添加回复
```
管理员输入回复内容
    ↓
选择是否为内部备注
    ↓
点击"发送回复"
    ↓
调用 addFeedbackReply() API
    ↓
POST /feedbacks/{id}/replies/
    ↓
成功后触发：
    ├→ 清空输入框
    ├→ 重置内部备注复选框
    ├→ 刷新回复列表（fetchReplies）
    └→ 刷新反馈详情（refresh）
    ↓
如果是公开回复
    └→ 后端自动发送邮件通知用户
```

## 错误处理

### 前端验证
- 回复内容不能为空
- 提示: "回复内容不能为空"

### API错误
- 权限不足（403）
- 反馈不存在（404）
- 网络错误

## 技术细节

### 文件修改
1. ✅ `src/composables/useFeedback.ts`
   - 添加双层嵌套数据格式支持
   - 导出 `fetchReplies` 方法

2. ✅ `src/views/feedback/feedbacks/detail.vue`
   - 添加 `displayReplies` 计算属性
   - 页面加载时调用 `fetchReplies()`
   - 添加回复成功后刷新数据
   - 导入 `message` 工具函数

### 依赖关系
```
detail.vue
    ↓
useFeedbackReplies (Composable)
    ↓
getFeedbackReplies / addFeedbackReply (API)
    ↓
http.request (HTTP客户端)
    ↓
Backend API
```

## 测试建议

### 功能测试
1. ✅ 回复列表正确显示
2. ✅ 内部备注显示特殊标签
3. ✅ 添加公开回复成功
4. ✅ 添加内部备注成功
5. ✅ 空内容验证生效
6. ✅ 提交后列表自动刷新
7. ✅ 回复计数正确更新

### 权限测试
1. ✅ 管理员看到所有回复
2. ✅ 管理员看到回复表单
3. ✅ 普通用户看不到内部备注
4. ✅ 普通用户看不到回复表单

### 数据格式测试
1. ✅ 直接数组格式
2. ✅ 分页格式
3. ✅ 双层嵌套格式
4. ✅ 空回复列表

## 已知限制

1. **实时性**: 当前需要手动刷新才能看到新回复，未使用WebSocket
2. **附件上传**: 回复中暂不支持附件，只支持文本
3. **Markdown**: 暂不支持Markdown渲染，仅纯文本显示
4. **回复编辑**: 暂未实现回复的编辑和删除功能

## 后续优化建议

1. **实时更新**: 集成WebSocket实现回复的实时推送
2. **富文本编辑**: 支持Markdown或富文本编辑器
3. **回复管理**: 添加编辑和删除回复的功能
4. **@提及**: 支持@用户功能
5. **回复通知**: 显示新回复的红点提示

## 相关文档

- API文档: `temp1022_2/03_反馈互动API.md`
- 类型定义: `src/types/feedback.ts`
- Composable: `src/composables/useFeedback.ts`
- 视图组件: `src/views/feedback/feedbacks/detail.vue`

