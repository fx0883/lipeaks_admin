# 软件版本管理功能更新说明

## 更新日期
2025-10-24

## 更新内容

### 1. 完整的版本管理功能

**文件**: `src/views/feedback/software/versions/index.vue`

#### 新增功能

1. **创建版本**
   - 使用嵌套路由 `POST /api/v1/feedbacks/software/{software_id}/versions/`
   - 弹出对话框方式创建
   - 自动计算 version_code
   - 需要先选择软件产品

2. **编辑版本**
   - 使用 `PATCH /api/v1/feedbacks/software-versions/{id}/`
   - 弹出对话框显示现有数据
   - 支持修改所有版本信息

3. **删除版本**
   - 确认对话框提示
   - 软删除操作
   - 删除成功后自动刷新列表

4. **版本号自动计算**
   - 输入版本号（如 v2.1.0）自动计算 version_code
   - 计算规则：主版本 × 100 + 次版本 × 10 + 修订版本
   - 支持手动修改

### 2. 表单字段

创建/编辑对话框包含以下字段：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| version | String | ✅ | 版本号（如：v2.1.0） |
| version_code | Integer | ✅ | 版本代码（自动计算或手动输入） |
| release_date | Date | ❌ | 发布日期 |
| release_notes | Textarea | ❌ | 更新说明（支持 Markdown） |
| download_url | String | ❌ | 下载链接 |
| is_stable | Boolean | ❌ | 是否稳定版（推荐用户使用） |
| is_active | Boolean | ❌ | 是否激活（停用后用户不可见） |

### 3. 数据格式处理

支持多种API响应格式：

```javascript
// 格式1: 直接数组
{
  "success": true,
  "data": [...]
}

// 格式2: 分页格式
{
  "success": true,
  "data": {
    "results": [...],
    "pagination": {...}
  }
}

// 格式3: 双层嵌套
{
  "success": true,
  "data": {
    "data": [...]
  }
}
```

### 4. 版本号规范

#### 推荐格式
- 版本号：`v主版本.次版本.修订版本`
- 示例：`v2.1.0`, `v3.0.5`

#### version_code 计算规则
```
version_code = 主版本 × 100 + 次版本 × 10 + 修订版本

示例:
v2.1.0 → 2×100 + 1×10 + 0 = 210
v3.0.5 → 3×100 + 0×10 + 5 = 305
v10.5.2 → 10×100 + 5×10 + 2 = 1052
```

### 5. 表单验证

- **版本号**：
  - 必填
  - 格式验证：`v?主版本.次版本.修订版本`
  - 错误提示：版本号格式错误，应为 v主版本.次版本.修订版本

- **版本代码**：
  - 必填
  - 数值类型
  - 最小值：1
  - 错误提示：版本代码必须大于0

### 6. 国际化支持

新增以下翻译键：

**中文 (zh-CN.yaml)**:
```yaml
codeFormatError: 代码格式错误，只能包含小写字母、数字和下划线
productEdit: 编辑软件产品
createVersion: 创建版本
editVersion: 编辑版本
versionPlaceholder: 请输入版本号（如：v2.1.0）
versionRequired: 版本号不能为空
versionFormatError: 版本号格式错误，应为 v主版本.次版本.修订版本
versionCodeRequired: 版本代码不能为空
versionCodeMin: 版本代码必须大于0
releaseNotesPlaceholder: "## 新功能\n- 功能1\n\n## Bug修复\n- 修复1"
downloadUrl: 下载链接
downloadUrlPlaceholder: 请输入下载链接
selectDate: 选择日期
selectSoftwareFirst: 请先选择软件产品
deleteVersionConfirm: 确定要删除版本 {version} 吗？
```

**英文 (en.yaml)**:
```yaml
codeFormatError: Code format error, only lowercase letters, numbers and underscores allowed
productEdit: Edit Software Product
createVersion: Create Version
editVersion: Edit Version
versionPlaceholder: Enter version (e.g., v2.1.0)
versionRequired: Version is required
versionFormatError: Version format error, should be vMAJOR.MINOR.PATCH
versionCodeRequired: Version code is required
versionCodeMin: Version code must be greater than 0
releaseNotesPlaceholder: "## New Features\n- Feature 1\n\n## Bug Fixes\n- Fix 1"
downloadUrl: Download URL
downloadUrlPlaceholder: Enter download URL
selectDate: Select Date
selectSoftwareFirst: Please select software product first
deleteVersionConfirm: Are you sure to delete version {version}?
```

### 7. 用户体验优化

1. **创建按钮状态**
   - 未选择软件时，创建按钮禁用
   - 鼠标悬停显示提示信息

2. **自动计算功能**
   - 输入版本号时自动计算 version_code
   - 支持手动修改计算结果

3. **表单提示**
   - 每个字段下方显示帮助提示
   - 格式要求清晰明了

4. **操作按钮**
   - 表格中的编辑、删除按钮
   - 对话框中的确定、取消按钮
   - 提交中显示加载状态

### 8. 使用流程

#### 创建版本
1. 访问 `/feedback/software/versions`
2. 在筛选器中选择软件产品
3. 点击"创建版本"按钮
4. 填写表单：
   - 输入版本号（如 v2.1.0），自动计算 version_code
   - 选择发布日期（可选）
   - 填写更新说明（支持 Markdown）
   - 填写下载链接（可选）
   - 设置是否稳定版
   - 设置是否激活
5. 点击"确定"创建

#### 编辑版本
1. 在版本列表中点击"编辑"按钮
2. 修改需要更新的字段
3. 点击"确定"保存

#### 删除版本
1. 在版本列表中点击"删除"按钮
2. 确认删除操作
3. 系统执行软删除

### 9. API 调用说明

#### 创建版本
```javascript
// POST /api/v1/feedbacks/software/{softwareId}/versions/
await addSoftwareVersion(softwareId, {
  version: "v2.2.0",
  version_code: 220,
  release_date: "2025-01-15",
  release_notes: "## 新功能\n- 添加暗黑模式\n- 性能优化",
  is_stable: true,
  is_active: true,
  download_url: "https://example.com/download/v2.2.0.zip"
});
```

#### 更新版本
```javascript
// PATCH /api/v1/feedbacks/software-versions/{versionId}/
await updateSoftwareVersion(versionId, {
  release_notes: "## 更新内容\n- 修复已知问题",
  is_stable: false
});
```

#### 删除版本
```javascript
// DELETE /api/v1/feedbacks/software-versions/{versionId}/
await deleteSoftwareVersion(versionId);
```

### 10. 注意事项

1. **版本号唯一性**
   - 同一软件的版本号不能重复
   - 建议使用语义化版本号

2. **version_code 递增**
   - version_code 应该递增
   - 用于版本比较和排序

3. **稳定版标记**
   - `is_stable=true`：推荐用户使用
   - `is_stable=false`：测试版本，可能有问题

4. **版本激活状态**
   - `is_active=true`：用户可见
   - `is_active=false`：已停用（发现严重bug时使用）

5. **Markdown 支持**
   - release_notes 字段支持 Markdown 格式
   - 建议使用标准的 Markdown 语法

### 11. 技术细节

- ✅ TypeScript 类型安全
- ✅ 表单验证
- ✅ 国际化支持（中英文）
- ✅ 响应式数据处理
- ✅ 错误处理和提示
- ✅ 加载状态显示
- ✅ 自动刷新列表

### 12. 相关文件

- 视图组件：`src/views/feedback/software/versions/index.vue`
- API 接口：`src/api/modules/feedback.ts`
- 类型定义：`src/types/feedback.ts`
- 国际化：`locales/zh-CN.yaml`, `locales/en.yaml`

### 13. 测试建议

1. **创建测试**
   - 测试必填字段验证
   - 测试版本号格式验证
   - 测试 version_code 自动计算
   - 测试创建成功后列表刷新

2. **编辑测试**
   - 测试数据正确填充
   - 测试更新成功
   - 测试部分字段更新

3. **删除测试**
   - 测试删除确认对话框
   - 测试删除成功
   - 测试列表刷新

4. **边界条件测试**
   - 未选择软件时创建按钮禁用
   - 版本号格式错误时的提示
   - version_code 小于1时的提示

## 总结

本次更新完善了软件版本管理的所有功能，提供了完整的增删改查操作，支持版本号自动计算，界面友好，操作流畅，符合最新的API文档规范。

