# 反馈互动 API 使用文档

## 🔄 模块概述

反馈互动模块提供回复、投票、附件上传等用户互动功能。

**API 数量**: 10 个  
**主要功能**: 回复管理、投票功能、附件处理

## 📑 API 列表

### 回复管理 (6个API)

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/feedbacks/{feedback_pk}/replies/` | 获取回复列表 | 分权限查看 |
| POST | `/feedbacks/{feedback_pk}/replies/` | 添加回复 | 仅管理员 |
| GET | `/feedbacks/{feedback_pk}/replies/{id}/` | 获取回复详情 | 分权限查看 |
| PUT | `/feedbacks/{feedback_pk}/replies/{id}/` | 完整更新回复 | 仅管理员 |
| PATCH | `/feedbacks/{feedback_pk}/replies/{id}/` | 部分更新回复 | 仅管理员 |
| DELETE | `/feedbacks/{feedback_pk}/replies/{id}/` | 删除回复 | 仅管理员 |

### 投票功能 (2个API)

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| POST | `/feedbacks/{id}/vote/` | 投票或修改投票 | 已认证用户 |
| DELETE | `/feedbacks/{id}/vote/` | 取消投票 | 已认证用户 |

### 附件管理 (4个API)

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/feedbacks/{feedback_pk}/attachments/` | 获取附件列表 | 分权限查看 |
| POST | `/feedbacks/{feedback_pk}/attachments/` | 上传附件 | 作者或管理员 |
| GET | `/feedbacks/{feedback_pk}/attachments/{id}/` | 获取附件详情 | 分权限查看 |
| DELETE | `/feedbacks/{feedback_pk}/attachments/{id}/` | 删除附件 | 上传者或管理员 |

---

## 回复管理

### 功能说明

**回复类型**:
1. **公开回复**: 所有能查看反馈的用户都能看到
2. **内部备注**: 只有管理员能看到，用于内部讨论

**权限控制**:
- 只有管理员可以添加回复
- 管理员可以看到所有回复（包括内部备注）
- 普通用户只能看到公开回复

**自动触发**:
- 添加公开回复后，系统自动发送邮件通知反馈提交者
- 内部备注不会触发邮件通知

### 1. 获取回复列表

**接口**: `GET /feedbacks/{feedback_pk}/replies/`

**返回字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| id | integer | 回复ID |
| feedback | integer | 反馈ID |
| content | string | 回复内容 |
| user | object | 回复者信息（username, email） |
| is_internal_note | boolean | 是否为内部备注 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

**数据过滤**:
- 管理员：看到所有回复
- 普通用户：只看到 `is_internal_note=false` 的回复

---

### 2. 添加回复

**接口**: `POST /feedbacks/{feedback_pk}/replies/`

**权限**: 仅管理员

**请求字段**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| content | string | ✅ | 回复内容 |
| is_internal_note | boolean | ❌ | 是否为内部备注（默认false） |

**使用建议**:

**公开回复的使用场景**:
- 告知用户问题处理进度
- 请求用户提供更多信息
- 告知问题已解决的版本
- 感谢用户的反馈

**内部备注的使用场景**:
- 团队内部讨论
- 记录技术细节
- 标注处理思路
- 记录待办事项

---

### 3-6. 回复的其他操作

**获取回复详情** (`GET /feedbacks/{feedback_pk}/replies/{id}/`)
- 查看单条回复的完整信息

**更新回复** (`PATCH /feedbacks/{feedback_pk}/replies/{id}/`)
- 修改回复内容
- 修改是否为内部备注

**删除回复** (`DELETE /feedbacks/{feedback_pk}/replies/{id}/`)
- 软删除
- 谨慎操作

---

## 投票功能

### 功能说明

**投票机制**:
- 每个用户对每个反馈只能投一票
- 可以投赞成票（+1）或反对票（-1）
- 可以修改投票或取消投票

**投票统计**:
- `vote_count` = 赞成票数量 - 反对票数量
- 可用于反馈热度排序

**使用场景**:
- 用户支持某个功能请求
- 用户也遇到了同样的bug
- 判断反馈的重要程度

### 7. 投票

**接口**: `POST /feedbacks/{id}/vote/`

**权限**: 已认证用户（匿名用户不能投票）

**请求字段**:

| 字段 | 类型 | 必填 | 值 | 说明 |
|------|------|------|---|------|
| vote_type | integer | ✅ | `1` 或 `-1` | 1=赞成，-1=反对 |

**投票行为**:
- **首次投票**: 创建投票记录
- **修改投票**: 更新 vote_type（从赞成改为反对，或反向）
- **重复相同投票**: 返回成功，不重复计数

**返回数据**:
```json
{
  "message": "投票已记录",
  "vote_type": 1,
  "total_votes": 15
}
```

---

### 8. 取消投票

**接口**: `DELETE /feedbacks/{id}/vote/`

**用途**: 取消之前的投票

**行为**:
- 删除用户对该反馈的投票记录
- 反馈的 `vote_count` 会相应调整

**错误情况**:
- 用户未投票时调用：返回 404

---

## 附件管理

### 功能说明

**支持的文件类型**:

| 类型 | 扩展名 | 用途 |
|------|--------|------|
| 图片 | jpg, jpeg, png, gif, webp | 截图、示意图 |
| 文档 | pdf, doc, docx, txt | 详细说明、日志 |
| 压缩包 | zip, rar | 批量文件 |

**文件限制**:
- 单个文件最大：10MB
- 每个反馈最多：10个附件
- 总大小限制：50MB/反馈

**权限规则**:
- 反馈提交者可以上传附件
- 管理员可以上传附件
- 只有上传者和管理员可以删除

### 9. 获取附件列表

**接口**: `GET /feedbacks/{feedback_pk}/attachments/`

**返回字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| id | integer | 附件ID |
| feedback | integer | 反馈ID |
| file | string | 文件URL（完整路径） |
| file_name | string | 原始文件名 |
| file_size | integer | 文件大小（字节） |
| file_type | string | MIME类型 |
| description | string | 附件描述 |
| uploaded_by | object | 上传者信息 |
| created_at | datetime | 上传时间 |

**使用建议**:
- 图片类型显示缩略图预览
- 文档类型显示文件图标
- 提供下载链接

---

### 10. 上传附件

**接口**: `POST /feedbacks/{feedback_pk}/attachments/`

**请求格式**: `multipart/form-data`

**请求字段**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | File | ✅ | 文件对象 |
| description | string | ❌ | 附件说明 |

**上传步骤**:

```
1. 用户选择文件
   ↓
2. 前端验证
   - 检查文件大小（≤10MB）
   - 检查文件类型
   ↓
3. 创建 FormData 对象
   - append('file', fileObject)
   - append('description', '说明')
   ↓
4. 发送 POST 请求
   - Content-Type: multipart/form-data
   - 可监听上传进度
   ↓
5. 接收返回的附件信息
   - 包含文件URL
   - 更新附件列表
```

**前端实现要点**:
- 使用 `<input type="file">` 选择文件
- 检查文件类型和大小
- 显示上传进度条
- 上传成功后立即在列表中显示
- 支持多文件批量上传（循环调用接口）

**错误处理**:

| HTTP状态码 | 说明 | 处理方式 |
|-----------|------|---------|
| 400 | 文件格式错误 | 提示支持的文件类型 |
| 413 | 文件过大 | 提示文件大小限制 |
| 415 | 不支持的类型 | 提示支持的文件类型 |

---

### 11-12. 附件其他操作

**获取附件详情** (`GET /feedbacks/{feedback_pk}/attachments/{id}/`)
- 查看单个附件的完整信息

**删除附件** (`DELETE /feedbacks/{feedback_pk}/attachments/{id}/`)
- 删除附件文件
- 只有上传者或管理员可以删除

---

## 业务流程

### 回复流程图

```
用户提交反馈
    ↓
管理员查看反馈详情
    ↓
管理员添加回复
    ↓
系统发送邮件通知
    ↓
用户收到邮件
    ↓
用户查看回复
```

### 投票流程图

```
用户查看反馈列表
    ↓
选择感兴趣的反馈
    ↓
点击"赞成"或"反对"按钮
    ↓
系统记录投票
    ↓
实时更新投票数
    ↓
反馈按热度重新排序
```

### 附件上传流程图

```
用户选择要上传的文件
    ↓
前端验证文件大小和类型
    ↓
显示上传进度条
    ↓
调用上传接口
    ↓
后端保存文件
    ↓
返回文件URL
    ↓
在附件列表中显示
```

---

## 前端集成建议

### 回复组件设计

**回复列表显示**:
- 按时间倒序（最新的在上）
- 区分管理员回复和内部备注
- 显示回复者头像、姓名、时间
- 内部备注添加特殊标记

**回复编辑器**:
- 多行文本输入框
- 支持 Markdown 或富文本（可选）
- 内部备注复选框
- 提交按钮

### 投票组件设计

**UI 元素**:
- 赞成按钮：👍 图标 + 数字
- 反对按钮：👎 图标
- 高亮显示用户已投的票
- 点击相同按钮=取消投票

**交互逻辑**:
```
未投票状态
    ├→ 点击👍 → 投赞成票
    └→ 点击👎 → 投反对票

已投赞成票状态
    ├→ 点击👍 → 取消投票
    └→ 点击👎 → 改为反对票

已投反对票状态
    ├→ 点击👍 → 改为赞成票
    └→ 点击👎 → 取消投票
```

### 附件组件设计

**上传区域**:
- 拖拽上传支持
- 或点击选择文件
- 多文件选择
- 上传进度显示

**附件列表**:
- 图片：显示缩略图，点击放大
- 文档：显示文件图标，提供下载链接
- 显示文件大小
- 显示上传时间
- 删除按钮（仅上传者和管理员）

**图片预览**:
- 支持点击查看大图
- 图片轮播
- 缩放功能

---

## 数据结构说明

### 回复对象

```json
{
  "id": 1,
  "feedback": 123,
  "content": "回复内容",
  "user": {
    "id": 2,
    "username": "admin",
    "email": "admin@example.com"
  },
  "is_internal_note": false,
  "created_at": "2025-10-22T10:00:00Z",
  "updated_at": "2025-10-22T10:00:00Z"
}
```

### 投票对象

投票不直接返回对象，而是返回统计结果：
```json
{
  "message": "投票已记录",
  "vote_type": 1,        // 当前投票类型
  "total_votes": 15      // 反馈的总票数
}
```

### 附件对象

```json
{
  "id": 1,
  "feedback": 123,
  "file": "http://example.com/media/uploads/screenshot.png",
  "file_name": "screenshot.png",
  "file_size": 102400,
  "file_type": "image/png",
  "description": "错误截图",
  "uploaded_by": {
    "id": 1,
    "username": "user1"
  },
  "created_at": "2025-10-22T10:00:00Z"
}
```

---

## 使用场景详解

### 场景1: 管理员回复用户反馈

**步骤**:
1. 管理员查看反馈详情
2. 了解问题后，撰写回复
3. 选择是否为内部备注
4. 提交回复
5. 系统自动发送邮件通知用户（公开回复）
6. 反馈的 `reply_count` 增加

**接口调用**:
```
POST /feedbacks/123/replies/
Body: {
  "content": "感谢反馈，我们会尽快处理",
  "is_internal_note": false
}
```

---

### 场景2: 用户投票支持功能请求

**步骤**:
1. 用户浏览反馈列表
2. 看到感兴趣的功能请求
3. 点击"赞成"按钮
4. 系统记录投票
5. 投票数实时更新
6. 列表按热度重新排序

**接口调用**:
```
POST /feedbacks/123/vote/
Body: { "vote_type": 1 }
```

---

### 场景3: 用户上传Bug截图

**步骤**:
1. 用户在提交反馈或查看详情时
2. 点击"上传附件"按钮
3. 选择文件（如截图）
4. 前端验证文件
5. 显示上传进度
6. 上传完成后在列表中显示
7. 可以继续上传更多文件

**接口调用**:
```
POST /feedbacks/123/attachments/
Content-Type: multipart/form-data
Body: FormData(file, description)
```

---

## 页面设计建议

### 反馈详情页布局

```
┌─────────────────────────────────────┐
│  反馈标题 + 标签                      │
│  提交者 | 软件 | 版本 | 时间          │
├─────────────────────────────────────┤
│  详细描述                             │
├─────────────────────────────────────┤
│  📎 附件列表 (3)                     │
│    [图片1] [文档1] [图片2]           │
├─────────────────────────────────────┤
│  投票区域                             │
│  👍 赞成 (15)  👎 反对 (2)          │
├─────────────────────────────────────┤
│  💬 回复 (5)                         │
│  ┌───────────────────────────────┐  │
│  │ 管理员 @ 10:00               │  │
│  │ 我们已经收到您的反馈...        │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ 管理员 @ 11:30               │  │
│  │ 问题已在v2.1.1中修复          │  │
│  └───────────────────────────────┘  │
├─────────────────────────────────────┤
│  [管理员] 回复输入框 + 发送按钮       │
└─────────────────────────────────────┘
```

---

## 注意事项

### 回复管理
1. **内部备注**: 使用不同的样式标识
2. **邮件通知**: 公开回复会触发邮件
3. **权限**: 前端需隐藏普通用户的回复按钮
4. **实时性**: 建议定期刷新或使用 WebSocket

### 投票功能
1. **登录检查**: 投票前需检查用户登录状态
2. **防重复**: 后端已处理，前端无需额外控制
3. **状态同步**: 投票后立即更新显示
4. **排序**: 可按票数排序展示热门反馈

### 附件处理
1. **文件验证**: 前端先验证，避免无效请求
2. **进度显示**: 大文件上传需要进度条
3. **预览功能**: 图片支持预览，文档提供下载
4. **懒加载**: 附件较多时使用懒加载
5. **错误处理**: 上传失败提供重试机制

---

**下一步**: [04_邮件系统API.md](04_邮件系统API.md)
