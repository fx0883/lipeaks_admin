# Feedback System 故障排查指南

## 🔍 当前错误分析

### 错误信息
```
data.reduce is not a function
```

### 错误原因
软件分类 API (`/feedbacks/software-categories/`) 返回的数据不是预期的数组格式。

### 可能的情况

**情况1: 后端 Feedback API 未部署** ⭐ 最可能
- Feedback System 后端服务未启动
- API 路径不存在，返回 404 错误
- 前端收到错误响应，导致数据格式异常

**情况2: API 基础路径配置错误**
- 前端请求的路径不正确
- CORS 配置问题
- 网络连接问题

**情况3: 后端返回格式不一致**
- 后端返回的数据结构与预期不同
- 需要调整前端的数据处理逻辑

---

## ✅ 已完成的修复

### 1. 国际化错误修复
- ✅ 修复了 YAML 重复 key 问题
- ✅ 修复了占位符嵌套错误 (`{{}}` → `{}`)

### 2. 数据处理增强
- ✅ 添加了数组类型检查
- ✅ 添加了详细的调试日志
- ✅ 添加了容错处理（数据异常时返回空数组）

---

## 🔧 排查步骤

### 第1步: 检查后端 API 状态

**打开浏览器控制台 (F12)**，查看 Network 面板：

1. 访问页面：`http://localhost:8848/#/feedback/software/categories`
2. 查看网络请求：找到 `/feedbacks/software-categories/` 请求
3. 检查响应：
   - **状态码 200** → API 正常，检查返回格式
   - **状态码 404** → API 不存在，需要部署后端
   - **状态码 500** → 后端服务错误
   - **无请求** → 前端配置问题

### 第2步: 检查 Console 日志

在浏览器控制台中查看日志输出：

```
[DEBUG] 软件分类API响应: { ... }
```

**预期的正确响应格式**:
```json
{
  "success": true,
  "code": 2000,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "name": "Web应用",
      "code": "web",
      "description": "Web应用程序",
      "sort_order": 1,
      "is_active": true,
      "software_count": 5
    }
  ]
}
```

**如果看到其他格式**，说明后端返回格式不一致。

### 第3步: 测试 API 可访问性

**在浏览器或命令行测试**:

```bash
# 测试健康检查端点
curl http://localhost:8000/api/v1/feedbacks/health/

# 测试分类列表端点（需要 Token）
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/v1/feedbacks/software-categories/
```

**预期结果**:
- 返回 JSON 数据
- 状态码 200

**如果返回 404**:
- Feedback System 后端未部署
- 需要先部署后端服务

---

## 🚀 解决方案

### 方案1: 后端 API 未部署（推荐）

**如果 Feedback System 后端还未部署**:

1. **暂时禁用相关菜单**
   - 在后端菜单配置中，暂时不添加 Feedback 相关菜单
   - 或设置 `showLink: false` 隐藏菜单

2. **部署后端服务**
   - 部署 Feedback System 后端
   - 确保 API 可访问
   - 配置正确的基础 URL

3. **启用菜单**
   - 后端部署完成后，再启用菜单
   - 测试所有功能

### 方案2: 使用 Mock 数据（临时方案）

**如果需要先开发前端**，可以创建 Mock 数据：

**文件位置**: `mock/feedback.ts`

```typescript
export default [
  {
    url: "/api/v1/feedbacks/software-categories/",
    method: "get",
    response: () => {
      return {
        success: true,
        code: 2000,
        message: "操作成功",
        data: [
          {
            id: 1,
            name: "Web应用",
            code: "web",
            description: "基于Web的应用程序",
            icon: "web",
            sort_order: 1,
            is_active: true,
            software_count: 5,
            created_at: "2025-01-01T00:00:00Z",
            updated_at: "2025-01-01T00:00:00Z"
          },
          {
            id: 2,
            name: "移动应用",
            code: "mobile",
            description: "移动端应用程序",
            icon: "smartphone",
            sort_order: 2,
            is_active: true,
            software_count: 3,
            created_at: "2025-01-01T00:00:00Z",
            updated_at: "2025-01-01T00:00:00Z"
          }
        ]
      };
    }
  }
];
```

### 方案3: 修改 API 基础路径

**如果后端 API 路径不同**:

检查并修改 `src/utils/http/index.ts` 中的 baseURL：

```typescript
baseURL: import.meta.env.VITE_BASE_API || "http://43.142.76.105:8000/api/v1"
```

或创建环境变量文件：

```bash
# .env.development
VITE_BASE_API=http://localhost:8000/api/v1
```

---

## 📊 当前状态总结

### ✅ 已完成
- 前端代码集成完成（19个文件）
- 国际化配置完成
- 错误处理增强
- 调试日志添加

### ⏳ 待确认
- 后端 Feedback System API 是否已部署
- API 基础 URL 是否正确
- 后端返回数据格式

### 🎯 建议的下一步

**优先级1: 确认后端状态** ⭐⭐⭐
1. 检查 Feedback System 后端是否已部署
2. 测试 API 是否可访问
3. 确认数据返回格式

**优先级2: 暂时隐藏菜单**
- 如果后端未准备好，先不添加 Feedback 菜单
- 等后端就绪后再启用

**优先级3: 使用 Mock 数据**
- 如果需要先开发前端，创建 Mock 数据
- 后端就绪后切换到真实 API

---

## 🔍 调试技巧

### 查看详细日志

现在代码中已添加调试日志，在浏览器控制台可以看到：

```
[DEBUG] 软件分类API响应: { success: true, code: 2000, data: [...] }
```

**如果看到**:
- `data: []` → API 返回空数组（正常，只是没有数据）
- `data: {...}` → 数据格式不对
- `success: false` → API 调用失败
- 错误对象 → 网络或服务器错误

### 网络请求检查

**在 Network 面板中**:
1. 找到失败的请求
2. 查看 Request URL（确认路径正确）
3. 查看 Request Headers（确认 Token 正确）
4. 查看 Response（确认返回数据）
5. 查看 Status Code（确认状态码）

---

## 💡 快速解决方案

### 临时方案：先隐藏 Feedback 菜单

**在后端菜单配置中**，暂时不添加 Feedback 相关配置，或者设置：

```json
{
  "path": "/feedback",
  "meta": {
    "showLink": false  // 暂时隐藏
  }
}
```

这样前端不会尝试加载这些页面，避免错误。

**等后端 Feedback System 部署完成后**:
1. 将 `showLink` 改为 `true`
2. 重新登录系统
3. 菜单就会显示

---

## 📞 联系后端团队

**需要确认的信息**:

1. **Feedback System 后端状态**
   - 是否已部署？
   - API 基础地址是什么？
   - 示例：`http://your-domain.com/api/v1/feedbacks/`

2. **API 访问方式**
   - 是否需要特殊的认证？
   - CORS 是否已配置？
   - 是否有 API 文档或 Swagger？

3. **数据返回格式**
   - 是否符合文档中的格式？
   - 是否使用标准的 DRF 响应格式？

---

## ✅ 修复确认

**现在启动应该不会报国际化错误了**，但是：

- ✅ YAML 语法错误已修复
- ✅ 数据处理已增强容错
- ⚠️ 如果后端 API 不可用，页面会显示空列表（不会报错）

**下一步**:
1. 确认后端 API 状态
2. 根据情况选择解决方案
3. 完成动态菜单配置

---

**需要更多帮助，请查看浏览器控制台的详细日志！** 🔍

