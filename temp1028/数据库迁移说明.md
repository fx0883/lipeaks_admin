# CMS分类多语言数据库迁移说明

> **重要**：执行迁移前请务必备份数据库！

## 迁移方式选择

由于django-parler在Django迁移系统中的技术限制，我们提供两种迁移方式：

- **方式1：使用SQL脚本**（推荐，更可靠）
- **方式2：使用Python管理命令**（更简单）

---

## 方式1：使用SQL脚本（推荐）

### 步骤1：备份数据库

```bash
# MySQL备份命令
mysqldump -u root -p multi_tenant_db_dev > backup_before_migration_$(date +%Y%m%d).sql
```

### 步骤2：执行SQL脚本

SQL脚本位置：`cms/migrations/manual_migration_0006.sql`

```bash
# 连接MySQL
mysql -u root -p multi_tenant_db_dev

# 在MySQL中执行
source /Users/fengxuan/Documents/Github/lipeaks_backend/cms/migrations/manual_migration_0006.sql;
```

或者一步执行：

```bash
mysql -u root -p multi_tenant_db_dev < cms/migrations/manual_migration_0006.sql
```

### 步骤3：验证数据迁移

在MySQL中运行验证查询：

```sql
-- 检查翻译表是否创建成功
SHOW TABLES LIKE 'cms_category_translation';

-- 检查数据是否迁移
SELECT 
    c.id, c.slug,
    t.language_code, t.name, t.description
FROM cms_category c
LEFT JOIN cms_category_translation t ON c.id = t.master_id
ORDER BY c.id;

-- 确认所有分类都有简体中文翻译
SELECT COUNT(*) as total_categories FROM cms_category;
SELECT COUNT(DISTINCT master_id) as translated_categories 
FROM cms_category_translation 
WHERE language_code = 'zh-hans';
-- 两个数字应该相等
```

### 步骤4：删除旧字段（可选）

⚠️ **警告**：执行此步骤后无法回退！请确认步骤3验证通过后再执行！

在SQL脚本中的步骤3已注释，如需删除旧字段，取消注释并执行：

```sql
ALTER TABLE `cms_category` DROP COLUMN `name`;
ALTER TABLE `cms_category` DROP COLUMN `description`;
ALTER TABLE `cms_category` DROP COLUMN `seo_title`;
ALTER TABLE `cms_category` DROP COLUMN `seo_description`;
```

---

## 方式2：使用Python管理命令

### 步骤1：备份数据库（同上）

### 步骤2：进入Django Shell

```bash
cd /Users/fengxuan/Documents/Github/lipeaks_backend
python3 manage.py shell
```

### 步骤3：执行迁移脚本

在Django shell中执行：

```python
from django.db import connection
from cms.models import Category

# 创建翻译表的SQL
create_table_sql = """
CREATE TABLE IF NOT EXISTS `cms_category_translation` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT,
    `language_code` varchar(15) NOT NULL,
    `name` varchar(100) NOT NULL,
    `description` longtext,
    `seo_title` varchar(255),
    `seo_description` longtext,
    `master_id` bigint(20) NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `cms_category_translat_language_code_master__37d9b6c5_uniq` (`language_code`, `master_id`),
    KEY `cms_category_translation_master_id_2ca0b49d_fk_cms_category_id` (`master_id`),
    KEY `cms_category_translation_language_code_c7ec18e8` (`language_code`),
    CONSTRAINT `cms_category_translation_master_id_2ca0b49d_fk_cms_category_id` 
        FOREIGN KEY (`master_id`) REFERENCES `cms_category` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
"""

# 数据迁移SQL
migrate_data_sql = """
INSERT INTO `cms_category_translation` 
    (`language_code`, `name`, `description`, `seo_title`, `seo_description`, `master_id`)
SELECT 
    'zh-hans' as language_code,
    `name`,
    `description`,
    `seo_title`,
    `seo_description`,
    `id`
FROM `cms_category`
WHERE `name` IS NOT NULL
AND NOT EXISTS (
    SELECT 1 FROM `cms_category_translation` t 
    WHERE t.master_id = cms_category.id 
    AND t.language_code = 'zh-hans'
);
"""

# 执行SQL
with connection.cursor() as cursor:
    print("创建翻译表...")
    cursor.execute(create_table_sql)
    print("✅ 翻译表创建成功")
    
    print("迁移数据...")
    cursor.execute(migrate_data_sql)
    rows_affected = cursor.rowcount
    print(f"✅ 迁移了 {rows_affected} 条分类数据到翻译表")

# 验证迁移
print("\n验证迁移结果：")
with connection.cursor() as cursor:
    cursor.execute("SELECT COUNT(*) FROM cms_category")
    total_categories = cursor.fetchone()[0]
    
    cursor.execute("""
        SELECT COUNT(DISTINCT master_id) 
        FROM cms_category_translation 
        WHERE language_code = 'zh-hans'
    """)
    translated_categories = cursor.fetchone()[0]
    
    print(f"总分类数：{total_categories}")
    print(f"已翻译分类数：{translated_categories}")
    
    if total_categories == translated_categories:
        print("✅ 所有分类都已成功迁移！")
    else:
        print(f"⚠️ 还有 {total_categories - translated_categories} 个分类未迁移")

print("\n完成！按Ctrl+D退出shell")
```

---

## 迁移后测试

### 1. 测试Admin后台

访问：`http://localhost:8000/admin/cms/category/`

- 检查是否能看到语言切换标签
- 尝试编辑一个分类，切换语言
- 确认数据显示正确

### 2. 测试API

```bash
# 测试获取分类列表（中文）
curl -X GET "http://localhost:8000/api/v1/cms/categories/" \
  -H "X-Tenant-ID: 1" \
  -H "Accept-Language: zh-hans"

# 测试获取分类列表（英文）
curl -X GET "http://localhost:8000/api/v1/cms/categories/" \
  -H "X-Tenant-ID: 1" \
  -H "Accept-Language: en"

# 测试创建多语言分类
curl -X POST "http://localhost:8000/api/v1/cms/categories/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Tenant-ID: 1" \
  -H "Content-Type: application/json" \
  -d '{
    "slug": "test-multi-lang",
    "translations": {
      "zh-hans": {
        "name": "测试分类",
        "description": "这是一个测试分类"
      },
      "en": {
        "name": "Test Category",
        "description": "This is a test category"
      }
    },
    "is_active": true
  }'
```

### 3. 检查翻译数据

在Django shell中：

```python
from cms.models import Category

# 获取一个分类
category = Category.objects.first()

# 检查中文翻译
category.set_current_language('zh-hans')
print(f"中文名称：{category.name}")

# 检查英文翻译（如果有）
category.set_current_language('en')
print(f"英文名称：{category.name}")  # 如果没有会显示中文（回退）

# 查看所有翻译
print("\n所有翻译：")
for translation in category.translations.all():
    print(f"{translation.language_code}: {translation.name}")
```

---

## 常见问题

### Q1: 迁移后访问API报错？

**A**: 检查是否正确执行了`python3 manage.py migrate cms --fake`。Django需要知道迁移已应用。

### Q2: Admin后台看不到语言切换标签？

**A**: 检查：
1. CategoryAdmin是否继承了TranslatableAdmin
2. 浏览器缓存是否清除
3. Django服务是否重启

### Q3: 某些分类没有迁移数据？

**A**: 检查这些分类的`name`字段是否为NULL。迁移脚本只迁移有名称的分类。

### Q4: 想要回退怎么办？

**A**: 
1. 恢复数据库备份
2. 撤销代码更改（git checkout）
3. 重新运行 `python3 manage.py migrate cms`

### Q5: 如何添加其他语言的翻译？

**A**: 在Admin后台编辑分类，切换到对应语言标签填写即可。或使用API更新：

```bash
curl -X PATCH "http://localhost:8000/api/v1/cms/categories/1/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Tenant-ID: 1" \
  -H "Content-Type: application/json" \
  -d '{
    "translations": {
      "en": {
        "name": "English Name",
        "description": "English Description"
      }
    }
  }'
```

---

## 删除旧字段（可选）

如果确认迁移成功，可以删除旧字段以清理数据库结构：

```sql
ALTER TABLE `cms_category` DROP COLUMN `name`;
ALTER TABLE `cms_category` DROP COLUMN `description`;
ALTER TABLE `cms_category` DROP COLUMN `seo_title`;
ALTER TABLE `cms_category` DROP COLUMN `seo_description`;
```

**注意**：删除后需要确保代码中不再引用这些字段。

---

## 技术说明

### 为什么需要手动迁移？

django-parler与Django迁移系统存在兼容性问题。在迁移过程中，Django的StateApps无法正确识别TranslatableModel，导致迁移失败。这是django-parler的已知限制。

### 迁移做了什么？

1. **创建翻译表**：`cms_category_translation`
2. **迁移现有数据**：将`cms_category`表中的`name`、`description`等字段数据复制到翻译表，语言代码设为`zh-hans`
3. **保留旧字段**：暂时保留原字段，便于验证和回退
4. **可选删除**：验证成功后可删除旧字段

### 数据安全

- 迁移不会删除原始数据
- 只是将数据复制到新表
- 可随时回退（恢复备份）
- 建议在测试环境先验证

---

**迁移完成后，请参考《CMS分类多语言使用指南.md》了解如何使用多语言功能。**

