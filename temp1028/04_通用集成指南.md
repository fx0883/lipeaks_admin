# 通用集成指南

> **适用对象**: 前端开发人员（iOS/Web/Android）  
> **文档版本**: 2.0  
> **最后更新**: 2025-10-31

---

## 📋 目录

1. [集成准备](#集成准备)
2. [认证流程](#认证流程)
3. [HTTP请求配置](#http请求配置)
4. [核心集成流程](#核心集成流程)
5. [平台特定说明](#平台特定说明)
6. [最佳实践](#最佳实践)

---

## 集成准备

### 1. 获取必要信息

向后端团队获取以下信息：

| 信息项 | 示例 | 说明 |
|--------|------|------|
| API Base URL | `https://api.your-domain.com` | API服务器地址 |
| 租户ID | `1` | 您的应用租户ID |
| 测试账号 | `test` / `test123` | 用于开发测试的账号 |

### 2. 环境配置

根据您的技术栈配置环境变量：

**iOS (Info.plist)**:
```xml
<key>API_BASE_URL</key>
<string>https://api.your-domain.com</string>
<key>TENANT_ID</key>
<string>1</string>
```

**Android (gradle.properties)**:
```properties
API_BASE_URL=https://api.your-domain.com
TENANT_ID=1
```

**Web (.env)**:
```bash
VITE_API_BASE_URL=https://api.your-domain.com
VITE_TENANT_ID=1
```

---

## 认证流程

### 完整认证流程图

```
┌──────────────────┐
│  用户输入         │
│  用户名 + 密码    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  发送登录请求     │
│  POST /auth/     │
│  member/login/   │
│                  │
│  请求头:         │
│  X-Tenant-ID: 1  │
│                  │
│  请求体:         │
│  { username,     │
│    password }    │
└────────┬─────────┘
         │
         ▼
    ┌────┴────┐
    │ 是否成功│
    └────┬────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│ 成功   │ │ 失败   │
└───┬────┘ └───┬────┘
    │          │
    ▼          ▼
┌────────┐ ┌────────┐
│ 保存   │ │ 显示   │
│ Token  │ │ 错误   │
│ 和     │ │        │
│ 租户ID │ │        │
└───┬────┘ └────────┘
    │
    ▼
┌──────────────────┐
│  配置HTTP客户端  │
│  添加拦截器/中间件│
│  自动添加认证头   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  获取用户信息     │
│  GET /members/me/│
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  进入主界面       │
└──────────────────┘
```

### 登录接口详情

**接口**: `POST /api/v1/auth/member/login/`

**请求头**:
```
X-Tenant-ID: 1
Content-Type: application/json
```

**请求体**:
```json
{
  "username": "your_username",
  "password": "your_password"
}
```

**成功响应 (200)**:
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 10,
    "username": "john_doe",
    "email": "john@example.com"
  }
}
```

**需要保存的数据**:
- `access`: 访问Token（用于后续所有请求）
- `refresh`: 刷新Token（用于获取新的access token）
- `user.id`: 用户ID
- 租户ID（从配置或登录时传入的）

---

## HTTP请求配置

### 所有API请求的通用要求

**请求头**（必须包含）:
```
Authorization: Bearer <access_token>
X-Tenant-ID: <tenant_id>
Content-Type: application/json  # POST/PUT请求
```

### HTTP客户端配置流程

```
┌──────────────────┐
│  创建HTTP客户端  │
│  (URLSession/    │
│   OkHttp/Axios)  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  设置Base URL    │
│  设置超时时间     │
│  (建议10秒)      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  添加请求拦截器   │
│  或中间件         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  自动添加:       │
│  - Authorization │
│  - X-Tenant-ID   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  添加响应拦截器   │
│  处理401错误     │
│  (Token过期)     │
└──────────────────┘
```

### 请求拦截器逻辑

```
对于每个请求:
1. 从本地存储获取access_token
2. 从本地存储获取tenant_id
3. 添加到请求头:
   Authorization: Bearer <access_token>
   X-Tenant-ID: <tenant_id>
4. 发送请求
```

### 响应拦截器逻辑

```
对于每个响应:
1. 检查HTTP状态码
2. 如果是401:
   - 清除本地Token
   - 跳转到登录页
3. 如果是其他错误:
   - 解析错误信息
   - 显示给用户
4. 如果成功:
   - 返回数据
```

---

## 核心集成流程

### 用户资料页面集成

```
┌──────────────────┐
│  页面初始化       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  调用用户信息API │
│  GET /members/   │
│  me/             │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  显示用户数据     │
│  - 头像          │
│  - 昵称          │
│  - 邮箱          │
│  - 手机号        │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  调用关注统计API │
│  GET /follows/   │
│  stats/          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  显示统计数据     │
│  - 关注数        │
│  - 粉丝数        │
│  - 好友数        │
└────────┬─────────┘
         │
    ┌────┴────┐
    │  用户操作│
    └────┬────┘
         │
    ┌────┴─────┬─────┐
    │          │     │
    ▼          ▼     ▼
┌────────┐ ┌────────┐ ┌────────┐
│ 编辑   │ │ 修改   │ │ 上传   │
│ 资料   │ │ 密码   │ │ 头像   │
└───┬────┘ └───┬────┘ └───┬────┘
    │          │          │
    ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐
│ PUT    │ │ POST   │ │ POST   │
│ /me/   │ │ /me/   │ │ /avatar│
│        │ │password│ │ /upload│
└───┬────┘ └───┬────┘ └───┬────┘
    │          │          │
    └────┬─────┴──────────┘
         │
         ▼
┌──────────────────┐
│  刷新用户信息     │
└──────────────────┘
```

### 社交互动功能集成

```
┌──────────────────┐
│  显示用户卡片     │
│  (列表/详情)     │
└────────┬─────────┘
         │
    ┌────┴────────────────┐
    │  并行调用检查API     │
    └────┬────────────────┘
         │
    ┌────┴─────┐
    │          │
    ▼          ▼
┌────────┐ ┌────────┐
│ 检查   │ │ 检查   │
│ 点赞   │ │ 关注   │
└───┬────┘ └───┬────┘
    │          │
    └────┬─────┘
         │
         ▼
┌──────────────────┐
│  根据状态显示     │
│  按钮样式         │
│  - 点赞: 高亮/普通│
│  - 关注: 已关注/  │
│    互关/未关注    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  用户点击按钮     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  立即更新UI      │
│  (乐观更新)      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  调用API         │
│  (create/delete) │
└────────┬─────────┘
         │
    ┌────┴────┐
    │ 是否成功│
    └────┬────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│ 成功   │ │ 失败   │
│ 保持UI │ │ 回滚UI │
└────────┘ └───┬────┘
               │
               ▼
          ┌────────┐
          │ 显示   │
          │ 错误   │
          └────────┘
```

---

## 平台特定说明

### iOS (SwiftUI/UIKit)

#### HTTP请求
- 使用`URLSession`或`Alamofire`
- 创建`NetworkService`类封装请求
- 实现`RequestInterceptor`自动添加认证头

#### Token存储
```
使用Keychain存储Token（安全）:
- access_token → Keychain
- refresh_token → Keychain
- tenant_id → UserDefaults
```

#### 数据解析
```
使用Codable协议:
1. 定义响应模型（struct）
2. 使用JSONDecoder解析
3. 处理可选值和默认值
```

#### 图片加载
```
头像URL处理:
1. 拼接完整URL: baseURL + relativePath
2. 使用SDWebImage或Kingfisher加载
3. 显示占位图
```

---

### Android (Kotlin)

#### HTTP请求
- 使用`Retrofit` + `OkHttp`
- 创建API接口定义
- 实现`Interceptor`添加认证头

#### Token存储
```
使用EncryptedSharedPreferences存储:
- access_token → EncryptedSharedPreferences
- refresh_token → EncryptedSharedPreferences
- tenant_id → SharedPreferences
```

#### 数据解析
```
使用Gson或Moshi:
1. 定义数据类(data class)
2. 自动解析JSON响应
3. 处理null值
```

#### 图片加载
```
头像URL处理:
1. 拼接完整URL
2. 使用Glide或Coil加载
3. 设置占位图和错误图
```

---

### Web (Vue/React/Angular)

#### HTTP请求
- 使用`axios`或`fetch`
- 创建API服务模块
- 使用axios拦截器自动添加认证头

#### Token存储
```
使用localStorage或sessionStorage:
- access_token → localStorage
- refresh_token → localStorage
- tenant_id → localStorage
```

#### 数据解析
```
TypeScript类型定义:
1. 定义接口(interface)
2. 类型检查和自动补全
3. 处理可选属性
```

#### 图片加载
```
头像URL处理:
1. 拼接完整URL
2. 使用<img>标签显示
3. 添加懒加载
```

---

## 核心集成流程

### 流程1: 用户登录和信息获取

```
开始
  ↓
显示登录页面
  ↓
用户输入用户名和密码
  ↓
调用登录API
  ↓
是否成功? → 否 → 显示错误 → 返回登录页面
  ↓ 是
保存Token和租户ID到本地
  ↓
配置HTTP客户端（添加认证头）
  ↓
调用获取用户信息API
  ↓
显示用户信息
  ↓
进入主界面
```

### 流程2: 点赞/关注功能实现

```
显示用户卡片
  ↓
调用check接口检查状态
  ↓
根据状态显示按钮样式
  ↓
用户点击按钮
  ↓
立即更新UI状态(乐观更新)
  ↓
调用create或delete接口
  ↓
是否成功? → 否 → 回滚UI状态 + 显示错误
  ↓ 是
保持UI状态
  ↓
可选：更新缓存
```

### 流程3: 分页列表加载

```
初始化
  ↓
page = 1
  ↓
调用列表API (page=1)
  ↓
显示第一页数据
  ↓
用户滚动到底部
  ↓
是否有下一页? → 否 → 显示"没有更多"
  ↓ 是
page = page + 1
  ↓
调用列表API (page=page)
  ↓
追加数据到列表
  ↓
返回"用户滚动到底部"
```

---

## 最佳实践

### 1. Token管理

**存储位置**:
- iOS: Keychain（推荐）
- Android: EncryptedSharedPreferences（推荐）
- Web: localStorage（注意XSS防护）

**Token刷新**:
```
当收到401错误时:
1. 检查是否有refresh_token
2. 如果有，调用refresh接口获取新token
3. 如果没有或refresh失败，跳转登录页
```

### 2. 请求重试策略

**建议策略**:
- 网络错误：重试3次
- 5xx服务器错误：重试1次
- 4xx客户端错误：不重试
- Token过期（401）：尝试刷新Token

### 3. 错误处理

**统一错误处理**:

```
收到错误响应 →
  检查状态码 →
    400: 显示具体字段错误
    401: 清除Token，跳转登录
    403: 显示权限不足
    404: 显示资源不存在
    500: 显示服务器错误
```

**错误信息显示**:
- 字段级错误：显示在对应输入框下方
- 通用错误：使用Toast/Alert显示
- 网络错误：显示重试按钮

### 4. 缓存策略

**建议缓存时长**:

| 数据类型 | 缓存时长 | 刷新时机 |
|---------|---------|---------|
| 用户信息 | 5-10分钟 | 用户主动刷新或修改后 |
| 点赞状态 | 1-3分钟 | 执行点赞操作后 |
| 关注状态 | 1-3分钟 | 执行关注操作后 |
| 收藏状态 | 1-3分钟 | 执行收藏操作后 |
| 统计数据 | 5分钟 | 用户主动刷新 |
| 列表数据 | 不缓存 | 每次重新请求 |

### 5. 乐观更新

**适用场景**:
- ✅ 点赞/取消点赞
- ✅ 关注/取消关注
- ✅ 收藏/取消收藏

**实现步骤**:
1. 用户点击按钮
2. **立即**更新UI状态（按钮变色/文字改变）
3. 发送API请求
4. 如果成功：保持UI状态
5. 如果失败：**回滚**UI状态 + 显示错误

**优点**:
- 即时响应，用户体验好
- 减少等待时间
- 看起来更流畅

**注意**:
- 必须实现失败回滚
- 显示加载状态（防止重复点击）

### 6. 图片处理

**头像URL拼接**:
```
后端返回: /media/avatars/xxx.jpg
完整URL: https://api.your-domain.com/media/avatars/xxx.jpg

拼接方法:
if (avatar.startsWith("http")) {
    使用原始URL
} else if (avatar不为空) {
    完整URL = BASE_URL + avatar
} else {
    使用默认头像
}
```

**上传前处理**:
```
1. 检查文件类型（jpg/png/gif等）
2. 检查文件大小（< 2MB）
3. 建议：压缩图片（前端压缩或服务端压缩）
4. 使用FormData上传
```

---

## API调用示例（伪代码）

### 示例1: 获取用户信息

```
// 请求
GET /api/v1/members/me/
Headers:
  Authorization: Bearer eyJ0eXAiOiJKV1Qi...
  X-Tenant-ID: 1

// 响应处理
if (statusCode == 200) {
    user = parseJSON(response)
    显示用户信息
} else if (statusCode == 401) {
    跳转登录页
} else {
    显示错误提示
}
```

### 示例2: 点赞用户

```
// 1. 检查状态
GET /api/v1/interactions/likes/check/8/
Headers: 同上

响应: { is_liked: false, ... }

// 2. 显示按钮
显示"点赞"按钮（未高亮状态）

// 3. 用户点击
用户点击按钮

// 4. 乐观更新
立即更新按钮为"已点赞"（高亮）

// 5. 发送请求
POST /api/v1/interactions/likes/
Headers: 同上
Body: { "to_member": 8 }

// 6. 处理响应
if (成功) {
    保持UI状态
} else {
    回滚为"点赞"（未高亮）
    显示错误提示
}
```

### 示例3: 上传头像

```
// 1. 用户选择图片
用户从相册/文件选择器选择图片

// 2. 验证
if (文件大小 > 2MB) {
    提示"文件过大"
    return
}
if (文件类型不在允许列表) {
    提示"格式不支持"
    return
}

// 3. 构建FormData
formData = new FormData()
formData.append("avatar", 图片文件)

// 4. 发送请求
POST /api/v1/members/avatar/upload/
Headers:
  Authorization: Bearer eyJ0eXAiOiJKV1Qi...
  X-Tenant-ID: 1
  Content-Type: multipart/form-data
Body: formData

// 5. 处理响应
if (成功) {
    newAvatarURL = BASE_URL + response.avatar
    更新头像显示
    提示"上传成功"
} else {
    显示错误信息
}
```

---

## 数据同步建议

### 本地状态维护

**建议维护的本地状态**:

```
用户相关:
- currentUser: 当前用户信息
- isLoggedIn: 是否登录

互动状态集合:
- likedMemberIds: Set<Integer> // 已点赞的用户ID集合
- followedMemberIds: Set<Integer> // 已关注的用户ID集合
- favoritedArticleIds: Set<Integer> // 已收藏的文章ID集合

统计数据:
- followStats: { following, followers, mutual }
```

**状态更新时机**:

```
登录时:
  清空所有状态

执行点赞操作后:
  if (点赞成功) {
    likedMemberIds.add(memberId)
  } else if (取消点赞成功) {
    likedMemberIds.remove(memberId)
  }

执行关注操作后:
  if (关注成功) {
    followedMemberIds.add(memberId)
    followStats.following_count += 1
  } else if (取消关注成功) {
    followedMemberIds.remove(memberId)
    followStats.following_count -= 1
  }
```

---

## 测试建议

### 使用Postman/Insomnia测试

#### 1. 设置环境变量
```
base_url = https://api.your-domain.com
tenant_id = 1
access_token = (登录后获取)
```

#### 2. 创建请求集合
- 登录
- 获取用户信息
- 点赞相关（6个接口）
- 关注相关（8个接口）
- 收藏相关（5个接口）

#### 3. 测试流程
1. 执行登录请求 → 获取Token
2. 测试各个接口 → 验证功能
3. 测试错误场景 → 验证错误处理

### 使用cURL测试

```bash
# 1. 登录
curl -X POST "https://api.your-domain.com/api/v1/auth/member/login/" \
  -H "X-Tenant-ID: 1" \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'

# 保存返回的token

# 2. 获取用户信息
curl -X GET "https://api.your-domain.com/api/v1/members/me/" \
  -H "Authorization: Bearer <token>" \
  -H "X-Tenant-ID: 1"

# 3. 点赞用户ID为2的用户
curl -X POST "https://api.your-domain.com/api/v1/interactions/likes/" \
  -H "Authorization: Bearer <token>" \
  -H "X-Tenant-ID: 1" \
  -H "Content-Type: application/json" \
  -d '{"to_member":2}'

# 4. 检查点赞状态
curl -X GET "https://api.your-domain.com/api/v1/interactions/likes/check/2/" \
  -H "Authorization: Bearer <token>" \
  -H "X-Tenant-ID: 1"
```

---

## 常见问题

### Q1: 如何处理Token过期？
**A**: 监听401响应码，清除本地Token，跳转登录页。可选：使用refresh_token刷新。

### Q2: 租户ID从哪里获取？
**A**: 通常在登录时由后端返回，或者由运营团队提供。保存到本地配置中。

### Q3: 头像URL如何处理？
**A**: 后端返回相对路径，需要拼接完整URL才能显示。

### Q4: 如何知道两个用户是否互相关注？
**A**: 查看关注记录中的`is_mutual`字段，为true表示互相关注。

### Q5: 是否需要实现离线缓存？
**A**: 建议实现基础缓存（用户信息、状态检查结果），但不建议离线缓存互动操作。

### Q6: 如何处理网络错误？
**A**: 
- 显示友好的错误提示
- 提供重试按钮
- 检查网络状态
- 考虑离线模式

### Q7: 子账号有什么限制？
**A**: 
- 不能登录
- 不能上传头像
- 不能创建子账号
- 其他功能与主账号相同

### Q8: 如何显示加载状态？
**A**: 
- 按钮：禁用 + 显示加载图标
- 列表：显示骨架屏或loading
- 全局：显示顶部进度条

---

## 调试技巧

### 1. 日志记录

**建议记录的信息**:
```
API请求日志:
- 时间戳
- 请求方法
- 请求URL
- 请求参数（不包含敏感信息）

API响应日志:
- 时间戳
- 状态码
- 响应时间
- 错误信息（如果有）
```

**不要记录**:
- ❌ Token
- ❌ 密码
- ❌ 其他敏感信息

### 2. 网络监控

**建议监控**:
- API调用成功率
- 平均响应时间
- 错误分布（按状态码）

**工具推荐**:
- iOS: Network Link Conditioner
- Android: Charles Proxy
- Web: Browser DevTools

### 3. 状态检查

**验证检查点**:
```
发送请求前:
- Token是否存在？
- 租户ID是否设置？
- 请求参数是否完整？

收到响应后:
- 状态码是什么？
- 响应数据格式是否正确？
- 是否需要更新本地状态？
```

---

## 性能优化

### 1. 减少API调用

**策略**:
- ✅ 缓存频繁访问的数据
- ✅ 使用check接口而不是获取完整列表
- ✅ 合并相似的请求
- ✅ 实现请求去重

### 2. 优化用户体验

**策略**:
- ✅ 乐观更新（立即UI反馈）
- ✅ 骨架屏（加载时显示）
- ✅ 懒加载（按需加载）
- ✅ 预加载（提前加载可能需要的数据）

### 3. 图片优化

**策略**:
- ✅ 使用缩略图（列表页）
- ✅ 懒加载图片
- ✅ 图片压缩
- ✅ CDN加速

---

## 安全建议

### 1. Token安全
- ✅ 使用安全存储（Keychain/EncryptedSharedPreferences）
- ❌ 不在URL参数中传递Token
- ❌ 不在日志中输出Token
- ✅ Token过期后立即清除

### 2. 输入验证
- ✅ 前端验证所有用户输入
- ✅ 文件上传前检查类型和大小
- ✅ 防止注入攻击

### 3. HTTPS
- ✅ 生产环境必须使用HTTPS
- ✅ 验证SSL证书
- ❌ 不允许HTTP降级

---

## 更新日志

| 版本 | 日期 | 说明 |
|------|------|------|
| 2.0 | 2025-10-31 | 重写为通用集成指南，移除特定框架代码 |
| 1.0 | 2025-10-31 | 初始版本 |

---

**技术支持**: 如有问题，请联系后端团队。

