# APIè°ƒç”¨500é”™è¯¯æ’æŸ¥æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025-11-03  
> **é—®é¢˜**: è°ƒç”¨/api/v1/cms/categories/è¿”å›500é”™è¯¯

---

## ğŸ” é—®é¢˜åˆ†æ

### ä½ çš„åŸå§‹è¯·æ±‚

```bash
curl 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'Accept: application/json, text/plain, */*' \
  -H 'Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7' \
  -H 'Authorization: Bearer eyJ...'
  # ... å…¶ä»–headers
```

### âš ï¸ é‡è¦å‘ç°

**å…³é”®ä¿¡æ¯**ï¼šä½ æ˜¯**ç§Ÿæˆ·ç®¡ç†å‘˜**ï¼ˆä»Tokenè§£æå¾—çŸ¥ï¼‰

**ä½ çš„Tokenä¿¡æ¯**ï¼š
- ç”¨æˆ·åï¼šadmin_cms
- è§’è‰²ï¼šç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆis_admin=True, is_super_admin=Falseï¼‰  
- å…³è”ç§Ÿæˆ·ï¼š**ç§Ÿæˆ·ID: 3**

### ç§Ÿæˆ·ç®¡ç†å‘˜çš„ç‰¹æ®Šè§„åˆ™

æ ¹æ®ä»£ç è®¾è®¡ï¼Œ**ç§Ÿæˆ·ç®¡ç†å‘˜æœ‰ç‰¹æ®Šçš„ç§Ÿæˆ·è·å–é€»è¾‘**ï¼š

1. âŒ **ç¦æ­¢**ä½¿ç”¨`X-Tenant-ID`è¯·æ±‚å¤´
2. âœ… **è‡ªåŠ¨**ä½¿ç”¨`user.tenant`çš„ç§Ÿæˆ·IDï¼ˆä½ çš„æƒ…å†µæ˜¯ç§Ÿæˆ·3ï¼‰
3. âœ… **å¯é€‰**ä½¿ç”¨æŸ¥è¯¢å‚æ•°`?tenant_id=3`ï¼ˆä½†åªèƒ½è®¿é—®è‡ªå·±çš„ç§Ÿæˆ·ï¼‰

### ä¸ºä»€ä¹ˆæŠ¥é”™ï¼Ÿ

**å¯èƒ½åŸå› 1**ï¼šä½ æƒ³è®¿é—®ç§Ÿæˆ·1çš„æ•°æ®ï¼Œä½†ä½ å±äºç§Ÿæˆ·3
- ä½œä¸ºç§Ÿæˆ·ç®¡ç†å‘˜ï¼Œä½ åªèƒ½è®¿é—®ç§Ÿæˆ·3çš„æ•°æ®
- è®¿é—®å…¶ä»–ç§Ÿæˆ·ä¼šè¢«æ‹’ç»ï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰

**å¯èƒ½åŸå› 2**ï¼šä»£ç é…ç½®é—®é¢˜
- CategoryViewSetçš„search_fieldså’Œorderingé…ç½®é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰
- åºåˆ—åŒ–å™¨è¾“å‡ºæ ¼å¼é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

---

## âœ… è§£å†³æ–¹æ¡ˆ

### é’ˆå¯¹ç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆä½ çš„æƒ…å†µï¼‰

#### æ–¹æ¡ˆ1ï¼šè®¿é—®è‡ªå·±çš„ç§Ÿæˆ·æ•°æ®ï¼ˆæ¨èï¼‰

```bash
# ä¸éœ€è¦ä»»ä½•ç§Ÿæˆ·å‚æ•°ï¼Œè‡ªåŠ¨ä½¿ç”¨ç§Ÿæˆ·ID: 3
curl 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

#### æ–¹æ¡ˆ2ï¼šä½¿ç”¨æŸ¥è¯¢å‚æ•°æ˜ç¡®æŒ‡å®š

```bash
# æ˜ç¡®æŒ‡å®šç§Ÿæˆ·3
curl 'http://localhost:8000/api/v1/cms/categories/?tenant_id=3' \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

#### âŒ é”™è¯¯æ–¹å¼

```bash
# ç§Ÿæˆ·ç®¡ç†å‘˜ç¦æ­¢ä½¿ç”¨X-Tenant-IDå¤´ï¼
curl 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \  # âŒ ä¼šè¢«æ‹’ç»ï¼
  -H 'Authorization: Bearer YOUR_TOKEN'
```

### é’ˆå¯¹Memberç”¨æˆ·æˆ–åŒ¿åç”¨æˆ·

#### æ–¹æ¡ˆï¼šå¿…é¡»ä½¿ç”¨X-Tenant-IDå¤´

```bash
curl 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \  # âœ… Memberç”¨æˆ·å¿…é¡»æä¾›
  -H 'Authorization: Bearer YOUR_TOKEN'  # Memberç”¨æˆ·å¯é€‰
```

### é’ˆå¯¹è¶…çº§ç®¡ç†å‘˜

#### æ–¹æ¡ˆ1ï¼šè®¿é—®ç‰¹å®šç§Ÿæˆ·

```bash
curl 'http://localhost:8000/api/v1/cms/categories/?tenant_id=1' \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

#### æ–¹æ¡ˆ2ï¼šè®¿é—®æ‰€æœ‰ç§Ÿæˆ·æ•°æ®

```bash
# ä¸å¸¦ä»»ä½•å‚æ•°ï¼Œè¿”å›æ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®
curl 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

---

## å‰ç«¯ä»£ç é…ç½®

### é’ˆå¯¹ä¸åŒç”¨æˆ·ç±»å‹çš„é…ç½®

#### é…ç½®1ï¼šMemberç”¨æˆ·å‰ç«¯ï¼ˆéœ€è¦X-Tenant-IDï¼‰

#### Axiosé…ç½®

```javascript
// å…¨å±€é…ç½®
axios.defaults.headers.common['X-Tenant-ID'] = '1';

// æˆ–åœ¨è¯·æ±‚æ‹¦æˆªå™¨ä¸­æ·»åŠ 
axios.interceptors.request.use(config => {
  config.headers['X-Tenant-ID'] = localStorage.getItem('tenantId') || '1';
  return config;
});
```

#### Fetché…ç½®

```javascript
const fetchCategories = async () => {
  const response = await fetch('http://localhost:8000/api/v1/cms/categories/', {
    headers: {
      'X-Tenant-ID': '1',  // ğŸ†• å¿…é¡»æ·»åŠ 
      'Accept-Language': 'en',
      'Authorization': 'Bearer ' + token
    }
  });
  return response.json();
};
```

---

## ğŸ”§ å·²ä¿®å¤çš„ä»£ç é—®é¢˜

åœ¨æ’æŸ¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°å¹¶ä¿®å¤äº†ä»¥ä¸‹ä»£ç é—®é¢˜ï¼š

### 1. CategoryViewSeté…ç½®é”™è¯¯

**é—®é¢˜**ï¼š`search_fields`å’Œ`ordering`å¼•ç”¨äº†ç¿»è¯‘å­—æ®µ`name`

**ä¿®å¤å‰**ï¼š
```python
search_fields = ['name', 'slug', 'description']  # âŒ nameå’Œdescriptionæ˜¯ç¿»è¯‘å­—æ®µ
ordering = ['-is_pinned', 'sort_order', 'name']  # âŒ nameä¸èƒ½ç›´æ¥æ’åº
```

**ä¿®å¤å**ï¼š
```python
search_fields = ['translations__name', 'slug', 'translations__description']  # âœ…
ordering = ['-is_pinned', 'sort_order', 'id']  # âœ… ä½¿ç”¨idæ›¿ä»£name
```

### 2. CategorySerializerè¾“å‡ºæ ¼å¼

**é—®é¢˜**ï¼š`name`ç­‰å­—æ®µè¿”å›å­—å…¸è€Œä¸æ˜¯å­—ç¬¦ä¸²

**ä¿®å¤å‰**ï¼š
```json
{
  "name": {"zh-hans": "æŠ€æœ¯"},  // âŒ åº”è¯¥æ˜¯å­—ç¬¦ä¸²
  "description": {"zh-hans": "..."}  // âŒ åº”è¯¥æ˜¯å­—ç¬¦ä¸²
}
```

**ä¿®å¤å**ï¼š
```json
{
  "name": "æŠ€æœ¯",  // âœ… å­—ç¬¦ä¸²æ ¼å¼
  "description": "...",  // âœ… å­—ç¬¦ä¸²æ ¼å¼
  "translations": {  // âœ… å®Œæ•´ç¿»è¯‘å¯¹è±¡
    "zh-hans": {"name": "æŠ€æœ¯", "description": "..."},
    "en": {"name": "Technology", "description": "..."}
  }
}
```

---

## ğŸ“‹ å®Œæ•´çš„æ­£ç¡®è¯·æ±‚ç¤ºä¾‹

### cURLå‘½ä»¤

```bash
# è·å–ä¸­æ–‡åˆ†ç±»åˆ—è¡¨
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \
  -H 'Accept-Language: zh-hans'

# è·å–è‹±æ–‡åˆ†ç±»åˆ—è¡¨
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \
  -H 'Accept-Language: en'

# å¸¦è®¤è¯çš„è¯·æ±‚
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \
  -H 'Accept-Language: en' \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

### JavaScriptï¼ˆAxiosï¼‰

```javascript
// å…¨å±€é…ç½®ï¼ˆæ¨èï¼‰
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:8000/api/v1',
  headers: {
    'X-Tenant-ID': '1'  // ğŸ”‘ å…³é”®ï¼šå…¨å±€è®¾ç½®
  }
});

// æ·»åŠ è¯­è¨€æ‹¦æˆªå™¨
api.interceptors.request.use(config => {
  const lang = localStorage.getItem('language') || 'zh-hans';
  config.headers['Accept-Language'] = lang;
  return config;
});

// ä½¿ç”¨
const categories = await api.get('/cms/categories/');
```

### JavaScriptï¼ˆFetchï¼‰

```javascript
const fetchCategories = async (language = 'zh-hans') => {
  const response = await fetch('http://localhost:8000/api/v1/cms/categories/', {
    headers: {
      'X-Tenant-ID': '1',  // ğŸ”‘ å…³é”®ï¼šå¿…é¡»åŒ…å«
      'Accept-Language': language
    }
  });
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  
  return response.json();
};
```

---

## ğŸš¨ é”™è¯¯ä»£ç å¯¹ç…§è¡¨

| HTTPçŠ¶æ€ç  | é”™è¯¯ä»£ç  | æ¶ˆæ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----------|---------|------|------|---------|
| 400 | 4500 | æœªæä¾›ç§Ÿæˆ·ID | ç¼ºå°‘X-Tenant-IDå¤´ | æ·»åŠ X-Tenant-IDå¤´ |
| 403 | 4003 | æ— æ³•è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„èµ„æº | Tokençš„ç§Ÿæˆ·IDä¸X-Tenant-IDä¸åŒ¹é… | ä½¿ç”¨æ­£ç¡®çš„ç§Ÿæˆ·ID |
| 401 | 4001 | æœªè®¤è¯ | Tokenæ— æ•ˆæˆ–è¿‡æœŸ | é‡æ–°ç™»å½•è·å–Token |
| 500 | 5000 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | ä»£ç é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰ | ä½¿ç”¨æœ€æ–°ä»£ç  |

---

## âœ… éªŒè¯æ­¥éª¤

### æ­¥éª¤1ï¼šæµ‹è¯•åŸºæœ¬è¿æ¥

```bash
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1'
```

**é¢„æœŸç»“æœ**ï¼šè¿”å›200çŠ¶æ€ç å’Œåˆ†ç±»åˆ—è¡¨

### æ­¥éª¤2ï¼šæµ‹è¯•è¯­è¨€åˆ‡æ¢

```bash
# ä¸­æ–‡
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \
  -H 'Accept-Language: zh-hans'

# è‹±æ–‡
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \
  -H 'Accept-Language: en'
```

**é¢„æœŸç»“æœ**ï¼šnameå­—æ®µæ˜¾ç¤ºä¸åŒè¯­è¨€çš„å†…å®¹

### æ­¥éª¤3ï¼šæµ‹è¯•å¸¦è®¤è¯çš„è¯·æ±‚

```bash
curl -X GET 'http://localhost:8000/api/v1/cms/categories/' \
  -H 'X-Tenant-ID: 1' \
  -H 'Authorization: Bearer YOUR_TOKEN'
```

**é¢„æœŸç»“æœ**ï¼šè¿”å›200å’Œæ•°æ®

---

## ğŸ”‘ å‰ç«¯å¿…é¡»é…ç½®çš„Headers

### æ‰€æœ‰CMS APIè¯·æ±‚éƒ½å¿…é¡»åŒ…å«

| Header | è¯´æ˜ | ç¤ºä¾‹å€¼ | å¿…éœ€æ€§ |
|--------|------|--------|-------|
| `X-Tenant-ID` | ç§Ÿæˆ·ID | `1` | âœ… å¿…éœ€ |
| `Authorization` | JWT Token | `Bearer eyJ...` | âš ï¸ éƒ¨åˆ†æ¥å£éœ€è¦ |
| `Accept-Language` | è¯­è¨€åå¥½ | `zh-hans`ã€`en`ã€`zh-hant` | âŒ å¯é€‰ï¼Œé»˜è®¤zh-hans |
| `Content-Type` | å†…å®¹ç±»å‹ | `application/json` | âš ï¸ POST/PUT/PATCHéœ€è¦ |

### å“ªäº›æ¥å£éœ€è¦Authorizationï¼Ÿ

| æ“ä½œ | éœ€è¦Authorization | è¯´æ˜ |
|------|------------------|------|
| GETï¼ˆè¯»å–ï¼‰ | âŒ åŒ¿åå¯è®¿é—® | ä»…è¿”å›is_active=trueçš„åˆ†ç±» |
| POSTï¼ˆåˆ›å»ºï¼‰ | âœ… éœ€è¦ | éœ€è¦ç®¡ç†å‘˜æƒé™ |
| PUT/PATCHï¼ˆæ›´æ–°ï¼‰ | âœ… éœ€è¦ | éœ€è¦ç®¡ç†å‘˜æƒé™ |
| DELETEï¼ˆåˆ é™¤ï¼‰ | âœ… éœ€è¦ | éœ€è¦ç®¡ç†å‘˜æƒé™ |

---

## ğŸ’¡ å‰ç«¯é…ç½®æœ€ä½³å®è·µ

### æ¨èé…ç½®ï¼ˆAxiosï¼‰

```javascript
// api/index.js
import axios from 'axios';

// åˆ›å»ºå®ä¾‹
const api = axios.create({
  baseURL: process.env.VUE_APP_API_BASE_URL || 'http://localhost:8000/api/v1',
  timeout: 10000
});

// è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use(
  config => {
    // 1. æ·»åŠ ç§Ÿæˆ·IDï¼ˆå¿…éœ€ï¼‰
    const tenantId = localStorage.getItem('tenantId') || '1';
    config.headers['X-Tenant-ID'] = tenantId;
    
    // 2. æ·»åŠ Tokenï¼ˆå¦‚æœæœ‰ï¼‰
    const token = localStorage.getItem('token');
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`;
    }
    
    // 3. æ·»åŠ è¯­è¨€ï¼ˆå¯é€‰ï¼‰
    const language = localStorage.getItem('language') || 'zh-hans';
    config.headers['Accept-Language'] = language;
    
    return config;
  },
  error => Promise.reject(error)
);

// å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  response => response.data,  // ç›´æ¥è¿”å›dataéƒ¨åˆ†
  error => {
    if (error.response) {
      switch (error.response.status) {
        case 400:
          console.error('è¯·æ±‚å‚æ•°é”™è¯¯:', error.response.data);
          break;
        case 401:
          // Tokenè¿‡æœŸï¼Œè·³è½¬ç™»å½•
          localStorage.removeItem('token');
          window.location.href = '/login';
          break;
        case 403:
          console.error('æƒé™ä¸è¶³:', error.response.data);
          break;
        case 500:
          console.error('æœåŠ¡å™¨é”™è¯¯:', error.response.data);
          break;
      }
    }
    return Promise.reject(error);
  }
);

export default api;

// ä½¿ç”¨
import api from '@/api';
const categories = await api.get('/cms/categories/');
```

---

## ğŸ¯ æ€»ç»“

### ä¸»è¦é—®é¢˜

1. âŒ **ç¼ºå°‘X-Tenant-IDå¤´** - è¿™æ˜¯å¯¼è‡´é”™è¯¯çš„ä¸»è¦åŸå› 
2. âœ… **ä»£ç é—®é¢˜å·²ä¿®å¤** - search_fieldså’Œorderingé…ç½®

### è§£å†³æ–¹æ¡ˆ

1. âœ… **åœ¨æ‰€æœ‰CMS APIè¯·æ±‚ä¸­æ·»åŠ X-Tenant-IDå¤´**
2. âœ… **é…ç½®axios/fetchæ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ **
3. âœ… **å‚è€ƒå‰ç«¯é›†æˆæ–‡æ¡£è¿›è¡Œé…ç½®**

### ç›¸å…³æ–‡æ¡£

- [å‰ç«¯CMSé›†æˆå¿«é€ŸæŒ‡å—.md](./å‰ç«¯CMSé›†æˆå¿«é€ŸæŒ‡å—.md) - å®Œæ•´çš„å‰ç«¯é…ç½®æŒ‡å—
- [åˆ†ç±»ç®¡ç†API.md](./åˆ†ç±»ç®¡ç†API.md) - APIè¯¦ç»†è¯´æ˜
- [04_é€šç”¨é›†æˆæŒ‡å—.md](./04_é€šç”¨é›†æˆæŒ‡å—.md) - HTTPå®¢æˆ·ç«¯é…ç½®

---

**é—®é¢˜å·²è§£å†³ï¼è¯·æ·»åŠ X-Tenant-IDå¤´åé‡è¯•ã€‚** âœ…

