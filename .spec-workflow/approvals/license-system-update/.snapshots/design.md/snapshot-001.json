{
  "id": "snapshot_1758870885290_i4l3945th",
  "approvalId": "approval_1758870885285_iqzq1nrru",
  "approvalTitle": "è®¸å¯è¯ç³»ç»Ÿæ–¹æ¡ˆAé‡æ„æ›´æ–°è®¾è®¡æ–‡æ¡£",
  "version": 1,
  "timestamp": "2025-09-26T07:14:45.290Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# è®¸å¯è¯ç³»ç»Ÿæ–¹æ¡ˆAé‡æ„æ›´æ–° - è®¾è®¡æ–‡æ¡£\n\n## ğŸ“‹ è®¾è®¡æ¦‚è¿°\n\n### æ¶æ„è®¾è®¡ç†å¿µ\nåŸºäºç°æœ‰çš„å¤šç§Ÿæˆ·Djangoæ¶æ„ï¼Œé‡‡ç”¨åˆ†å±‚è®¾è®¡æ¨¡å¼å®ç°è®¸å¯è¯ç³»ç»Ÿçš„æ¸è¿›å¼é‡æ„ã€‚è®¾è®¡éµå¾ªSOLIDåŸåˆ™ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå‘åå…¼å®¹æ€§ã€‚\n\n### æ ¸å¿ƒè®¾è®¡ç›®æ ‡\n- **è¯­ä¹‰æ˜ç¡®æ€§**: é€šè¿‡å­—æ®µé‡å‘½åæ˜ç¡®åŒºåˆ†æ¨¡æ¿é…ç½®ä¸å®é™…ä½¿ç”¨å€¼\n- **è·¨å¹³å°å…¼å®¹**: å®ç°macOSï¼ˆIntel + Apple Siliconï¼‰å®Œæ•´æ”¯æŒ\n- **å®‰å…¨å¢å¼º**: å¼ºåŒ–RSAç­¾åéªŒè¯å’Œå¼‚å¸¸æ£€æµ‹æœºåˆ¶\n- **ç”¨æˆ·ä½“éªŒ**: ä¿è¯å‰ç«¯ç•Œé¢çš„æµç•…æ€§å’Œä¸€è‡´æ€§\n\n## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡\n\n### æ•´ä½“æ¶æ„å›¾\n```mermaid\ngraph TB\n    subgraph \"å‰ç«¯å±‚\"\n        A[Vue.jsç®¡ç†ç•Œé¢] --> B[TypeScriptç±»å‹å±‚]\n        B --> C[APIè°ƒç”¨å±‚]\n    end\n    \n    subgraph \"APIç½‘å…³å±‚\"\n        D[Django REST Framework] --> E[è®¤è¯ä¸­é—´ä»¶]\n        E --> F[æƒé™æ§åˆ¶ä¸­é—´ä»¶]\n        F --> G[APIç‰ˆæœ¬æ§åˆ¶]\n    end\n    \n    subgraph \"ä¸šåŠ¡æœåŠ¡å±‚\"\n        H[LicensePlanæœåŠ¡] --> I[è®¸å¯è¯æ¿€æ´»æœåŠ¡]\n        I --> J[ç¡¬ä»¶æŒ‡çº¹æœåŠ¡]\n        J --> K[å®‰å…¨éªŒè¯æœåŠ¡]\n    end\n    \n    subgraph \"æ•°æ®è®¿é—®å±‚\"\n        L[Django ORM] --> M[æ•°æ®åº“è¿ç§»å±‚]\n        M --> N[ç¼“å­˜å±‚ Redis]\n    end\n    \n    subgraph \"æ•°æ®å­˜å‚¨å±‚\"\n        O[(MySQLæ•°æ®åº“)] --> P[å¤‡ä»½ä¸æ¢å¤]\n    end\n    \n    C --> D\n    G --> H\n    K --> L\n    N --> O\n```\n\n### æ¨¡å—ä¾èµ–å…³ç³»\n```mermaid\ngraph LR\n    subgraph \"æ ¸å¿ƒæ¨¡å—\"\n        A[licenses.models] --> B[licenses.serializers]\n        B --> C[licenses.views]\n        C --> D[licenses.services]\n    end\n    \n    subgraph \"æ”¯æŒæ¨¡å—\"\n        E[licenses.utils] --> F[licenses.middleware]\n        F --> G[licenses.validators]\n    end\n    \n    subgraph \"é›†æˆæ¨¡å—\"\n        H[authentication] --> I[permissions]\n        I --> J[multi_tenant]\n    end\n    \n    D --> E\n    C --> H\n```\n\n## ğŸ”„ æ•°æ®æ¨¡å‹è®¾è®¡\n\n### LicensePlanæ¨¡å‹é‡æ„\n```python\nclass LicensePlan(BaseModel):\n    \"\"\"è®¸å¯è¯æ–¹æ¡ˆæ¨¡å‹ - é‡æ„å\"\"\"\n    \n    # åŸºç¡€ä¿¡æ¯ï¼ˆæ— å˜æ›´ï¼‰\n    name = models.CharField(max_length=100, verbose_name=\"æ–¹æ¡ˆåç§°\")\n    code = models.CharField(max_length=50, unique=True, verbose_name=\"æ–¹æ¡ˆä»£ç \")\n    plan_type = models.CharField(max_length=20, choices=PLAN_TYPE_CHOICES)\n    \n    # é‡æ„å­—æ®µï¼ˆè¯­ä¹‰åŒ–å‘½åï¼‰\n    default_max_activations = models.PositiveIntegerField(\n        verbose_name=\"é»˜è®¤æœ€å¤§æ¿€æ´»æ•°\",\n        help_text=\"è¯¥æ–¹æ¡ˆçš„æ¨¡æ¿é»˜è®¤æœ€å¤§æ¿€æ´»è®¾å¤‡æ•°\"\n    )\n    default_validity_days = models.PositiveIntegerField(\n        verbose_name=\"é»˜è®¤æœ‰æ•ˆå¤©æ•°\", \n        help_text=\"è¯¥æ–¹æ¡ˆçš„æ¨¡æ¿é»˜è®¤æœ‰æ•ˆæœŸå¤©æ•°\"\n    )\n    \n    # å…¶ä»–å­—æ®µä¿æŒä¸å˜\n    features = models.JSONField(default=dict, verbose_name=\"åŠŸèƒ½é…ç½®\")\n    price = models.DecimalField(max_digits=10, decimal_places=2)\n    currency = models.CharField(max_length=3, default='CNY')\n    status = models.CharField(max_length=20, default='active')\n    \n    class Meta:\n        db_table = 'licenses_license_plan'\n        verbose_name = \"è®¸å¯è¯æ–¹æ¡ˆ\"\n        verbose_name_plural = \"è®¸å¯è¯æ–¹æ¡ˆ\"\n```\n\n### Licenseæ¨¡å‹ï¼ˆä¿æŒä¸å˜ï¼‰\n```python\nclass License(BaseModel):\n    \"\"\"è®¸å¯è¯æ¨¡å‹ - å®é™…ä½¿ç”¨å€¼ï¼Œæ— éœ€å˜æ›´\"\"\"\n    \n    license_key = models.CharField(max_length=255, unique=True)\n    plan = models.ForeignKey(LicensePlan, on_delete=models.PROTECT)\n    \n    # å®é™…ä½¿ç”¨å­—æ®µï¼ˆæ— å˜æ›´ï¼‰\n    max_activations = models.PositiveIntegerField(\n        verbose_name=\"å®é™…æœ€å¤§æ¿€æ´»æ•°\"\n    )\n    expires_at = models.DateTimeField(verbose_name=\"å®é™…è¿‡æœŸæ—¶é—´\")\n    \n    # å…¶ä»–å­—æ®µä¿æŒä¸å˜\n    issued_to = models.CharField(max_length=200)\n    customer_email = models.EmailField()\n    status = models.CharField(max_length=20, default='active')\n```\n\n### æ•°æ®åº“è¿ç§»è®¾è®¡\n```python\n# 0004_rename_licenseplan_fields.py\nfrom django.db import migrations\n\nclass Migration(migrations.Migration):\n    dependencies = [\n        ('licenses', '0003_previous_migration'),\n    ]\n    \n    operations = [\n        migrations.RenameField(\n            model_name='licenseplan',\n            old_name='max_machines',\n            new_name='default_max_activations',\n        ),\n        migrations.RenameField(\n            model_name='licenseplan',\n            old_name='validity_days',\n            new_name='default_validity_days',\n        ),\n    ]\n```\n\n## ğŸ”Œ APIè®¾è®¡\n\n### APIåºåˆ—åŒ–å™¨é‡æ„\n```python\nclass LicensePlanSerializer(serializers.ModelSerializer):\n    \"\"\"LicensePlanåºåˆ—åŒ–å™¨ - æ”¯æŒæ–°æ—§å­—æ®µåå…¼å®¹\"\"\"\n    \n    # æ–°å­—æ®µåï¼ˆä¸»è¦ä½¿ç”¨ï¼‰\n    default_max_activations = serializers.IntegerField()\n    default_validity_days = serializers.IntegerField()\n    \n    # å‘åå…¼å®¹å­—æ®µï¼ˆåªè¯»ï¼Œç”¨äºè¿‡æ¸¡æœŸï¼‰\n    max_machines = serializers.IntegerField(\n        source='default_max_activations', \n        read_only=True\n    )\n    validity_days = serializers.IntegerField(\n        source='default_validity_days',\n        read_only=True  \n    )\n    \n    class Meta:\n        model = LicensePlan\n        fields = [\n            'id', 'name', 'code', 'plan_type',\n            'default_max_activations', 'default_validity_days',\n            'max_machines', 'validity_days',  # å…¼å®¹å­—æ®µ\n            'features', 'price', 'currency', 'status',\n            'created_at', 'updated_at'\n        ]\n    \n    def to_representation(self, instance):\n        \"\"\"è‡ªå®šä¹‰å“åº”æ ¼å¼ï¼Œæ ¹æ®APIç‰ˆæœ¬è¿”å›å¯¹åº”å­—æ®µ\"\"\"\n        data = super().to_representation(instance)\n        \n        # æ£€æŸ¥è¯·æ±‚ç‰ˆæœ¬ï¼Œå†³å®šæ˜¯å¦åŒ…å«å…¼å®¹å­—æ®µ\n        request = self.context.get('request')\n        if request and hasattr(request, 'version'):\n            if request.version == 'v1':\n                # v1ç‰ˆæœ¬ä¿ç•™æ—§å­—æ®µå\n                data['max_machines'] = data['default_max_activations']\n                data['validity_days'] = data['default_validity_days']\n            elif request.version == 'v2':\n                # v2ç‰ˆæœ¬ç§»é™¤æ—§å­—æ®µå\n                data.pop('max_machines', None)\n                data.pop('validity_days', None)\n        \n        return data\n```\n\n### APIç«¯ç‚¹è®¾è®¡\n```python\n# licenses/views/license_plan_views.py\nclass LicensePlanViewSet(viewsets.ModelViewSet):\n    \"\"\"è®¸å¯è¯æ–¹æ¡ˆAPIè§†å›¾é›†\"\"\"\n    \n    serializer_class = LicensePlanSerializer\n    permission_classes = [IsAuthenticated, HasLicenseManagePermission]\n    filterset_class = LicensePlanFilter\n    ordering_fields = ['name', 'created_at', 'default_max_activations']\n    \n    def get_queryset(self):\n        \"\"\"æ ¹æ®ç§Ÿæˆ·è¿‡æ»¤æ•°æ®\"\"\"\n        return LicensePlan.objects.filter(\n            tenant=self.request.tenant\n        ).select_related('tenant')\n    \n    def perform_create(self, serializer):\n        \"\"\"åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·\"\"\"\n        serializer.save(\n            tenant=self.request.tenant,\n            created_by=self.request.user\n        )\n```\n\n## ğŸ” å®‰å…¨è®¾è®¡\n\n### ç¡¬ä»¶æŒ‡çº¹ç”Ÿæˆç®—æ³•\n```python\nclass HardwareFingerprintService:\n    \"\"\"è·¨å¹³å°ç¡¬ä»¶æŒ‡çº¹ç”ŸæˆæœåŠ¡\"\"\"\n    \n    @staticmethod\n    def generate_fingerprint(hardware_info: dict) -> str:\n        \"\"\"ç”Ÿæˆç»Ÿä¸€çš„ç¡¬ä»¶æŒ‡çº¹\"\"\"\n        \n        # æå–å…³é”®ç¡¬ä»¶ä¿¡æ¯\n        key_components = {\n            'hardware_uuid': hardware_info.get('hardware_uuid'),\n            'cpu_model': hardware_info.get('cpu_info', {}).get('model'),\n            'mac_addresses': sorted(hardware_info.get('network_info', {}).get('mac_addresses', [])),\n            'platform': hardware_info.get('system_info', {}).get('os_name')\n        }\n        \n        # ç”Ÿæˆç¨³å®šçš„æŒ‡çº¹\n        fingerprint_data = json.dumps(key_components, sort_keys=True)\n        fingerprint_hash = hashlib.sha256(fingerprint_data.encode()).hexdigest()\n        \n        return f\"fp_{fingerprint_hash[:32]}\"\n    \n    @staticmethod\n    def validate_fingerprint_similarity(stored_fp: str, current_fp: str) -> float:\n        \"\"\"è®¡ç®—æŒ‡çº¹ç›¸ä¼¼åº¦ï¼Œå¤„ç†ç¡¬ä»¶å¾®å°å˜åŒ–\"\"\"\n        # å®ç°æŒ‡çº¹ç›¸ä¼¼åº¦ç®—æ³•\n        # è¿”å›0.0-1.0ä¹‹é—´çš„ç›¸ä¼¼åº¦åˆ†æ•°\n        pass\n```\n\n### RSAç­¾åéªŒè¯å¢å¼º\n```python\nclass LicenseSignatureService:\n    \"\"\"è®¸å¯è¯æ•°å­—ç­¾åæœåŠ¡\"\"\"\n    \n    @staticmethod\n    def verify_license_signature(license_key: str, signature: str, public_key: str) -> bool:\n        \"\"\"éªŒè¯è®¸å¯è¯RSAæ•°å­—ç­¾å\"\"\"\n        try:\n            # åŠ è½½RSAå…¬é’¥\n            rsa_key = RSA.import_key(public_key)\n            \n            # åˆ›å»ºç­¾åéªŒè¯å™¨\n            verifier = pkcs1_15.new(rsa_key)\n            \n            # è®¡ç®—è®¸å¯è¯å¯†é’¥çš„å“ˆå¸Œ\n            license_hash = SHA256.new(license_key.encode())\n            \n            # éªŒè¯ç­¾å\n            verifier.verify(license_hash, base64.b64decode(signature))\n            return True\n            \n        except (ValueError, TypeError) as e:\n            logger.warning(f\"License signature verification failed: {e}\")\n            return False\n```\n\n## ğŸ¨ å‰ç«¯è®¾è®¡\n\n### TypeScriptç±»å‹å®šä¹‰\n```typescript\n// types/license.ts\nexport interface LicensePlan {\n  id: number;\n  name: string;\n  code: string;\n  plan_type: string;\n  \n  // æ–°å­—æ®µåï¼ˆä¸»è¦ä½¿ç”¨ï¼‰\n  default_max_activations: number;\n  default_validity_days: number;\n  \n  // å…¶ä»–å­—æ®µ\n  features: Record<string, any>;\n  price: string;\n  currency: string;\n  status: string;\n  created_at: string;\n  updated_at: string;\n}\n\n// å‘åå…¼å®¹çš„ç±»å‹å®šä¹‰\nexport interface LegacyLicensePlan extends LicensePlan {\n  max_machines: number;  // æ˜ å°„åˆ° default_max_activations\n  validity_days: number; // æ˜ å°„åˆ° default_validity_days\n}\n```\n\n### Vueç»„ä»¶è®¾è®¡\n```vue\n<!-- components/LicensePlan/LicensePlanForm.vue -->\n<template>\n  <el-form ref=\"formRef\" :model=\"form\" :rules=\"rules\" label-width=\"120px\">\n    <el-form-item label=\"æ–¹æ¡ˆåç§°\" prop=\"name\">\n      <el-input v-model=\"form.name\" placeholder=\"è¯·è¾“å…¥æ–¹æ¡ˆåç§°\" />\n    </el-form-item>\n    \n    <el-form-item label=\"æ–¹æ¡ˆä»£ç \" prop=\"code\">\n      <el-input v-model=\"form.code\" placeholder=\"è¯·è¾“å…¥æ–¹æ¡ˆä»£ç \" />\n    </el-form-item>\n    \n    <!-- ä½¿ç”¨æ–°å­—æ®µå -->\n    <el-form-item label=\"é»˜è®¤æœ€å¤§æ¿€æ´»æ•°\" prop=\"default_max_activations\">\n      <el-input-number \n        v-model=\"form.default_max_activations\" \n        :min=\"1\" \n        :max=\"1000\"\n        placeholder=\"è®¾å¤‡æ•°é‡é™åˆ¶\"\n      />\n    </el-form-item>\n    \n    <el-form-item label=\"é»˜è®¤æœ‰æ•ˆå¤©æ•°\" prop=\"default_validity_days\">\n      <el-input-number \n        v-model=\"form.default_validity_days\"\n        :min=\"1\"\n        :max=\"3650\" \n        placeholder=\"æœ‰æ•ˆæœŸå¤©æ•°\"\n      />\n    </el-form-item>\n    \n    <el-form-item label=\"ä»·æ ¼\" prop=\"price\">\n      <el-input v-model=\"form.price\" placeholder=\"è¯·è¾“å…¥ä»·æ ¼\">\n        <template #append>{{ form.currency }}</template>\n      </el-input>\n    </el-form-item>\n    \n    <el-form-item>\n      <el-button type=\"primary\" @click=\"handleSubmit\">ä¿å­˜</el-button>\n      <el-button @click=\"handleCancel\">å–æ¶ˆ</el-button>\n    </el-form-item>\n  </el-form>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, reactive } from 'vue'\nimport type { LicensePlan } from '@/types/license'\nimport { createLicensePlan, updateLicensePlan } from '@/api/license'\n\ninterface Props {\n  modelValue?: LicensePlan\n  mode: 'create' | 'edit'\n}\n\nconst props = defineProps<Props>()\nconst emit = defineEmits<{\n  submit: [plan: LicensePlan]\n  cancel: []\n}>()\n\n// è¡¨å•æ•°æ®ï¼ˆä½¿ç”¨æ–°å­—æ®µåï¼‰\nconst form = reactive({\n  name: '',\n  code: '',\n  plan_type: 'basic',\n  default_max_activations: 1,\n  default_validity_days: 365,\n  price: '0.00',\n  currency: 'CNY',\n  status: 'active'\n})\n\n// è¡¨å•éªŒè¯è§„åˆ™\nconst rules = {\n  name: [\n    { required: true, message: 'è¯·è¾“å…¥æ–¹æ¡ˆåç§°', trigger: 'blur' }\n  ],\n  code: [\n    { required: true, message: 'è¯·è¾“å…¥æ–¹æ¡ˆä»£ç ', trigger: 'blur' }\n  ],\n  default_max_activations: [\n    { required: true, message: 'è¯·è®¾ç½®é»˜è®¤æœ€å¤§æ¿€æ´»æ•°', trigger: 'blur' }\n  ],\n  default_validity_days: [\n    { required: true, message: 'è¯·è®¾ç½®é»˜è®¤æœ‰æ•ˆå¤©æ•°', trigger: 'blur' }\n  ]\n}\n\nconst handleSubmit = async () => {\n  try {\n    if (props.mode === 'create') {\n      const result = await createLicensePlan(form)\n      emit('submit', result)\n    } else {\n      const result = await updateLicensePlan(props.modelValue!.id, form)\n      emit('submit', result)\n    }\n  } catch (error) {\n    console.error('ä¿å­˜å¤±è´¥:', error)\n  }\n}\n</script>\n```\n\n### APIè°ƒç”¨å±‚è®¾è®¡\n```typescript\n// api/license.ts\nimport { request } from '@/utils/request'\nimport type { LicensePlan } from '@/types/license'\n\nexport interface LicensePlanListResponse {\n  count: number\n  results: LicensePlan[]\n}\n\nexport interface CreateLicensePlanRequest {\n  name: string\n  code: string\n  plan_type: string\n  default_max_activations: number  // ä½¿ç”¨æ–°å­—æ®µå\n  default_validity_days: number    // ä½¿ç”¨æ–°å­—æ®µå\n  price: string\n  currency: string\n}\n\nexport const licensePlanAPI = {\n  // è·å–æ–¹æ¡ˆåˆ—è¡¨\n  async getPlans(params?: any): Promise<LicensePlanListResponse> {\n    return request.get('/api/licenses/plans/', { params })\n  },\n  \n  // åˆ›å»ºæ–¹æ¡ˆ\n  async createPlan(data: CreateLicensePlanRequest): Promise<LicensePlan> {\n    return request.post('/api/licenses/plans/', data)\n  },\n  \n  // æ›´æ–°æ–¹æ¡ˆ\n  async updatePlan(id: number, data: Partial<CreateLicensePlanRequest>): Promise<LicensePlan> {\n    return request.patch(`/api/licenses/plans/${id}/`, data)\n  },\n  \n  // åˆ é™¤æ–¹æ¡ˆ\n  async deletePlan(id: number): Promise<void> {\n    return request.delete(`/api/licenses/plans/${id}/`)\n  }\n}\n```\n\n## ğŸ§ª æµ‹è¯•è®¾è®¡\n\n### å•å…ƒæµ‹è¯•è®¾è®¡\n```python\n# tests/test_license_plan_serializer.py\nclass TestLicensePlanSerializer(TestCase):\n    \"\"\"LicensePlanåºåˆ—åŒ–å™¨æµ‹è¯•\"\"\"\n    \n    def setUp(self):\n        self.plan_data = {\n            'name': 'æµ‹è¯•æ–¹æ¡ˆ',\n            'code': 'TEST',\n            'plan_type': 'basic',\n            'default_max_activations': 5,\n            'default_validity_days': 365,\n            'price': '999.00'\n        }\n    \n    def test_serializer_with_new_field_names(self):\n        \"\"\"æµ‹è¯•æ–°å­—æ®µååºåˆ—åŒ–\"\"\"\n        serializer = LicensePlanSerializer(data=self.plan_data)\n        self.assertTrue(serializer.is_valid())\n        \n        plan = serializer.save()\n        self.assertEqual(plan.default_max_activations, 5)\n        self.assertEqual(plan.default_validity_days, 365)\n    \n    def test_backward_compatibility_fields(self):\n        \"\"\"æµ‹è¯•å‘åå…¼å®¹å­—æ®µ\"\"\"\n        plan = LicensePlan.objects.create(**self.plan_data)\n        serializer = LicensePlanSerializer(plan)\n        \n        data = serializer.data\n        # æ–°å­—æ®µå\n        self.assertEqual(data['default_max_activations'], 5)\n        self.assertEqual(data['default_validity_days'], 365)\n        \n        # å…¼å®¹å­—æ®µåï¼ˆåªè¯»ï¼‰\n        self.assertEqual(data['max_machines'], 5)\n        self.assertEqual(data['validity_days'], 365)\n```\n\n### é›†æˆæµ‹è¯•è®¾è®¡\n```python\n# tests/test_license_plan_api.py\nclass TestLicensePlanAPI(APITestCase):\n    \"\"\"LicensePlan APIé›†æˆæµ‹è¯•\"\"\"\n    \n    def setUp(self):\n        self.user = create_test_user()\n        self.tenant = create_test_tenant()\n        self.client.force_authenticate(user=self.user)\n        \n    def test_create_plan_with_new_fields(self):\n        \"\"\"æµ‹è¯•ä½¿ç”¨æ–°å­—æ®µååˆ›å»ºæ–¹æ¡ˆ\"\"\"\n        data = {\n            'name': 'æ–°æµ‹è¯•æ–¹æ¡ˆ',\n            'code': 'NEW_TEST',\n            'plan_type': 'professional',\n            'default_max_activations': 10,\n            'default_validity_days': 730,\n            'price': '1999.00'\n        }\n        \n        response = self.client.post('/api/licenses/plans/', data)\n        self.assertEqual(response.status_code, 201)\n        \n        plan = LicensePlan.objects.get(code='NEW_TEST')\n        self.assertEqual(plan.default_max_activations, 10)\n        self.assertEqual(plan.default_validity_days, 730)\n    \n    def test_api_response_format(self):\n        \"\"\"æµ‹è¯•APIå“åº”æ ¼å¼åŒ…å«æ–°æ—§å­—æ®µå\"\"\"\n        plan = LicensePlan.objects.create(\n            name='å“åº”æµ‹è¯•',\n            code='RESPONSE_TEST',\n            default_max_activations=3,\n            default_validity_days=180,\n            tenant=self.tenant\n        )\n        \n        response = self.client.get(f'/api/licenses/plans/{plan.id}/')\n        self.assertEqual(response.status_code, 200)\n        \n        data = response.json()\n        # éªŒè¯æ–°å­—æ®µåå­˜åœ¨\n        self.assertIn('default_max_activations', data)\n        self.assertIn('default_validity_days', data)\n        self.assertEqual(data['default_max_activations'], 3)\n        self.assertEqual(data['default_validity_days'], 180)\n```\n\n## ğŸ“Š æ€§èƒ½è®¾è®¡\n\n### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–\n```python\n# ä¼˜åŒ–åçš„æŸ¥è¯¢é›†\nclass LicensePlanQuerySet(models.QuerySet):\n    \"\"\"ä¼˜åŒ–çš„æŸ¥è¯¢é›†\"\"\"\n    \n    def with_license_stats(self):\n        \"\"\"åŒ…å«è®¸å¯è¯ç»Ÿè®¡ä¿¡æ¯\"\"\"\n        return self.annotate(\n            total_licenses=Count('license'),\n            active_licenses=Count('license', filter=Q(license__status='active')),\n            total_activations=Sum('license__max_activations')\n        )\n    \n    def for_tenant(self, tenant):\n        \"\"\"ç§Ÿæˆ·è¿‡æ»¤\"\"\"\n        return self.filter(tenant=tenant)\n    \n    def active_plans(self):\n        \"\"\"æ´»è·ƒæ–¹æ¡ˆ\"\"\"\n        return self.filter(status='active')\n\n# ä½¿ç”¨ç¤ºä¾‹\nplans = LicensePlan.objects.for_tenant(request.tenant)\\\n    .active_plans()\\\n    .with_license_stats()\\\n    .select_related('tenant')\\\n    .order_by('name')\n```\n\n### ç¼“å­˜ç­–ç•¥è®¾è®¡\n```python\n# ç¼“å­˜é…ç½®\nCACHE_SETTINGS = {\n    'license_plan_list': {\n        'timeout': 300,  # 5åˆ†é’Ÿ\n        'key_pattern': 'license_plans:tenant:{tenant_id}:list'\n    },\n    'license_plan_detail': {\n        'timeout': 600,  # 10åˆ†é’Ÿ\n        'key_pattern': 'license_plan:detail:{plan_id}'\n    }\n}\n\nclass CachedLicensePlanService:\n    \"\"\"å¸¦ç¼“å­˜çš„è®¸å¯è¯æ–¹æ¡ˆæœåŠ¡\"\"\"\n    \n    @staticmethod\n    def get_plans_for_tenant(tenant_id: int) -> List[LicensePlan]:\n        cache_key = f'license_plans:tenant:{tenant_id}:list'\n        \n        plans = cache.get(cache_key)\n        if plans is None:\n            plans = list(LicensePlan.objects.for_tenant_id(tenant_id).active_plans())\n            cache.set(cache_key, plans, timeout=300)\n        \n        return plans\n```\n\n## ğŸ”„ éƒ¨ç½²è®¾è®¡\n\n### æ•°æ®åº“è¿ç§»ç­–ç•¥\n```python\n# è¿ç§»æ‰§è¡Œè®¡åˆ’\nMIGRATION_PLAN = {\n    'phase_1': {\n        'description': 'æ‰§è¡Œå­—æ®µé‡å‘½åè¿ç§»',\n        'migrations': ['0004_rename_licenseplan_fields'],\n        'rollback_safe': True,\n        'estimated_time': '< 1åˆ†é’Ÿ'\n    },\n    'phase_2': {\n        'description': 'éªŒè¯æ•°æ®å®Œæ•´æ€§',\n        'commands': ['python manage.py check_license_data_integrity'],\n        'rollback_safe': True,\n        'estimated_time': '< 30ç§’'\n    }\n}\n```\n\n### éƒ¨ç½²è„šæœ¬è®¾è®¡\n```bash\n#!/bin/bash\n# deploy_license_update.sh\n\nset -e\n\necho \"å¼€å§‹éƒ¨ç½²è®¸å¯è¯ç³»ç»Ÿæ›´æ–°...\"\n\n# 1. å¤‡ä»½æ•°æ®åº“\necho \"1. å¤‡ä»½æ•°æ®åº“...\"\npython manage.py dbbackup\n\n# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»\necho \"2. æ‰§è¡Œæ•°æ®åº“è¿ç§»...\"\npython manage.py migrate licenses\n\n# 3. éªŒè¯æ•°æ®å®Œæ•´æ€§\necho \"3. éªŒè¯æ•°æ®å®Œæ•´æ€§...\"\npython manage.py check_license_data_integrity\n\n# 4. é‡å¯æœåŠ¡\necho \"4. é‡å¯åº”ç”¨æœåŠ¡...\"\nsudo systemctl restart gunicorn\nsudo systemctl restart celery\n\n# 5. éªŒè¯æœåŠ¡çŠ¶æ€\necho \"5. éªŒè¯æœåŠ¡çŠ¶æ€...\"\npython manage.py health_check\n\necho \"éƒ¨ç½²å®Œæˆï¼\"\n```\n\n## ğŸ“ ç›‘æ§è®¾è®¡\n\n### å…³é”®æŒ‡æ ‡ç›‘æ§\n```python\n# ç›‘æ§æŒ‡æ ‡å®šä¹‰\nMONITORING_METRICS = {\n    'api_performance': {\n        'license_plan_list_response_time': 'histogram',\n        'license_plan_create_response_time': 'histogram',\n        'license_plan_update_response_time': 'histogram'\n    },\n    'business_metrics': {\n        'license_plans_created_daily': 'counter',\n        'license_plans_updated_daily': 'counter',\n        'api_field_compatibility_usage': 'counter'\n    },\n    'error_metrics': {\n        'license_plan_api_errors': 'counter',\n        'database_migration_errors': 'counter',\n        'field_validation_errors': 'counter'\n    }\n}\n```\n\n## âœ… è®¾è®¡éªŒè¯\n\n### è®¾è®¡åŸåˆ™éªŒè¯\n- âœ… **å‘åå…¼å®¹æ€§**: APIæ”¯æŒæ–°æ—§å­—æ®µåï¼Œå¹³æ»‘è¿‡æ¸¡\n- âœ… **æ•°æ®å®Œæ•´æ€§**: è¿ç§»è¿‡ç¨‹ä¿è¯æ•°æ®ä¸ä¸¢å¤±\n- âœ… **æ€§èƒ½ä¿éšœ**: ä¼˜åŒ–æŸ¥è¯¢å’Œç¼“å­˜ç­–ç•¥\n- âœ… **å®‰å…¨å¢å¼º**: RSAç­¾åå’Œç¡¬ä»¶æŒ‡çº¹éªŒè¯\n- âœ… **ç”¨æˆ·ä½“éªŒ**: å‰ç«¯ç•Œé¢ä¿æŒä¸€è‡´æ€§\n\n### æŠ€æœ¯å€ºåŠ¡è¯„ä¼°\n- **ä½é£é™©**: å­—æ®µé‡å‘½åå¯¹ç°æœ‰åŠŸèƒ½å½±å“æœ€å°\n- **ä¸­é£é™©**: å‰ç«¯ç»„ä»¶éœ€è¦ç³»ç»Ÿæ€§æ›´æ–°\n- **å¯æ§é£é™©**: é€šè¿‡åˆ†é˜¶æ®µéƒ¨ç½²é™ä½é£é™©\n\n---\n\n*è®¾è®¡æ–‡æ¡£ç‰ˆæœ¬: v1.0*  \n*åˆ›å»ºæ—¥æœŸ: 2025å¹´9æœˆ26æ—¥*  \n*åŸºäºéœ€æ±‚: license-system-update requirements v1.0*\n",
  "fileStats": {
    "size": 20881,
    "lines": 717,
    "lastModified": "2025-09-26T07:14:39.043Z"
  },
  "comments": []
}