# 客户与联系人订单关联

## 1. 概述

客户与联系人订单关联功能是订单管理模块与客户管理、联系人管理模块的集成点，实现订单与客户、联系人之间的无缝关联，使用户可以方便地查看特定客户或联系人的所有订单，提高业务处理效率。

## 2. 功能列表

客户与联系人订单关联功能包括以下几个主要部分：

1. **客户订单关联**：管理订单与客户之间的关系
2. **联系人订单关联**：管理订单与联系人之间的关系
3. **客户订单查看**：按客户查看和管理订单
4. **联系人订单查看**：按联系人查看和管理订单
5. **关联统计分析**：客户和联系人的订单统计分析

## 3. 客户订单关联

客户订单关联用于建立和管理订单与客户之间的关系，是订单基本属性的一部分。

### 3.1 功能描述

- 创建订单时必须选择关联客户
- 显示客户的基本信息和历史订单摘要
- 支持更改订单关联的客户
- 支持按客户筛选订单

### 3.2 界面设计

创建/编辑订单时的客户选择界面：

```
+------------------------------------------------------------------+
| 基本信息                                                         |
+------------------------------------------------------------------+
| 客户*: [             ▼] [搜索]                [+新建客户]        |
|                                                                  |
| 选中客户信息:                                                    |
| 客户名称: 北京科技有限公司                                       |
| 客户代码: BJ001                                                  |
| 客户类型: 企业客户                                               |
| 历史订单: 5 单，总金额 ¥25,000                                   |
|                                                                  |
| 联系人*: [             ▼] [搜索]               [+新建联系人]     |
|                                                                  |
| 选中联系人信息:                                                  |
| 姓名: 李四                                                       |
| 职位: 采购经理                                                   |
| 电话: 139-0013-9000                                             |
| 邮箱: lisi@example.com                                          |
+------------------------------------------------------------------+
```

客户选择组件应支持以下功能：

- 下拉选择常用客户
- 搜索客户（按名称、代码等）
- 显示选中客户的关键信息
- 提供快速创建新客户的入口

### 3.3 客户选择数据源

客户选择组件需要从客户管理模块获取数据，通过以下方式：

1. **客户列表API**：获取客户基本信息列表
2. **客户搜索API**：根据关键词搜索客户
3. **客户详情API**：获取选中客户的详细信息

### 3.4 数据关联结构

订单与客户的关联数据结构如下：

```
Order {
  // ... 其他订单字段
  
  // 客户关联
  customer: number;           // 客户ID，外键关联到Customer表
  customer_name: string;      // 客户名称（冗余字段，便于显示）
  customer_type: string;      // 客户类型，如"新客户"、"老客户"
}

Customer {
  id: number;                 // 客户ID
  name: string;               // 客户名称
  type: string;               // 客户类型
  // ... 其他客户字段
}
```

## 4. 联系人订单关联

联系人订单关联用于建立和管理订单与客户联系人之间的关系，便于按联系人追踪和管理订单。

### 4.1 功能描述

- 创建订单时可选择客户联系人
- 显示联系人的基本信息
- 支持更改订单关联的联系人
- 支持按联系人筛选订单

### 4.2 界面设计

联系人选择应与客户选择相关联：

```
+------------------------------------------------------------------+
| 联系人选择                                                       |
+------------------------------------------------------------------+
| 客户: 北京科技有限公司                                           |
|                                                                  |
| 联系人: [           ▼] [搜索]                 [+新建联系人]      |
|                                                                  |
| 可选联系人:                                                      |
| - 李四 (采购经理) - lisi@example.com - 139-0013-9000             |
| - 王五 (技术总监) - wangwu@example.com - 138-0138-0000           |
| - 赵六 (财务主管) - zhaoliu@example.com - 137-0137-0000          |
|                                                                  |
| 选中联系人信息:                                                  |
| 姓名: 李四                                                       |
| 职位: 采购经理                                                   |
| 电话: 139-0013-9000                                             |
| 邮箱: lisi@example.com                                          |
+------------------------------------------------------------------+
```

联系人选择需实现以下功能：

- 根据所选客户自动筛选相关联系人
- 支持搜索联系人
- 显示选中联系人的关键信息
- 提供快速创建新联系人的入口

### 4.3 联系人选择数据源

联系人选择组件需要从联系人/会员管理模块获取数据：

1. **联系人列表API**：获取特定客户的联系人列表
2. **联系人搜索API**：根据关键词搜索联系人
3. **联系人详情API**：获取选中联系人的详细信息

### 4.4 数据关联结构

订单与联系人的关联数据结构如下：

```
Order {
  // ... 其他订单字段和客户关联
  
  // 联系人关联
  customer_contact: number;   // 联系人ID，外键关联到Contact表
  customer_contact_info: {    // 联系人信息（冗余对象，便于显示）
    id: number;
    username: string;
    display_name: string;
    phone: string;
    email: string;
  };
}

Contact {
  id: number;                 // 联系人ID
  username: string;           // 用户名
  display_name: string;       // 显示名称
  phone: string;              // 电话
  email: string;              // 邮箱
  customer: number;           // 所属客户ID
  // ... 其他联系人字段
}
```

## 5. 客户订单查看

客户订单查看功能允许用户从客户视角查看和管理订单，为客户服务提供统一视图。

### 5.1 功能描述

- 显示特定客户的所有关联订单
- 提供订单筛选和排序功能
- 支持从客户详情页直接跳转到客户订单列表
- 支持从客户订单列表创建新订单

### 5.2 界面设计

客户订单列表界面：

```
+------------------------------------------------------------------+
| 客户订单列表 - 北京科技有限公司                    [新建订单]     |
+------------------------------------------------------------------+
| [客户信息卡片]                                                    |
| 名称: 北京科技有限公司 | 类型: 企业客户 | 联系人: 李四, 王五      |
| 客户代码: BJ001       | 创建时间: 2025-01-15 | 负责人: 张三        |
+------------------------------------------------------------------+
| 筛选: [支付状态 ▼] [服务类型 ▼] [创建日期 ▼] [搜索框             ]|
+------------------------------------------------------------------+
| 订单列表                                          共 15 条订单    |
| +--------+--------------+----------+-----------+---------+--------+
| | 订单号 | 服务类型     | 语种     | 金额      | 状态    | 操作    |
| +--------+--------------+----------+-----------+---------+--------+
| | PQ-... | 文档翻译     | 中英     | ¥3,000    | 已支付  | 详情... |
| | PQ-... | 口译服务     | 中英     | ¥5,000    | 未支付  | 详情... |
| | ...    | ...          | ...      | ...       | ...     | ...     |
| +--------+--------------+----------+-----------+---------+--------+
|                                                                  |
| [分页控制]                                                       |
+------------------------------------------------------------------+

[客户订单统计]
+------------------+ +-------------------+ +--------------------+
| 订单总数: 15     | | 总金额: ¥45,000   | | 平均订单: ¥3,000   |
+------------------+ +-------------------+ +--------------------+
```

### 5.3 与客户详情页的集成

客户订单查看功能应与客户详情页集成：

1. **客户详情页添加订单标签页**：显示客户订单摘要和进入订单列表的入口
2. **客户详情页显示订单统计**：显示客户订单数量、总金额等统计信息
3. **提供快捷操作**：从客户详情页快速创建订单

### 5.4 API集成

实现客户订单查看需要以下API：

```
GET /api/v1/orders/customers/{customer_id}/orders/
```

支持的查询参数：

- payment_status: 按支付状态筛选
- service_type: 按服务类型筛选
- order_date_from: 按订单日期范围筛选（起始）
- order_date_to: 按订单日期范围筛选（结束）
- search: 搜索订单编号等信息
- page: 页码
- page_size: 每页条数
- ordering: 排序字段

## 6. 联系人订单查看

联系人订单查看功能允许用户从联系人视角查看和管理订单，便于追踪特定联系人的订单历史。

### 6.1 功能描述

- 显示特定联系人的所有关联订单
- 提供订单筛选和排序功能
- 支持从联系人详情页直接跳转到联系人订单列表
- 支持从联系人订单列表创建新订单

### 6.2 界面设计

联系人订单列表界面：

```
+------------------------------------------------------------------+
| 联系人订单列表 - 李四                             [新建订单]      |
+------------------------------------------------------------------+
| [联系人信息卡片]                                                  |
| 姓名: 李四 | 职位: 采购经理 | 电话: 139-0013-9000                |
| 邮箱: lisi@example.com | 所属客户: 北京科技有限公司              |
+------------------------------------------------------------------+
| 筛选: [支付状态 ▼] [服务类型 ▼] [创建日期 ▼] [搜索框             ]|
+------------------------------------------------------------------+
| 订单列表                                          共 8 条订单     |
| +--------+--------------+----------+-----------+---------+--------+
| | 订单号 | 服务类型     | 语种     | 金额      | 状态    | 操作    |
| +--------+--------------+----------+-----------+---------+--------+
| | PQ-... | 文档翻译     | 中英     | ¥2,000    | 已支付  | 详情... |
| | PQ-... | 校对服务     | 中英     | ¥1,000    | 未支付  | 详情... |
| | ...    | ...          | ...      | ...       | ...     | ...     |
| +--------+--------------+----------+-----------+---------+--------+
|                                                                  |
| [分页控制]                                                       |
+------------------------------------------------------------------+

[联系人订单统计]
+------------------+ +-------------------+ +--------------------+
| 订单总数: 8      | | 总金额: ¥18,000   | | 平均订单: ¥2,250   |
+------------------+ +-------------------+ +--------------------+
```

### 6.3 与联系人详情页的集成

联系人订单查看功能应与联系人详情页集成：

1. **联系人详情页添加订单标签页**：显示联系人订单摘要和进入订单列表的入口
2. **联系人详情页显示订单统计**：显示联系人订单数量、总金额等统计信息
3. **提供快捷操作**：从联系人详情页快速创建订单

### 6.4 API集成

实现联系人订单查看需要以下API：

```
GET /api/v1/orders/contacts/{contact_id}/orders/
```

支持的查询参数与客户订单查看API类似，包括支付状态、服务类型、日期范围等筛选条件。

## 7. 关联统计分析

关联统计分析功能提供客户和联系人的订单数据统计分析，帮助了解客户价值和联系人重要性。

### 7.1 功能描述

- 分析客户的订单数量、金额和毛利趋势
- 分析客户的服务类型和语种偏好
- 分析联系人的订单活跃度
- 提供客户价值评估

### 7.2 界面设计

客户订单分析界面：

```
+------------------------------------------------------------------+
| 客户订单分析 - 北京科技有限公司                    [导出报表]     |
+------------------------------------------------------------------+
| 时间范围: [2025-01-01] 至 [2025-07-31]            [应用筛选]     |
+------------------------------------------------------------------+
| 订单趋势                                                         |
| [折线图/柱状图，显示客户订单数量和金额随时间的变化趋势]           |
+------------------------------------------------------------------+
| 服务偏好                                                         |
| +-----------------+        +------------------+                  |
| | 服务类型分布    |        | 语种分布         |                  |
| | [饼图]          |        | [饼图]           |                  |
| +-----------------+        +------------------+                  |
|                                                                  |
| 联系人订单分布                                                   |
| +---------------+----------+---------------+--------------+------+
| | 联系人        | 订单数   | 总金额        | 最近订单     | 占比  |
| +---------------+----------+---------------+--------------+------+
| | 李四          | 5        | ¥15,000      | 2025-07-15   | 60%  |
| | 王五          | 3        | ¥10,000      | 2025-07-10   | 40%  |
| +---------------+----------+---------------+--------------+------+
+------------------------------------------------------------------+
```

### 7.3 客户价值评估

系统可以基于订单数据对客户进行价值评估：

1. **总订单金额**：客户所有订单的总金额
2. **订单频率**：客户平均下单频率
3. **平均订单金额**：客户平均单笔订单金额
4. **客户活跃度**：最近一次下单时间与首次下单时间间隔
5. **客户忠诚度**：持续合作时间

### 7.4 API集成

实现客户订单分析需要以下API：

```
GET /api/v1/orders/customers/{customer_id}/statistics/
```

支持的查询参数：

- start_date: 统计开始日期
- end_date: 统计结束日期
- period: 统计周期（daily/weekly/monthly/yearly）

## 8. 数据流转图

以下是订单与客户、联系人之间的数据流转过程：

```
创建订单流程
+--------+    +-----------------+    +---------------+
| 用户   | -> | 选择客户        | -> | 选择联系人    |
+--------+    +-----------------+    +---------------+
                  |                        |
                  v                        v
        +-----------------+      +------------------+
        | 客户管理模块    |      | 联系人管理模块   |
        | - 提供客户列表  |      | - 提供联系人列表 |
        | - 客户信息验证  |      | - 联系人信息验证 |
        +-----------------+      +------------------+
                  |                        |
                  v                        v
              +----------------------------------+
              | 订单管理模块                     |
              | - 创建订单                       |
              | - 关联客户和联系人               |
              +----------------------------------+
```

## 9. 实现要点

### 9.1 API设计

需要设计以下API以支持客户与联系人订单关联：

1. **客户订单API**：
   - 获取客户订单列表：GET /api/v1/orders/customers/{customer_id}/orders/
   - 获取客户订单详情：GET /api/v1/orders/customers/{customer_id}/orders/{id}/
   - 获取客户订单统计：GET /api/v1/orders/customers/{customer_id}/statistics/

2. **联系人订单API**：
   - 获取联系人订单列表：GET /api/v1/orders/contacts/{contact_id}/orders/
   - 获取联系人订单详情：GET /api/v1/orders/contacts/{contact_id}/orders/{id}/
   - 获取联系人订单统计：GET /api/v1/orders/contacts/{contact_id}/statistics/

### 9.2 组件设计

需要设计以下组件以支持客户与联系人订单关联：

1. **客户选择器组件**：用于在订单创建/编辑时选择客户
2. **联系人选择器组件**：用于在订单创建/编辑时选择联系人
3. **客户订单列表组件**：展示特定客户的所有订单
4. **联系人订单列表组件**：展示特定联系人的所有订单
5. **客户订单统计组件**：展示客户订单统计信息

### 9.3 数据缓存策略

为提高性能，应采用以下数据缓存策略：

1. **客户和联系人基础信息缓存**：缓存常用客户和联系人信息，减少API调用
2. **订单列表分页缓存**：缓存已加载的订单列表页，提高翻页响应速度
3. **统计数据缓存**：缓存统计分析结果，定期更新

### 9.4 权限控制

应实现以下权限控制：

1. **客户访问权限**：用户只能查看其有权限访问的客户的订单
2. **联系人访问权限**：用户只能查看其有权限访问的联系人的订单
3. **操作权限**：根据用户角色限制订单创建、编辑、删除等操作 