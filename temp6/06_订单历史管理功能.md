# 订单历史管理功能

## 1. 概述

订单历史管理功能用于追踪和管理订单的变更历史，实现订单版本控制，便于审计和回溯。该功能记录订单从创建到每次修改的所有变更，并提供版本比较和还原功能，增强订单数据的可追溯性和安全性。

## 2. 功能列表

订单历史管理功能包括以下几个主要部分：

1. **历史记录查看**：查看订单的所有历史版本
2. **版本详情查看**：查看特定版本的订单详情
3. **版本比较**：比较不同版本之间的差异
4. **历史版本还原**：将订单还原到历史版本

## 3. 历史记录查看

历史记录查看功能允许用户查看订单的所有历史变更记录，了解订单的演变过程。

### 3.1 功能描述

- 显示订单的所有历史版本列表
- 提供版本号、修改时间、修改人和变更摘要信息
- 支持按时间排序和筛选
- 显示当前活动版本标记

### 3.2 界面设计

订单历史记录列表界面：

```
+------------------------------------------------------------------+
| 订单历史记录 - #PQ-202507-1234                       返回订单详情 |
+------------------------------------------------------------------+
| 订单基本信息                                                      |
| 订单编号: PQ-202507-1234 | 客户: 北京科技有限公司 | 当前版本: 5    |
+------------------------------------------------------------------+
| 历史版本列表                                                     |
| +--------+-------------+----------+---------------------------+--+
| | 版本   | 修改时间    | 修改人   | 变更内容                  |操作|
| +--------+-------------+----------+---------------------------+--+
| | 5      | 2025-07-15  | admin    | 更新支付状态为已支付      |查看|
| | (当前) | 15:30:45    |          |                          |    |
| +--------+-------------+----------+---------------------------+--+
| | 4      | 2025-07-12  | admin    | 更新译员费用和译员支付状态|查看|
| |        | 10:25:30    |          |                          |比较|
| +--------+-------------+----------+---------------------------+--+
| | 3      | 2025-07-11  | user1    | 更新服务时间和项目详情    |查看|
| |        | 16:40:20    |          |                          |比较|
| +--------+-------------+----------+---------------------------+--+
| | 2      | 2025-07-10  | admin    | 更新客户总价和客户数量    |查看|
| |        | 14:15:10    |          |                          |比较|
| +--------+-------------+----------+---------------------------+--+
| | 1      | 2025-07-10  | admin    | 创建订单                  |查看|
| |        | 09:30:00    |          |                          |    |
| +--------+-------------+----------+---------------------------+--+
+------------------------------------------------------------------+
```

### 3.3 变更内容展示

变更内容应简洁明了地展示主要变更，可以采用以下形式：

1. **创建操作**：显示"创建订单"
2. **更新操作**：显示更新的关键字段，如"更新支付状态为已支付"
3. **多字段更新**：显示"更新多个字段（5项变更）"并提供详情查看

### 3.4 API集成

实现历史记录查看需要以下API：

```
GET /api/v1/orders/{order_id}/history/
```

支持的查询参数：

- ordering: 排序字段，可用值为version、modified_at
- page: 页码
- page_size: 每页条数

## 4. 版本详情查看

版本详情查看功能允许用户查看特定历史版本的订单完整信息。

### 4.1 功能描述

- 展示指定历史版本的订单完整信息
- 突出显示与当前版本的差异
- 提供还原到此版本的操作选项
- 提供与其他版本比较的选项

### 4.2 界面设计

历史版本详情界面：

```
+------------------------------------------------------------------+
| 订单历史版本详情 - 版本 3                         返回历史列表    |
+------------------------------------------------------------------+
| 订单编号: PQ-202507-1234 | 版本: 3/5 | 修改时间: 2025-07-11 16:40|
| 修改人: user1            | 操作类型: 更新                         |
+------------------------------------------------------------------+
| 变更详情                                                         |
| +--------------------+------------------------+-------------------+
| | 字段              | 旧值                  | 新值               |
| +--------------------+------------------------+-------------------+
| | service_time      | 2025-07-20            | 2025-07-15        |
| | project_details   | 技术文档翻译          | 技术文档翻译(急件) |
| +--------------------+------------------------+-------------------+
|                                                                  |
| [与版本  4  比较 ▼]                            [还原到此版本]    |
+------------------------------------------------------------------+
| 订单完整信息 (版本 3)                                            |
| +------------------------------------------------------------------+
| | 基本信息                                                         |
| | 客户: 北京科技有限公司     | 联系人: 李四                         |
| | 服务类型: 文档翻译        | 语种: 中英                           |
| | 客户数量: 5000字          | 翻译数量: 5000字                     |
| | ...                     | ...                                  |
| +------------------------------------------------------------------+
```

### 4.3 API集成

实现版本详情查看需要以下API：

```
GET /api/v1/orders/{order_id}/history/{version}/
```

## 5. 版本比较

版本比较功能允许用户直观地对比两个订单版本之间的差异。

### 5.1 功能描述

- 选择两个版本进行比较
- 并排或对比形式展示差异
- 突出显示变更字段
- 提供字段级别的比较

### 5.2 界面设计

版本比较界面：

```
+------------------------------------------------------------------+
| 订单版本比较                                       返回历史列表    |
+------------------------------------------------------------------+
| 订单编号: PQ-202507-1234                                          |
| 比较版本: [版本 3 (2025-07-11)] 与 [版本 4 (2025-07-12)]          |
+------------------------------------------------------------------+
| 差异字段列表                                                      |
| +--------------------+------------------------+-------------------+
| | 字段              | 版本 3 值              | 版本 4 值          |
| +--------------------+------------------------+-------------------+
| | translator_fee    | ¥1000.00               | ¥1200.00          |
| | translator_payment_status | 待付款          | 已付款            |
| +--------------------+------------------------+-------------------+
+------------------------------------------------------------------+
| 版本信息对比                                                      |
| +----------------------+------------------------+------------------+
| | 属性                | 版本 3                | 版本 4            |
| +----------------------+------------------------+------------------+
| | 修改时间            | 2025-07-11 16:40:20   | 2025-07-12 10:25:30 |
| | 修改人              | user1                 | admin             |
| | 操作类型            | 更新                  | 更新              |
| +----------------------+------------------------+------------------+
|                                                                  |
| [查看版本 3 详情]                              [查看版本 4 详情]  |
+------------------------------------------------------------------+
```

### 5.3 差异展示方式

差异可以通过以下方式直观展示：

1. **并排对比**：左右或上下布局，直观展示两个版本的差异
2. **高亮差异**：在差异字段上使用颜色标记（如添加绿色，删除红色）
3. **折叠相同部分**：只展开显示有差异的部分

### 5.4 API集成

实现版本比较需要以下API：

```
GET /api/v1/orders/{order_id}/history/compare/?version1={version1}&version2={version2}
```

## 6. 历史版本还原

历史版本还原功能允许用户将订单还原到之前的历史版本状态。

### 6.1 功能描述

- 将订单还原到选定的历史版本
- 创建新的历史记录，记录还原操作
- 保留不可变的系统字段（ID、创建时间等）
- 提供还原前的确认和还原后的反馈

### 6.2 界面设计

版本还原确认对话框：

```
+------------------------------------------------------------------+
|                       还原历史版本                               |
+------------------------------------------------------------------+
|                                                                  |
| 您确定要将订单 #PQ-202507-1234 还原到版本 3 吗？                 |
|                                                                  |
| 版本 3 信息:                                                     |
| - 修改时间: 2025-07-11 16:40:20                                 |
| - 修改人: user1                                                 |
|                                                                  |
| 此操作将:                                                        |
| 1. 用版本 3 的数据替换当前版本数据                               |
| 2. 创建新的版本记录（版本 6）                                    |
| 3. 保留订单ID、创建时间等系统字段不变                             |
|                                                                  |
| 是否继续?                                                        |
|                                                                  |
|                                         [取消] [确认还原]        |
+------------------------------------------------------------------+
```

还原成功反馈：

```
+------------------------------------------------------------------+
|                       还原成功                                   |
+------------------------------------------------------------------+
|                                                                  |
| 订单 #PQ-202507-1234 已成功还原到版本 3                          |
|                                                                  |
| 新版本信息:                                                      |
| - 版本号: 6                                                      |
| - 修改时间: 2025-07-16 11:20:30                                 |
| - 操作: 还原到版本 3                                            |
|                                                                  |
|                                   [查看详情] [返回订单列表]      |
+------------------------------------------------------------------+
```

### 6.3 还原处理逻辑

历史版本还原的处理逻辑如下：

1. **获取历史版本**：读取选定历史版本的订单快照数据
2. **字段过滤**：保留不可变系统字段（ID、创建时间、租户等）的当前值
3. **更新当前订单**：用历史版本的数据更新当前订单
4. **创建新历史记录**：创建新的历史记录，记录还原操作
5. **返回更新后的订单数据**：返回还原后的订单详情

### 6.4 API集成

实现历史版本还原需要以下API：

```
POST /api/v1/orders/{order_id}/history/{version}/restore/
```

## 7. 历史记录存储设计

历史记录存储设计是订单历史管理功能的关键部分，需要合理设计以确保性能和存储效率。

### 7.1 历史记录数据模型

历史记录数据模型应包含以下字段：

```
OrderHistory {
  id: number;                 // 历史记录ID
  order: number;              // 关联的订单ID
  version: number;            // 版本号，从1开始递增
  modified_by: number;        // 修改人ID
  modified_at: string;        // 修改时间
  change_details: string;     // 变更详情JSON字符串
  snapshot: string;           // 订单完整快照的JSON字符串
}
```

### 7.2 存储策略

历史记录存储策略应考虑以下几点：

1. **完整快照**：每个历史记录存储订单的完整快照，便于直接查看和还原
2. **增量差异**：同时存储变更详情，记录哪些字段发生了变化
3. **压缩存储**：对历史记录进行压缩存储，减少空间占用
4. **分表存储**：根据需要可将历史记录存储在单独的表中

### 7.3 版本号管理

版本号管理策略如下：

1. **初始版本**：订单创建时，生成版本1
2. **递增规则**：每次更新订单时，版本号加1
3. **版本号范围**：使用整数类型，支持足够多的版本
4. **并发控制**：使用乐观锁或其他机制确保版本号的一致性

## 8. 历史记录生成机制

历史记录生成机制定义了何时以及如何创建历史记录。

### 8.1 创建时机

历史记录的创建时机包括：

1. **订单创建时**：记录初始版本（版本1）
2. **订单更新时**：记录每次更新操作
3. **订单还原时**：记录还原操作
4. **批量更新时**：对每个订单单独记录历史

### 8.2 变更详情记录

变更详情记录应包含以下信息：

1. **操作类型**：create（创建）、update（更新）、restore（还原）
2. **变更字段**：更新操作中修改的字段
3. **前后值**：字段的旧值和新值
4. **还原信息**：还原操作的源版本号

### 8.3 历史记录格式

历史记录的`change_details`字段存储JSON格式的变更详情：

```json
// 创建操作
{
  "action": "create",
  "message": "创建订单"
}

// 更新操作
{
  "action": "update",
  "changes": {
    "payment_status": {
      "old": "unpaid",
      "new": "paid"
    },
    "payment_date": {
      "old": null,
      "new": "2025-07-12"
    }
  }
}

// 还原操作
{
  "action": "restore",
  "source_version": 3,
  "message": "还原到版本3"
}
```

## 9. 权限控制

历史管理功能需要适当的权限控制，确保数据安全。

### 9.1 查看权限

- **历史记录列表查看**：需要订单查看权限
- **历史版本详情查看**：需要订单查看权限
- **版本比较**：需要订单查看权限

### 9.2 还原权限

- **历史版本还原**：需要订单编辑权限和特殊的还原权限
- **批量还原**：可能需要管理员权限

### 9.3 删除权限

- **历史记录不允许删除**：确保审计跟踪的完整性
- **特殊情况下的删除**：仅超级管理员可执行，且需要留下操作日志

## 10. 性能优化

为确保历史管理功能的高效运行，需要进行性能优化。

### 10.1 查询优化

- **索引设计**：为order_id和version字段建立索引
- **分页查询**：默认采用分页方式加载历史记录
- **延迟加载**：历史记录详情采用延迟加载策略

### 10.2 存储优化

- **快照压缩**：存储前压缩历史记录快照
- **旧数据归档**：定期将过旧的历史记录归档
- **选择性记录**：仅记录重要字段的变更

### 10.3 UI优化

- **渐进式加载**：大量历史记录采用渐进式加载
- **变更摘要优先**：先显示变更摘要，详情按需加载
- **异步比较**：版本比较操作异步进行，避免阻塞UI

## 11. 展示效果增强

为提高用户体验，可以增强历史管理功能的展示效果。

### 11.1 变更高亮

- **文本差异**：使用文本差异算法突出显示文本字段的变化
- **颜色编码**：添加绿色，删除红色，变更黄色
- **并排比较**：提供并排比较视图

### 11.2 时间轴展示

```
+------------------------------------------------------------------+
| 订单历史时间轴 - #PQ-202507-1234                                  |
+------------------------------------------------------------------+
|                                                                  |
| 2025-07-10 ●───────●─────────────●───────────────●─────────○     |
| 09:30:00   │       │             │               │         │     |
|  创建订单   │       │             │               │     当前版本  |
|            │       │             │               │               |
|            │       │             │               │               |
|            │ 14:15 │      7/11   │     7/12      │    7/15       |
|            │ 更新价格│     更新时间 │    更新费用   │   更新状态     |
|            │       │             │               │               |
| [版本 1]  [版本 2]  [版本 3]      [版本 4]        [版本 5]        |
+------------------------------------------------------------------+
```

### 11.3 变更分组

- **按日期分组**：将同一天的变更分组显示
- **按修改人分组**：将同一人的变更分组显示
- **按操作类型分组**：将相似类型的变更分组显示 