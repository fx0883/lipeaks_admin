# 订单数据模型设计

## 1. 订单核心数据结构

订单管理模块的核心是订单（Order）数据模型，该模型包含了订单的所有相关信息。基于API文档分析，订单数据结构设计如下：

### 1.1 订单基础信息

```
Order {
  id: number;                 // 订单ID
  order_number: string;       // 订单编号，自动生成，格式如：PQ-202507-1234
  created_at: string;         // 创建时间
  updated_at: string;         // 更新时间
  is_deleted: boolean;        // 是否删除（软删除标记）
}
```

### 1.2 客户信息

```
Order {
  // ... 基础信息
  
  // 客户关联信息
  customer: number;           // 客户ID
  customer_name: string;      // 客户名称（冗余字段，便于显示）
  customer_contact: number;   // 联系人ID
  customer_contact_info: {    // 联系人信息（冗余对象，便于显示）
    id: number;
    username: string;
    display_name: string;
    phone: string;
    email: string;
  };
  
  // 创建者信息
  created_by_info: {          // 创建者信息
    id: number;
    username: string;
    display_name: string;
  };
}
```

### 1.3 订单业务信息

```
Order {
  // ... 基础信息和客户信息
  
  // 订单业务信息
  source_platform: string;    // 来源平台，如"官网"、"邮件咨询"等
  project_manager: string;    // 项目负责人
  customer_type: string;      // 客户类型，如"新客户"、"老客户"
  order_date: string;         // 下单日期，格式：YYYY-MM-DD
  service_type: string;       // 服务类型，如"文档翻译"、"口译服务"、"校对服务"
  service_type_display: string; // 服务类型显示名称
  language: string;           // 语种，如"中英"、"中日"等
  customer_count: string;     // 客户数量，如"5000字"、"1天"等
  translation_count: string;  // 翻译数量
  service_time: string;       // 服务时间，格式：YYYY-MM-DD
  project_location: string;   // 项目地点，如"线上"、"北京"等
}
```

### 1.4 价格和费用信息

```
Order {
  // ... 前面的信息
  
  // 价格和费用信息
  translator: string;         // 译员姓名
  customer_price: string;     // 客户单价，如"0.5元/字"
  customer_total_amount: string; // 客户总价
  translator_fee: string;     // 译员费用
  translator_price: string;   // 译员单价，如"0.25元/字"
  translator_payment_status: string; // 译员支付状态，如"已付款"、"待付款"
  translator_payment_method: string; // 译员支付方式，如"支付宝"、"微信"
  project_fee: string;        // 项目费用
  project_details: string;    // 项目明细
  cost_details: string;       // 费用明细
  refund_amount: string;      // 退款金额
  refund_reason: string;      // 退款原因
  
  // 利润相关（计算字段）
  profit: number;             // 毛利 = 客户总价 - 译员费用 - 项目费用
  profit_rate: number;        // 毛利率 = 毛利 / 客户总价
  formatted_profit: string;   // 格式化的毛利，如"¥600.00"
  formatted_profit_rate: string; // 格式化的毛利率，如"30.00%"
}
```

### 1.5 支付和发票信息

```
Order {
  // ... 前面的信息
  
  // 支付信息
  payment_status: string;     // 支付状态，如"paid"(已支付)、"unpaid"(未支付)
  payment_status_display: string; // 支付状态显示名称，如"已支付"
  payment_date: string;       // 支付日期，格式：YYYY-MM-DD
  payment_method: string;     // 支付方式，如"微信支付"、"支付宝"、"银行转账"
  payment_remarks: string;    // 支付备注
  
  // 发票信息
  invoice_status: string;     // 发票状态，如"issued"(已开具)、"pending"(待开具)、"not_required"(无需开具)
  invoice_status_display: string; // 发票状态显示名称
  invoice_info: string;       // 发票信息
}
```

### 1.6 合同和地址信息

```
Order {
  // ... 前面的信息
  
  // 合同信息
  contract_number: string;    // 合同编号
  contract_info: string;      // 合同信息
  contract_remarks: string;   // 合同备注
  
  // 地址信息
  delivery_address: string;   // 收件地址
  order_address: string;      // 订单地址
}
```

### 1.7 备注和其他信息

```
Order {
  // ... 前面的信息
  
  // 其他信息
  remarks: string;            // 备注
  follow_up_record: string;   // 回访记录
  tenant: number;             // 所属租户ID
  
  // 历史记录相关
  history_count: number;      // 历史版本数量
}
```

## 2. 订单历史记录数据结构

订单历史记录用于跟踪订单的变更历史，设计如下：

```
OrderHistory {
  id: number;                 // 历史记录ID
  order: number;              // 关联的订单ID
  version: number;            // 版本号，从1开始递增
  modified_by: number;        // 修改人ID
  modified_by_name: string;   // 修改人用户名
  modified_at: string;        // 修改时间
  change_details: string;     // 变更详情JSON字符串
  change_details_data: {      // 变更详情解析后的对象
    action: string;           // 操作类型，如"create"、"update"
    changes?: {               // 变更的字段
      [key: string]: {
        old: any;             // 旧值
        new: any;             // 新值
      }
    };
    message?: string;         // 消息，如"创建订单"
  };
  snapshot: string;           // 订单完整快照的JSON字符串
  snapshot_data: Order;       // 解析后的订单快照对象
}
```

## 3. 订单统计数据结构

订单统计数据用于分析订单情况，设计如下：

```
OrderStatistics {
  period: string;             // 统计周期，如"monthly"
  start_date: string;         // 开始日期
  end_date: string;           // 结束日期
  total_orders: number;       // 订单总数
  customer_total_amount: string; // 订单总金额
  total_profit: string;       // 总毛利
  average_profit_rate: number; // 平均毛利率
  
  // 按周期分组的统计
  by_period: Array<{
    period: string;           // 周期标识，如"2025-01"
    count: number;            // 订单数量
    customer_total_amount: string; // 客户总金额
    profit: string;           // 毛利
    profit_rate: number;      // 毛利率
  }>;
  
  // 按服务类型分组的统计
  by_service_type: Array<{
    service_type: string;     // 服务类型
    count: number;            // 订单数量
    customer_total_amount: string; // 客户总金额
    profit: string;           // 毛利
    profit_rate: number;      // 毛利率
  }>;
  
  // 按支付状态分组的统计
  by_payment_status: Array<{
    payment_status: string;   // 支付状态
    count: number;            // 订单数量
    customer_total_amount: string; // 客户总金额
    profit: string;           // 毛利
    profit_rate: number;      // 毛利率
  }>;
}
```

## 4. 订单提醒数据结构

订单提醒数据用于显示即将到期的订单，设计如下：

```
OrderReminders {
  count: number;              // 提醒总数
  results: Array<{
    id: number;               // 订单ID
    order_number: string;     // 订单编号
    customer_name: string;    // 客户名称
    service_type: string;     // 服务类型
    service_time: string;     // 服务时间
    days_remaining: number;   // 剩余天数
    customer_total_amount: string; // 客户总价
    payment_status: string;   // 支付状态
    translator: string;       // 译员
    project_manager: string;  // 项目负责人
  }>;
  summary: {
    total: number;            // 总订单数
    urgent: number;           // 紧急订单数（3天内）
    paid: number;             // 已支付订单数
    unpaid: number;           // 未支付订单数
    total_amount: string;     // 总金额
  };
}
```

## 5. 请求和响应参数设计

### 5.1 订单列表请求参数

```
OrderListParams {
  payment_status?: string;    // 按支付状态筛选
  service_type?: string;      // 按服务类型筛选
  language?: string;          // 按语种筛选
  customer_id?: number;       // 按客户ID筛选
  customer_type?: string;     // 按客户类型筛选
  service_time?: string;      // 按服务时间筛选
  search?: string;            // 搜索关键词
  page?: number;              // 页码
  page_size?: number;         // 每页数量
  ordering?: string;          // 排序字段
}
```

### 5.2 创建订单请求参数

```
OrderCreateParams {
  customer: number;           // 客户ID（必填）
  source_platform?: string;   // 来源平台
  project_manager?: string;   // 项目负责人
  customer_type?: string;     // 客户类型
  order_date?: string;        // 下单日期
  service_type: string;       // 服务类型（必填）
  language: string;           // 语种（必填）
  customer_count: string;     // 客户数量（必填）
  translation_count?: string; // 翻译数量
  service_time?: string;      // 服务时间
  project_location?: string;  // 项目地点
  customer_contact?: number;  // 客户联系人ID
  translator?: string;        // 译员
  customer_price?: string;    // 客户单价
  customer_total_amount: string; // 客户总价（必填）
  translator_fee?: string;    // 译员费用
  translator_price?: string;  // 翻译单价
  translator_payment_status?: string; // 译费支付状态
  translator_payment_method?: string; // 译费支付方式
  project_fee?: string;       // 项目费用
  project_details?: string;   // 项目明细
  cost_details?: string;      // 费用明细
  refund_amount?: string;     // 项目退款
  refund_reason?: string;     // 退款原因
  payment_status?: string;    // 支付状态
  payment_date?: string;      // 支付日期
  payment_method?: string;    // 支付方式
  payment_remarks?: string;   // 支付备注
  invoice_status?: string;    // 发票状态
  invoice_info?: string;      // 发票信息
  contract_number?: string;   // 合同编号
  contract_info?: string;     // 合同信息
  contract_remarks?: string;  // 合同备注
  delivery_address?: string;  // 收件地址
  order_address?: string;     // 订单地址
  remarks?: string;           // 备注
  follow_up_record?: string;  // 回访记录
}
```

### 5.3 批量操作请求参数

```
OrderBulkOperationParams {
  order_ids: number[];        // 要操作的订单ID列表
  action: 'update' | 'delete'; // 操作类型
  data?: Record<string, any>; // 更新数据（仅在action=update时需要）
}
```

### 5.4 统计数据请求参数

```
OrderStatisticsParams {
  period?: 'daily' | 'weekly' | 'monthly' | 'yearly'; // 统计周期
  start_date?: string;        // 开始日期
  end_date?: string;          // 结束日期
  customer?: number;          // 按客户ID筛选
  service_type?: string;      // 按服务类型筛选
}
```

## 6. 实体关系图

以下是订单管理模块的实体关系图，展示了订单与其他实体的关系：

```
+-------------+       +---------------+       +----------------+
|   Customer  |       |     Order     |       |  OrderHistory  |
+-------------+       +---------------+       +----------------+
| id          |<----->| customer      |       | id             |
| name        |       | customer_name |       | order          |-------+
| ...         |       | ...           |------>| version        |       |
+-------------+       +---------------+       | ...            |       |
                      | customer_contact |    +----------------+       |
                      | ...              |                             |
+--------------+      +------------------+                             |
|   Contact    |                                                       |
+--------------+      +------------------+                             |
| id           |<---->| customer_contact |                             |
| name         |      +------------------+                             |
| ...          |                                                       |
+--------------+                                                       |
                                                                       |
+-------------+       +---------------+       +----------------+       |
|   Tenant    |<----->|     Order     |<------| OrderHistory   |<------+
+-------------+       +---------------+       +----------------+
| id          |       | tenant        |
| name        |       | ...           |
| ...         |       |               |
+-------------+       +---------------+
```

## 7. 数据流转图

以下是订单数据的主要流转过程：

```
创建订单
+--------+    +----------------+    +---------------+    +----------------+
| 用户   | -> | 填写订单表单   | -> | 提交订单数据  | -> | 后端API处理    |
+--------+    +----------------+    +---------------+    +----------------+
                                                         |
                                                         v
+-----------------+    +------------------+    +------------------+
| 返回订单详情    | <- | 创建历史记录     | <- | 保存订单         |
+-----------------+    +------------------+    +------------------+

更新订单
+--------+    +----------------+    +---------------+    +----------------+
| 用户   | -> | 修改订单表单   | -> | 提交更新数据  | -> | 后端API处理    |
+--------+    +----------------+    +---------------+    +----------------+
                                                         |
                                                         v
+-----------------+    +------------------+    +------------------+
| 返回更新后详情  | <- | 创建新的历史记录 | <- | 更新订单         |
+-----------------+    +------------------+    +------------------+

订单历史管理
+--------+    +-------------------+    +----------------+    +---------------+
| 用户   | -> | 查看订单历史列表  | -> | 选择历史版本  | -> | 查看版本详情  |
+--------+    +-------------------+    +----------------+    +---------------+
                                                              |
                                                              v
+------------------+    +-----------------+    +------------------+
| 返回还原后订单   | <- | 创建新历史记录  | <- | 还原到历史版本   |
+------------------+    +-----------------+    +------------------+
```

## 8. 状态转换图

订单支付状态的转换过程：

```
+----------+     更新支付信息     +----------+
|  未支付  | ------------------> |  已支付  |
+----------+                     +----------+
     ^                                |
     |                                |
     |           退款操作             |
     +--------------------------------+
```

订单发票状态的转换过程：

```
+----------+     申请发票      +----------+     开具发票     +----------+
| 无需开具 | ---------------> |  待开具  | --------------> |  已开具  |
+----------+                  +----------+                 +----------+
```

## 9. 前端类型定义

根据上述数据结构，前端TypeScript类型定义如下：

### 9.1 基本类型

```typescript
// 支付状态类型
export type PaymentStatus = 'paid' | 'unpaid';

// 发票状态类型
export type InvoiceStatus = 'issued' | 'pending' | 'not_required';

// 服务类型
export type ServiceType = '文档翻译' | '口译服务' | '校对服务' | string;
```

### 9.2 订单类型

```typescript
// 订单对象类型
export interface Order {
  id: number;
  order_number: string;
  customer: number;
  customer_name: string;
  customer_contact?: number;
  customer_contact_info?: {
    id: number;
    username: string;
    display_name: string;
    phone: string;
    email: string;
  };
  created_by_info?: {
    id: number;
    username: string;
    display_name: string;
  };
  profit: number;
  profit_rate: number;
  formatted_profit: string;
  formatted_profit_rate: string;
  created_at: string;
  updated_at: string;
  is_deleted: boolean;
  
  source_platform?: string;
  project_manager?: string;
  customer_type?: string;
  order_date?: string;
  service_type: ServiceType;
  service_type_display?: string;
  language: string;
  customer_count: string;
  translation_count?: string;
  service_time?: string;
  project_location?: string;
  
  translator?: string;
  customer_price?: string;
  customer_total_amount: string;
  translator_fee?: string;
  translator_price?: string;
  translator_payment_status?: string;
  translator_payment_method?: string;
  project_fee?: string;
  project_details?: string;
  cost_details?: string;
  refund_amount?: string;
  refund_reason?: string;
  
  payment_status: PaymentStatus;
  payment_status_display?: string;
  payment_date?: string;
  payment_method?: string;
  payment_remarks?: string;
  
  invoice_status?: InvoiceStatus;
  invoice_status_display?: string;
  invoice_info?: string;
  
  contract_number?: string;
  contract_info?: string;
  contract_remarks?: string;
  
  delivery_address?: string;
  order_address?: string;
  
  remarks?: string;
  follow_up_record?: string;
  tenant: number;
  
  history_count?: number;
}
```

### 9.3 请求参数类型

```typescript
// 订单列表查询参数
export interface OrderListParams {
  payment_status?: PaymentStatus;
  service_type?: ServiceType;
  language?: string;
  customer_id?: number;
  customer_type?: string;
  service_time?: string;
  search?: string;
  page?: number;
  page_size?: number;
  ordering?: string;
}

// 创建/更新订单参数
export interface OrderCreateUpdateParams {
  customer: number;
  source_platform?: string;
  project_manager?: string;
  customer_type?: string;
  order_date?: string;
  service_type: ServiceType;
  language: string;
  customer_count: string;
  translation_count?: string;
  service_time?: string;
  project_location?: string;
  customer_contact?: number;
  translator?: string;
  customer_price?: string;
  customer_total_amount: string;
  translator_fee?: string;
  translator_price?: string;
  translator_payment_status?: string;
  translator_payment_method?: string;
  project_fee?: string;
  project_details?: string;
  cost_details?: string;
  refund_amount?: string;
  refund_reason?: string;
  payment_status?: PaymentStatus;
  payment_date?: string;
  payment_method?: string;
  payment_remarks?: string;
  invoice_status?: InvoiceStatus;
  invoice_info?: string;
  contract_number?: string;
  contract_info?: string;
  contract_remarks?: string;
  delivery_address?: string;
  order_address?: string;
  remarks?: string;
  follow_up_record?: string;
}
```

## 10. 数据校验规则

为确保数据的完整性和有效性，以下是主要字段的校验规则：

1. **必填字段校验**：
   - customer：客户ID，必填
   - service_type：服务类型，必填
   - language：语种，必填
   - customer_count：客户数量，必填
   - customer_total_amount：客户总价，必填

2. **格式校验**：
   - order_date：日期格式，YYYY-MM-DD
   - service_time：日期格式，YYYY-MM-DD
   - payment_date：日期格式，YYYY-MM-DD
   - customer_total_amount：数字格式，可含小数点

3. **业务规则校验**：
   - 如果payment_status为paid，则payment_date和payment_method应该有值
   - 如果invoice_status为issued，则invoice_info应该有值
   - customer_total_amount应大于等于translator_fee加project_fee

4. **计算字段**：
   - profit = parseFloat(customer_total_amount) - parseFloat(translator_fee || "0") - parseFloat(project_fee || "0")
   - profit_rate = profit / parseFloat(customer_total_amount)
   - formatted_profit = "¥" + profit.toFixed(2)
   - formatted_profit_rate = (profit_rate * 100).toFixed(2) + "%" 